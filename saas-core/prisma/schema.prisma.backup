generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

// Global role - only SUPER_ADMIN has meaning here
// Regular users get their roles via TenantMembership
enum GlobalRole {
  SUPER_ADMIN // Can access all tenants, manage platform
  USER // Regular user, gets access via TenantMembership
}

// Tenant-specific role - assigned via TenantMembership
enum TenantRole {
  TENANT_ADMIN // Full control of tenant (users, settings, billing)
  TENANT_USER // Regular member with limited permissions
}

// Tenant lifecycle status
enum TenantStatus {
  PENDING_ACTIVATION // Created by partner, awaiting tenant signup/payment
  ACTIVE // Normal operation
  SUSPENDED // Temporarily disabled (e.g., payment issue)
  DEACTIVATED // Soft-deleted, data retained
}

// Attribution method - how the tenant was linked to a partner
enum AttributionMethod {
  PARTNER_CREATED // Partner created the tenant directly
  REFERRAL_LINK // Tenant signed up via referral link/code
  MANUAL_ASSIGNMENT // Super Admin manually assigned (rare, audit logged)
}

// Domain verification status
enum DomainStatus {
  PENDING // Awaiting DNS verification
  VERIFIED // DNS verified, domain active
  FAILED // Verification failed
}

// Domain type for clarity
enum DomainType {
  SUBDOMAIN // e.g., acme.saascore.com (platform-provided)
  CUSTOM // e.g., app.acme.com (customer-owned)
}

// ============================================================================
// USER
// Global identity - authentication happens here
// ============================================================================
model User {
  id         String     @id @default(uuid())
  email      String     @unique
  name       String?
  avatarUrl  String?
  globalRole GlobalRole @default(USER)
  isActive   Boolean    @default(true)

  // Audit fields
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  memberships TenantMembership[]
  magicLinks  MagicLink[]
  sessions    Session[]

  // Partner relation (a user can belong to ONE partner organization)
  partnerMembership PartnerUser?

  @@index([email])
  @@index([globalRole])
}

// ============================================================================
// TENANT
// Organization/workspace - the isolation boundary
// ============================================================================
model Tenant {
  id     String       @id @default(uuid())
  name   String // Display name: "Acme Corporation"
  slug   String       @unique // URL-safe identifier: "acme"
  status TenantStatus @default(ACTIVE)

  // Branding (embedded for simplicity, could be separate model)
  appName        String  @default("SaaS App")
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String  @default("#6366f1")
  secondaryColor String  @default("#8b5cf6")

  // Partner-assisted creation fields
  requestedModules String[]  @default([]) // ["POS", "SVM", "MVM"] - requested at creation
  activatedModules String[]  @default([]) // Actually provisioned after payment
  activatedAt      DateTime? // When tenant completed signup and payment

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  domains     TenantDomain[]
  memberships TenantMembership[]
  magicLinks  MagicLink[]

  // Partner referral (immutable - who referred this tenant)
  partnerReferral PartnerReferral?

  // Subscription & Entitlements
  subscription Subscription?
  entitlements Entitlement[]
  invoices     Invoice[]

  // Business profile
  businessProfile BusinessProfile?

  @@index([slug])
  @@index([status])
}

// ============================================================================
// TENANT MEMBERSHIP
// Join table: User <-> Tenant with role
// This is where tenant-specific permissions live
// ============================================================================
model TenantMembership {
  id       String     @id @default(uuid())
  userId   String
  tenantId String
  role     TenantRole @default(TENANT_USER)
  isActive Boolean    @default(true)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  joinedAt  DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // A user can only have one membership per tenant
  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([role])
}

// ============================================================================
// TENANT DOMAIN
// Manages both subdomains and custom domains for tenant resolution
// ============================================================================
model TenantDomain {
  id        String       @id @default(uuid())
  tenantId  String
  domain    String       @unique // e.g., "acme" (subdomain) or "app.acme.com" (custom)
  type      DomainType
  status    DomainStatus @default(PENDING)
  isPrimary Boolean      @default(false) // Primary domain shown in UI

  // For custom domain verification
  verificationToken String?
  verifiedAt        DateTime?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([tenantId])
  @@index([type, status])
}

// ============================================================================
// MAGIC LINK
// Passwordless authentication tokens
// ============================================================================
model MagicLink {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  tenantId  String? // Optional: login directly to a specific tenant
  expiresAt DateTime
  usedAt    DateTime?

  // Audit fields
  createdAt DateTime @default(now())

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// SESSION
// Active user sessions for authentication
// ============================================================================
model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  activeTenant String? // Currently selected tenant (for multi-tenant users)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime

  // Audit fields
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// SUBSCRIPTION & ENTITLEMENT DOMAIN
// Manages tenant subscriptions and module access
// Partner logic is ISOLATED - modules only check entitlements
// ============================================================================

// Subscription status
enum SubscriptionStatus {
  PENDING // Created but not yet active
  TRIALING // In trial period
  ACTIVE // Paid and active
  PAST_DUE // Payment failed, retry in progress
  GRACE_PERIOD // Payment failed, in grace period (limited access)
  CANCELLED // Cancelled, access until period end
  EXPIRED // Period ended, no access
  SUSPENDED // Suspended due to payment failure (no access)
  PAUSED // Temporarily paused by user
}

// Billing interval
enum BillingInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

// Entitlement status
enum EntitlementStatus {
  ACTIVE // Module is accessible
  SUSPENDED // Temporarily suspended
  EXPIRED // No longer valid
}

// Subscription event types
enum SubscriptionEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_PAUSED
  SUBSCRIPTION_RESUMED
  SUBSCRIPTION_UPGRADED
  SUBSCRIPTION_DOWNGRADED
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_SUSPENDED
  SUBSCRIPTION_GRACE_PERIOD_STARTED
  SUBSCRIPTION_RECOVERED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TRIAL_STARTED
  TRIAL_ENDED
}

// ============================================================================
// SUBSCRIPTION PLAN
// Defines available plans and their module bundles
// ============================================================================
model SubscriptionPlan {
  id          String  @id @default(uuid())
  name        String // "Starter", "Professional", "Enterprise"
  slug        String  @unique
  description String?

  // Pricing
  priceMonthly Decimal @db.Decimal(12, 2)
  priceYearly  Decimal @db.Decimal(12, 2)
  currency     String  @default("USD")

  // Module entitlements included in this plan
  includedModules String[] // ["POS", "SVM", "MVM"]

  // Limits and quotas
  maxUsers   Int? // null = unlimited
  maxStorage Int? // GB, null = unlimited
  features   Json? // Additional feature flags

  // Plan metadata
  isActive  Boolean @default(true)
  isPublic  Boolean @default(true) // Visible in pricing page
  sortOrder Int     @default(0)

  // Trial configuration
  trialDays Int @default(14)

  // Grace period configuration (per plan)
  gracePeriodDays Int @default(7) // Days of grace before suspension

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([slug])
  @@index([isActive, isPublic])
}

// ============================================================================
// SUBSCRIPTION
// Tenant's active subscription with optional Partner attribution
// Partner ID is OPTIONAL - not all subscriptions have partner attribution
// ============================================================================
model Subscription {
  id       String @id @default(uuid())
  tenantId String @unique // One subscription per tenant
  planId   String

  // Status
  status SubscriptionStatus @default(PENDING)

  // Billing
  billingInterval    BillingInterval @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Pricing at time of subscription (may differ from plan if discounted)
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD")

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Grace Period
  // When payment fails, subscription enters GRACE_PERIOD status
  // gracePeriodEnd defines when access is fully revoked
  gracePeriodDays   Int       @default(7) // Days of grace after payment failure
  gracePeriodStart  DateTime? // When grace period began
  gracePeriodEnd    DateTime? // When grace period ends (full revocation)
  paymentFailedAt   DateTime? // When payment first failed
  paymentRetryCount Int       @default(0) // Number of retry attempts

  // Cancellation
  cancelledAt       DateTime?
  cancelReason      String?
  cancelAtPeriodEnd Boolean   @default(false)

  // External payment provider reference
  externalId      String? // Stripe subscription ID, etc.
  paymentProvider String? // "stripe", "paypal", etc.

  // Partner attribution (OPTIONAL - may be null)
  // This links to the PartnerReferral, NOT directly to Partner
  // Ensures commission logic stays with attribution
  partnerReferralId String?

  // Metadata
  metadata Json?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan            SubscriptionPlan    @relation(fields: [planId], references: [id])
  partnerReferral PartnerReferral?    @relation(fields: [partnerReferralId], references: [id], onDelete: SetNull)
  entitlements    Entitlement[]
  events          SubscriptionEvent[]
  invoices        Invoice[]

  @@index([tenantId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([partnerReferralId])
}

// ============================================================================
// ENTITLEMENT
// Module access grants for a tenant
// MODULES ONLY CHECK THIS - no subscription/partner logic in modules
// ============================================================================
model Entitlement {
  id             String  @id @default(uuid())
  tenantId       String
  subscriptionId String? // null = manually granted

  // Module this entitlement grants access to
  module String // "POS", "SVM", "MVM"

  // Status
  status EntitlementStatus @default(ACTIVE)

  // Validity period
  validFrom  DateTime  @default(now())
  validUntil DateTime? // null = until subscription ends

  // Limits specific to this entitlement
  limits Json? // { "maxTransactions": 1000 }

  // Source of entitlement (for auditing)
  source String @default("subscription") // "subscription", "addon", "promo", "manual"

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  // Tenant can have multiple entitlements for different modules
  @@unique([tenantId, module])
  @@index([tenantId])
  @@index([module])
  @@index([status])
}

// ============================================================================
// SUBSCRIPTION EVENT
// Immutable log of subscription lifecycle events
// Used for commission calculation and auditing
// ============================================================================
model SubscriptionEvent {
  id             String @id @default(uuid())
  subscriptionId String

  // Event type
  eventType SubscriptionEventType

  // Snapshot at time of event (immutable)
  tenantId  String
  partnerId String? // From attribution, NULL if no partner

  // Module and billing info at time of event
  modules         String[] // Modules at time of event
  billingAmount   Decimal?         @db.Decimal(12, 2)
  billingCurrency String?
  billingInterval BillingInterval?

  // Period info
  periodStart DateTime?
  periodEnd   DateTime?

  // Additional context
  metadata Json? // Event-specific data

  // External reference
  externalEventId String? // Payment provider event ID

  // Timestamp - immutable
  occurredAt DateTime @default(now())

  // NO updatedAt - events are immutable

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([tenantId])
  @@index([partnerId])
  @@index([eventType])
  @@index([occurredAt])
}

// ============================================================================
// INVOICE
// Billing records for subscriptions
// ============================================================================
model Invoice {
  id             String @id @default(uuid())
  subscriptionId String
  tenantId       String

  // Invoice details
  invoiceNumber String @unique
  status        String // "draft", "open", "paid", "void", "uncollectible"

  // Amounts
  subtotal   Decimal @db.Decimal(12, 2)
  tax        Decimal @default(0) @db.Decimal(12, 2)
  total      Decimal @db.Decimal(12, 2)
  amountPaid Decimal @default(0) @db.Decimal(12, 2)
  amountDue  Decimal @db.Decimal(12, 2)
  currency   String  @default("USD")

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Dates
  issuedAt DateTime  @default(now())
  dueAt    DateTime
  paidAt   DateTime?

  // External reference
  externalId String? // Stripe invoice ID
  hostedUrl  String? // URL to hosted invoice
  pdfUrl     String? // URL to PDF

  // Partner attribution snapshot (for commission calculation)
  partnerId String?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([tenantId])
  @@index([status])
  @@index([partnerId])
}

// ============================================================================
// PARTNER DOMAIN - Platform-level reseller/affiliate system
// Partners are INDEPENDENT of Tenants - they exist at platform level
// ============================================================================

// Partner lifecycle status
enum PartnerStatus {
  PENDING // Application submitted, awaiting approval
  ACTIVE // Approved and operational
  SUSPENDED // Temporarily disabled
  TERMINATED // Permanently ended
}

// Partner tier for commission structures
enum PartnerTier {
  BRONZE // Entry level
  SILVER // Mid tier
  GOLD // High performer
  PLATINUM // Top tier / enterprise
}

// Partner user roles within a partner organization
enum PartnerRole {
  PARTNER_OWNER // Full control: manage agreement, users, view all data
  PARTNER_STAFF // Limited: view referrals/earnings, create referral codes
}

// Agreement status
enum AgreementStatus {
  DRAFT // Being prepared
  ACTIVE // Currently in effect
  SUPERSEDED // Replaced by newer version
  TERMINATED // Ended
}

// Commission calculation type
enum CommissionType {
  PERCENTAGE // % of transaction amount
  FIXED // Fixed amount per transaction/period
  TIERED // Volume-based tiers
  HYBRID // Combination of multiple models
}

// Commission trigger - when commission is earned
enum CommissionTrigger {
  ON_PAYMENT // When payment is received
  ON_ACTIVATION // When subscription activates (first payment)
  ON_RENEWAL // On each renewal
  ON_SIGNUP // One-time on signup
}

// Earning status - ledger state machine
enum EarningStatus {
  PENDING // Calculated, awaiting clearance period
  CLEARED // Clearance period passed, ready for payout
  APPROVED // Approved for payment batch
  PAID // Payment processed
  DISPUTED // Under review/dispute
  REVERSED // Reversed (chargeback, refund)
  VOIDED // Voided before clearance
}

// Earning entry type - for ledger
enum EarningEntryType {
  CREDIT // Positive earning (commission)
  DEBIT // Negative (reversal, adjustment)
  ADJUSTMENT // Manual adjustment
}

// ============================================================================
// PARTNER
// Independent platform actor - NOT a tenant, NOT a vendor
// Represents a reseller/affiliate organization
// ============================================================================
model Partner {
  id      String  @id @default(uuid())
  name    String // Company name: "Digital Solutions Inc"
  slug    String  @unique // URL-safe identifier: "digital-solutions"
  email   String // Primary contact email
  phone   String? // Contact phone
  website String? // Partner's website

  status PartnerStatus @default(PENDING)
  tier   PartnerTier   @default(BRONZE)

  // Business details
  companyNumber String? // Business registration number
  taxId         String? // Tax identification
  address       Json? // Structured address

  // Metadata for flexibility
  metadata Json?

  // Audit fields
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime? // When partner was approved

  // Relations
  users          PartnerUser[]
  agreements     PartnerAgreement[]
  referralCodes  PartnerReferralCode[]
  referrals      PartnerReferral[]
  earnings       PartnerEarning[]
  payoutBatches  PayoutBatch[]
  payoutSettings PartnerPayoutSettings?

  @@index([slug])
  @@index([email])
  @@index([status])
  @@index([tier])
}

// ============================================================================
// PARTNER USER
// Users belonging to a Partner organization
// Links existing User model to Partner with role
// ============================================================================
model PartnerUser {
  id        String      @id @default(uuid())
  partnerId String
  userId    String
  role      PartnerRole @default(PARTNER_STAFF)
  isActive  Boolean     @default(true)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  joinedAt  DateTime @default(now())

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // A user can only belong to one partner (prevents conflicts)
  @@unique([userId])
  // Index for partner lookups
  @@unique([partnerId, userId])
  @@index([partnerId])
  @@index([role])
}

// ============================================================================
// PARTNER AGREEMENT
// Versioned agreement terms between platform and partner
// Supports multiple versions over time - only one ACTIVE at a time
// Commission rules are DECLARATIVE, not procedural
// ============================================================================
model PartnerAgreement {
  id        String @id @default(uuid())
  partnerId String

  // Versioning
  version Int // Auto-increment per partner: 1, 2, 3...

  // Effective period
  effectiveFrom DateTime // When this agreement takes effect
  effectiveTo   DateTime? // Null = current/indefinite

  // =========================================================================
  // COMMISSION RULES - Declarative, flexible structure
  // =========================================================================

  // Primary commission model
  commissionType CommissionType @default(PERCENTAGE)

  // When commission is triggered
  commissionTrigger CommissionTrigger @default(ON_PAYMENT)

  // Base commission rate (for PERCENTAGE type)
  commissionRate Decimal @db.Decimal(5, 4) // e.g., 0.1500 = 15%

  // Fixed amount (for FIXED type)
  fixedAmount Decimal? @db.Decimal(12, 2) // e.g., 10.00

  // One-time setup fee (in addition to recurring)
  setupFee Decimal? @db.Decimal(12, 2) // e.g., 50.00 on first payment

  // Tiered commission structure (if commissionType = TIERED or HYBRID)
  // Format: [{ "minVolume": 0, "maxVolume": 1000, "rate": 0.10 }, ...]
  commissionTiers Json?

  // Full commission rules (for HYBRID and complex scenarios)
  // Format: { "rules": [...], "conditions": [...] }
  commissionRules Json?

  // Minimum and maximum commission per transaction
  minCommission Decimal? @db.Decimal(12, 2)
  maxCommission Decimal? @db.Decimal(12, 2)

  // Clearance period (days before PENDING -> CLEARED)
  clearanceDays Int @default(30)

  // Currency for fixed amounts
  currency String @default("USD")

  // =========================================================================
  // AGREEMENT TERMS
  // =========================================================================

  // Full agreement terms (flexible structure)
  terms Json? // Payment terms, conditions, etc.

  // Signature tracking
  status         AgreementStatus @default(DRAFT)
  signedAt       DateTime?
  signedByUserId String? // PartnerUser who signed

  // Platform approval
  approvedAt       DateTime?
  approvedByUserId String? // Super Admin who approved

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner  Partner          @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  earnings PartnerEarning[]

  // Only one agreement version number per partner
  @@unique([partnerId, version])
  @@index([partnerId])
  @@index([status])
  @@index([effectiveFrom, effectiveTo])
}

// ============================================================================
// PARTNER REFERRAL CODE
// Trackable codes for attribution
// Partners can have multiple codes for different campaigns
// ============================================================================
model PartnerReferralCode {
  id        String @id @default(uuid())
  partnerId String
  code      String @unique // e.g., "PARTNER2024", "SUMMER-SALE"

  // Usage controls
  isActive   Boolean   @default(true)
  usageLimit Int? // Null = unlimited
  usageCount Int       @default(0)
  expiresAt  DateTime? // Null = never expires

  // Campaign tracking
  campaignName String? // e.g., "Q4 2024 Promotion"
  metadata     Json? // Additional tracking data

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner   Partner           @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  referrals PartnerReferral[]

  @@index([code])
  @@index([partnerId])
  @@index([isActive])
}

// ============================================================================
// PARTNER REFERRAL
// IMMUTABLE attribution link between Partner and Tenant
// Once created, the partner-tenant relationship cannot be changed
// This is the source of truth for "who referred this tenant"
// ============================================================================
model PartnerReferral {
  id             String  @id @default(uuid())
  partnerId      String
  tenantId       String  @unique // Each tenant can only have ONE referral (immutable)
  referralCodeId String? // The code used (if any)

  // Attribution method - HOW the tenant was linked
  attributionMethod AttributionMethod @default(REFERRAL_LINK)

  // Attribution timestamp - IMMUTABLE
  referredAt DateTime @default(now())

  // Attribution window configuration
  // If set, attribution is only valid for commissions within this period
  attributionWindowDays Int? // null = lifetime attribution
  attributionExpiresAt  DateTime? // Calculated: referredAt + windowDays

  // Lock flag - set to true after first successful billing
  // Once locked, this record can NEVER be modified or deleted
  attributionLocked Boolean   @default(false)
  lockedAt          DateTime?

  // Context at time of referral
  referralSource String? // e.g., "website", "email", "direct"
  landingPage    String? // URL where signup occurred
  metadata       Json? // Additional attribution data

  // Who created this attribution
  createdByUserId String? // Partner user or Super Admin who created

  // Audit fields
  createdAt DateTime @default(now())
  // NO updatedAt - this is intentionally immutable

  // Relations
  partner       Partner              @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  referralCode  PartnerReferralCode? @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  earnings      PartnerEarning[]
  subscriptions Subscription[] // Subscriptions attributed to this referral

  @@index([partnerId])
  @@index([tenantId])
  @@index([referredAt])
  @@index([attributionLocked])
  @@index([attributionMethod])
}

// ============================================================================
// PARTNER EARNING LEDGER
// IMMUTABLE, APPEND-ONLY earning records
// No direct edits allowed - use DEBIT entries for reversals
// Linked to specific agreement version that was active at time of earning
// ============================================================================
model PartnerEarning {
  id          String @id @default(uuid())
  partnerId   String
  referralId  String // Which tenant referral generated this
  agreementId String // Which agreement terms applied

  // Entry type - for ledger accounting
  entryType EarningEntryType @default(CREDIT)

  // Link to subscription event that triggered this earning
  subscriptionEventId String? // For traceability

  // Idempotency key - prevents duplicate processing
  idempotencyKey String @unique // e.g., "evt_{eventId}_comm"

  // Billing period
  periodStart DateTime // Start of billing period
  periodEnd   DateTime // End of billing period

  // =========================================================================
  // FINANCIAL DETAILS - Snapshot at time of earning (IMMUTABLE)
  // =========================================================================

  // Source amount
  grossAmount Decimal @db.Decimal(12, 2) // Total billed to tenant

  // Commission calculation snapshot
  commissionType CommissionType // Type used for calculation
  commissionRate Decimal?       @db.Decimal(5, 4) // Rate if PERCENTAGE
  fixedAmount    Decimal?       @db.Decimal(12, 2) // Amount if FIXED

  // Final calculated commission (can be negative for DEBIT)
  commissionAmount Decimal @db.Decimal(12, 2) // The actual earning
  currency         String  @default("USD")

  // Calculation details (for audit trail)
  calculationDetails Json? // { "formula": "...", "inputs": {...} }

  // =========================================================================
  // STATUS - State machine for ledger
  // =========================================================================

  status EarningStatus @default(PENDING)

  // State transition timestamps
  clearedAt  DateTime? // When PENDING -> CLEARED
  approvedAt DateTime? // When CLEARED -> APPROVED
  paidAt     DateTime? // When APPROVED -> PAID
  disputedAt DateTime? // When disputed
  reversedAt DateTime? // When reversed
  voidedAt   DateTime? // When voided

  // For REVERSED/VOIDED - link to reversal entry
  reversalEntryId String? // Points to the DEBIT entry
  reversedById    String? // Original entry this reverses
  reversalReason  String? // Why reversed/voided

  // =========================================================================
  // PAYMENT TRACKING
  // =========================================================================

  payoutBatchId    String? // Which payout batch this belongs to
  paymentReference String? // External payment ID
  paymentMethod    String? // e.g., "bank_transfer", "paypal"

  // =========================================================================
  // AUDIT FIELDS - Immutable
  // =========================================================================

  createdAt DateTime @default(now())
  // NO updatedAt - this is an APPEND-ONLY ledger
  // State changes create new entries or use state transition timestamps

  createdByUserId  String? // System or user who created
  approvedByUserId String? // Super Admin who approved

  // Context at time of creation
  metadata Json? // Additional context

  // Relations
  partner   Partner          @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  referral  PartnerReferral  @relation(fields: [referralId], references: [id], onDelete: Restrict)
  agreement PartnerAgreement @relation(fields: [agreementId], references: [id], onDelete: Restrict)

  @@index([partnerId])
  @@index([referralId])
  @@index([agreementId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
  @@index([payoutBatchId])
  @@index([entryType])
}

// ============================================================================
// PARTNER PAYOUT SETTINGS
// Configuration for payout thresholds and tax withholding
// ============================================================================
model PartnerPayoutSettings {
  id        String @id @default(uuid())
  partnerId String @unique

  // Payout thresholds
  minimumPayout Decimal @default(100.00) @db.Decimal(12, 2) // Minimum balance for payout
  currency      String  @default("USD")

  // Payout schedule preference
  payoutFrequency String @default("MONTHLY") // WEEKLY, BIWEEKLY, MONTHLY, QUARTERLY

  // Tax withholding
  taxWithholdingEnabled Boolean  @default(false)
  taxWithholdingRate    Decimal? @db.Decimal(5, 4) // e.g., 0.30 = 30%
  taxWithholdingReason  String? // "W-8BEN", "1099-MISC", etc.

  // Tax documentation status
  taxDocumentStatus     String    @default("NOT_SUBMITTED") // NOT_SUBMITTED, PENDING, VERIFIED, EXPIRED
  taxDocumentType       String? // "W-9", "W-8BEN", etc.
  taxDocumentVerifiedAt DateTime?

  // Bank/Payment details (placeholder - no actual integration)
  paymentMethodType     String? // "BANK_TRANSFER", "PAYPAL", "CHECK"
  paymentMethodVerified Boolean @default(false)
  paymentMethodDetails  Json? // Encrypted/masked details

  // Hold status
  payoutHold       Boolean   @default(false)
  payoutHoldReason String?
  payoutHoldUntil  DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
}

// ============================================================================
// PAYOUT BATCH
// Groups earnings for payment processing
// Status: DRAFT → PENDING_APPROVAL → APPROVED → READY → PROCESSING → COMPLETED/FAILED
// ============================================================================
model PayoutBatch {
  id        String @id @default(uuid())
  partnerId String

  // Batch details
  batchNumber String @unique // e.g., "PO-2025-001234"
  status      String @default("DRAFT") // DRAFT, PENDING_APPROVAL, APPROVED, READY, PROCESSING, COMPLETED, FAILED, CANCELLED

  // Financial summary
  grossAmount    Decimal @db.Decimal(12, 2) // Total before withholding
  taxWithholding Decimal @default(0) @db.Decimal(12, 2) // Tax withheld
  netAmount      Decimal @db.Decimal(12, 2) // Amount to be paid
  currency       String  @default("USD")
  earningsCount  Int // Number of earnings in batch

  // Period covered
  periodStart DateTime
  periodEnd   DateTime

  // Readiness checks
  readinessChecks Json? // { "minimumMet": true, "taxDocsVerified": true, ... }
  readinessStatus String  @default("NOT_CHECKED") // NOT_CHECKED, READY, BLOCKED
  blockReason     String? // Why payout is blocked

  // Payment details (populated when processed - NOT in Phase 5)
  paymentMethod    String?
  paymentReference String?
  processedAt      DateTime?
  failureReason    String?

  // Approval workflow
  approvedAt       DateTime?
  approvedByUserId String?

  // Cancellation
  cancelledAt        DateTime?
  cancelledByUserId  String?
  cancellationReason String?

  // Notes
  internalNotes String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Restrict)

  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
  @@index([readinessStatus])
}

// ============================================================================
// AUDIT LOG
// Track all significant actions for compliance and debugging
// ============================================================================
enum AuditAction {
  // Tenant actions
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  TENANT_DEACTIVATED

  // Domain actions
  DOMAIN_ADDED
  DOMAIN_REMOVED
  DOMAIN_VERIFIED

  // User actions
  USER_INVITED
  USER_REMOVED
  USER_ROLE_CHANGED

  // Auth actions
  USER_LOGIN
  USER_LOGOUT

  // Super Admin actions
  SUPER_ADMIN_IMPERSONATION_START
  SUPER_ADMIN_IMPERSONATION_END

  // Partner actions
  PARTNER_CREATED
  PARTNER_UPDATED
  PARTNER_APPROVED
  PARTNER_SUSPENDED
  PARTNER_TERMINATED
  PARTNER_USER_ADDED
  PARTNER_USER_REMOVED
  PARTNER_AGREEMENT_CREATED
  PARTNER_AGREEMENT_SIGNED
  PARTNER_AGREEMENT_APPROVED
  PARTNER_REFERRAL_CREATED
  PARTNER_REFERRAL_LOCKED
  PARTNER_EARNING_CREATED
  PARTNER_EARNING_APPROVED
  PARTNER_EARNING_PAID

  // Attribution actions
  ATTRIBUTION_CREATED // New attribution link created
  ATTRIBUTION_LOCKED // Attribution locked after first billing
  ATTRIBUTION_LOCK_ATTEMPTED // Failed attempt to modify locked attribution
  ATTRIBUTION_REASSIGN_BLOCKED // Attempted reassignment blocked

  // Partner-assisted tenant creation
  PARTNER_TENANT_CREATED // Partner created tenant in PENDING state
  PARTNER_TENANT_ACTIVATED // Tenant completed signup and activated

  // Subscription actions (module-agnostic)
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_PAUSED
  SUBSCRIPTION_RESUMED
  SUBSCRIPTION_UPGRADED
  SUBSCRIPTION_DOWNGRADED
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_GRACE_PERIOD_STARTED
  SUBSCRIPTION_SUSPENDED

  // Entitlement actions
  ENTITLEMENT_GRANTED
  ENTITLEMENT_REVOKED
  ENTITLEMENT_EXPIRED

  // Invoice actions
  INVOICE_CREATED
  INVOICE_PAID
  INVOICE_VOIDED

  // Commission & Earnings actions
  COMMISSION_CALCULATED // Commission calculated for event
  EARNING_CREATED // Earning ledger entry created
  EARNING_CLEARED // Earning cleared (after clearance period)
  EARNING_APPROVED // Earning approved for payout
  EARNING_PAID // Earning paid
  EARNING_DISPUTED // Earning disputed
  EARNING_REVERSED // Earning reversed
  EARNING_VOIDED // Earning voided

  // Payout actions
  PAYOUT_BATCH_CREATED // Payout batch created
  PAYOUT_BATCH_APPROVED // Payout batch approved
  PAYOUT_BATCH_PROCESSED // Payout batch processed
  PAYOUT_BATCH_FAILED // Payout batch failed
  PAYOUT_BATCH_CANCELLED // Payout batch cancelled

  // Payout readiness actions
  PAYOUT_READINESS_CHECKED // Readiness check performed
  PAYOUT_HOLD_APPLIED // Partner payout put on hold
  PAYOUT_HOLD_RELEASED // Partner payout hold released
  PAYOUT_SETTINGS_UPDATED // Partner payout settings changed
  TAX_DOCUMENT_SUBMITTED // Tax document submitted
  TAX_DOCUMENT_VERIFIED // Tax document verified
}

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  actorId    String // User who performed the action
  actorEmail String // Denormalized for easy querying
  tenantId   String? // Null for super admin global actions
  targetType String? // e.g., "User", "Tenant", "TenantDomain"
  targetId   String? // ID of the affected entity
  metadata   Json? // Additional context
  ipAddress  String?
  userAgent  String?

  // Audit fields
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@index([targetType, targetId])
}

// ============================================================================
// ============================================================================
// SHARED BUSINESS ENTITIES
// ============================================================================
// ============================================================================
// 
// These entities are OWNED by SaaS Core and USED by all modules (POS, SVM, MVM).
// Modules reference these via ID only. Modules do NOT mutate these directly.
// All mutations happen through Core APIs or Core event handlers.
//
// OWNERSHIP:
// - Product, ProductVariant, ProductCategory: Core owns master catalog
// - InventoryLevel: Core owns single source of truth
// - Customer, CustomerAddress: Core owns customer data
// - StaffMember: Core owns staff/employee data
// - Supplier: Core owns supplier relationships
// - Location: Core owns branch/location data
// - Wallet, WalletTransaction: Core owns financial balances
// - TaxRule, TaxRate: Core owns tax configuration
// - PricingRule: Core owns pricing logic
// - Notification, NotificationPreference: Core owns communication
// - BusinessProfile: Core owns tenant business details
//
// ============================================================================

// ============================================================================
// BUSINESS PROFILE
// Extended business details for a tenant
// ============================================================================
model BusinessProfile {
  id       String @id @default(uuid())
  tenantId String @unique

  // Business identity
  legalName          String? // Legal business name
  tradingName        String? // DBA / Trading as
  taxId              String? // VAT/GST/EIN number
  registrationNumber String? // Company registration

  // Business type
  businessType String? // SOLE_PROPRIETOR, LLC, CORPORATION, etc.
  industry     String? // Industry classification

  // Contact details
  email   String? // Primary business email
  phone   String? // Primary phone
  website String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @default("US")

  // Operating details
  timezone   String @default("UTC")
  currency   String @default("USD")
  dateFormat String @default("YYYY-MM-DD")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

// ============================================================================
// LOCATION / BRANCH
// Physical or virtual business locations
// ============================================================================
enum LocationStatus {
  ACTIVE
  INACTIVE
  CLOSED
}

model Location {
  id       String @id @default(uuid())
  tenantId String

  // Location identity
  name String // "Main Store", "Warehouse #1"
  code String? // Internal code: "LOC-001"
  type String  @default("STORE") // STORE, WAREHOUSE, OFFICE, VIRTUAL

  // Status
  status LocationStatus @default(ACTIVE)

  // Contact
  email String?
  phone String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)

  // Operating hours (JSON for flexibility)
  operatingHours Json? // { "mon": { "open": "09:00", "close": "17:00" }, ... }

  // Capabilities
  isDefaultLocation Boolean @default(false)
  allowsPickup      Boolean @default(false)
  allowsShipping    Boolean @default(false)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inventoryLevels  InventoryLevel[]
  staffAssignments StaffMember[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
}

// ============================================================================
// PRODUCT CATEGORY
// Hierarchical product categorization
// ============================================================================
model ProductCategory {
  id       String @id @default(uuid())
  tenantId String

  // Category identity
  name        String
  slug        String
  description String?
  imageUrl    String?

  // Hierarchy
  parentId String?
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryHierarchy")

  // Ordering
  sortOrder Int @default(0)

  // Status
  isActive Boolean @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([parentId])
}

// ============================================================================
// PRODUCT
// Master product catalog - single source of truth
// ============================================================================
enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ProductType {
  PHYSICAL // Tangible goods
  DIGITAL // Digital downloads
  SERVICE // Services
  BUNDLE // Product bundles
}

model Product {
  id       String @id @default(uuid())
  tenantId String

  // Product identity
  name             String
  slug             String
  sku              String? // Stock keeping unit
  barcode          String? // UPC/EAN
  description      String? @db.Text
  shortDescription String?

  // Categorization
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags       String[]         @default([])

  // Type
  type ProductType @default(PHYSICAL)

  // Pricing (base price, variants may override)
  price          Decimal  @db.Decimal(12, 2)
  compareAtPrice Decimal? @db.Decimal(12, 2) // Original/strikethrough price
  costPrice      Decimal? @db.Decimal(12, 2) // Cost for margin calculation

  // Tax
  taxable       Boolean @default(true)
  taxCategoryId String? // Reference to tax category

  // Physical attributes
  weight        Decimal? @db.Decimal(10, 4) // In kg
  weightUnit    String?  @default("kg")
  length        Decimal? @db.Decimal(10, 2)
  width         Decimal? @db.Decimal(10, 2)
  height        Decimal? @db.Decimal(10, 2)
  dimensionUnit String?  @default("cm")

  // Inventory tracking
  trackInventory Boolean @default(true)
  allowBackorder Boolean @default(false)

  // Media
  images Json? // [{ url, alt, position }]

  // SEO
  metaTitle       String?
  metaDescription String?

  // Status
  status      ProductStatus @default(DRAFT)
  publishedAt DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants        ProductVariant[]
  inventoryLevels InventoryLevel[]

  @@unique([tenantId, slug])
  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([categoryId])
  @@index([status])
  @@index([barcode])
}

// ============================================================================
// PRODUCT VARIANT
// Variations of a product (size, color, etc.)
// ============================================================================
model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Variant identity
  name    String // "Red / Large"
  sku     String?
  barcode String?

  // Options (JSON for flexibility)
  options Json? // { "color": "Red", "size": "Large" }

  // Pricing (overrides product price)
  price          Decimal? @db.Decimal(12, 2)
  compareAtPrice Decimal? @db.Decimal(12, 2)
  costPrice      Decimal? @db.Decimal(12, 2)

  // Physical attributes (overrides product)
  weight Decimal? @db.Decimal(10, 4)

  // Media
  imageUrl String?

  // Status
  isActive Boolean @default(true)

  // Ordering
  position Int @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inventoryLevels InventoryLevel[]

  @@index([productId])
  @@index([sku])
  @@index([barcode])
}

// ============================================================================
// INVENTORY LEVEL
// Single source of truth for stock levels per location
// ============================================================================
model InventoryLevel {
  id       String @id @default(uuid())
  tenantId String

  // Product reference (either product or variant)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // Location
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // Stock quantities
  quantityOnHand    Int @default(0) // Physical stock
  quantityReserved  Int @default(0) // Reserved for orders
  quantityAvailable Int @default(0) // On hand - reserved (computed)
  quantityIncoming  Int @default(0) // Expected from suppliers

  // Reorder settings
  reorderPoint    Int? // Alert when below this
  reorderQuantity Int? // Suggested reorder amount

  // Bin/shelf location
  binLocation String?

  // Audit
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastCountedAt DateTime? // Last physical count

  @@unique([productId, variantId, locationId])
  @@index([tenantId])
  @@index([productId])
  @@index([locationId])
  @@index([quantityAvailable])
}

// ============================================================================
// CUSTOMER
// Unified customer data across all modules
// ============================================================================
enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

model Customer {
  id       String @id @default(uuid())
  tenantId String

  // Identity
  email String?
  phone String?

  // Name
  firstName String?
  lastName  String?
  fullName  String? // Computed or provided

  // Company (B2B)
  company String?
  taxId   String?

  // Default address ID
  defaultAddressId String?

  // Status
  status CustomerStatus @default(ACTIVE)

  // Marketing
  acceptsMarketing Boolean   @default(false)
  marketingOptInAt DateTime?

  // Notes
  notes String?  @db.Text
  tags  String[] @default([])

  // Metrics (denormalized for performance)
  totalOrders       Int       @default(0)
  totalSpent        Decimal   @default(0) @db.Decimal(12, 2)
  averageOrderValue Decimal?  @db.Decimal(12, 2)
  lastOrderAt       DateTime?

  // Loyalty
  loyaltyPoints Int     @default(0)
  loyaltyTier   String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  addresses CustomerAddress[]
  wallets   Wallet[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([phone])
  @@index([status])
}

// ============================================================================
// CUSTOMER ADDRESS
// Customer shipping/billing addresses
// ============================================================================
enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

model CustomerAddress {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Address type
  type AddressType @default(BOTH)

  // Contact
  firstName String?
  lastName  String?
  company   String?
  phone     String?

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String

  // Flags
  isDefault Boolean @default(false)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

// ============================================================================
// STAFF MEMBER
// Employees/staff working for the tenant
// ============================================================================
enum StaffStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

model StaffMember {
  id       String @id @default(uuid())
  tenantId String

  // Link to User (optional - staff may not have login)
  userId String? // If staff has system access

  // Identity
  email     String
  firstName String
  lastName  String
  phone     String?

  // Employment
  employeeId String? // Internal employee number
  department String?
  jobTitle   String?
  hireDate   DateTime?

  // Assignment
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  // Status
  status StaffStatus @default(ACTIVE)

  // Permissions (module-specific permissions handled by modules)
  permissions String[] @default([])

  // PIN for POS login (hashed)
  pinHash String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
  @@unique([tenantId, employeeId])
  @@index([tenantId])
  @@index([locationId])
  @@index([status])
}

// ============================================================================
// SUPPLIER
// Vendors/suppliers for inventory procurement
// ============================================================================
enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model Supplier {
  id       String @id @default(uuid())
  tenantId String

  // Identity
  name String
  code String? // Supplier code

  // Contact
  email   String?
  phone   String?
  website String?

  // Primary contact person
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Payment terms
  paymentTerms String? // "NET30", "NET60", etc.
  currency     String  @default("USD")

  // Status
  status SupplierStatus @default(ACTIVE)

  // Notes
  notes String? @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
}

// ============================================================================
// WALLET / BALANCE
// Customer store credit, gift card balances, loyalty points
// ============================================================================
enum WalletType {
  STORE_CREDIT // Store credit balance
  GIFT_CARD // Gift card
  LOYALTY_POINTS // Loyalty points (value conversion needed)
  PREPAID // Prepaid balance
}

enum WalletStatus {
  ACTIVE
  FROZEN // Cannot be used
  EXPIRED
}

model Wallet {
  id       String @id @default(uuid())
  tenantId String

  // Owner (customer or anonymous for gift cards)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Wallet identity
  type WalletType
  code String? // Gift card code, etc.

  // Balance
  balance  Decimal @default(0) @db.Decimal(12, 2)
  currency String  @default("USD")

  // For gift cards
  initialValue Decimal? @db.Decimal(12, 2)

  // Status
  status WalletStatus @default(ACTIVE)

  // Expiry
  expiresAt DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transactions WalletTransaction[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([customerId])
  @@index([type])
  @@index([status])
}

// ============================================================================
// WALLET TRANSACTION
// Immutable ledger of wallet balance changes
// ============================================================================
enum WalletTransactionType {
  CREDIT // Add to balance
  DEBIT // Subtract from balance
  ADJUSTMENT // Manual adjustment
  EXPIRY // Balance expired
}

model WalletTransaction {
  id       String @id @default(uuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Transaction details
  type         WalletTransactionType
  amount       Decimal               @db.Decimal(12, 2)
  balanceAfter Decimal               @db.Decimal(12, 2)

  // Reference to source (module event)
  sourceModule String? // "POS", "SVM", etc.
  sourceType   String? // "SALE", "ORDER", "REFUND"
  sourceId     String? // Sale/Order ID

  // Description
  description String?

  // Idempotency
  idempotencyKey String? @unique

  // Audit
  createdAt DateTime @default(now())
  createdBy String? // User/System ID

  @@index([walletId])
  @@index([sourceModule, sourceId])
  @@index([createdAt])
}

// ============================================================================
// TAX RULE
// Tax configuration per jurisdiction
// ============================================================================
model TaxRule {
  id       String @id @default(uuid())
  tenantId String

  // Rule identity
  name String // "US Sales Tax", "UK VAT"
  code String? // Internal code

  // Jurisdiction
  country    String
  state      String? // State/Province
  postalCode String? // Postal code pattern
  city       String?

  // Rate
  rate       Decimal @db.Decimal(6, 4) // e.g., 0.0825 for 8.25%
  isCompound Boolean @default(false) // Apply on top of other taxes

  // Priority (for compound taxes)
  priority Int @default(0)

  // Applicability
  appliesToShipping Boolean @default(false)

  // Status
  isActive Boolean @default(true)

  // Effective dates
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rates TaxRate[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([country, state])
  @@index([isActive])
}

// ============================================================================
// TAX RATE
// Product category-specific tax rates
// ============================================================================
model TaxRate {
  id        String  @id @default(uuid())
  taxRuleId String
  taxRule   TaxRule @relation(fields: [taxRuleId], references: [id], onDelete: Cascade)

  // Category this rate applies to
  taxCategoryId String? // Product tax category

  // Override rate (null = use parent rule rate)
  rate Decimal? @db.Decimal(6, 4)

  // Special handling
  isExempt Boolean @default(false) // Zero rate

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taxRuleId])
  @@index([taxCategoryId])
}

// ============================================================================
// PRICING RULE
// Dynamic pricing rules (discounts, markups, time-based pricing)
// ============================================================================
enum PricingRuleType {
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
  PERCENTAGE_MARKUP
  FIXED_MARKUP
  FIXED_PRICE
}

enum PricingRuleScope {
  ALL_PRODUCTS
  CATEGORY
  PRODUCT
  VARIANT
  CUSTOMER_GROUP
}

model PricingRule {
  id       String @id @default(uuid())
  tenantId String

  // Rule identity
  name        String
  description String?

  // Type and value
  type  PricingRuleType
  value Decimal         @db.Decimal(12, 4) // Percentage or amount

  // Scope
  scope    PricingRuleScope @default(ALL_PRODUCTS)
  scopeIds String[]         @default([]) // Category/Product/Customer IDs

  // Conditions
  minQuantity   Int? // Minimum quantity for rule to apply
  minOrderValue Decimal? @db.Decimal(12, 2)

  // Validity
  startsAt DateTime?
  endsAt   DateTime?

  // Priority (higher = applied first)
  priority Int @default(0)

  // Status
  isActive Boolean @default(true)

  // Stacking
  isStackable Boolean @default(false)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope])
  @@index([isActive])
  @@index([startsAt, endsAt])
}

// ============================================================================
// NOTIFICATION
// System notifications to users
// ============================================================================
enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

model Notification {
  id       String  @id @default(uuid())
  tenantId String? // Null for system-wide notifications

  // Recipient
  userId         String? // Specific user
  recipientEmail String? // Or email for non-users
  recipientPhone String? // For SMS

  // Channel
  channel NotificationChannel

  // Content
  title     String?
  body      String  @db.Text
  actionUrl String? // Click-through URL

  // Template reference
  templateId   String?
  templateData Json? // Template variables

  // Status
  status NotificationStatus @default(PENDING)

  // Timestamps
  scheduledAt   DateTime?
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  failureReason String?

  // Source (what triggered this)
  sourceModule String? // "POS", "SVM", "CORE"
  sourceEvent  String? // Event type
  sourceId     String? // Entity ID

  // Audit
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([channel])
  @@index([createdAt])
}

// ============================================================================
// NOTIFICATION PREFERENCE
// User preferences for notification channels
// ============================================================================
model NotificationPreference {
  id       String  @id @default(uuid())
  userId   String
  tenantId String? // Null = global preference

  // Category
  category String // "ORDER_UPDATES", "MARKETING", etc.

  // Channel preferences
  email Boolean @default(true)
  sms   Boolean @default(false)
  push  Boolean @default(true)
  inApp Boolean @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId, category])
  @@index([userId])
}

// ============================================================================
// SVM CART
// Persistent shopping cart for SVM module
// ============================================================================
enum SvmCartStatus {
  ACTIVE // Currently being used
  CONVERTED // Converted to order
  ABANDONED // Abandoned (can be recovered)
  EXPIRED // Past expiry
}

model SvmCart {
  id       String @id @default(cuid())
  tenantId String

  // Owner - either customer or session-based
  customerId String? // Core Customer reference
  sessionId  String? // Anonymous session ID
  email      String? // Guest email (for recovery)

  // Status
  status    SvmCartStatus @default(ACTIVE)
  expiresAt DateTime?

  // Totals (denormalized for performance)
  itemCount     Int     @default(0)
  subtotal      Decimal @default(0) @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  shippingTotal Decimal @default(0) @db.Decimal(12, 2)
  taxTotal      Decimal @default(0) @db.Decimal(12, 2)
  grandTotal    Decimal @default(0) @db.Decimal(12, 2)

  // Applied promotion
  promotionCode String?
  promotionId   String?

  // Shipping (selected shipping option)
  shippingZoneId String?
  shippingRateId String?
  shippingMethod String?

  // Currency
  currency String @default("USD")

  // Shipping address (stored as JSON for flexibility)
  shippingAddress Json?

  // Conversion tracking
  convertedToOrderId String?
  convertedAt        DateTime?

  // Recovery
  recoveryEmailSentAt DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items SvmCartItem[]

  @@unique([tenantId, sessionId])
  @@index([tenantId])
  @@index([customerId])
  @@index([sessionId])
  @@index([status])
  @@index([email])
  @@map("svm_carts")
}

// ============================================================================
// SVM CART ITEM
// Items in a shopping cart
// ============================================================================
model SvmCartItem {
  id     String  @id @default(cuid())
  cartId String
  cart   SvmCart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  // Product reference (Core Product)
  productId String
  variantId String?

  // Snapshot at time of adding (in case product changes)
  productName String
  variantName String?
  sku         String?
  imageUrl    String?

  // Pricing
  unitPrice Decimal @db.Decimal(12, 2)
  quantity  Int     @default(1)
  lineTotal Decimal @db.Decimal(12, 2)

  // Item-level discount
  discountAmount Decimal @default(0) @db.Decimal(12, 2)

  // Metadata
  customizations Json? // Gift wrapping, notes, etc.

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@map("svm_cart_items")
}

// ============================================================================
// SVM ORDER
// Persistent order for SVM module
// ============================================================================
enum SvmOrderStatus {
  PENDING // Just created, awaiting payment
  CONFIRMED // Payment received
  PROCESSING // Being prepared
  SHIPPED // Shipped to customer
  DELIVERED // Delivered
  CANCELLED // Cancelled
  REFUNDED // Fully refunded
  PARTIALLY_REFUNDED
}

enum SvmPaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SvmFulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  CANCELLED
}

model SvmOrder {
  id       String @id @default(cuid())
  tenantId String

  // Order number (human readable)
  orderNumber String @unique

  // Customer
  customerId    String? // Core Customer reference (null for guest)
  customerEmail String
  customerPhone String?
  customerName  String?

  // Status
  status            SvmOrderStatus       @default(PENDING)
  paymentStatus     SvmPaymentStatus     @default(PENDING)
  fulfillmentStatus SvmFulfillmentStatus @default(UNFULFILLED)

  // Source
  sourceCartId String? // Cart this order came from
  channel      String  @default("WEB") // WEB, MOBILE, API

  // Addresses (stored as JSON)
  shippingAddress Json
  billingAddress  Json?

  // Shipping
  shippingMethod    String?
  shippingCarrier   String?
  shippingTotal     Decimal   @db.Decimal(12, 2)
  trackingNumber    String?
  trackingUrl       String?
  shippedAt         DateTime?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?

  // Pricing
  currency      String  @default("USD")
  subtotal      Decimal @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  taxTotal      Decimal @db.Decimal(12, 2)
  grandTotal    Decimal @db.Decimal(12, 2)

  // Applied promotion
  promotionCode String?
  promotionId   String?

  // Payment
  paymentMethod String?
  paymentRef    String? // External payment reference
  paidAt        DateTime?

  // Refunds
  refundedAmount Decimal   @default(0) @db.Decimal(12, 2)
  refundedAt     DateTime?
  refundReason   String?

  // Notes
  customerNotes String? @db.Text
  internalNotes String? @db.Text

  // IP and User Agent (for fraud detection)
  ipAddress String?
  userAgent String?

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?

  // Relations
  items SvmOrderItem[]

  @@index([tenantId])
  @@index([customerId])
  @@index([customerEmail])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("svm_orders")
}

// ============================================================================
// SVM ORDER ITEM
// Line items in an order
// ============================================================================
model SvmOrderItem {
  id      String   @id @default(cuid())
  orderId String
  order   SvmOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Product reference (Core Product)
  productId String
  variantId String?

  // Snapshot at time of purchase
  productName String
  variantName String?
  sku         String?
  imageUrl    String?

  // Pricing
  unitPrice      Decimal @db.Decimal(12, 2)
  quantity       Int
  discountAmount Decimal @default(0) @db.Decimal(12, 2)
  taxAmount      Decimal @default(0) @db.Decimal(12, 2)
  lineTotal      Decimal @db.Decimal(12, 2)

  // Fulfillment
  fulfilledQuantity Int @default(0)
  refundedQuantity  Int @default(0)

  // Metadata
  customizations Json?

  // Audit
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("svm_order_items")
}

// ============================================================================
// SVM SHIPPING ZONE
// Shipping zone configuration for SVM module
// ============================================================================
model SvmShippingZone {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?

  // Zone definition
  countries   String[] // ISO country codes
  states      String[] // State/province codes (optional)
  postalCodes String[] // Specific postal codes (optional)
  cities      String[] // Cities (optional)

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)
  priority  Int     @default(0) // Higher = checked first

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates SvmShippingRate[]

  @@index([tenantId])
  @@map("svm_shipping_zones")
}

// ============================================================================
// SVM SHIPPING RATE
// Shipping rates within a zone
// ============================================================================
enum SvmShippingRateType {
  FLAT // Fixed rate
  WEIGHT_BASED // Based on total weight
  PRICE_BASED // Based on order total
  ITEM_BASED // Based on item count
}

model SvmShippingRate {
  id     String          @id @default(cuid())
  zoneId String
  zone   SvmShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  name        String // "Standard", "Express", "Overnight"
  description String?
  carrier     String? // "USPS", "FedEx", "UPS"

  // Rate calculation
  rateType SvmShippingRateType @default(FLAT)
  flatRate Decimal?            @db.Decimal(10, 2)

  // Weight-based
  minWeight     Decimal? @db.Decimal(10, 2)
  maxWeight     Decimal? @db.Decimal(10, 2)
  weightRate    Decimal? @db.Decimal(10, 4) // per unit
  baseWeightFee Decimal? @db.Decimal(10, 2)

  // Price-based
  minOrderTotal  Decimal? @db.Decimal(10, 2)
  maxOrderTotal  Decimal? @db.Decimal(10, 2)
  percentageRate Decimal? @db.Decimal(5, 4)

  // Item-based
  perItemRate Decimal? @db.Decimal(10, 2)

  // Product restrictions
  allowedProductIds   String[]
  excludedProductIds  String[]
  allowedCategoryIds  String[]
  excludedCategoryIds String[]

  // Free shipping threshold
  freeAbove Decimal? @db.Decimal(10, 2)

  // Delivery estimate
  minDays Int?
  maxDays Int?

  isActive Boolean @default(true)
  priority Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([zoneId])
  @@map("svm_shipping_rates")
}

// ============================================================================
// SVM PROMOTION
// Discount codes and automatic promotions
// ============================================================================
enum SvmPromotionType {
  COUPON // Requires code entry
  AUTOMATIC // Applied automatically
  FLASH_SALE // Time-limited
}

enum SvmDiscountType {
  PERCENTAGE // % off
  FIXED_AMOUNT // $ off order
  FIXED_PER_ITEM // $ off each item
  FREE_SHIPPING // Free shipping
  BUY_X_GET_Y // BOGO style
}

model SvmPromotion {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?
  code        String? // Nullable for automatic promotions

  // Type
  type         SvmPromotionType @default(COUPON)
  discountType SvmDiscountType

  // Value
  discountValue Decimal  @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2) // Cap for percentage

  // Conditions
  minOrderTotal Decimal? @db.Decimal(10, 2)
  minQuantity   Int?

  // Product restrictions (empty = all products)
  productIds        String[] // Specific products
  categoryIds       String[] // Product categories
  excludeProductIds String[] // Excluded products

  // Customer restrictions
  customerIds    String[] // Specific customers only
  firstOrderOnly Boolean  @default(false)

  // Usage limits
  usageLimit       Int? // Total uses allowed
  usageCount       Int  @default(0)
  perCustomerLimit Int? // Uses per customer

  // BUY_X_GET_Y specific
  buyQuantity        Int?
  getQuantity        Int?
  getDiscountPercent Int? // 100 = free

  // Validity
  startsAt DateTime  @default(now())
  endsAt   DateTime?
  isActive Boolean   @default(true)

  // Stacking
  stackable Boolean @default(false)
  priority  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usages SvmPromotionUsage[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([isActive, startsAt, endsAt])
  @@map("svm_promotions")
}

// ============================================================================
// SVM PROMOTION USAGE
// Tracks promotion usage per order
// ============================================================================
model SvmPromotionUsage {
  id          String       @id @default(cuid())
  promotionId String
  promotion   SvmPromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  orderId    String
  customerId String? // Core reference

  discountApplied Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([promotionId])
  @@index([customerId])
  @@map("svm_promotion_usages")
}

// ============================================================================
// ============================================================================
// COMMERCE WALLET SYSTEM (Phase B2)
// Ledger-based wallets for Customer, Vendor, and Platform
// ============================================================================
// ============================================================================

// ============================================================================
// COMMERCE WALLET TYPE
// Different wallet owners in the commerce system
// ============================================================================
enum CommerceWalletType {
  CUSTOMER // Customer wallet for refunds, store credit
  VENDOR // Vendor wallet for earnings from MVM sales
  PLATFORM // Platform wallet for fees and commissions
}

// ============================================================================
// COMMERCE WALLET STATUS
// Wallet lifecycle status
// ============================================================================
enum CommerceWalletStatus {
  ACTIVE // Normal operation
  FROZEN // Temporarily frozen (disputes, fraud)
  SUSPENDED // Long-term suspension
  CLOSED // Permanently closed
}

// ============================================================================
// COMMERCE WALLET
// Holds balance for customers, vendors, or platform
// ============================================================================
model CommerceWallet {
  id       String @id @default(cuid())
  tenantId String

  // Wallet type
  type CommerceWalletType

  // Owner reference (mutually exclusive based on type)
  customerId String? // For CUSTOMER type
  vendorId   String? // For VENDOR type (MVM vendor ID)
  // PLATFORM type has no owner - one per tenant

  // Balance (calculated from ledger, cached here for performance)
  balance          Decimal @default(0) @db.Decimal(12, 2)
  pendingBalance   Decimal @default(0) @db.Decimal(12, 2) // Holds, pending clearance
  availableBalance Decimal @default(0) @db.Decimal(12, 2) // balance - pendingBalance
  currency         String  @default("USD")

  // Status
  status CommerceWalletStatus @default(ACTIVE)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ledgerEntries CommerceWalletLedger[]

  @@unique([tenantId, type, customerId, vendorId]) // One wallet per owner per type
  @@index([tenantId])
  @@index([type])
  @@index([customerId])
  @@index([vendorId])
  @@index([status])
  @@map("commerce_wallets")
}

// ============================================================================
// COMMERCE WALLET LEDGER ENTRY TYPE
// Types of ledger entries
// ============================================================================
enum LedgerEntryType {
  // Credits (increase balance)
  CREDIT_ORDER_PAYMENT // Customer paid for order
  CREDIT_REFUND // Refund credited to customer
  CREDIT_SALE_PROCEEDS // Vendor earned from sale
  CREDIT_PLATFORM_FEE // Platform earned fee
  CREDIT_ADJUSTMENT // Manual credit adjustment
  CREDIT_TRANSFER_IN // Transfer from another wallet
  CREDIT_PAYOUT_REVERSAL // Payout failed/reversed

  // Debits (decrease balance)
  DEBIT_ORDER_PAYMENT // Payment deducted (for platform flow)
  DEBIT_VENDOR_COMMISSION // Commission deducted from vendor
  DEBIT_PLATFORM_FEE // Fee paid to platform
  DEBIT_PAYOUT // Payout to external account
  DEBIT_ADJUSTMENT // Manual debit adjustment
  DEBIT_TRANSFER_OUT // Transfer to another wallet
  DEBIT_CHARGEBACK // Chargeback deduction

  // Holds
  HOLD_CREATED // Funds put on hold
  HOLD_RELEASED // Hold released back to available
  HOLD_CAPTURED // Hold converted to actual debit
}

// ============================================================================
// COMMERCE WALLET LEDGER STATUS
// Status of individual ledger entries
// ============================================================================
enum LedgerEntryStatus {
  PENDING // Entry created, awaiting processing
  COMPLETED // Entry processed successfully
  FAILED // Entry failed
  REVERSED // Entry was reversed
}

// ============================================================================
// COMMERCE WALLET LEDGER
// IMMUTABLE, APPEND-ONLY ledger of all wallet transactions
// This is the source of truth - wallet.balance is just a cache
// ============================================================================
model CommerceWalletLedger {
  id       String         @id @default(cuid())
  walletId String
  wallet   CommerceWallet @relation(fields: [walletId], references: [id], onDelete: Restrict)

  // Entry type and status
  entryType LedgerEntryType
  status    LedgerEntryStatus @default(COMPLETED)

  // Amount (positive for credits, negative for debits)
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD")

  // Balance snapshot AFTER this entry (for audit trail)
  balanceAfter          Decimal @db.Decimal(12, 2)
  pendingBalanceAfter   Decimal @default(0) @db.Decimal(12, 2)
  availableBalanceAfter Decimal @db.Decimal(12, 2)

  // Reference to source transaction
  referenceType String? // "ORDER", "REFUND", "PAYOUT", "TRANSFER", "ADJUSTMENT"
  referenceId   String? // Order ID, Payout ID, etc.

  // For transfers between wallets
  counterpartyWalletId String?

  // For holds
  holdId String? // Links HOLD_CREATED with HOLD_RELEASED/HOLD_CAPTURED

  // Idempotency key (prevents duplicate entries)
  idempotencyKey String @unique

  // Description
  description String?

  // Metadata for additional context
  metadata Json?

  // Audit (IMMUTABLE - no updatedAt)
  createdAt DateTime @default(now())
  createdBy String? // User or system that created this entry

  @@index([walletId])
  @@index([entryType])
  @@index([status])
  @@index([referenceType, referenceId])
  @@index([holdId])
  @@index([createdAt])
  @@map("commerce_wallet_ledger")
}

// ============================================================================
// COMMERCE PAYOUT
// Track payouts from vendor/platform wallets to external accounts
// ============================================================================
enum PayoutStatus {
  PENDING // Created, awaiting processing
  PROCESSING // Being processed
  COMPLETED // Successfully paid out
  FAILED // Payout failed
  CANCELLED // Cancelled before processing
}

model CommercePayout {
  id       String @id @default(cuid())
  tenantId String

  // Source wallet
  walletId   String
  walletType CommerceWalletType

  // Payout details
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD")

  // Fees
  processingFee Decimal @default(0) @db.Decimal(12, 2)
  netAmount     Decimal @db.Decimal(12, 2) // amount - processingFee

  // Status
  status PayoutStatus @default(PENDING)

  // External payment reference
  paymentMethod  String? // "BANK_TRANSFER", "PAYPAL", etc.
  paymentDetails Json? // Masked account details
  externalRef    String? // External payment provider reference

  // Processing timestamps
  processedAt DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  // Failure details
  failureReason String?
  failureCode   String?

  // Admin who triggered payout
  triggeredBy String?

  // Linked ledger entry
  ledgerEntryId String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([walletId])
  @@index([status])
  @@index([createdAt])
  @@map("commerce_payouts")
}

// ============================================================================
// ============================================================================
// SAAS CORE: CAPABILITY FRAMEWORK (PHASE 0.5)
// ============================================================================
// ============================================================================
//
// Industry-agnostic capability activation system.
// Supports multiple domains: commerce, education, hospitality, healthcare, etc.
//
// DESIGN PRINCIPLES:
// - Capabilities are NOT features, they are discrete functional units
// - Activation is SEPARATE from entitlements
// - Runtime access = entitlement AND activation must both be true
// - NO capability is auto-active by default
// - Future non-commerce modules can register cleanly
//
// ============================================================================

// Capability activation status
enum CapabilityStatus {
  ACTIVE // Capability is enabled and operational
  INACTIVE // Capability is disabled (default state)
  SUSPENDED // Temporarily disabled (e.g., compliance, abuse)
}

// Who activated the capability
enum CapabilityActivator {
  SELF // Tenant self-activated
  ADMIN // Super admin activated
  SYSTEM // System auto-activated (e.g., migration)
}

// ============================================================================
// CAPABILITY
// Registry of all available capabilities (modules) in the system
// This is CORE-OWNED, not module-specific
// ============================================================================
model Capability {
  id String @id @default(uuid())

  // Unique key used in code (e.g., "pos", "inventory", "school_attendance")
  key String @unique

  // Human-readable name
  displayName String

  // Domain/vertical this capability belongs to
  // e.g., "commerce", "education", "hospitality", "healthcare", "core"
  domain String

  // Description of what this capability provides
  description String?

  // Dependencies on other capabilities (by key)
  // e.g., ["pos"] means this capability requires POS to be active
  dependencies String[] @default([])

  // Is this a core capability that cannot be deactivated?
  // e.g., "tenant_management", "user_management"
  isCore Boolean @default(false)

  // Is this capability available for activation?
  // Set to false to hide from UI (deprecated, beta, etc.)
  isAvailable Boolean @default(true)

  // Ordering for UI display within a domain
  sortOrder Int @default(0)

  // Optional icon identifier for UI
  icon String?

  // Optional metadata (version, release notes, etc.)
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activations TenantCapabilityActivation[]

  @@index([domain])
  @@index([isAvailable])
  @@index([isCore])
  @@map("core_capabilities")
}

// ============================================================================
// TENANT CAPABILITY ACTIVATION
// Per-tenant activation status for each capability
// This is the runtime switch that determines if a tenant can use a capability
// ============================================================================
model TenantCapabilityActivation {
  id String @id @default(uuid())

  // Tenant reference
  tenantId String

  // Capability reference (by key for easier querying)
  capabilityKey String

  // Current status
  status CapabilityStatus @default(INACTIVE)

  // Activation metadata
  activatedAt   DateTime?
  deactivatedAt DateTime?
  suspendedAt   DateTime?

  // Who activated this capability
  activatedBy CapabilityActivator?

  // User who performed the activation (for audit)
  activatedByUserId String?

  // Reason for suspension (if suspended)
  suspensionReason String?

  // Optional configuration overrides for this tenant
  // e.g., custom limits, feature flags
  configuration Json?

  // Audit trail
  auditLog Json? // Array of { action, userId, timestamp, reason }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  capability Capability @relation(fields: [capabilityKey], references: [key], onDelete: Cascade)

  // A tenant can only have one activation record per capability
  @@unique([tenantId, capabilityKey])
  @@index([tenantId])
  @@index([capabilityKey])
  @@index([status])
  @@map("core_tenant_capability_activations")
}

// ============================================================================
// CAPABILITY EVENT LOG
// Immutable audit log for capability activation events
// ============================================================================
model CapabilityEventLog {
  id String @id @default(uuid())

  // Event type
  eventType String // ACTIVATED, DEACTIVATED, SUSPENDED, CONFIGURATION_CHANGED

  // References
  tenantId      String
  capabilityKey String

  // Who triggered the event
  triggeredBy CapabilityActivator
  userId      String?

  // Event details
  previousStatus String?
  newStatus      String?
  reason         String?
  metadata       Json?

  // Timestamp (immutable)
  timestamp DateTime @default(now())

  @@index([tenantId])
  @@index([capabilityKey])
  @@index([eventType])
  @@index([timestamp])
  @@map("core_capability_event_logs")
}

// ============================================================================
// ============================================================================
// MODULE 1: INVENTORY & WAREHOUSE MANAGEMENT
// ============================================================================
// ============================================================================
//
// This module is INDEPENDENTLY SUBSCRIBABLE and provides:
// - Advanced inventory workflows
// - Warehouse & stock movement logic
// - Reordering intelligence
// - Inventory audits
//
// OWNERSHIP RULES:
// - This module OWNS: Warehouse, StockMovement, StockTransfer, ReorderRule,
//   InventoryAudit, SupplierReplenishmentRule
// - This module USES from Core (by ID only): Product, InventoryLevel, 
//   Location, Supplier
// - Core InventoryLevel remains the SINGLE SOURCE OF TRUTH for quantities
// - All inventory changes emit events for Core to process
//
// ============================================================================

// ============================================================================
// ENUMS - MODULE 1
// ============================================================================

// Stock movement reason - why inventory changed
enum StockMovementReason {
  PURCHASE_ORDER // Received from supplier
  SALE // Sold to customer
  RETURN_FROM_CUSTOMER // Customer returned item
  RETURN_TO_SUPPLIER // Returned to supplier
  TRANSFER_IN // Received from another warehouse
  TRANSFER_OUT // Sent to another warehouse
  ADJUSTMENT_POSITIVE // Manual increase (found stock)
  ADJUSTMENT_NEGATIVE // Manual decrease (damaged, lost)
  AUDIT_CORRECTION // Correction after physical count
  INITIAL_STOCK // Initial inventory setup
  EXPIRED // Stock expired
  DAMAGED // Stock damaged
  THEFT // Stock stolen
  WRITE_OFF // Written off
}

// Stock transfer status - state machine for transfers
enum StockTransferStatus {
  DRAFT // Being prepared
  PENDING_APPROVAL // Awaiting approval
  APPROVED // Approved, ready to ship
  IN_TRANSIT // Shipped, not yet received
  PARTIALLY_RECEIVED // Some items received
  COMPLETED // Fully received
  CANCELLED // Transfer cancelled
  REJECTED // Approval rejected
}

// Inventory audit status - state machine for audits
enum InventoryAuditStatus {
  DRAFT // Being prepared
  IN_PROGRESS // Counting in progress
  PENDING_REVIEW // Counting complete, awaiting review
  APPROVED // Variances approved
  ADJUSTMENTS_PENDING // Adjustments submitted to Core
  COMPLETED // All adjustments applied
  CANCELLED // Audit cancelled
}

// Reorder rule trigger type
enum ReorderTriggerType {
  BELOW_THRESHOLD // When stock falls below reorder point
  VELOCITY_BASED // Based on sales velocity prediction
  SCHEDULED // On a schedule (weekly, monthly)
  MANUAL // Manual trigger only
}

// Reorder suggestion status
enum ReorderSuggestionStatus {
  PENDING // Awaiting review
  APPROVED // Approved for ordering
  REJECTED // Rejected by user
  CONVERTED // Converted to purchase order (future)
  EXPIRED // Expired without action
}

// ============================================================================
// WAREHOUSE
// Extended warehouse metadata beyond Core Location
// Core Location defines basic location data; this adds warehouse-specific logic
// ============================================================================
model Warehouse {
  id       String @id @default(uuid())
  tenantId String

  // Link to Core Location (this warehouse IS a location)
  locationId String @unique

  // Warehouse identity
  name        String // Display name (may differ from Location.name)
  code        String // Warehouse code: "WH-001", "WH-LAGOS-01"
  description String?

  // Warehouse type
  warehouseType String @default("GENERAL") // GENERAL, COLD_STORAGE, BONDED, DISTRIBUTION

  // Capacity
  totalCapacity Int? // Total storage units
  usedCapacity  Int? // Currently used units
  capacityUnit  String? // "PALLETS", "SQFT", "CUBIC_METERS"

  // Priority for fulfillment (higher = preferred)
  fulfillmentPriority Int @default(0)

  // Flags
  isActive              Boolean @default(true)
  acceptsTransfersIn    Boolean @default(true)
  acceptsTransfersOut   Boolean @default(true)
  isDefaultForReceiving Boolean @default(false) // Default for new stock

  // Contact for this warehouse
  managerName  String?
  managerPhone String?
  managerEmail String?

  // Operating hours (JSON for flexibility)
  operatingHours Json? // { "mon": { "open": "08:00", "close": "18:00" }, ... }

  // Nigeria-specific
  lgaCode   String? // Local Government Area code
  stateCode String? // State code (e.g., "LA" for Lagos)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transfersFrom      StockTransfer[]             @relation("TransferFromWarehouse")
  transfersTo        StockTransfer[]             @relation("TransferToWarehouse")
  audits             InventoryAudit[]
  replenishmentRules SupplierReplenishmentRule[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([locationId])
  @@index([isActive])
  @@index([warehouseType])
  @@map("inv_warehouses")
}

// ============================================================================
// STOCK MOVEMENT
// Immutable audit trail of all inventory changes
// This is EVENT-DRIVEN - records movements, does NOT mutate Core inventory
// Core listens to events and updates InventoryLevel
// ============================================================================
model StockMovement {
  id       String @id @default(uuid())
  tenantId String

  // Product reference (Core entity IDs only)
  productId String
  variantId String?

  // Location where movement occurred (Core Location ID)
  locationId String

  // Movement details
  reason   StockMovementReason
  quantity Int // Positive for IN, negative for OUT

  // Quantities BEFORE this movement (snapshot for audit)
  quantityBefore Int

  // Unit cost at time of movement (for COGS calculation)
  unitCost Decimal? @db.Decimal(12, 2)
  currency String   @default("NGN")

  // Reference to source document
  referenceType String? // "TRANSFER", "AUDIT", "SALE", "PURCHASE_ORDER"
  referenceId   String? // ID of the source document

  // Batch/lot tracking (for expiry, traceability)
  batchNumber   String?
  lotNumber     String?
  expiryDate    DateTime?
  serialNumbers String[]  @default([]) // For serialized items

  // Bin/shelf location within warehouse
  binLocation String?

  // Notes
  notes String?

  // Event tracking
  eventId        String?   @unique // Idempotency key / event ID
  eventEmittedAt DateTime? // When event was emitted to Core
  eventProcessed Boolean   @default(false) // Has Core processed this?

  // Who performed this movement
  performedBy     String? // User ID
  performedByName String? // Denormalized for display

  // Offline sync tracking
  isOfflineCreated Boolean   @default(false)
  offlineId        String? // Client-generated ID for offline sync
  syncedAt         DateTime? // When synced from offline

  // Audit (IMMUTABLE - no updatedAt)
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([productId])
  @@index([variantId])
  @@index([locationId])
  @@index([reason])
  @@index([referenceType, referenceId])
  @@index([batchNumber])
  @@index([expiryDate])
  @@index([createdAt])
  @@index([eventProcessed])
  @@map("inv_stock_movements")
}

// ============================================================================
// STOCK TRANSFER
// Warehouse-to-warehouse stock transfers with approval workflow
// Emits events; Core applies actual inventory changes
// ============================================================================
model StockTransfer {
  id       String @id @default(uuid())
  tenantId String

  // Transfer number (human-readable)
  transferNumber String @unique

  // Source and destination
  fromWarehouseId String
  fromWarehouse   Warehouse @relation("TransferFromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouseId   String
  toWarehouse     Warehouse @relation("TransferToWarehouse", fields: [toWarehouseId], references: [id])

  // Status
  status StockTransferStatus @default(DRAFT)

  // Dates
  requestedDate   DateTime  @default(now())
  approvedDate    DateTime?
  shippedDate     DateTime?
  expectedArrival DateTime?
  receivedDate    DateTime?

  // Priority
  priority String @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  // Reason for transfer
  reason String? // "Rebalancing", "Stockout prevention", "Consolidation"

  // Shipping details
  shippingMethod String? // "INTERNAL_TRUCK", "COURIER", "PICKUP"
  trackingNumber String?
  carrierName    String?
  shippingCost   Decimal? @db.Decimal(12, 2)
  currency       String   @default("NGN")

  // Notes
  notes         String?
  internalNotes String? // For staff only

  // Approval workflow
  requestedById   String?
  requestedByName String?
  approvedById    String?
  approvedByName  String?
  rejectedById    String?
  rejectedByName  String?
  rejectionReason String?

  // Receiving confirmation
  receivedById   String?
  receivedByName String?
  receivingNotes String?

  // Event tracking
  eventId        String?   @unique
  eventEmittedAt DateTime?

  // Offline support
  isOfflineCreated Boolean   @default(false)
  offlineId        String?
  syncedAt         DateTime?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items StockTransferItem[]

  @@index([tenantId])
  @@index([status])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([requestedDate])
  @@index([priority])
  @@map("inv_stock_transfers")
}

// ============================================================================
// STOCK TRANSFER ITEM
// Line items for a stock transfer
// ============================================================================
model StockTransferItem {
  id         String        @id @default(uuid())
  transferId String
  transfer   StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  // Product reference (Core entity IDs only)
  productId String
  variantId String?

  // Product snapshot (for display, in case product changes)
  productName String
  variantName String?
  sku         String?

  // Quantities
  quantityRequested Int // How many to transfer
  quantityShipped   Int @default(0) // How many actually shipped
  quantityReceived  Int @default(0) // How many received at destination

  // Variance
  varianceQuantity Int? // Difference (received - shipped)
  varianceReason   String? // "DAMAGED", "LOST", "MISCOUNTED"

  // Batch/lot (if tracked)
  batchNumber String?
  lotNumber   String?
  expiryDate  DateTime?

  // Unit cost at time of transfer
  unitCost Decimal? @db.Decimal(12, 2)

  // Bin locations
  fromBinLocation String?
  toBinLocation   String?

  // Notes
  notes String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([transferId, productId, variantId, batchNumber])
  @@index([transferId])
  @@index([productId])
  @@map("inv_stock_transfer_items")
}

// ============================================================================
// REORDER RULE
// Intelligent reordering thresholds and preferences
// Advisory only - does NOT create financial commitments
// ============================================================================
model ReorderRule {
  id       String @id @default(uuid())
  tenantId String

  // Scope - what this rule applies to
  productId  String? // Specific product (null = category/all)
  variantId  String? // Specific variant
  categoryId String? // Product category (Core)
  locationId String? // Specific location (null = all locations)

  // Rule identity
  name        String
  description String?

  // Trigger configuration
  triggerType ReorderTriggerType @default(BELOW_THRESHOLD)

  // Threshold-based settings
  reorderPoint    Int? // Trigger when available <= this
  reorderQuantity Int? // Suggested quantity to order

  // Velocity-based settings (days of stock remaining)
  minDaysOfStock    Int? // Trigger when < this many days of stock
  targetDaysOfStock Int? // Order enough for this many days

  // Velocity calculation period (days to look back for sales)
  velocityPeriodDays Int @default(30)

  // Preferred supplier (Core Supplier ID)
  preferredSupplierId String?

  // Constraints
  minOrderQuantity Int? // Minimum order quantity
  maxOrderQuantity Int? // Maximum order quantity
  orderMultiple    Int? // Order in multiples of this

  // Lead time consideration
  supplierLeadTimeDays Int @default(7) // Expected supplier lead time

  // Cost thresholds
  maxUnitCost Decimal? @db.Decimal(12, 2) // Don't suggest if cost exceeds
  currency    String   @default("NGN")

  // Schedule (for SCHEDULED trigger type)
  scheduleExpression String? // Cron expression or "WEEKLY_MONDAY", etc.

  // Status
  isActive Boolean @default(true)

  // Priority (for conflicting rules)
  priority Int @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  suggestions ReorderSuggestion[]

  @@index([tenantId])
  @@index([productId])
  @@index([categoryId])
  @@index([locationId])
  @@index([isActive])
  @@map("inv_reorder_rules")
}

// ============================================================================
// REORDER SUGGESTION
// Generated suggestions based on reorder rules
// ADVISORY ONLY - no automatic purchasing
// ============================================================================
model ReorderSuggestion {
  id       String @id @default(uuid())
  tenantId String

  // Link to rule that generated this
  ruleId String?
  rule   ReorderRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  // Product reference
  productId String
  variantId String?

  // Product snapshot
  productName String
  variantName String?
  sku         String?

  // Location
  locationId   String
  locationName String

  // Current stock situation (snapshot)
  currentQuantity   Int
  reservedQuantity  Int
  availableQuantity Int

  // Velocity data
  avgDailySales   Decimal? @db.Decimal(10, 2)
  daysOfStockLeft Int?
  velocityTrend   String? // "INCREASING", "STABLE", "DECREASING"

  // Suggestion
  suggestedQuantity     Int
  suggestedSupplierId   String?
  suggestedSupplierName String?
  estimatedUnitCost     Decimal? @db.Decimal(12, 2)
  estimatedTotalCost    Decimal? @db.Decimal(12, 2)
  currency              String   @default("NGN")

  // Priority
  urgency String @default("NORMAL") // LOW, NORMAL, HIGH, CRITICAL

  // Status
  status ReorderSuggestionStatus @default(PENDING)

  // User actions
  reviewedById    String?
  reviewedByName  String?
  reviewedAt      DateTime?
  rejectionReason String?

  // Expiry (suggestions become stale)
  expiresAt DateTime

  // Notes
  notes String?

  // Metadata (calculation details)
  calculationDetails Json? // How suggestion was derived

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([productId])
  @@index([locationId])
  @@index([status])
  @@index([urgency])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("inv_reorder_suggestions")
}

// ============================================================================
// INVENTORY AUDIT
// Periodic stock count workflows with variance detection
// Adjustments emit events for Core to apply
// ============================================================================
model InventoryAudit {
  id       String @id @default(uuid())
  tenantId String

  // Audit number (human-readable)
  auditNumber String @unique

  // Scope
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  // What to audit (null = full warehouse audit)
  categoryIds  String[] @default([]) // Specific categories
  productIds   String[] @default([]) // Specific products
  binLocations String[] @default([]) // Specific bins/aisles

  // Audit type
  auditType String @default("FULL") // FULL, CYCLE, SPOT, ANNUAL

  // Status
  status InventoryAuditStatus @default(DRAFT)

  // Dates
  scheduledDate DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  approvedAt    DateTime?

  // Summary statistics (populated after counting)
  totalItemsCounted  Int      @default(0)
  itemsWithVariance  Int      @default(0)
  totalVarianceValue Decimal? @db.Decimal(12, 2)
  variancePercentage Decimal? @db.Decimal(5, 2)
  currency           String   @default("NGN")

  // Participants
  createdById    String?
  createdByName  String?
  supervisorId   String?
  supervisorName String?
  approvedById   String?
  approvedByName String?

  // Notes
  notes         String?
  internalNotes String?

  // Approval workflow
  requiresApproval       Boolean  @default(true)
  varianceThresholdPct   Decimal? @db.Decimal(5, 2) // Auto-approve if variance below
  varianceThresholdValue Decimal? @db.Decimal(12, 2)

  // Event tracking
  adjustmentEventId String? // Event ID for adjustment batch

  // Offline support
  isOfflineCreated Boolean   @default(false)
  offlineId        String?
  syncedAt         DateTime?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items InventoryAuditItem[]

  @@index([tenantId])
  @@index([warehouseId])
  @@index([status])
  @@index([scheduledDate])
  @@index([auditType])
  @@map("inv_audits")
}

// ============================================================================
// INVENTORY AUDIT ITEM
// Individual product counts within an audit
// ============================================================================
model InventoryAuditItem {
  id      String         @id @default(uuid())
  auditId String
  audit   InventoryAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  // Product reference
  productId String
  variantId String?

  // Product snapshot
  productName String
  variantName String?
  sku         String?

  // Bin location
  binLocation String?

  // Expected vs Actual
  expectedQuantity Int // From Core InventoryLevel at audit start
  countedQuantity  Int? // What was physically counted

  // Variance
  varianceQuantity Int? // counted - expected
  varianceValue    Decimal? @db.Decimal(12, 2) // variance * unit cost
  varianceReason   String? // "DAMAGED", "THEFT", "MISCOUNT", "SYSTEM_ERROR"

  // Unit cost for variance calculation
  unitCost Decimal? @db.Decimal(12, 2)

  // Batch/lot if applicable
  batchNumber String?
  lotNumber   String?

  // Count details
  countedById     String?
  countedByName   String?
  countedAt       DateTime?
  recountRequired Boolean   @default(false)
  recountedAt     DateTime?

  // Approval for this item's adjustment
  adjustmentApproved     Boolean   @default(false)
  adjustmentApprovedById String?
  adjustmentApprovedAt   DateTime?

  // Notes
  notes String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([auditId, productId, variantId, binLocation, batchNumber])
  @@index([auditId])
  @@index([productId])
  @@index([varianceQuantity])
  @@map("inv_audit_items")
}

// ============================================================================
// SUPPLIER REPLENISHMENT RULE
// Supplier-specific rules for ordering and replenishment
// Nigeria-first: supports informal suppliers, WhatsApp ordering (future)
// ============================================================================
model SupplierReplenishmentRule {
  id       String @id @default(uuid())
  tenantId String

  // Supplier reference (Core Supplier ID)
  supplierId String

  // Warehouse this rule applies to (null = all)
  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  // Rule identity
  name        String
  description String?

  // Supplier details snapshot (for display)
  supplierName    String
  supplierContact String?
  supplierPhone   String?
  supplierEmail   String?

  // Ordering preferences
  preferredOrderDays   String[] @default([]) // ["MONDAY", "THURSDAY"]
  minimumOrderValue    Decimal? @db.Decimal(12, 2)
  minimumOrderQuantity Int?
  currency             String   @default("NGN")

  // Lead time
  standardLeadTimeDays Int  @default(7)
  expressLeadTimeDays  Int? // For rush orders

  // Communication preference (Nigeria-first)
  orderMethod String @default("MANUAL") // MANUAL, EMAIL, WHATSAPP, PHONE, API

  // Payment terms
  paymentTerms String? // "CASH_ON_DELIVERY", "NET_30", "PREPAID"
  creditLimit  Decimal? @db.Decimal(12, 2)

  // Product preferences (which products to order from this supplier)
  productIds               String[] @default([]) // Empty = all products supplier provides
  categoryIds              String[] @default([]) // Categories this supplier covers
  isPreferredForCategories Boolean  @default(false)

  // Pricing agreements
  discountPercentage Decimal? @db.Decimal(5, 2)
  volumeDiscounts    Json? // [{ "minQty": 100, "discount": 5 }, ...]

  // Quality/reliability ratings
  reliabilityScore   Int? // 1-100
  qualityScore       Int? // 1-100
  lastDeliveryRating Int? // 1-5 stars

  // Status
  isActive Boolean @default(true)

  // Notes
  notes String?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, supplierId, warehouseId])
  @@index([tenantId])
  @@index([supplierId])
  @@index([warehouseId])
  @@index([isActive])
  @@map("inv_supplier_replenishment_rules")
}

// ============================================================================
// ============================================================================
// MODULE 2: ACCOUNTING & FINANCE
// ============================================================================
// ============================================================================
//
// This module is INDEPENDENTLY SUBSCRIBABLE and provides:
// - Double-entry accounting
// - Chart of Accounts management
// - Journal entries and ledger postings
// - Expense tracking
// - Financial reporting (P&L, Balance Sheet)
// - Tax computation (Nigeria VAT 7.5%)
//
// OWNERSHIP RULES:
// - This module OWNS: ChartOfAccount, LedgerAccount, LedgerEntry, 
//   JournalEntry, JournalLine, FinancialPeriod, ExpenseRecord, TaxSummary
// - This module USES from Core (READ-ONLY via events): Payment, Wallet,
//   WalletTransaction, Order, Customer
// - Wallets remain 100% Core-owned - NO balance mutations here
// - NO money movement or payment execution in this module
// - All financial data is derived from Core events
//
// CONSTRAINTS:
// - Ledger entries are APPEND-ONLY (no updates or deletes)
// - All amounts are currency-aware
// - Double-entry enforced (debits must equal credits)
// - References to Core entities via IDs only
//
// ============================================================================

// Account type for Chart of Accounts
enum AcctAccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
  CONTRA_ASSET
  CONTRA_LIABILITY
  CONTRA_EQUITY
  CONTRA_REVENUE
  CONTRA_EXPENSE
}

// Account sub-type for detailed categorization
enum AcctAccountSubType {
  // Assets
  CASH
  BANK
  ACCOUNTS_RECEIVABLE
  INVENTORY
  PREPAID_EXPENSE
  FIXED_ASSET
  OTHER_ASSET

  // Liabilities
  ACCOUNTS_PAYABLE
  ACCRUED_EXPENSE
  VAT_PAYABLE
  OTHER_TAX_PAYABLE
  SHORT_TERM_DEBT
  LONG_TERM_DEBT
  OTHER_LIABILITY

  // Equity
  OWNER_EQUITY
  RETAINED_EARNINGS
  OWNER_DRAW

  // Revenue
  SALES_REVENUE
  SERVICE_REVENUE
  OTHER_INCOME

  // Expenses
  COST_OF_GOODS
  OPERATING_EXPENSE
  PAYROLL_EXPENSE
  RENT_EXPENSE
  UTILITIES_EXPENSE
  MARKETING_EXPENSE
  OTHER_EXPENSE
}

// Journal entry status
enum AcctJournalStatus {
  DRAFT
  POSTED
  VOIDED
}

// Journal entry source type
enum AcctJournalSourceType {
  MANUAL
  POS_SALE
  SVM_ORDER
  MVM_ORDER
  REFUND
  INVENTORY_ADJUSTMENT
  EXPENSE
  WALLET_TRANSACTION
  SYSTEM
}

// Expense status
enum AcctExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  POSTED
}

// Expense payment method (Nigeria-first: cash-heavy)
enum AcctExpensePaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
  CREDIT
  OTHER
}

// Financial period status
enum AcctPeriodStatus {
  OPEN
  CLOSING
  CLOSED
  LOCKED
}

// ============================================================================
// CHART OF ACCOUNTS
// Configurable account structure for double-entry accounting
// Nigeria-first: Pre-configured for Nigerian SMEs with VAT support
// ============================================================================
model AcctChartOfAccount {
  id       String @id @default(uuid())
  tenantId String

  // Account identity
  code        String // e.g., "1000", "2100", "4000"
  name        String // e.g., "Cash on Hand", "VAT Payable"
  description String?

  // Classification
  accountType    AcctAccountType
  accountSubType AcctAccountSubType?

  // Hierarchy (for sub-accounts)
  parentId String?
  parent   AcctChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children AcctChartOfAccount[] @relation("AccountHierarchy")

  // Account behavior
  normalBalance    String  @default("DEBIT") // DEBIT or CREDIT
  isSystemAccount  Boolean @default(false) // System accounts cannot be deleted
  isActive         Boolean @default(true)
  isBankAccount    Boolean @default(false)
  isControlAccount Boolean @default(false) // For sub-ledger control

  // Tax configuration
  taxCode      String? // e.g., "VAT_7.5", "EXEMPT"
  isTaxAccount Boolean @default(false)

  // Display
  sortOrder Int @default(0)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  ledgerAccounts AcctLedgerAccount[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([accountType])
  @@index([parentId])
  @@index([isActive])
  @@map("acct_chart_of_accounts")
}

// ============================================================================
// LEDGER ACCOUNT
// Tenant-specific account instance with computed balances
// Balance is DERIVED from entries - never directly mutated
// ============================================================================
model AcctLedgerAccount {
  id       String @id @default(uuid())
  tenantId String

  // Link to Chart of Accounts
  chartOfAccountId String
  chartOfAccount   AcctChartOfAccount @relation(fields: [chartOfAccountId], references: [id], onDelete: Restrict)

  // Current balance (computed from entries, cached for performance)
  // This is updated by triggers/functions, NEVER directly by application code
  currentBalance Decimal @default(0) @db.Decimal(18, 4)
  currency       String  @default("NGN") // Nigeria-first

  // Period balances (for faster reporting)
  openingBalance Decimal @default(0) @db.Decimal(18, 4)
  periodDebit    Decimal @default(0) @db.Decimal(18, 4)
  periodCredit   Decimal @default(0) @db.Decimal(18, 4)

  // Active period reference
  currentPeriodId String?
  currentPeriod   AcctFinancialPeriod? @relation("CurrentPeriod", fields: [currentPeriodId], references: [id], onDelete: SetNull)

  // Status
  isActive Boolean @default(true)

  // Last reconciliation
  lastReconciledAt      DateTime?
  lastReconciledBalance Decimal?  @db.Decimal(18, 4)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  entries AcctLedgerEntry[]

  @@unique([tenantId, chartOfAccountId, currency])
  @@index([tenantId])
  @@index([chartOfAccountId])
  @@index([currentPeriodId])
  @@map("acct_ledger_accounts")
}

// ============================================================================
// LEDGER ENTRY
// APPEND-ONLY immutable record of account balance changes
// Core of the accounting system - cannot be updated or deleted
// ============================================================================
model AcctLedgerEntry {
  id       String @id @default(uuid())
  tenantId String

  // Account reference
  ledgerAccountId String
  ledgerAccount   AcctLedgerAccount @relation(fields: [ledgerAccountId], references: [id], onDelete: Restrict)

  // Journal reference (every entry belongs to a journal)
  journalEntryId String
  journalEntry   AcctJournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Restrict)

  // Entry details - IMMUTABLE
  entryDate    DateTime
  debitAmount  Decimal  @default(0) @db.Decimal(18, 4)
  creditAmount Decimal  @default(0) @db.Decimal(18, 4)

  // Running balance at time of entry (for audit trail)
  balanceAfter Decimal @db.Decimal(18, 4)

  // Currency
  currency String @default("NGN")

  // Description
  description String?
  memo        String?

  // Reference to source document
  referenceType   String? // "INVOICE", "RECEIPT", "EXPENSE", etc.
  referenceId     String?
  referenceNumber String? // Human-readable reference

  // Financial period
  periodId String
  period   AcctFinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)

  // Audit - IMMUTABLE after creation
  createdAt DateTime @default(now())
  createdBy String?

  // Sequence number for ordering within journal
  lineNumber Int

  @@index([tenantId])
  @@index([ledgerAccountId])
  @@index([journalEntryId])
  @@index([periodId])
  @@index([entryDate])
  @@index([referenceType, referenceId])
  @@map("acct_ledger_entries")
}

// ============================================================================
// JOURNAL ENTRY
// Double-entry journal with balanced debits and credits
// Events from Core modules create journal entries automatically
// ============================================================================
model AcctJournalEntry {
  id       String @id @default(uuid())
  tenantId String

  // Journal identity
  journalNumber String // Auto-generated sequence
  entryDate     DateTime
  postDate      DateTime?

  // Source tracking (event-sourced accounting)
  sourceType   AcctJournalSourceType
  sourceId     String? // Order ID, Sale ID, etc.
  sourceModule String? // "POS", "SVM", "MVM", "EXPENSE"

  // Core event reference
  eventId        String? // Core event that triggered this journal
  idempotencyKey String? @unique // Prevent duplicate postings

  // Description
  description String
  memo        String?

  // Status
  status AcctJournalStatus @default(DRAFT)

  // Totals (must balance)
  totalDebit  Decimal @db.Decimal(18, 4)
  totalCredit Decimal @db.Decimal(18, 4)
  currency    String  @default("NGN")

  // Tax breakdown
  taxAmount Decimal? @db.Decimal(18, 4)
  taxCode   String? // e.g., "VAT_7.5"

  // Financial period
  periodId String
  period   AcctFinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)

  // Reversal (for void/correction)
  isReversal        Boolean           @default(false)
  reversedJournalId String?           @unique
  reversedJournal   AcctJournalEntry? @relation("JournalReversal", fields: [reversedJournalId], references: [id], onDelete: SetNull)
  reversalOf        AcctJournalEntry? @relation("JournalReversal")

  // Attachments (future-ready)
  attachmentUrls String[] @default([])

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  postedBy  String?
  postedAt  DateTime?

  // Relations
  lines AcctLedgerEntry[]

  @@unique([tenantId, journalNumber])
  @@index([tenantId])
  @@index([status])
  @@index([sourceType])
  @@index([sourceId])
  @@index([periodId])
  @@index([entryDate])
  @@index([eventId])
  @@map("acct_journal_entries")
}

// ============================================================================
// FINANCIAL PERIOD
// Accounting periods for reporting and closing
// ============================================================================
model AcctFinancialPeriod {
  id       String @id @default(uuid())
  tenantId String

  // Period identity
  name String // e.g., "January 2026", "Q1 2026", "FY 2026"
  code String // e.g., "2026-01", "2026-Q1", "FY2026"

  // Period type
  periodType String @default("MONTHLY") // MONTHLY, QUARTERLY, ANNUAL

  // Date range
  startDate DateTime
  endDate   DateTime

  // Status
  status AcctPeriodStatus @default(OPEN)

  // Year reference
  fiscalYear Int

  // Closing
  closedAt DateTime?
  closedBy String?
  lockedAt DateTime?
  lockedBy String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  journalEntries  AcctJournalEntry[]
  ledgerEntries   AcctLedgerEntry[]
  currentAccounts AcctLedgerAccount[] @relation("CurrentPeriod")
  taxSummaries    AcctTaxSummary[]
  expenses        AcctExpenseRecord[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([fiscalYear])
  @@map("acct_financial_periods")
}

// ============================================================================
// EXPENSE RECORD
// Manual expense entry with categorization
// Nigeria-first: Supports cash purchases and informal expenses
// ============================================================================
model AcctExpenseRecord {
  id       String @id @default(uuid())
  tenantId String

  // Expense identity
  expenseNumber String // Auto-generated sequence
  expenseDate   DateTime

  // Categorization
  ledgerAccountId String // Expense account from COA
  categoryName    String? // Human-readable category

  // Amount
  amount   Decimal @db.Decimal(18, 4)
  currency String  @default("NGN")

  // Tax
  taxAmount      Decimal? @db.Decimal(18, 4)
  taxCode        String? // e.g., "VAT_7.5"
  isVatInclusive Boolean  @default(false)

  // Payment details (Nigeria-first: cash-heavy)
  paymentMethod AcctExpensePaymentMethod @default(CASH)
  paidFrom      String? // Bank account, cash drawer, etc.

  // Vendor/Supplier
  vendorName    String?
  vendorId      String? // Core Supplier ID if applicable
  vendorContact String?
  vendorPhone   String?

  // Description
  description String
  memo        String?

  // Receipt/Documentation
  receiptNumber  String?
  receiptDate    DateTime?
  attachmentUrls String[]  @default([])

  // Status and workflow
  status AcctExpenseStatus @default(DRAFT)

  // Approval
  submittedAt     DateTime?
  submittedBy     String?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?

  // Journal posting
  journalEntryId String?
  postedAt       DateTime?

  // Financial period
  periodId String?
  period   AcctFinancialPeriod? @relation(fields: [periodId], references: [id], onDelete: SetNull)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@unique([tenantId, expenseNumber])
  @@index([tenantId])
  @@index([status])
  @@index([expenseDate])
  @@index([ledgerAccountId])
  @@index([periodId])
  @@index([vendorId])
  @@map("acct_expense_records")
}

// ============================================================================
// TAX SUMMARY
// Period-based tax computation summaries
// Nigeria-first: VAT 7.5% support
// ============================================================================
model AcctTaxSummary {
  id       String @id @default(uuid())
  tenantId String

  // Period reference
  periodId String
  period   AcctFinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)

  // Tax type
  taxCode String // e.g., "VAT_7.5", "WHT"
  taxName String // e.g., "Value Added Tax", "Withholding Tax"
  taxRate Decimal @db.Decimal(6, 4) // e.g., 0.075 for 7.5%

  // Summary amounts
  taxableAmount   Decimal @db.Decimal(18, 4) // Total taxable transactions
  taxCollected    Decimal @db.Decimal(18, 4) // Tax charged to customers (output VAT)
  taxPaid         Decimal @db.Decimal(18, 4) // Tax paid on purchases (input VAT)
  netTaxLiability Decimal @db.Decimal(18, 4) // taxCollected - taxPaid

  // Currency
  currency String @default("NGN")

  // Breakdown
  salesTaxAmount   Decimal @default(0) @db.Decimal(18, 4) // From sales
  expenseTaxAmount Decimal @default(0) @db.Decimal(18, 4) // From expenses
  adjustmentAmount Decimal @default(0) @db.Decimal(18, 4) // Manual adjustments

  // Filing status (reporting only, no actual filing)
  reportGeneratedAt DateTime?
  reportGeneratedBy String?

  // Notes
  notes String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, periodId, taxCode])
  @@index([tenantId])
  @@index([periodId])
  @@index([taxCode])
  @@map("acct_tax_summaries")
}


// ============================================================================
// MODULE 3: CRM & CUSTOMER ENGAGEMENT
// ============================================================================
// Nigeria-first CRM for customer retention, loyalty, and growth
// This module does NOT duplicate Core Customer - it references by customerId
// This module does NOT send messages directly - it delegates to Core
// ============================================================================

// ============================================================================
// CRM ENUMS
// ============================================================================

enum CrmSegmentType {
  DYNAMIC     // Auto-updating based on rules
  STATIC      // Manual membership
  COMBINED    // Mix of rules + manual additions
}

enum CrmSegmentStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum CrmLoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum CrmLoyaltyTransactionType {
  EARN           // Points earned from purchase
  REDEEM         // Points redeemed for reward
  BONUS          // Promotional bonus points
  ADJUSTMENT     // Manual adjustment
  EXPIRY         // Points expired
  TRANSFER_IN    // Points transferred in
  TRANSFER_OUT   // Points transferred out
}

enum CrmCampaignType {
  PROMOTIONAL    // Sales/discounts
  LOYALTY        // Points multipliers
  ENGAGEMENT     // Re-engagement
  ANNOUNCEMENT   // Product/service announcements
  BIRTHDAY       // Birthday offers
  WINBACK        // Win-back inactive customers
}

enum CrmCampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum CrmCampaignChannel {
  SMS
  EMAIL
  PUSH
  WHATSAPP
  IN_APP
}

enum CrmEngagementType {
  PURCHASE
  VISIT
  CART_ABANDON
  WISHLIST_ADD
  REVIEW_SUBMIT
  REFERRAL
  CAMPAIGN_RESPONSE
  LOYALTY_REDEEM
  SUPPORT_CONTACT
}

// ============================================================================
// CUSTOMER SEGMENTS
// Rule-based and manual customer grouping
// ============================================================================
model CrmCustomerSegment {
  id       String @id @default(uuid())
  tenantId String

  // Segment identity
  name        String
  slug        String   // URL-friendly identifier
  description String?  @db.Text

  // Type
  segmentType   CrmSegmentType   @default(DYNAMIC)
  status        CrmSegmentStatus @default(ACTIVE)

  // Rules (JSON for flexibility)
  // Example: { "rules": [{ "field": "totalSpent", "operator": "gte", "value": 50000 }], "combinator": "AND" }
  rules Json?

  // Membership count (denormalized)
  memberCount Int @default(0)

  // Last computed
  lastComputedAt DateTime?
  computeError   String?

  // Priority for overlapping segments
  priority Int @default(0)

  // Metadata
  tags     String[] @default([])
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  memberships   CrmSegmentMembership[]
  campaigns     CrmCampaignAudience[]
  loyaltyRules  CrmLoyaltyRule[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([status])
  @@index([segmentType])
  @@map("crm_customer_segments")
}

// ============================================================================
// SEGMENT MEMBERSHIP
// Tracks which customers belong to which segments
// ============================================================================
model CrmSegmentMembership {
  id       String @id @default(uuid())
  tenantId String

  // References
  segmentId  String
  segment    CrmCustomerSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  customerId String  // References Core Customer

  // Membership details
  addedAt      DateTime @default(now())
  addedBy      String?  // null = auto-computed, user_id = manual
  isManual     Boolean  @default(false)

  // Score for ranked segments
  score Float?

  // Metadata
  metadata Json?

  @@unique([segmentId, customerId])
  @@index([tenantId])
  @@index([customerId])
  @@map("crm_segment_memberships")
}

// ============================================================================
// LOYALTY PROGRAM
// Points-based loyalty system
// ============================================================================
model CrmLoyaltyProgram {
  id       String @id @default(uuid())
  tenantId String

  // Program identity
  name        String
  description String? @db.Text

  // Status
  isActive   Boolean   @default(true)
  startsAt   DateTime?
  endsAt     DateTime?

  // Currency
  pointsName   String  @default("Points")    // "Points", "Stars", "Coins"
  pointsSymbol String  @default("pts")       // "pts", "★", "🪙"

  // Value configuration
  pointsPerCurrency  Decimal  @default(1) @db.Decimal(10, 4) // Points per NGN spent
  currencyPerPoint   Decimal? @db.Decimal(10, 4)             // NGN value per point (for redemption)

  // Expiry
  pointsExpireMonths Int?  // null = never expire

  // Tier configuration (JSON)
  // Example: { "tiers": [{ "name": "Bronze", "minPoints": 0 }, { "name": "Silver", "minPoints": 1000 }] }
  tierConfig Json?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  rules        CrmLoyaltyRule[]
  transactions CrmLoyaltyTransaction[]

  @@unique([tenantId])  // One program per tenant
  @@map("crm_loyalty_programs")
}

// ============================================================================
// LOYALTY RULES
// Earn and redeem rules for loyalty points
// ============================================================================
model CrmLoyaltyRule {
  id       String @id @default(uuid())
  tenantId String

  // Program reference
  programId String
  program   CrmLoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  // Rule identity
  name        String
  description String?
  ruleType    String   // "EARN", "REDEEM", "BONUS", "MULTIPLIER"

  // Conditions (JSON)
  // Example: { "minPurchase": 1000, "channels": ["POS", "ONLINE"], "productCategories": ["*"] }
  conditions Json?

  // Action
  pointsValue    Int?      // Fixed points (for EARN/BONUS)
  pointsMultiplier Decimal? @db.Decimal(5, 2) // Multiplier (for MULTIPLIER)
  percentValue   Decimal?  @db.Decimal(5, 2) // Percentage of purchase

  // Targeting
  segmentId String?
  segment   CrmCustomerSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  // Validity
  isActive Boolean   @default(true)
  startsAt DateTime?
  endsAt   DateTime?

  // Limits
  maxUsesPerCustomer Int?
  maxTotalUses       Int?
  currentUses        Int @default(0)

  // Priority
  priority Int @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([programId])
  @@index([ruleType])
  @@map("crm_loyalty_rules")
}

// ============================================================================
// LOYALTY TRANSACTIONS (LEDGER)
// Append-only ledger of all points movements
// ============================================================================
model CrmLoyaltyTransaction {
  id       String @id @default(uuid())
  tenantId String

  // Program reference
  programId String
  program   CrmLoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Restrict)

  // Customer reference (Core)
  customerId String

  // Transaction details
  transactionType CrmLoyaltyTransactionType
  points          Int                         // Positive for earn, negative for redeem
  balanceAfter    Int                         // Running balance

  // Source reference
  sourceType String?  // "POS_SALE", "ONLINE_ORDER", "MANUAL", "CAMPAIGN"
  sourceId   String?  // Order ID, Sale ID, etc.
  ruleId     String?  // Which rule triggered this

  // Description
  description String?
  memo        String?

  // Expiry tracking
  expiresAt DateTime?
  isExpired Boolean   @default(false)

  // Metadata
  metadata Json?

  // Immutable audit
  createdAt DateTime @default(now())
  createdBy String?

  @@index([tenantId])
  @@index([customerId])
  @@index([programId])
  @@index([transactionType])
  @@index([sourceType, sourceId])
  @@index([expiresAt])
  @@map("crm_loyalty_transactions")
}

// ============================================================================
// CAMPAIGNS
// Marketing campaign definitions (NOT execution)
// ============================================================================
model CrmCampaign {
  id       String @id @default(uuid())
  tenantId String

  // Campaign identity
  name        String
  slug        String
  description String? @db.Text

  // Type and status
  campaignType CrmCampaignType
  status       CrmCampaignStatus @default(DRAFT)

  // Channel
  channels CrmCampaignChannel[]

  // Content (JSON)
  // Example: { "subject": "...", "body": "...", "smsText": "...", "callToAction": "..." }
  content Json?

  // Scheduling
  scheduledAt DateTime?
  startsAt    DateTime?
  endsAt      DateTime?

  // Trigger conditions (JSON)
  // Example: { "trigger": "PURCHASE", "delay": "1h", "conditions": {...} }
  triggerConfig Json?

  // Offer/Reward
  offerType  String?  // "DISCOUNT_PERCENT", "DISCOUNT_FIXED", "LOYALTY_MULTIPLIER", "FREE_ITEM"
  offerValue Decimal? @db.Decimal(10, 2)
  offerCode  String?

  // Budget and limits
  budgetLimit        Decimal? @db.Decimal(12, 2)
  budgetUsed         Decimal  @default(0) @db.Decimal(12, 2)
  maxRecipients      Int?
  currentRecipients  Int      @default(0)

  // Performance metrics (denormalized)
  sentCount     Int @default(0)
  deliveredCount Int @default(0)
  openedCount   Int @default(0)
  clickedCount  Int @default(0)
  convertedCount Int @default(0)

  // Metadata
  tags     String[] @default([])
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  publishedAt DateTime?
  publishedBy String?

  // Relations
  audiences CrmCampaignAudience[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([status])
  @@index([campaignType])
  @@index([scheduledAt])
  @@map("crm_campaigns")
}

// ============================================================================
// CAMPAIGN AUDIENCE
// Links campaigns to segments
// ============================================================================
model CrmCampaignAudience {
  id       String @id @default(uuid())
  tenantId String

  // References
  campaignId String
  campaign   CrmCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Audience type
  audienceType String  // "SEGMENT", "ALL_CUSTOMERS", "CUSTOM_LIST"

  // Segment reference (if audienceType = SEGMENT)
  segmentId String?
  segment   CrmCustomerSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  // Custom list (if audienceType = CUSTOM_LIST)
  customerIds String[] @default([])

  // Exclusions
  excludeSegmentIds String[] @default([])
  excludeCustomerIds String[] @default([])

  // Estimated reach
  estimatedReach Int?

  // Audit
  createdAt DateTime @default(now())

  @@index([campaignId])
  @@index([segmentId])
  @@map("crm_campaign_audiences")
}

// ============================================================================
// ENGAGEMENT EVENTS
// Tracks customer engagement across channels
// ============================================================================
model CrmEngagementEvent {
  id       String @id @default(uuid())
  tenantId String

  // Customer reference (Core)
  customerId String

  // Event details
  eventType   CrmEngagementType
  channel     String?           // "POS", "ONLINE", "MARKETPLACE", "APP"
  description String?

  // Source reference
  sourceType String?  // "SALE", "ORDER", "CAMPAIGN", "MANUAL"
  sourceId   String?

  // Value
  monetaryValue Decimal? @db.Decimal(12, 2)
  pointsValue   Int?

  // Campaign tracking
  campaignId String?

  // Session/device info
  sessionId String?
  deviceId  String?
  ipAddress String?
  userAgent String?

  // Metadata
  metadata Json?

  // Timestamp (immutable)
  occurredAt DateTime @default(now())

  @@index([tenantId])
  @@index([customerId])
  @@index([eventType])
  @@index([occurredAt])
  @@index([campaignId])
  @@map("crm_engagement_events")
}

// ============================================================================
// CRM CONFIGURATION
// Tenant-level CRM settings
// ============================================================================
model CrmConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Segmentation settings
  autoUpdateSegments Boolean @default(true)
  segmentUpdateFrequency String @default("HOURLY") // "REALTIME", "HOURLY", "DAILY"

  // Loyalty settings
  loyaltyEnabled       Boolean @default(false)
  loyaltyProgramId     String?

  // Campaign settings
  campaignsEnabled     Boolean @default(false)
  defaultSmsTemplate   String?
  defaultEmailTemplate String?

  // Communication preferences
  smsEnabled           Boolean @default(true)
  emailEnabled         Boolean @default(true)
  pushEnabled          Boolean @default(false)
  whatsappEnabled      Boolean @default(false)

  // Nigeria-first settings
  phoneNumberFormat    String  @default("NG")   // Country code for formatting
  defaultCurrency      String  @default("NGN")

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_configurations")
}


// ============================================================================
// ============================================================================
// MODULE 4: LOGISTICS & DELIVERY
// ============================================================================
// ============================================================================
// 
// Nigeria-first delivery management module.
// Supports in-house riders, informal delivery, and future 3PL integration.
//
// OWNERSHIP:
// - DeliveryZone: Delivery areas and coverage
// - DeliveryPricingRule: Zone-based pricing logic
// - DeliveryAgent: Riders/delivery personnel
// - DeliveryAssignment: Order-to-rider assignment
// - DeliveryStatusHistory: Immutable status trail
// - DeliveryProof: Proof of delivery records
// - LogisticsConfiguration: Tenant settings
//
// REFERENCES (read-only):
// - Orders via orderId (POS/SVM/MVM own orders)
// - Customers via customerId (Core owns customers)
// - Locations via locationId (Core owns locations)
//
// ============================================================================

// ============================================================================
// DELIVERY ZONE
// Geographic delivery areas with coverage rules
// ============================================================================
enum LogisticsZoneType {
  CITY        // City-based zone
  LGA         // Local Government Area (Nigeria)
  STATE       // State-based zone
  DISTANCE    // Distance-based from origin
  CUSTOM      // Custom polygon/area
}

enum LogisticsZoneStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model LogisticsDeliveryZone {
  id       String @id @default(uuid())
  tenantId String

  // Zone identity
  name        String
  code        String?   // Internal code: "LAGOS-IKEJA"
  description String?
  zoneType    LogisticsZoneType @default(CITY)

  // Geographic coverage
  city        String?
  state       String?
  lga         String?   // Local Government Area (Nigeria-specific)
  postalCodes String[]  @default([])
  
  // For distance-based zones
  centerLatitude  Decimal? @db.Decimal(10, 8)
  centerLongitude Decimal? @db.Decimal(11, 8)
  radiusKm        Decimal? @db.Decimal(10, 2)

  // Custom polygon (GeoJSON format)
  polygon Json?

  // Status
  status LogisticsZoneStatus @default(ACTIVE)

  // Ordering
  sortOrder Int @default(0)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  pricingRules LogisticsDeliveryPricingRule[]
  assignments  LogisticsDeliveryAssignment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@index([city])
  @@index([state])
  @@index([lga])
  @@map("logistics_delivery_zones")
}

// ============================================================================
// DELIVERY PRICING RULE
// Zone-based delivery pricing logic
// ============================================================================
enum LogisticsPricingType {
  FLAT_RATE       // Fixed delivery fee
  DISTANCE_BASED  // Fee per km
  WEIGHT_BASED    // Fee per kg
  ORDER_VALUE     // Percentage of order
  TIERED          // Tiered pricing
}

model LogisticsDeliveryPricingRule {
  id       String @id @default(uuid())
  tenantId String

  // Zone reference
  zoneId String
  zone   LogisticsDeliveryZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  // Rule identity
  name        String
  description String?

  // Pricing type
  pricingType LogisticsPricingType @default(FLAT_RATE)

  // Base pricing
  baseFee      Decimal  @default(0) @db.Decimal(12, 2)
  feePerKm     Decimal? @db.Decimal(12, 2)
  feePerKg     Decimal? @db.Decimal(12, 2)
  percentOfOrder Decimal? @db.Decimal(5, 2)

  // Free delivery threshold
  freeDeliveryThreshold Decimal? @db.Decimal(12, 2)

  // Min/max constraints
  minOrderValue Decimal? @db.Decimal(12, 2)
  maxOrderValue Decimal? @db.Decimal(12, 2)
  minFee        Decimal? @db.Decimal(12, 2)
  maxFee        Decimal? @db.Decimal(12, 2)

  // Tiered pricing (JSON array)
  tiers Json?  // [{ "minValue": 0, "maxValue": 5000, "fee": 500 }, ...]

  // Time-based pricing
  expressMultiplier    Decimal? @db.Decimal(5, 2) // Multiplier for express delivery
  weekendMultiplier    Decimal? @db.Decimal(5, 2) // Multiplier for weekend
  peakHourMultiplier   Decimal? @db.Decimal(5, 2) // Multiplier for peak hours

  // Currency
  currency String @default("NGN")

  // Status
  isActive Boolean @default(true)
  priority Int     @default(0)  // Higher priority rules evaluated first

  // Validity period
  validFrom  DateTime?
  validUntil DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([zoneId])
  @@index([isActive])
  @@map("logistics_delivery_pricing_rules")
}

// ============================================================================
// DELIVERY AGENT (RIDER)
// Delivery personnel management
// ============================================================================
enum LogisticsAgentStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
}

enum LogisticsAgentAvailability {
  AVAILABLE
  BUSY
  OFFLINE
  ON_DELIVERY
}

enum LogisticsAgentType {
  IN_HOUSE    // Company employee
  FREELANCE   // Freelance rider
  THIRD_PARTY // 3PL provider rider
}

model LogisticsDeliveryAgent {
  id       String @id @default(uuid())
  tenantId String

  // Agent identity
  firstName   String
  lastName    String
  phone       String   // Primary identifier (Nigeria-first)
  email       String?
  photoUrl    String?

  // Agent type
  agentType LogisticsAgentType @default(IN_HOUSE)

  // Vehicle info
  vehicleType   String?  // MOTORCYCLE, BICYCLE, CAR, VAN, TRUCK
  vehiclePlate  String?
  vehicleModel  String?

  // Location assignment
  defaultZoneId    String?
  assignedZoneIds  String[] @default([])

  // Status
  status       LogisticsAgentStatus       @default(ACTIVE)
  availability LogisticsAgentAvailability @default(OFFLINE)

  // Current location (last known)
  lastLatitude   Decimal? @db.Decimal(10, 8)
  lastLongitude  Decimal? @db.Decimal(11, 8)
  lastLocationAt DateTime?

  // Performance metrics (denormalized)
  totalDeliveries      Int     @default(0)
  completedDeliveries  Int     @default(0)
  failedDeliveries     Int     @default(0)
  averageRating        Decimal? @db.Decimal(3, 2)
  totalRatings         Int     @default(0)

  // Employment details (NOT payroll - just reference)
  employeeId   String?   // If linked to HR system
  hireDate     DateTime?
  terminatedAt DateTime?

  // Bank details (for future payout reference - NOT payment logic)
  bankName      String?
  bankAccount   String?
  bankAccountName String?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignments LogisticsDeliveryAssignment[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([status])
  @@index([availability])
  @@index([agentType])
  @@map("logistics_delivery_agents")
}

// ============================================================================
// DELIVERY ASSIGNMENT
// Links orders to delivery agents
// ============================================================================
enum LogisticsDeliveryStatus {
  PENDING         // Order ready, awaiting assignment
  ASSIGNED        // Rider assigned
  ACCEPTED        // Rider accepted assignment
  PICKING_UP      // Rider en route to pickup
  PICKED_UP       // Order collected
  IN_TRANSIT      // On the way to customer
  ARRIVING        // Near delivery location
  DELIVERED       // Successfully delivered
  FAILED          // Delivery failed
  RETURNED        // Returned to sender
  CANCELLED       // Assignment cancelled
}

enum LogisticsDeliveryPriority {
  STANDARD
  EXPRESS
  SAME_DAY
  NEXT_DAY
}

model LogisticsDeliveryAssignment {
  id       String @id @default(uuid())
  tenantId String

  // Order reference (READ-ONLY - module does NOT own orders)
  orderId     String   // Reference to POS Sale or SVM/MVM Order
  orderType   String   // "POS_SALE", "SVM_ORDER", "MVM_ORDER"
  orderNumber String?  // Human-readable order number

  // Customer reference (READ-ONLY)
  customerId   String?
  customerName String?
  customerPhone String?

  // Delivery zone
  zoneId String?
  zone   LogisticsDeliveryZone? @relation(fields: [zoneId], references: [id])

  // Assigned agent
  agentId String?
  agent   LogisticsDeliveryAgent? @relation(fields: [agentId], references: [id])

  // Delivery address (snapshot at time of assignment)
  deliveryAddress Json?  // { line1, line2, city, state, lga, postalCode, country, landmark }
  deliveryLatitude  Decimal? @db.Decimal(10, 8)
  deliveryLongitude Decimal? @db.Decimal(11, 8)

  // Pickup location
  pickupLocationId String?
  pickupAddress    Json?
  pickupLatitude   Decimal? @db.Decimal(10, 8)
  pickupLongitude  Decimal? @db.Decimal(11, 8)

  // Status
  status LogisticsDeliveryStatus @default(PENDING)
  priority LogisticsDeliveryPriority @default(STANDARD)

  // Pricing (ADVISORY ONLY - does not execute payment)
  estimatedFee   Decimal? @db.Decimal(12, 2)
  actualFee      Decimal? @db.Decimal(12, 2)
  currency       String   @default("NGN")
  feeCalculation Json?    // Breakdown of how fee was calculated

  // Distance & time estimates
  estimatedDistanceKm Decimal? @db.Decimal(10, 2)
  estimatedDurationMin Int?
  actualDistanceKm    Decimal? @db.Decimal(10, 2)
  actualDurationMin   Int?

  // Scheduling
  scheduledPickupAt   DateTime?
  scheduledDeliveryAt DateTime?
  actualPickupAt      DateTime?
  actualDeliveryAt    DateTime?

  // Delivery window
  deliveryWindowStart DateTime?
  deliveryWindowEnd   DateTime?

  // Delivery instructions
  specialInstructions String?
  contactOnArrival    Boolean @default(true)

  // Package info
  packageCount    Int     @default(1)
  totalWeight     Decimal? @db.Decimal(10, 2)
  packageDetails  Json?

  // Failure info
  failureReason   String?
  failureCode     String?
  failedAttempts  Int     @default(0)
  maxAttempts     Int     @default(3)

  // Rating (customer rating of delivery)
  customerRating  Int?      // 1-5 stars
  customerReview  String?
  ratedAt         DateTime?

  // Assignment metadata
  assignedBy      String?   // User who assigned
  assignedAt      DateTime?
  autoAssigned    Boolean   @default(false)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  statusHistory LogisticsDeliveryStatusHistory[]
  proofs        LogisticsDeliveryProof[]

  @@unique([orderId, orderType])
  @@index([tenantId])
  @@index([orderId])
  @@index([agentId])
  @@index([status])
  @@index([scheduledDeliveryAt])
  @@index([createdAt])
  @@map("logistics_delivery_assignments")
}

// ============================================================================
// DELIVERY STATUS HISTORY
// Immutable audit trail of delivery status changes
// ============================================================================
model LogisticsDeliveryStatusHistory {
  id           String @id @default(uuid())
  assignmentId String
  assignment   LogisticsDeliveryAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  // Status change
  fromStatus LogisticsDeliveryStatus?
  toStatus   LogisticsDeliveryStatus

  // Location at time of status change
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  address   String?

  // Who made the change
  changedBy     String?  // User or agent ID
  changedByType String?  // "AGENT", "ADMIN", "SYSTEM", "CUSTOMER"

  // Notes
  notes String?

  // Offline tracking
  offlineId     String?   // Client-generated ID for offline sync
  recordedAt    DateTime  // When status actually changed (may differ from createdAt)
  syncedAt      DateTime? // When synced from offline

  // Metadata
  metadata Json?

  // Timestamp (immutable)
  createdAt DateTime @default(now())

  @@index([assignmentId])
  @@index([toStatus])
  @@index([recordedAt])
  @@index([offlineId])
  @@map("logistics_delivery_status_history")
}

// ============================================================================
// DELIVERY PROOF
// Proof of delivery records (photos, signatures, etc.)
// ============================================================================
enum LogisticsProofType {
  PHOTO           // Delivery photo
  SIGNATURE       // Customer signature
  PIN_CODE        // PIN verification
  OTP             // OTP verification
  RECIPIENT_NAME  // Recipient name confirmation
  NOTES           // Delivery notes
}

model LogisticsDeliveryProof {
  id           String @id @default(uuid())
  assignmentId String
  assignment   LogisticsDeliveryAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  // Proof type
  proofType LogisticsProofType

  // Proof data
  imageUrl      String?   // For photos/signatures
  signatureData String?   // Base64 signature
  pinCode       String?   // Hashed PIN
  otpCode       String?   // Hashed OTP
  recipientName String?
  notes         String?

  // Location at time of proof capture
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  // Captured by
  capturedBy     String?  // Agent ID
  capturedByType String?  // "AGENT", "CUSTOMER"

  // Offline tracking
  offlineId  String?
  capturedAt DateTime  // When proof was captured
  syncedAt   DateTime? // When synced

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())

  @@index([assignmentId])
  @@index([proofType])
  @@index([capturedAt])
  @@map("logistics_delivery_proofs")
}

// ============================================================================
// LOGISTICS CONFIGURATION
// Tenant-level logistics settings
// ============================================================================
model LogisticsConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Feature flags
  deliveryEnabled      Boolean @default(true)
  autoAssignmentEnabled Boolean @default(false)
  realTimeTrackingEnabled Boolean @default(false)
  proofOfDeliveryRequired Boolean @default(true)

  // Default settings
  defaultPriority LogisticsDeliveryPriority @default(STANDARD)
  defaultCurrency String @default("NGN")

  // Proof requirements
  photoProofRequired     Boolean @default(true)
  signatureProofRequired Boolean @default(false)
  pinVerificationEnabled Boolean @default(false)
  otpVerificationEnabled Boolean @default(false)

  // Auto-assignment rules
  assignmentAlgorithm String @default("NEAREST") // "NEAREST", "ROUND_ROBIN", "LEAST_BUSY"
  maxConcurrentDeliveries Int @default(5)  // Max deliveries per agent

  // Delivery windows
  defaultDeliveryWindowHours Int @default(4)
  expressDeliveryWindowHours Int @default(2)
  sameDayDeliveryWindowHours Int @default(6)

  // Operating hours (JSON format)
  operatingHours Json?  // { "mon": { "start": "08:00", "end": "20:00" }, ... }

  // Retry settings
  maxDeliveryAttempts Int @default(3)
  retryDelayHours     Int @default(24)

  // Notification settings
  notifyCustomerOnAssignment Boolean @default(true)
  notifyCustomerOnPickup     Boolean @default(true)
  notifyCustomerOnTransit    Boolean @default(true)
  notifyCustomerOnArrival    Boolean @default(true)
  notifyCustomerOnDelivery   Boolean @default(true)
  notifyCustomerOnFailure    Boolean @default(true)

  // Nigeria-first settings
  supportInformalAddresses Boolean @default(true)
  landmarkRequired         Boolean @default(true)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("logistics_configurations")
}

// ============================================================================
// ============================================================================
// MODULE 5: HR & PAYROLL
// ============================================================================
// ============================================================================
// 
// Nigeria-first workforce management for SMEs.
// Supports informal employment, cash payroll, and flexible pay cycles.
//
// OWNERSHIP:
// - EmployeeProfile: Extended HR data for staff
// - EmploymentContract: Employment terms and conditions
// - WorkSchedule: Shift schedules and work patterns
// - AttendanceRecord: Clock-in/out and attendance tracking
// - LeaveRequest: Leave applications and approvals
// - LeaveBalance: Leave entitlements per employee
// - PayrollPeriod: Pay cycle definitions
// - PayrollCalculation: Calculated payroll per employee per period
// - Payslip: Generated payslip records (immutable)
// - HrConfiguration: Tenant HR settings
//
// REFERENCES (read-only):
// - Staff via staffId (Core owns staff records)
// - Locations via locationId (Core owns locations)
//
// IMPORTANT: This module does NOT execute payments.
// Payroll calculations are advisory - actual payment is external.
//
// ============================================================================

// ============================================================================
// EMPLOYEE PROFILE
// Extended HR data linked to Core Staff
// ============================================================================
enum HrEmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  CASUAL      // Nigeria: daily/informal workers
  INTERN
  APPRENTICE  // Nigeria: trade apprenticeships
}

enum HrPayFrequency {
  DAILY
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum HrPaymentMethod {
  CASH          // Common in Nigeria
  BANK_TRANSFER
  MOBILE_MONEY  // OPay, Paga, etc.
  CHECK
}

model HrEmployeeProfile {
  id       String @id @default(uuid())
  tenantId String

  // Core Staff reference (NOT duplicated)
  staffId String @unique

  // Employment details
  employmentType HrEmploymentType @default(FULL_TIME)
  jobTitle       String?
  department     String?
  grade          String?     // Salary grade/level

  // Compensation
  baseSalary        Decimal?    @db.Decimal(12, 2)
  hourlyRate        Decimal?    @db.Decimal(12, 2)
  dailyRate         Decimal?    @db.Decimal(12, 2)
  payFrequency      HrPayFrequency @default(MONTHLY)
  paymentMethod     HrPaymentMethod @default(CASH)
  currency          String      @default("NGN")

  // Bank details (optional - many Nigerian workers paid cash)
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?

  // Mobile money (Nigeria-first)
  mobileMoneyProvider String?
  mobileMoneyNumber   String?

  // Employment dates
  hireDate          DateTime?
  confirmationDate  DateTime?
  terminationDate   DateTime?
  terminationReason String?

  // Work assignment
  primaryLocationId String?
  supervisorStaffId String?   // Reference to another staff

  // Leave entitlements (annual defaults)
  annualLeaveEntitlement  Int @default(15)
  sickLeaveEntitlement    Int @default(10)
  casualLeaveEntitlement  Int @default(5)

  // Tax info (Nigeria: PAYE)
  taxIdNumber       String?   // TIN
  pensionNumber     String?   // PFA number
  nhfNumber         String?   // National Housing Fund

  // Emergency contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contracts         HrEmploymentContract[]
  schedules         HrWorkSchedule[]
  attendanceRecords HrAttendanceRecord[]
  leaveRequests     HrLeaveRequest[]
  leaveBalances     HrLeaveBalance[]
  payrollCalculations HrPayrollCalculation[]
  payslips          HrPayslip[]

  @@index([tenantId])
  @@index([staffId])
  @@index([employmentType])
  @@index([department])
  @@map("hr_employee_profiles")
}

// ============================================================================
// EMPLOYMENT CONTRACT
// Employment terms and conditions
// ============================================================================
enum HrContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
  RENEWED
}

model HrEmploymentContract {
  id       String @id @default(uuid())
  tenantId String

  // Employee reference
  employeeProfileId String
  employeeProfile   HrEmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  // Contract details
  contractNumber    String?
  contractType      HrEmploymentType
  status            HrContractStatus @default(DRAFT)

  // Duration
  startDate         DateTime
  endDate           DateTime?   // null = permanent
  probationEndDate  DateTime?

  // Compensation terms
  agreedSalary      Decimal     @db.Decimal(12, 2)
  salaryType        String      @default("MONTHLY") // HOURLY, DAILY, MONTHLY
  currency          String      @default("NGN")

  // Benefits
  benefits          Json?       // { "transport": 5000, "housing": 10000, ... }
  allowances        Json?
  deductions        Json?       // Standard deductions

  // Work terms
  workHoursPerDay   Int         @default(8)
  workDaysPerWeek   Int         @default(5)
  overtimeRate      Decimal?    @db.Decimal(5, 2)  // Multiplier (1.5x, 2x)

  // Notice period
  noticePeriodDays  Int         @default(30)

  // Signatures (simple tracking)
  employeeSignedAt  DateTime?
  employerSignedAt  DateTime?
  signedBy          String?

  // Metadata
  metadata          Json?
  notes             String?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeProfileId])
  @@index([status])
  @@map("hr_employment_contracts")
}

// ============================================================================
// WORK SCHEDULE
// Shift schedules and work patterns
// ============================================================================
enum HrScheduleType {
  FIXED       // Same hours every day
  ROTATING    // Rotating shifts
  FLEXIBLE    // Flexible hours
  ON_CALL     // On-call shifts
}

model HrWorkSchedule {
  id       String @id @default(uuid())
  tenantId String

  // Schedule identity
  name          String
  description   String?
  scheduleType  HrScheduleType @default(FIXED)
  isDefault     Boolean @default(false)

  // Employee assignment (optional - can be template)
  employeeProfileId String?
  employeeProfile   HrEmployeeProfile? @relation(fields: [employeeProfileId], references: [id], onDelete: SetNull)

  // Location (optional)
  locationId    String?

  // Effective period
  effectiveFrom DateTime
  effectiveUntil DateTime?

  // Weekly schedule (JSON for flexibility)
  // { "monday": { "start": "09:00", "end": "17:00", "break": 60 }, ... }
  weeklySchedule Json

  // Standard hours
  hoursPerDay   Int @default(8)
  hoursPerWeek  Int @default(40)

  // Overtime rules
  overtimeThresholdDaily   Int?   // Minutes after which overtime starts
  overtimeThresholdWeekly  Int?

  // Status
  isActive Boolean @default(true)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeProfileId])
  @@index([isActive])
  @@map("hr_work_schedules")
}

// ============================================================================
// ATTENDANCE RECORD
// Clock-in/out and attendance tracking
// ============================================================================
enum HrAttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  LEAVE
  HOLIDAY
  REST_DAY
}

enum HrClockMethod {
  MANUAL        // Admin entry
  SELF_SERVICE  // Employee clock-in
  BIOMETRIC     // Fingerprint/face
  LOCATION      // GPS-based
  QR_CODE       // QR scan
}

model HrAttendanceRecord {
  id       String @id @default(uuid())
  tenantId String

  // Employee reference
  employeeProfileId String
  employeeProfile   HrEmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  // Date
  date DateTime @db.Date

  // Clock times
  clockIn     DateTime?
  clockOut    DateTime?
  breakStart  DateTime?
  breakEnd    DateTime?

  // Status
  status HrAttendanceStatus @default(PRESENT)

  // Calculated fields (in minutes)
  scheduledMinutes  Int?
  workedMinutes     Int?
  breakMinutes      Int?
  overtimeMinutes   Int?
  lateMinutes       Int?
  earlyLeaveMinutes Int?

  // Method and location
  clockInMethod  HrClockMethod?
  clockOutMethod HrClockMethod?
  clockInLocationId  String?
  clockOutLocationId String?
  clockInLatitude    Decimal? @db.Decimal(10, 8)
  clockInLongitude   Decimal? @db.Decimal(11, 8)
  clockOutLatitude   Decimal? @db.Decimal(10, 8)
  clockOutLongitude  Decimal? @db.Decimal(11, 8)

  // Leave reference (if on leave)
  leaveRequestId String?

  // Approval (for manual entries)
  requiresApproval Boolean  @default(false)
  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?

  // Offline tracking
  offlineId   String?
  recordedAt  DateTime @default(now())  // When actually recorded (may differ from clock times)
  syncedAt    DateTime?

  // Notes
  notes String?
  adminNotes String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([employeeProfileId, date])
  @@index([tenantId])
  @@index([employeeProfileId])
  @@index([date])
  @@index([status])
  @@index([offlineId])
  @@map("hr_attendance_records")
}

// ============================================================================
// LEAVE REQUEST
// Leave applications and approvals
// ============================================================================
enum HrLeaveType {
  ANNUAL      // Paid annual leave
  SICK        // Sick leave
  CASUAL      // Casual/personal leave
  MATERNITY   // Maternity leave (Nigeria: 12 weeks min)
  PATERNITY   // Paternity leave
  COMPASSIONATE // Bereavement/family emergency
  UNPAID      // Leave without pay
  STUDY       // Study/exam leave
}

enum HrLeaveStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  COMPLETED
}

model HrLeaveRequest {
  id       String @id @default(uuid())
  tenantId String

  // Employee reference
  employeeProfileId String
  employeeProfile   HrEmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  // Leave details
  leaveType   HrLeaveType
  status      HrLeaveStatus @default(PENDING)

  // Duration
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  totalDays   Int
  halfDay     Boolean  @default(false)
  halfDayType String?  // "AM" or "PM"

  // Reason
  reason      String?
  attachmentUrl String?

  // Approval workflow
  approverStaffId String?
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Cancellation
  cancelledBy     String?
  cancelledAt     DateTime?
  cancellationReason String?

  // Balance impact
  balanceDeducted Int?      // Days deducted from balance
  balanceType     HrLeaveType?  // Which balance was used

  // Relief arrangement
  reliefStaffId   String?   // Who covers during leave
  handoverNotes   String?

  // Offline tracking
  offlineId String?
  syncedAt  DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeProfileId])
  @@index([status])
  @@index([startDate])
  @@index([offlineId])
  @@map("hr_leave_requests")
}

// ============================================================================
// LEAVE BALANCE
// Leave entitlements per employee per year
// ============================================================================
model HrLeaveBalance {
  id       String @id @default(uuid())
  tenantId String

  // Employee reference
  employeeProfileId String
  employeeProfile   HrEmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  // Period
  year Int

  // Leave type
  leaveType HrLeaveType

  // Balance tracking
  entitlement     Int @default(0)   // Total entitled days
  carriedForward  Int @default(0)   // From previous year
  adjustments     Int @default(0)   // Manual adjustments
  used            Int @default(0)   // Days used
  pending         Int @default(0)   // Days in pending requests
  available       Int @default(0)   // Computed: entitlement + carried + adjustments - used - pending

  // Metadata
  notes String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeProfileId, year, leaveType])
  @@index([tenantId])
  @@index([employeeProfileId])
  @@index([year])
  @@map("hr_leave_balances")
}

// ============================================================================
// PAYROLL PERIOD
// Pay cycle definitions
// ============================================================================
enum HrPayrollPeriodStatus {
  DRAFT       // Being configured
  OPEN        // Active, accepting entries
  PROCESSING  // Calculating
  FINALIZED   // Calculations complete
  PAID        // Marked as paid (external)
  CLOSED      // Archived
}

model HrPayrollPeriod {
  id       String @id @default(uuid())
  tenantId String

  // Period identity
  name        String
  payFrequency HrPayFrequency

  // Period dates
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date
  payDate     DateTime @db.Date

  // Status
  status HrPayrollPeriodStatus @default(DRAFT)

  // Processing timestamps
  calculatedAt  DateTime?
  calculatedBy  String?
  finalizedAt   DateTime?
  finalizedBy   String?
  paidMarkedAt  DateTime?
  paidMarkedBy  String?

  // Summary (denormalized)
  employeeCount       Int @default(0)
  totalGrossPay       Decimal @default(0) @db.Decimal(14, 2)
  totalDeductions     Decimal @default(0) @db.Decimal(14, 2)
  totalNetPay         Decimal @default(0) @db.Decimal(14, 2)
  currency            String @default("NGN")

  // Notes
  notes String?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  calculations HrPayrollCalculation[]
  payslips     HrPayslip[]

  @@unique([tenantId, periodStart, periodEnd, payFrequency])
  @@index([tenantId])
  @@index([status])
  @@index([periodStart])
  @@map("hr_payroll_periods")
}

// ============================================================================
// PAYROLL CALCULATION
// Calculated payroll per employee per period
// ============================================================================
enum HrPayrollCalculationStatus {
  PENDING     // Awaiting calculation
  CALCULATED  // Calculated, not finalized
  APPROVED    // Approved by admin
  FINALIZED   // Cannot be changed
}

model HrPayrollCalculation {
  id       String @id @default(uuid())
  tenantId String

  // Period reference
  payrollPeriodId String
  payrollPeriod   HrPayrollPeriod @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)

  // Employee reference
  employeeProfileId String
  employeeProfile   HrEmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  // Status
  status HrPayrollCalculationStatus @default(PENDING)

  // Earnings breakdown
  basePay           Decimal @default(0) @db.Decimal(12, 2)
  overtimePay       Decimal @default(0) @db.Decimal(12, 2)
  allowances        Decimal @default(0) @db.Decimal(12, 2)
  bonuses           Decimal @default(0) @db.Decimal(12, 2)
  otherEarnings     Decimal @default(0) @db.Decimal(12, 2)
  grossPay          Decimal @default(0) @db.Decimal(12, 2)

  // Deductions breakdown
  taxDeduction      Decimal @default(0) @db.Decimal(12, 2)  // PAYE
  pensionDeduction  Decimal @default(0) @db.Decimal(12, 2)
  nhfDeduction      Decimal @default(0) @db.Decimal(12, 2)  // National Housing Fund
  loanDeduction     Decimal @default(0) @db.Decimal(12, 2)
  advanceDeduction  Decimal @default(0) @db.Decimal(12, 2)
  otherDeductions   Decimal @default(0) @db.Decimal(12, 2)
  totalDeductions   Decimal @default(0) @db.Decimal(12, 2)

  // Net pay
  netPay            Decimal @default(0) @db.Decimal(12, 2)
  currency          String  @default("NGN")

  // Calculation details (JSON breakdown)
  earningsBreakdown   Json?   // Detailed earnings items
  deductionsBreakdown Json?   // Detailed deduction items

  // Attendance summary for period
  daysWorked        Int @default(0)
  daysAbsent        Int @default(0)
  daysLeave         Int @default(0)
  overtimeHours     Decimal @default(0) @db.Decimal(10, 2)
  lateCount         Int @default(0)

  // Approval
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?

  // Notes
  notes             String?
  adminNotes        String?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([payrollPeriodId, employeeProfileId])
  @@index([tenantId])
  @@index([payrollPeriodId])
  @@index([employeeProfileId])
  @@index([status])
  @@map("hr_payroll_calculations")
}

// ============================================================================
// PAYSLIP
// Generated payslip records (IMMUTABLE after generation)
// ============================================================================
model HrPayslip {
  id       String @id @default(uuid())
  tenantId String

  // References
  payrollPeriodId   String
  payrollPeriod     HrPayrollPeriod @relation(fields: [payrollPeriodId], references: [id])
  employeeProfileId String
  employeeProfile   HrEmployeeProfile @relation(fields: [employeeProfileId], references: [id])

  // Payslip number
  payslipNumber String @unique

  // Employee snapshot (at time of generation)
  employeeName      String
  employeeId        String    // Staff ID from Core
  department        String?
  jobTitle          String?
  bankName          String?
  bankAccountNumber String?   // Masked for security

  // Period info
  periodStart       DateTime @db.Date
  periodEnd         DateTime @db.Date
  payDate           DateTime @db.Date

  // Earnings (snapshot from calculation)
  basePay           Decimal @db.Decimal(12, 2)
  overtimePay       Decimal @default(0) @db.Decimal(12, 2)
  allowances        Decimal @default(0) @db.Decimal(12, 2)
  bonuses           Decimal @default(0) @db.Decimal(12, 2)
  otherEarnings     Decimal @default(0) @db.Decimal(12, 2)
  grossPay          Decimal @db.Decimal(12, 2)

  // Deductions (snapshot)
  taxDeduction      Decimal @default(0) @db.Decimal(12, 2)
  pensionDeduction  Decimal @default(0) @db.Decimal(12, 2)
  nhfDeduction      Decimal @default(0) @db.Decimal(12, 2)
  loanDeduction     Decimal @default(0) @db.Decimal(12, 2)
  advanceDeduction  Decimal @default(0) @db.Decimal(12, 2)
  otherDeductions   Decimal @default(0) @db.Decimal(12, 2)
  totalDeductions   Decimal @db.Decimal(12, 2)

  // Net pay
  netPay            Decimal @db.Decimal(12, 2)
  currency          String  @default("NGN")

  // Detailed breakdown (JSON for completeness)
  earningsDetails   Json?
  deductionsDetails Json?

  // Attendance summary
  daysWorked        Int
  daysAbsent        Int
  daysLeave         Int
  overtimeHours     Decimal @db.Decimal(10, 2)

  // Payment info (status tracking only - NO payment execution)
  paymentMethod     HrPaymentMethod @default(CASH)
  paymentStatus     String @default("PENDING")  // PENDING, PAID, HELD
  paymentReference  String?   // External reference
  paidAt            DateTime?
  paidBy            String?

  // Delivery
  deliveredAt       DateTime?
  deliveredMethod   String?   // "EMAIL", "PRINT", "PORTAL"
  viewedAt          DateTime?

  // Immutable flag
  isFinalized       Boolean @default(true)

  // Audit (creation only - no updates allowed)
  generatedAt       DateTime @default(now())
  generatedBy       String?

  @@index([tenantId])
  @@index([payrollPeriodId])
  @@index([employeeProfileId])
  @@index([periodStart])
  @@index([paymentStatus])
  @@map("hr_payslips")
}

// ============================================================================
// HR CONFIGURATION
// Tenant-level HR settings
// ============================================================================
model HrConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Feature flags
  hrEnabled           Boolean @default(true)
  attendanceEnabled   Boolean @default(true)
  leaveEnabled        Boolean @default(true)
  payrollEnabled      Boolean @default(true)

  // Default pay settings
  defaultPayFrequency HrPayFrequency @default(MONTHLY)
  defaultPaymentMethod HrPaymentMethod @default(CASH)
  defaultCurrency     String @default("NGN")

  // Work settings
  defaultWorkHoursPerDay Int @default(8)
  defaultWorkDaysPerWeek Int @default(5)
  overtimeMultiplier     Decimal @default(1.5) @db.Decimal(5, 2)

  // Attendance settings
  allowManualAttendance   Boolean @default(true)
  allowSelfClockIn        Boolean @default(true)
  requireLocationForClockIn Boolean @default(false)
  lateThresholdMinutes    Int @default(15)
  earlyLeaveThresholdMinutes Int @default(15)

  // Leave settings
  defaultAnnualLeave      Int @default(15)
  defaultSickLeave        Int @default(10)
  defaultCasualLeave      Int @default(5)
  leaveCarryForwardLimit  Int @default(5)
  requireLeaveApproval    Boolean @default(true)

  // Payroll settings
  requirePayrollApproval  Boolean @default(true)
  autoCalculatePayroll    Boolean @default(false)

  // Nigeria-specific
  payeTaxEnabled          Boolean @default(true)
  pensionEnabled          Boolean @default(true)
  pensionEmployeeRate     Decimal @default(8) @db.Decimal(5, 2)   // 8%
  pensionEmployerRate     Decimal @default(10) @db.Decimal(5, 2)  // 10%
  nhfEnabled              Boolean @default(false)
  nhfRate                 Decimal @default(2.5) @db.Decimal(5, 2) // 2.5%

  // Operating hours (JSON)
  operatingHours Json?

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hr_configurations")
}

// ============================================================================
// MODULE 6: PROCUREMENT & SUPPLIER MANAGEMENT
// Nigeria-first sourcing, restocking & supplier intelligence
// 
// This module OWNS:
// - Procurement workflows (purchase requests, purchase orders)
// - Purchase planning logic
// - Supplier performance tracking
// - Purchase order lifecycle
// - Goods receipt records
// - Supplier pricing
//
// This module DOES NOT OWN:
// - Supplier (Core owns - references by supplierId only)
// - Product (Core owns - references by productId only)
// - InventoryLevel (Core owns - read-only access)
// - Wallet/Payment (no payment execution)
// 
// Key Principle: This module is ADVISORY only. No inventory or payment mutation.
// ============================================================================

// ============================================================================
// PROCUREMENT ENUMS
// ============================================================================

enum ProcPurchaseRequestStatus {
  DRAFT           // Created, not submitted
  SUBMITTED       // Pending approval
  APPROVED        // Approved, can create PO
  REJECTED        // Rejected
  CANCELLED       // Cancelled by requester
  CONVERTED       // Converted to PO
}

enum ProcPurchaseOrderStatus {
  DRAFT           // Created, not sent
  PENDING         // Awaiting supplier response
  CONFIRMED       // Supplier confirmed
  PARTIALLY_RECEIVED  // Some items received
  RECEIVED        // All items received
  CANCELLED       // Cancelled
  CLOSED          // Completed and closed
}

enum ProcGoodsReceiptStatus {
  PENDING         // Not verified
  VERIFIED        // Quality verified
  REJECTED        // Quality rejected
  ACCEPTED        // Accepted into inventory (event emitted)
}

enum ProcPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================================================
// PROCUREMENT CONFIGURATION
// ============================================================================
model ProcConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Feature flags
  procurementEnabled       Boolean @default(true)
  purchaseRequestsEnabled  Boolean @default(true)
  supplierPriceListEnabled Boolean @default(true)
  performanceTrackingEnabled Boolean @default(true)

  // Workflow settings
  requireApprovalForPR     Boolean @default(true)
  approvalThresholdAmount  Decimal? @db.Decimal(15, 2)  // Auto-approve below this
  defaultPaymentTerms      String  @default("NET30")
  defaultCurrency          String  @default("NGN")

  // Nigeria-first settings
  allowInformalSuppliers   Boolean @default(true)
  allowCashPurchases       Boolean @default(true)
  requireReceiptPhotos     Boolean @default(false)

  // PO settings
  poNumberPrefix           String  @default("PO")
  poNumberSequence         Int     @default(1)
  autoConfirmPO            Boolean @default(false)

  // Notifications
  notifyOnPRApproval       Boolean @default(true)
  notifyOnPOConfirmation   Boolean @default(true)
  notifyOnGoodsReceipt     Boolean @default(true)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("proc_configurations")
}

// ============================================================================
// PURCHASE REQUEST
// Internal request for goods/services before PO
// ============================================================================
model ProcPurchaseRequest {
  id       String @id @default(uuid())
  tenantId String

  // Request identification
  requestNumber String    // PR-2025-000001
  
  // Status workflow
  status    ProcPurchaseRequestStatus @default(DRAFT)
  priority  ProcPriority @default(NORMAL)

  // Requester info
  requestedBy     String   // staffId or userId
  requestedAt     DateTime @default(now())
  department      String?
  locationId      String?  // Warehouse/location

  // Preferred supplier (optional)
  preferredSupplierId String?

  // Request details
  title           String
  description     String? @db.Text
  justification   String? @db.Text

  // Budget (advisory only)
  estimatedTotal  Decimal? @db.Decimal(15, 2)
  budgetCode      String?

  // Timeline
  neededByDate    DateTime?

  // Approval workflow
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Conversion tracking
  convertedToPOId String?
  convertedAt     DateTime?

  // Offline support
  offlineId       String?

  // Metadata
  notes     String? @db.Text
  metadata  Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items ProcPurchaseRequestItem[]

  @@unique([tenantId, requestNumber])
  @@unique([tenantId, offlineId])
  @@index([tenantId])
  @@index([status])
  @@index([requestedBy])
  @@index([preferredSupplierId])
  @@map("proc_purchase_requests")
}

// ============================================================================
// PURCHASE REQUEST ITEM
// Line items for purchase request
// ============================================================================
model ProcPurchaseRequestItem {
  id                String @id @default(uuid())
  purchaseRequestId String
  purchaseRequest   ProcPurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  // Product reference (Core Product)
  productId   String
  productSku  String?
  productName String   // Snapshot at time of request

  // Quantity
  quantity        Decimal @db.Decimal(15, 4)
  unit            String  @default("UNIT")

  // Estimated pricing (advisory)
  estimatedUnitPrice  Decimal? @db.Decimal(15, 4)
  estimatedTotal      Decimal? @db.Decimal(15, 2)

  // Notes
  specifications  String? @db.Text
  notes           String?

  // Order
  lineNumber      Int

  @@index([purchaseRequestId])
  @@index([productId])
  @@map("proc_purchase_request_items")
}

// ============================================================================
// PURCHASE ORDER
// Formal order to supplier (commitment, not payment)
// ============================================================================
model ProcPurchaseOrder {
  id       String @id @default(uuid())
  tenantId String

  // PO identification
  poNumber  String    // PO-2025-000001

  // Status workflow
  status    ProcPurchaseOrderStatus @default(DRAFT)
  priority  ProcPriority @default(NORMAL)

  // Supplier (Core Supplier reference)
  supplierId    String
  supplierName  String   // Snapshot
  supplierPhone String?  // Snapshot for Nigeria-first

  // Source
  purchaseRequestId String?  // If converted from PR

  // Shipping
  shipToLocationId  String?
  shipToAddress     String? @db.Text

  // Dates
  orderDate         DateTime @default(now())
  expectedDelivery  DateTime?
  confirmedDelivery DateTime?

  // Payment terms (informational only - NO execution)
  paymentTerms      String  @default("NET30")
  currency          String  @default("NGN")

  // Totals (commitment amounts only)
  subtotal          Decimal @db.Decimal(15, 2)
  taxAmount         Decimal @default(0) @db.Decimal(15, 2)
  shippingCost      Decimal @default(0) @db.Decimal(15, 2)
  discount          Decimal @default(0) @db.Decimal(15, 2)
  totalAmount       Decimal @db.Decimal(15, 2)

  // Workflow
  createdBy         String
  confirmedBy       String?
  confirmedAt       DateTime?
  cancelledBy       String?
  cancelledAt       DateTime?
  cancellationReason String?
  closedAt          DateTime?

  // Nigeria-first
  isCashPurchase    Boolean @default(false)
  supplierContactPhone String?

  // Offline support
  offlineId         String?

  // Notes
  internalNotes     String? @db.Text
  supplierNotes     String? @db.Text
  termsAndConditions String? @db.Text

  // Metadata
  metadata  Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items     ProcPurchaseOrderItem[]
  receipts  ProcGoodsReceipt[]

  @@unique([tenantId, poNumber])
  @@unique([tenantId, offlineId])
  @@index([tenantId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("proc_purchase_orders")
}

// ============================================================================
// PURCHASE ORDER ITEM
// Line items for PO
// ============================================================================
model ProcPurchaseOrderItem {
  id              String @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   ProcPurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Product reference (Core Product)
  productId   String
  productSku  String?
  productName String   // Snapshot

  // Quantity
  orderedQuantity   Decimal @db.Decimal(15, 4)
  receivedQuantity  Decimal @default(0) @db.Decimal(15, 4)
  pendingQuantity   Decimal @db.Decimal(15, 4)  // Computed: ordered - received
  unit              String  @default("UNIT")

  // Pricing
  unitPrice         Decimal @db.Decimal(15, 4)
  taxRate           Decimal @default(0) @db.Decimal(5, 4)  // e.g., 0.075 for 7.5%
  discount          Decimal @default(0) @db.Decimal(15, 2)
  lineTotal         Decimal @db.Decimal(15, 2)

  // Specs
  specifications    String? @db.Text
  notes             String?

  // Order
  lineNumber        Int

  // Fulfillment status
  isFulfilled       Boolean @default(false)

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("proc_purchase_order_items")
}

// ============================================================================
// GOODS RECEIPT
// Record of received goods (emits inventory events - does NOT mutate directly)
// ============================================================================
model ProcGoodsReceipt {
  id       String @id @default(uuid())
  tenantId String

  // Receipt identification
  receiptNumber String    // GR-2025-000001

  // Source
  purchaseOrderId String
  purchaseOrder   ProcPurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  // Status
  status        ProcGoodsReceiptStatus @default(PENDING)

  // Receipt info
  receivedDate  DateTime @default(now())
  receivedBy    String   // staffId
  locationId    String?  // Receiving location/warehouse

  // Supplier delivery reference
  deliveryNote  String?
  invoiceNumber String?
  invoiceDate   DateTime?

  // Quality check
  qualityCheckedBy  String?
  qualityCheckedAt  DateTime?
  qualityNotes      String? @db.Text

  // Event emission tracking
  inventoryEventEmitted Boolean @default(false)
  inventoryEventId      String?
  inventoryEventAt      DateTime?

  // Photos (Nigeria-first - receipt proof)
  photoUrls     Json?  // Array of URLs

  // Offline support
  offlineId     String?

  // Notes
  notes         String? @db.Text
  metadata      Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items ProcGoodsReceiptItem[]

  @@unique([tenantId, receiptNumber])
  @@unique([tenantId, offlineId])
  @@index([tenantId])
  @@index([purchaseOrderId])
  @@index([status])
  @@index([receivedDate])
  @@map("proc_goods_receipts")
}

// ============================================================================
// GOODS RECEIPT ITEM
// Line items for goods receipt
// ============================================================================
model ProcGoodsReceiptItem {
  id             String @id @default(uuid())
  goodsReceiptId String
  goodsReceipt   ProcGoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)

  // PO Item reference
  purchaseOrderItemId String

  // Product reference
  productId   String
  productSku  String?
  productName String

  // Quantities
  orderedQuantity    Decimal @db.Decimal(15, 4)
  receivedQuantity   Decimal @db.Decimal(15, 4)
  acceptedQuantity   Decimal @default(0) @db.Decimal(15, 4)
  rejectedQuantity   Decimal @default(0) @db.Decimal(15, 4)
  damagedQuantity    Decimal @default(0) @db.Decimal(15, 4)
  missingQuantity    Decimal @default(0) @db.Decimal(15, 4)
  unit               String  @default("UNIT")

  // Quality info
  qualityStatus      String?  // "PASS", "FAIL", "PARTIAL"
  qualityNotes       String?

  // Batch/lot tracking (optional)
  batchNumber        String?
  expiryDate         DateTime?
  serialNumbers      Json?    // Array for serialized items

  // Notes
  notes              String?

  @@index([goodsReceiptId])
  @@index([purchaseOrderItemId])
  @@index([productId])
  @@map("proc_goods_receipt_items")
}

// ============================================================================
// SUPPLIER PRICE LIST
// Track supplier pricing for products
// ============================================================================
model ProcSupplierPriceList {
  id       String @id @default(uuid())
  tenantId String

  // Supplier (Core reference)
  supplierId String

  // Product (Core reference)
  productId  String

  // Pricing
  unitPrice        Decimal @db.Decimal(15, 4)
  currency         String  @default("NGN")
  minOrderQuantity Decimal @default(1) @db.Decimal(15, 4)
  unit             String  @default("UNIT")

  // Validity
  validFrom        DateTime @default(now())
  validTo          DateTime?
  isActive         Boolean @default(true)

  // Lead time
  leadTimeDays     Int?

  // Notes
  notes            String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, supplierId, productId, validFrom])
  @@index([tenantId])
  @@index([supplierId])
  @@index([productId])
  @@index([isActive])
  @@map("proc_supplier_price_lists")
}

// ============================================================================
// SUPPLIER PERFORMANCE METRIC
// Track supplier delivery and quality performance
// ============================================================================
model ProcSupplierPerformance {
  id       String @id @default(uuid())
  tenantId String

  // Supplier (Core reference)
  supplierId String

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Order metrics
  totalOrders         Int @default(0)
  completedOrders     Int @default(0)
  cancelledOrders     Int @default(0)
  totalOrderValue     Decimal @default(0) @db.Decimal(15, 2)

  // Delivery metrics
  onTimeDeliveries    Int @default(0)
  lateDeliveries      Int @default(0)
  avgDeliveryDays     Decimal? @db.Decimal(5, 2)

  // Quality metrics
  totalItemsReceived  Int @default(0)
  acceptedItems       Int @default(0)
  rejectedItems       Int @default(0)
  damagedItems        Int @default(0)
  qualityScore        Decimal? @db.Decimal(5, 2)  // 0-100

  // Pricing metrics
  priceVariance       Decimal? @db.Decimal(5, 2)  // % from quoted

  // Overall score (0-100)
  overallScore        Decimal? @db.Decimal(5, 2)

  // Notes
  notes               String? @db.Text

  // Audit
  calculatedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, supplierId, periodStart, periodEnd])
  @@index([tenantId])
  @@index([supplierId])
  @@index([periodStart])
  @@map("proc_supplier_performance")
}

// ============================================================================
// PROCUREMENT EVENT LOG
// Audit trail for procurement actions
// ============================================================================
model ProcEventLog {
  id       String @id @default(uuid())
  tenantId String

  // Event info
  eventType   String    // PURCHASE_REQUEST_CREATED, PO_CONFIRMED, GOODS_RECEIVED, etc.
  eventData   Json

  // Entity reference
  entityType  String    // "PURCHASE_REQUEST", "PURCHASE_ORDER", "GOODS_RECEIPT"
  entityId    String

  // Actor
  actorId     String?
  actorType   String?   // "USER", "SYSTEM"

  // Timestamp
  occurredAt  DateTime @default(now())

  // Metadata
  metadata    Json?

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("proc_event_logs")
}

// ============================================================================
// MODULE 7: ANALYTICS & BUSINESS INTELLIGENCE
// Nigeria-first insights, decision support
// 
// This module OWNS:
// - Analytics models
// - Aggregations and metrics
// - Dashboards and reports
// - Forecasting logic (basic)
//
// This module DOES NOT OWN:
// - Order, Payment, Inventory, Customer, Wallet, Ledger (all read-only)
// 
// Key Principle: STRICTLY READ-ONLY. No data mutation occurs.
// All analytics are EVENT-DERIVED only.
// ============================================================================

// ============================================================================
// ANALYTICS CONFIGURATION
// ============================================================================
model AnalyticsConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Feature flags
  analyticsEnabled    Boolean @default(true)
  dashboardsEnabled   Boolean @default(true)
  reportsEnabled      Boolean @default(true)
  forecastingEnabled  Boolean @default(false)
  exportEnabled       Boolean @default(true)

  // Data retention
  snapshotRetentionDays Int @default(365)
  
  // Refresh settings
  autoRefreshEnabled  Boolean @default(true)
  refreshIntervalMins Int     @default(60)
  lastRefreshedAt     DateTime?

  // Nigeria-first settings
  defaultCurrency     String  @default("NGN")
  timezone            String  @default("Africa/Lagos")
  fiscalYearStart     Int     @default(1) // Month 1-12

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analytics_configurations")
}

// ============================================================================
// METRIC DEFINITION
// Defines what metrics are tracked
// ============================================================================
model AnalyticsMetricDefinition {
  id       String @id @default(uuid())
  tenantId String

  // Metric identification
  key         String    // total_sales, order_count, avg_order_value
  name        String    // Total Sales
  description String?
  category    String    // sales, inventory, customers, operations

  // Calculation
  aggregationType String   // SUM, COUNT, AVG, MIN, MAX
  sourceEvent     String   // SALE_COMPLETED, ORDER_CREATED
  sourceField     String?  // amount, quantity
  formula         String?  // Custom formula if needed

  // Display
  format      String  @default("number")  // number, currency, percentage
  unit        String? // e.g., "NGN", "%", "items"
  precision   Int     @default(2)

  // Status
  isSystem    Boolean @default(false)  // Built-in vs custom
  isActive    Boolean @default(true)

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  snapshots AnalyticsMetricSnapshot[]

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([category])
  @@map("analytics_metric_definitions")
}

// ============================================================================
// METRIC SNAPSHOT
// Time-series metric values
// ============================================================================
model AnalyticsMetricSnapshot {
  id       String @id @default(uuid())
  tenantId String

  // Metric reference
  metricId String
  metric   AnalyticsMetricDefinition @relation(fields: [metricId], references: [id], onDelete: Cascade)

  // Time period
  periodType  String    // HOUR, DAY, WEEK, MONTH, YEAR
  periodStart DateTime
  periodEnd   DateTime

  // Value
  value       Decimal  @db.Decimal(20, 4)
  count       Int      @default(1)  // For averaging

  // Dimensions (optional breakdown)
  dimensionKey   String?  // channel, location, product_category
  dimensionValue String?

  // Comparison
  previousValue  Decimal? @db.Decimal(20, 4)
  changePercent  Decimal? @db.Decimal(10, 4)

  // Metadata
  computedAt DateTime @default(now())

  @@unique([metricId, periodType, periodStart, dimensionKey, dimensionValue])
  @@index([tenantId])
  @@index([metricId])
  @@index([periodType, periodStart])
  @@map("analytics_metric_snapshots")
}

// ============================================================================
// DASHBOARD
// User-configurable dashboards
// ============================================================================
model AnalyticsDashboard {
  id       String @id @default(uuid())
  tenantId String

  // Dashboard info
  key         String    // business_overview, sales_performance
  name        String
  description String?
  
  // Layout
  layout      Json      // Grid positions for widgets

  // Status
  isSystem    Boolean @default(false)
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)

  // Access
  visibility  String  @default("TENANT")  // TENANT, USER

  // Metadata
  metadata Json?

  // Audit
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets AnalyticsDashboardWidget[]

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("analytics_dashboards")
}

// ============================================================================
// DASHBOARD WIDGET
// Individual widget on a dashboard
// ============================================================================
model AnalyticsDashboardWidget {
  id          String @id @default(uuid())
  dashboardId String
  dashboard   AnalyticsDashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  // Widget info
  title       String
  type        String   // card, line_chart, bar_chart, pie_chart, table

  // Data source
  metricKeys  Json     // Array of metric keys to display
  dimensions  Json?    // Optional dimensions for breakdown

  // Display config
  config      Json     // Chart options, colors, etc.

  // Position
  gridX       Int
  gridY       Int
  gridW       Int
  gridH       Int

  // Status
  isActive    Boolean @default(true)

  // Order
  sortOrder   Int     @default(0)

  @@index([dashboardId])
  @@map("analytics_dashboard_widgets")
}

// ============================================================================
// REPORT DEFINITION
// Scheduled and on-demand reports
// ============================================================================
model AnalyticsReportDefinition {
  id       String @id @default(uuid())
  tenantId String

  // Report info
  key         String
  name        String
  description String?
  category    String   // sales, inventory, financial, operational

  // Content
  metricKeys  Json     // Metrics to include
  dimensions  Json?    // Breakdown dimensions
  filters     Json?    // Default filters

  // Format
  format      String   @default("PDF")  // PDF, CSV, EXCEL

  // Schedule
  isScheduled Boolean  @default(false)
  schedule    String?  // Cron expression
  recipients  Json?    // Email addresses

  // Status
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)

  // Metadata
  metadata Json?

  // Audit
  lastGeneratedAt DateTime?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("analytics_report_definitions")
}

// ============================================================================
// INSIGHT
// AI/Rule-based insights and recommendations
// ============================================================================
model AnalyticsInsight {
  id       String @id @default(uuid())
  tenantId String

  // Insight identification
  type        String   // low_stock_alert, sales_trend, customer_churn_risk
  title       String
  description String   @db.Text
  severity    String   // info, warning, critical
  category    String   // inventory, sales, customers, operations

  // Data
  data        Json     // Relevant data points
  
  // Actions
  suggestedAction String?   @db.Text
  actionUrl       String?

  // Status
  status      String   @default("NEW")  // NEW, ACKNOWLEDGED, RESOLVED, DISMISSED
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedAt     DateTime?

  // Validity
  validUntil  DateTime?
  
  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([severity])
  @@map("analytics_insights")
}

// ============================================================================
// ANALYTICS EVENT LOG
// Track processed events for idempotency
// ============================================================================
model AnalyticsEventLog {
  id       String @id @default(uuid())
  tenantId String

  // Event reference
  sourceModule  String   // pos, svm, mvm, inventory, crm
  eventType     String   // SALE_COMPLETED, ORDER_CREATED
  eventId       String   // Original event ID
  eventData     Json

  // Processing
  processedAt   DateTime @default(now())
  metricsUpdated Json?   // List of metrics updated

  @@unique([tenantId, sourceModule, eventId])
  @@index([tenantId])
  @@index([eventType])
  @@index([processedAt])
  @@map("analytics_event_logs")
}

// ============================================================================
// MODULE 8: MARKETING AUTOMATION
// Nigeria-first growth automation without complexity
// 
// This module OWNS:
// - Automation workflows
// - Triggers and conditions
// - Scheduling logic
// - Automation state tracking
//
// This module DOES NOT OWN:
// - Customer, Campaign, Message, Notification, Segment (Core/CRM owns)
// 
// CRITICAL: No direct messaging. All message delivery delegated to Core.
// ============================================================================

// ============================================================================
// MARKETING AUTOMATION ENUMS
// ============================================================================

enum MktAutomationStatus {
  DRAFT           // Not active
  ACTIVE          // Running
  PAUSED          // Temporarily stopped
  COMPLETED       // Finished (for one-time)
  ARCHIVED        // No longer used
}

enum MktTriggerType {
  EVENT           // Event-based (customer_created, order_completed)
  TIME            // Time-based (birthday, anniversary)
  CONDITION       // Condition-based (inactivity)
  MANUAL          // Manually triggered
}

enum MktActionType {
  SEND_MESSAGE    // Delegate to Core Communication Engine
  APPLY_TAG       // Tag customer
  AWARD_POINTS    // Delegate to CRM Loyalty
  INTERNAL_NOTIFY // Internal notification
  WAIT            // Delay action
}

enum MktRunStatus {
  PENDING         // Waiting to execute
  RUNNING         // Currently executing
  COMPLETED       // Successfully completed
  FAILED          // Execution failed
  SKIPPED         // Skipped (conditions not met)
  CANCELLED       // Cancelled
}

// ============================================================================
// MARKETING CONFIGURATION
// ============================================================================
model MktConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Feature flags
  automationEnabled    Boolean @default(true)
  smsAutomation        Boolean @default(true)
  emailAutomation      Boolean @default(true)
  pushAutomation       Boolean @default(false)

  // Throttling
  maxMessagesPerDay    Int @default(100)
  maxMessagesPerCustomer Int @default(3)
  quietHoursStart      Int? // Hour 0-23
  quietHoursEnd        Int?

  // Nigeria-first settings
  defaultChannel       String  @default("SMS")
  smsFirst             Boolean @default(true)

  // Defaults
  timezone             String  @default("Africa/Lagos")

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("mkt_configurations")
}

// ============================================================================
// AUTOMATION WORKFLOW
// Main automation definition
// ============================================================================
model MktAutomationWorkflow {
  id       String @id @default(uuid())
  tenantId String

  // Workflow info
  name        String
  description String? @db.Text
  
  // Status
  status      MktAutomationStatus @default(DRAFT)

  // Schedule
  isRecurring Boolean @default(true)
  startDate   DateTime?
  endDate     DateTime?

  // Template (for prebuilt)
  templateKey String?
  isTemplate  Boolean @default(false)

  // Statistics
  totalRuns       Int @default(0)
  successfulRuns  Int @default(0)
  failedRuns      Int @default(0)
  lastRunAt       DateTime?

  // Offline support
  offlineId   String?

  // Metadata
  metadata Json?

  // Audit
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  triggers  MktAutomationTrigger[]
  actions   MktAutomationAction[]
  runs      MktAutomationRun[]

  @@unique([tenantId, offlineId])
  @@index([tenantId])
  @@index([status])
  @@map("mkt_automation_workflows")
}

// ============================================================================
// AUTOMATION TRIGGER
// What starts the automation
// ============================================================================
model MktAutomationTrigger {
  id         String @id @default(uuid())
  workflowId String
  workflow   MktAutomationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Trigger type
  type       MktTriggerType
  eventName  String?   // For EVENT type: CUSTOMER_CREATED, ORDER_COMPLETED

  // Conditions (JSON for flexibility)
  conditions Json?     // e.g., { "segmentId": "abc", "minOrderAmount": 1000 }

  // Time-based
  scheduleType String? // BIRTHDAY, ANNIVERSARY, INACTIVITY
  scheduleDays Int?    // Days before/after or inactivity days

  // Order
  sortOrder Int @default(0)

  // Active
  isActive  Boolean @default(true)

  @@index([workflowId])
  @@map("mkt_automation_triggers")
}

// ============================================================================
// AUTOMATION ACTION
// What to do when triggered
// ============================================================================
model MktAutomationAction {
  id         String @id @default(uuid())
  workflowId String
  workflow   MktAutomationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Action type
  type       MktActionType

  // Configuration (JSON for flexibility)
  config     Json    // Channel, template, points, etc.

  // Delay
  delayMinutes Int @default(0)

  // Order
  sortOrder Int @default(0)

  // Active
  isActive  Boolean @default(true)

  @@index([workflowId])
  @@map("mkt_automation_actions")
}

// ============================================================================
// AUTOMATION RUN
// Individual execution of automation
// ============================================================================
model MktAutomationRun {
  id         String @id @default(uuid())
  tenantId   String
  workflowId String
  workflow   MktAutomationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Target
  customerId String?
  customerPhone String?

  // Trigger info
  triggeredBy   String   // Event ID or "SCHEDULE"
  triggerData   Json?

  // Status
  status        MktRunStatus @default(PENDING)

  // Execution
  startedAt     DateTime?
  completedAt   DateTime?
  errorMessage  String?

  // Action results
  actionsExecuted Int @default(0)
  actionResults   Json?

  // Handoff tracking
  coreRequestId String?  // Communication Engine request ID

  // Metadata
  metadata Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([workflowId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("mkt_automation_runs")
}

// ============================================================================
// AUTOMATION LOG
// Audit trail
// ============================================================================
model MktAutomationLog {
  id       String @id @default(uuid())
  tenantId String

  // Event
  eventType  String
  eventData  Json

  // References
  workflowId String?
  runId      String?
  customerId String?

  // Actor
  actorId   String?
  actorType String?

  // Timestamp
  occurredAt DateTime @default(now())

  @@index([tenantId])
  @@index([workflowId])
  @@index([runId])
  @@index([occurredAt])
  @@map("mkt_automation_logs")
}

// ============================================================================
// MODULE 9: B2B & WHOLESALE
// Nigeria-first bulk trading, credit, and negotiated pricing
// ============================================================================

// ============================================================================
// B2B CONFIGURATION
// Tenant-level B2B settings
// ============================================================================
model B2BConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Core settings
  b2bEnabled           Boolean @default(true)
  wholesalePricing     Boolean @default(true)
  creditSalesEnabled   Boolean @default(false)
  bulkOrderingEnabled  Boolean @default(true)
  
  // Defaults
  defaultCreditDays    Int     @default(30)
  defaultCreditLimit   Decimal @default(0) @db.Decimal(12, 2)
  defaultMinOrderValue Decimal @default(0) @db.Decimal(12, 2)
  defaultCurrency      String  @default("NGN")
  
  // Tax settings
  wholesaleTaxExempt   Boolean @default(false)
  vatRate              Decimal @default(7.5) @db.Decimal(5, 2)
  
  // Approval settings
  creditApprovalRequired   Boolean @default(true)
  autoApproveBelow         Decimal @default(0) @db.Decimal(12, 2)
  
  // Nigeria-first
  negotiatedPricingEnabled Boolean @default(true)
  manualOverrideEnabled    Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("b2b_configurations")
}

// ============================================================================
// B2B CUSTOMER PROFILE
// Extended B2B info for Core customers (does NOT duplicate Customer)
// ============================================================================
model B2BCustomerProfile {
  id       String @id @default(uuid())
  tenantId String
  
  // Core customer reference (NOT duplicated)
  customerId String @unique
  
  // B2B Classification
  isB2B           Boolean @default(true)
  customerType    B2BCustomerType @default(RETAILER)
  businessName    String?
  businessRegNo   String?  // CAC number for Nigeria
  taxId           String?  // TIN for Nigeria
  
  // Contact
  primaryContact  String?
  primaryPhone    String?
  primaryEmail    String?
  
  // Address
  businessAddress Json?
  
  // Pricing
  priceTierId     String?
  priceTier       B2BPriceTier? @relation(fields: [priceTierId], references: [id])
  
  // Credit
  creditTermId    String?
  creditTerm      B2BCreditTerm? @relation(fields: [creditTermId], references: [id])
  creditLimit     Decimal @default(0) @db.Decimal(12, 2)
  creditUsed      Decimal @default(0) @db.Decimal(12, 2)
  creditStatus    B2BCreditStatus @default(ACTIVE)
  
  // Preferences
  preferredPaymentMethod  String?
  preferredShippingMethod String?
  
  // Nigeria-first
  allowCashPurchase   Boolean @default(true)
  allowCreditPurchase Boolean @default(false)
  
  // Status
  status           B2BProfileStatus @default(ACTIVE)
  verifiedAt       DateTime?
  verifiedBy       String?
  
  // Metadata
  notes     String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoices     B2BInvoice[]
  creditLedger B2BCreditLedger[]
  bulkOrders   B2BBulkOrderDraft[]

  @@unique([tenantId, customerId])
  @@index([tenantId])
  @@index([customerId])
  @@index([priceTierId])
  @@index([status])
  @@map("b2b_customer_profiles")
}

enum B2BCustomerType {
  RETAILER
  DISTRIBUTOR
  WHOLESALER
  AGENT
  RESELLER
  OTHER
}

enum B2BCreditStatus {
  ACTIVE
  SUSPENDED
  EXCEEDED
  BLOCKED
}

enum B2BProfileStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

// ============================================================================
// B2B PRICE TIER
// Customer groupings for pricing
// ============================================================================
model B2BPriceTier {
  id       String @id @default(uuid())
  tenantId String
  
  // Tier info
  name        String
  code        String
  description String?
  
  // Discount settings
  defaultDiscount   Decimal @default(0) @db.Decimal(5, 2) // Percentage
  discountType      B2BDiscountType @default(PERCENTAGE)
  
  // Order requirements
  minOrderValue     Decimal @default(0) @db.Decimal(12, 2)
  minOrderQuantity  Int     @default(1)
  
  // Priority (higher = better pricing)
  priority Int @default(0)
  
  // Status
  isActive Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customers  B2BCustomerProfile[]
  priceRules B2BWholesalePriceRule[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("b2b_price_tiers")
}

enum B2BDiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  TIERED_QUANTITY
}

// ============================================================================
// B2B WHOLESALE PRICE RULE
// Product-specific or category-specific wholesale pricing
// ============================================================================
model B2BWholesalePriceRule {
  id       String @id @default(uuid())
  tenantId String
  
  // Scope
  productId    String?  // Specific product (Core Product reference)
  categoryId   String?  // Category-wide
  priceTierId  String?  // For specific tier
  priceTier    B2BPriceTier? @relation(fields: [priceTierId], references: [id])
  
  // Rule name
  name        String
  description String?
  
  // Pricing
  priceType      B2BPriceType @default(DISCOUNT_PERCENTAGE)
  value          Decimal @db.Decimal(12, 2) // Amount or percentage
  
  // Quantity breaks (JSON array of {minQty, price/discount})
  quantityBreaks Json?
  
  // Validity
  validFrom    DateTime?
  validTo      DateTime?
  
  // Priority
  priority Int @default(0)
  
  // Status
  isActive Boolean @default(true)
  
  // Audit
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([productId])
  @@index([categoryId])
  @@index([priceTierId])
  @@index([isActive])
  @@map("b2b_wholesale_price_rules")
}

enum B2BPriceType {
  FIXED_PRICE
  DISCOUNT_PERCENTAGE
  DISCOUNT_AMOUNT
  TIERED_PRICE
}

// ============================================================================
// B2B CREDIT TERM
// Credit policies for B2B customers
// ============================================================================
model B2BCreditTerm {
  id       String @id @default(uuid())
  tenantId String
  
  // Term info
  name        String
  code        String
  description String?
  
  // Credit settings
  creditDays     Int     @default(30)  // Net 30, Net 60, etc.
  creditLimit    Decimal @default(0) @db.Decimal(12, 2)
  gracePeriod    Int     @default(0)   // Extra days before penalty
  
  // Penalties
  lateFeeType    B2BLateFeeType @default(NONE)
  lateFeeValue   Decimal @default(0) @db.Decimal(5, 2)
  
  // Deposit requirement
  depositRequired    Boolean @default(false)
  depositPercent     Decimal @default(0) @db.Decimal(5, 2)
  
  // Status
  isActive Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customers B2BCustomerProfile[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("b2b_credit_terms")
}

enum B2BLateFeeType {
  NONE
  FIXED
  PERCENTAGE_DAILY
  PERCENTAGE_TOTAL
}

// ============================================================================
// B2B CREDIT LEDGER
// Append-only credit history
// ============================================================================
model B2BCreditLedger {
  id       String @id @default(uuid())
  tenantId String
  
  // Customer
  profileId String
  profile   B2BCustomerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Transaction
  transactionType   B2BCreditTransactionType
  amount            Decimal @db.Decimal(12, 2)
  balanceBefore     Decimal @db.Decimal(12, 2)
  balanceAfter      Decimal @db.Decimal(12, 2)
  
  // Reference
  referenceType     String?   // ORDER, PAYMENT, ADJUSTMENT, etc.
  referenceId       String?   // Order ID, Payment ID, etc.
  invoiceId         String?
  invoice           B2BInvoice? @relation(fields: [invoiceId], references: [id])
  
  // Details
  description       String?
  
  // Due date (for charges)
  dueDate           DateTime?
  
  // Audit
  performedBy       String?
  performedAt       DateTime @default(now())
  notes             String?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([profileId])
  @@index([invoiceId])
  @@index([transactionType])
  @@index([createdAt])
  @@map("b2b_credit_ledger")
}

enum B2BCreditTransactionType {
  CREDIT_GRANTED     // Credit limit increase
  CREDIT_REDUCED     // Credit limit decrease
  PURCHASE           // Credit used for purchase
  PAYMENT            // Payment received
  REFUND             // Refund processed
  ADJUSTMENT         // Manual adjustment
  LATE_FEE           // Late fee charged
  WRITE_OFF          // Bad debt written off
}

// ============================================================================
// B2B INVOICE
// Record-only invoices (no payment execution)
// ============================================================================
model B2BInvoice {
  id       String @id @default(uuid())
  tenantId String
  
  // Invoice number
  invoiceNumber String
  
  // Customer
  profileId String
  profile   B2BCustomerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Order reference (Core Order)
  orderId     String?
  orderNumber String?
  
  // Amounts
  subtotal      Decimal @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  taxTotal      Decimal @default(0) @db.Decimal(12, 2)
  totalAmount   Decimal @db.Decimal(12, 2)
  
  // Payment
  amountPaid    Decimal @default(0) @db.Decimal(12, 2)
  amountDue     Decimal @db.Decimal(12, 2)
  
  // Dates
  invoiceDate   DateTime @default(now())
  dueDate       DateTime
  paidDate      DateTime?
  
  // Status
  status        B2BInvoiceStatus @default(DRAFT)
  
  // Payment terms
  creditTermId  String?
  paymentTerms  String?
  
  // Line items (JSON)
  lineItems     Json?
  
  // Notes
  notes         String?
  internalNotes String?
  
  // Audit
  createdBy     String?
  approvedBy    String?
  approvedAt    DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creditEntries B2BCreditLedger[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([profileId])
  @@index([orderId])
  @@index([status])
  @@index([dueDate])
  @@map("b2b_invoices")
}

enum B2BInvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  DISPUTED
}

// ============================================================================
// B2B BULK ORDER DRAFT
// Bulk ordering workflow
// ============================================================================
model B2BBulkOrderDraft {
  id       String @id @default(uuid())
  tenantId String
  
  // Customer
  profileId String
  profile   B2BCustomerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Draft info
  name        String?
  description String?
  
  // Items (JSON array)
  items       Json
  
  // Totals (calculated)
  itemCount     Int     @default(0)
  subtotal      Decimal @default(0) @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  estimatedTotal Decimal @default(0) @db.Decimal(12, 2)
  
  // Status
  status        B2BBulkOrderStatus @default(DRAFT)
  
  // Pricing snapshot
  pricingSnapshot Json?  // Capture pricing at time of submission
  
  // Conversion
  convertedOrderId String?  // Core Order ID when converted
  convertedAt      DateTime?
  
  // Offline support
  offlineId     String?
  
  // Audit
  createdBy     String?
  submittedBy   String?
  submittedAt   DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, offlineId])
  @@index([tenantId])
  @@index([profileId])
  @@index([status])
  @@index([createdAt])
  @@map("b2b_bulk_order_drafts")
}

enum B2BBulkOrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CONVERTED
  CANCELLED
  EXPIRED
}

// ============================================================================
// B2B EVENT LOG
// Audit trail for B2B actions
// ============================================================================
model B2BEventLog {
  id       String @id @default(uuid())
  tenantId String

  // Event
  eventType  String
  eventData  Json

  // References
  profileId  String?
  invoiceId  String?
  orderId    String?

  // Actor
  actorId   String?
  actorType String?

  // Timestamp
  occurredAt DateTime @default(now())

  @@index([tenantId])
  @@index([profileId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("b2b_event_logs")
}

// ============================================================================
// MODULE 10: PAYMENTS & WALLETS
// Nigeria-first, cash + digital, auditable money layer
// THE ONLY place where money actually moves
// ============================================================================

// ============================================================================
// PAYMENT CONFIGURATION
// Tenant-level payment settings
// ============================================================================
model PayConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Core settings
  paymentsEnabled      Boolean @default(true)
  walletsEnabled       Boolean @default(true)
  refundsEnabled       Boolean @default(true)
  
  // Currency
  defaultCurrency      String  @default("NGN")
  supportedCurrencies  Json    @default("[\"NGN\"]")
  
  // Payment methods
  cashEnabled          Boolean @default(true)
  cardEnabled          Boolean @default(false)
  bankTransferEnabled  Boolean @default(true)
  mobileMoneyEnabled   Boolean @default(false)
  
  // Gateway settings
  paystackEnabled      Boolean @default(false)
  paystackPublicKey    String?
  paystackSecretKey    String?
  flutterwaveEnabled   Boolean @default(false)
  flutterwavePublicKey String?
  flutterwaveSecretKey String?
  
  // Settlement
  autoSettlement       Boolean @default(false)
  settlementSchedule   String  @default("MANUAL") // MANUAL, DAILY, WEEKLY
  settlementThreshold  Decimal @default(0) @db.Decimal(12, 2)
  
  // Vendor payouts (MVM)
  vendorPayoutsEnabled Boolean @default(false)
  platformCommission   Decimal @default(0) @db.Decimal(5, 2) // Percentage
  
  // Offline
  offlineCashEnabled   Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pay_configurations")
}

// ============================================================================
// WALLET
// Single source of truth for balances
// ============================================================================
model PayWallet {
  id       String @id @default(uuid())
  tenantId String

  // Owner (one of these must be set)
  ownerType     PayWalletOwnerType
  ownerId       String?    // customerId, vendorId, or null for platform
  
  // Identity
  walletNumber  String     // Human-readable
  name          String?
  
  // Currency
  currency      String @default("NGN")
  
  // Balances (derived from transactions)
  balance          Decimal @default(0) @db.Decimal(12, 2)  // Available
  pendingBalance   Decimal @default(0) @db.Decimal(12, 2)  // Held/pending
  totalBalance     Decimal @default(0) @db.Decimal(12, 2)  // Available + pending
  
  // Limits
  dailyLimit       Decimal? @db.Decimal(12, 2)
  monthlyLimit     Decimal? @db.Decimal(12, 2)
  minBalance       Decimal @default(0) @db.Decimal(12, 2)
  
  // Status
  status           PayWalletStatus @default(ACTIVE)
  suspendedAt      DateTime?
  suspendedReason  String?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transactions PayWalletTransaction[]
  settlements  PaySettlement[]
  payouts      PayPayoutRequest[]

  @@unique([tenantId, ownerType, ownerId, currency])
  @@unique([tenantId, walletNumber])
  @@index([tenantId])
  @@index([ownerType, ownerId])
  @@index([status])
  @@map("pay_wallets")
}

enum PayWalletOwnerType {
  BUSINESS   // Tenant's main wallet
  VENDOR     // MVM vendor wallet
  CUSTOMER   // Customer wallet (optional)
  PLATFORM   // Platform fees wallet
}

enum PayWalletStatus {
  ACTIVE
  SUSPENDED
  FROZEN
  CLOSED
}

// ============================================================================
// WALLET TRANSACTION
// Immutable, append-only money movements
// ============================================================================
model PayWalletTransaction {
  id       String @id @default(uuid())
  tenantId String
  
  // Wallet
  walletId String
  wallet   PayWallet @relation(fields: [walletId], references: [id])
  
  // Transaction
  transactionNumber String
  type              PayTransactionType
  direction         PayTransactionDirection
  
  // Amount
  amount            Decimal @db.Decimal(12, 2)
  currency          String  @default("NGN")
  
  // Balance snapshot (for reconciliation)
  balanceBefore     Decimal @db.Decimal(12, 2)
  balanceAfter      Decimal @db.Decimal(12, 2)
  
  // Reference
  referenceType     String?   // ORDER, REFUND, SETTLEMENT, PAYOUT, etc.
  referenceId       String?
  
  // Related entities
  paymentId         String?
  payment           PayPaymentTransaction? @relation(fields: [paymentId], references: [id])
  settlementId      String?
  payoutId          String?
  
  // Description
  description       String?
  
  // Status
  status            PayTxStatus @default(COMPLETED)
  
  // Audit
  performedBy       String?
  performedAt       DateTime @default(now())
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  // Never updated - immutable
  @@unique([tenantId, transactionNumber])
  @@index([tenantId])
  @@index([walletId])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("pay_wallet_transactions")
}

enum PayTransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT_RECEIVED
  PAYMENT_MADE
  REFUND_RECEIVED
  REFUND_MADE
  SETTLEMENT
  PAYOUT
  COMMISSION
  FEE
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
}

enum PayTransactionDirection {
  CREDIT
  DEBIT
}

enum PayTxStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

// ============================================================================
// PAYMENT INTENT
// Pre-payment authorization
// ============================================================================
model PayPaymentIntent {
  id       String @id @default(uuid())
  tenantId String
  
  // Intent ID (public)
  intentId String @unique
  
  // Amount
  amount            Decimal @db.Decimal(12, 2)
  currency          String  @default("NGN")
  
  // Order reference
  orderId           String?
  orderNumber       String?
  
  // Customer
  customerId        String?
  customerEmail     String?
  customerPhone     String?
  
  // Payment method
  paymentMethod     PayPaymentMethod?
  methodDetails     Json?
  
  // Gateway
  gatewayProvider   String?
  gatewayReference  String?
  gatewayResponse   Json?
  
  // Status
  status            PayIntentStatus @default(CREATED)
  
  // Expiry
  expiresAt         DateTime?
  
  // Result
  paymentId         String?  // Created payment transaction
  
  // Idempotency
  idempotencyKey    String?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId])
  @@index([orderId])
  @@index([customerId])
  @@index([status])
  @@index([gatewayReference])
  @@map("pay_payment_intents")
}

enum PayIntentStatus {
  CREATED
  PROCESSING
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  CANCELLED
  EXPIRED
}

enum PayPaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MOBILE_MONEY
  WALLET
  POS_TERMINAL
}

// ============================================================================
// PAYMENT TRANSACTION
// Executed payments
// ============================================================================
model PayPaymentTransaction {
  id       String @id @default(uuid())
  tenantId String
  
  // Transaction number
  transactionNumber String
  
  // Intent
  intentId          String?
  
  // Amount
  amount            Decimal @db.Decimal(12, 2)
  currency          String  @default("NGN")
  
  // Fees
  gatewayFee        Decimal @default(0) @db.Decimal(12, 2)
  platformFee       Decimal @default(0) @db.Decimal(12, 2)
  netAmount         Decimal @db.Decimal(12, 2)
  
  // Order reference
  orderId           String?
  orderNumber       String?
  
  // Customer
  customerId        String?
  customerEmail     String?
  customerPhone     String?
  
  // Payment details
  paymentMethod     PayPaymentMethod
  methodDetails     Json?
  
  // Gateway
  gatewayProvider   String?
  gatewayReference  String?
  gatewayResponse   Json?
  
  // Destination wallet
  destinationWalletId String?
  
  // Status
  status            PayPaymentStatus @default(PENDING)
  statusMessage     String?
  
  // Timestamps
  confirmedAt       DateTime?
  failedAt          DateTime?
  
  // Idempotency
  idempotencyKey    String?
  
  // Audit
  processedBy       String?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  walletTransactions PayWalletTransaction[]
  refunds           PayRefund[]
  settlementItems   PaySettlementItem[]

  @@unique([tenantId, transactionNumber])
  @@unique([tenantId, idempotencyKey])
  @@index([tenantId])
  @@index([orderId])
  @@index([customerId])
  @@index([status])
  @@index([gatewayReference])
  @@index([createdAt])
  @@map("pay_payment_transactions")
}

enum PayPaymentStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

// ============================================================================
// REFUND
// Immutable refund records
// ============================================================================
model PayRefund {
  id       String @id @default(uuid())
  tenantId String
  
  // Refund number
  refundNumber String
  
  // Original payment
  paymentId String
  payment   PayPaymentTransaction @relation(fields: [paymentId], references: [id])
  
  // Amount
  amount    Decimal @db.Decimal(12, 2)
  currency  String  @default("NGN")
  
  // Reason
  reason    PayRefundReason
  notes     String?
  
  // Gateway
  gatewayReference  String?
  gatewayResponse   Json?
  
  // Status
  status    PayRefundStatus @default(PENDING)
  
  // Destination
  refundMethod      PayRefundMethod @default(ORIGINAL_METHOD)
  
  // Timestamps
  processedAt       DateTime?
  failedAt          DateTime?
  
  // Audit
  requestedBy       String?
  approvedBy        String?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, refundNumber])
  @@index([tenantId])
  @@index([paymentId])
  @@index([status])
  @@map("pay_refunds")
}

enum PayRefundReason {
  CUSTOMER_REQUEST
  ORDER_CANCELLED
  DUPLICATE_PAYMENT
  FRAUD
  OTHER
}

enum PayRefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  FAILED
  REJECTED
}

enum PayRefundMethod {
  ORIGINAL_METHOD
  WALLET
  BANK_TRANSFER
  CASH
}

// ============================================================================
// SETTLEMENT
// Vendor settlements (MVM)
// ============================================================================
model PaySettlement {
  id       String @id @default(uuid())
  tenantId String
  
  // Settlement number
  settlementNumber String
  
  // Vendor wallet
  walletId String
  wallet   PayWallet @relation(fields: [walletId], references: [id])
  
  // Period
  periodStart DateTime
  periodEnd   DateTime
  
  // Amounts
  grossAmount       Decimal @db.Decimal(12, 2)
  commissionAmount  Decimal @db.Decimal(12, 2)
  feeAmount         Decimal @db.Decimal(12, 2)
  refundAmount      Decimal @db.Decimal(12, 2)
  netAmount         Decimal @db.Decimal(12, 2)
  
  // Items
  itemCount         Int @default(0)
  
  // Status
  status    PaySettlementStatus @default(PENDING)
  
  // Processing
  processedAt       DateTime?
  paidAt            DateTime?
  payoutId          String?
  
  // Audit
  createdBy         String?
  approvedBy        String?
  approvedAt        DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items PaySettlementItem[]

  @@unique([tenantId, settlementNumber])
  @@index([tenantId])
  @@index([walletId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("pay_settlements")
}

enum PaySettlementStatus {
  PENDING
  CALCULATED
  APPROVED
  PROCESSING
  PAID
  FAILED
}

model PaySettlementItem {
  id       String @id @default(uuid())
  
  // Settlement
  settlementId String
  settlement   PaySettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  
  // Payment
  paymentId String
  payment   PayPaymentTransaction @relation(fields: [paymentId], references: [id])
  
  // Amounts
  grossAmount       Decimal @db.Decimal(12, 2)
  commissionAmount  Decimal @db.Decimal(12, 2)
  netAmount         Decimal @db.Decimal(12, 2)
  
  createdAt DateTime @default(now())

  @@index([settlementId])
  @@index([paymentId])
  @@map("pay_settlement_items")
}

// ============================================================================
// PAYOUT REQUEST
// Withdrawal requests from wallet
// ============================================================================
model PayPayoutRequest {
  id       String @id @default(uuid())
  tenantId String
  
  // Payout number
  payoutNumber String
  
  // Source wallet
  walletId String
  wallet   PayWallet @relation(fields: [walletId], references: [id])
  
  // Amount
  amount    Decimal @db.Decimal(12, 2)
  currency  String  @default("NGN")
  
  // Fee
  fee       Decimal @default(0) @db.Decimal(12, 2)
  netAmount Decimal @db.Decimal(12, 2)
  
  // Destination
  payoutMethod      PayPayoutMethod
  bankName          String?
  bankCode          String?
  accountNumber     String?
  accountName       String?
  
  // Status
  status    PayPayoutStatus @default(PENDING)
  
  // Processing
  gatewayReference  String?
  gatewayResponse   Json?
  processedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?
  
  // Audit
  requestedBy       String?
  approvedBy        String?
  approvedAt        DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, payoutNumber])
  @@index([tenantId])
  @@index([walletId])
  @@index([status])
  @@map("pay_payout_requests")
}

enum PayPayoutMethod {
  BANK_TRANSFER
  MOBILE_MONEY
  CASH
}

enum PayPayoutStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  FAILED
  REJECTED
}

// ============================================================================
// PAYMENT EVENT LOG
// Audit trail for payment actions
// ============================================================================
model PayEventLog {
  id       String @id @default(uuid())
  tenantId String

  // Event
  eventType  String
  eventData  Json

  // References
  walletId    String?
  paymentId   String?
  refundId    String?
  settlementId String?
  payoutId    String?

  // Actor
  actorId   String?
  actorType String?

  // Timestamp
  occurredAt DateTime @default(now())

  @@index([tenantId])
  @@index([walletId])
  @@index([paymentId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("pay_event_logs")
}

// ============================================================================
// MODULE 11: PARTNER & RESELLER PLATFORM
// Digital Transformation Partners for eMarketWaka
// Partners operate in a parallel plane, NOT inside tenancy
// ============================================================================

// ============================================================================
// PARTNER CONFIGURATION
// Platform-level partner program settings
// ============================================================================
model PartnerConfiguration {
  id       String @id @default(uuid())
  
  // Program settings
  programEnabled      Boolean @default(true)
  autoApproval        Boolean @default(false)
  minPayoutThreshold  Decimal @default(10000) @db.Decimal(12, 2) // NGN
  defaultCommission   Decimal @default(10) @db.Decimal(5, 2) // Percentage
  
  // Attribution settings
  attributionWindow   Int     @default(30) // Days
  cookieDuration      Int     @default(30) // Days
  attributionLock     Boolean @default(true) // Once set, cannot be changed
  
  // Verification
  verificationRequired Boolean @default(true)
  manualVerification   Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("partner_configurations")
}

// ============================================================================
// PARTNER
// Partner identity - global, NOT tenant-scoped
// ============================================================================
model Partner {
  id       String @id @default(uuid())
  
  // Identity
  partnerCode   String @unique
  type          PartnerType @default(INDIVIDUAL)
  
  // Contact
  fullName      String
  email         String @unique
  phone         String?
  
  // Company (for COMPANY type)
  companyName   String?
  companyRegNo  String?  // CAC number for Nigeria
  taxId         String?  // TIN for Nigeria
  
  // Address
  address       Json?
  
  // Banking (for payouts)
  bankName      String?
  bankCode      String?
  accountNumber String?
  accountName   String?
  
  // Status
  status        PartnerStatus @default(PENDING)
  verifiedAt    DateTime?
  verifiedBy    String?
  
  // Metrics (cached for performance)
  totalReferrals      Int     @default(0)
  totalEarnings       Decimal @default(0) @db.Decimal(12, 2)
  pendingEarnings     Decimal @default(0) @db.Decimal(12, 2)
  
  // Metadata
  notes     String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile          PartnerProfile?
  verification     PartnerVerification?
  referralLinks    PartnerReferralLink[]
  attributions     PartnerAttribution[]
  commissionRules  PartnerCommissionRule[]
  commissionRecords PartnerCommissionRecord[]

  @@index([email])
  @@index([status])
  @@index([partnerCode])
  @@map("partners")
}

enum PartnerType {
  INDIVIDUAL
  COMPANY
  CONSULTANT
  AGENCY
  RESELLER
}

enum PartnerStatus {
  PENDING       // Awaiting verification
  VERIFIED      // Verified, awaiting approval
  ACTIVE        // Approved and active
  SUSPENDED     // Temporarily suspended
  REJECTED      // Application rejected
  INACTIVE      // Voluntarily inactive
}

// ============================================================================
// PARTNER PROFILE
// Extended partner information
// ============================================================================
model PartnerProfile {
  id       String @id @default(uuid())
  
  // Partner reference
  partnerId String @unique
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Bio
  bio           String?
  website       String?
  linkedinUrl   String?
  
  // Expertise
  industries    String[] @default([])
  specialties   String[] @default([])
  languages     String[] @default(["en"])
  
  // Capacity
  teamSize      Int?
  yearsExperience Int?
  
  // Nigeria-specific
  servicesOffered String[] @default([]) // Implementation, training, support, etc.
  regionsServed   String[] @default([]) // Lagos, Abuja, etc.
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("partner_profiles")
}

// ============================================================================
// PARTNER VERIFICATION
// Verification workflow tracking
// ============================================================================
model PartnerVerification {
  id       String @id @default(uuid())
  
  // Partner reference
  partnerId String @unique
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Documents
  documentType    String?  // NIN, BVN, CAC, etc.
  documentNumber  String?
  documentUrl     String?
  
  // Verification status
  status          VerificationStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?
  
  // Rejection
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  
  // Audit
  attempts        Int @default(0)
  lastAttemptAt   DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("partner_verifications")
}

enum VerificationStatus {
  PENDING
  IN_REVIEW
  VERIFIED
  REJECTED
  EXPIRED
}

// ============================================================================
// PARTNER REFERRAL LINK
// Unique referral tracking links
// ============================================================================
model PartnerReferralLink {
  id       String @id @default(uuid())
  
  // Partner reference
  partnerId String
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Link details
  code          String @unique  // Short code for URL
  name          String?         // Friendly name
  destinationUrl String?        // Custom destination
  
  // Campaign tracking
  campaign      String?
  source        String?
  medium        String?
  
  // Status
  isActive      Boolean @default(true)
  expiresAt     DateTime?
  
  // Metrics
  clicks        Int @default(0)
  signups       Int @default(0)
  conversions   Int @default(0)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  attributions PartnerAttribution[]

  @@index([partnerId])
  @@index([code])
  @@index([isActive])
  @@map("partner_referral_links")
}

// ============================================================================
// PARTNER ATTRIBUTION
// Tenant signup attribution - IMMUTABLE once set
// ============================================================================
model PartnerAttribution {
  id       String @id @default(uuid())
  
  // Partner reference
  partnerId String
  partner   Partner @relation(fields: [partnerId], references: [id])
  
  // Referral link
  referralLinkId String?
  referralLink   PartnerReferralLink? @relation(fields: [referralLinkId], references: [id])
  
  // Attributed tenant (READ-ONLY reference)
  tenantId      String
  tenantSlug    String?
  
  // Attribution details
  attributedAt      DateTime @default(now())
  firstSubscription DateTime?
  
  // Source tracking
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  
  // Status
  status        AttributionStatus @default(ATTRIBUTED)
  
  // Lock (cannot be changed after this is set)
  isLocked      Boolean @default(false)
  lockedAt      DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  commissions PartnerCommissionRecord[]

  @@unique([tenantId])  // One attribution per tenant
  @@index([partnerId])
  @@index([tenantId])
  @@index([attributedAt])
  @@map("partner_attributions")
}

enum AttributionStatus {
  ATTRIBUTED    // Successfully attributed
  CONVERTED     // Tenant has subscribed
  CHURNED       // Tenant churned
  EXPIRED       // Attribution window expired
}

// ============================================================================
// PARTNER COMMISSION RULE
// Commission calculation rules (NOT payout execution)
// ============================================================================
model PartnerCommissionRule {
  id       String @id @default(uuid())
  
  // Partner reference (null = global rule)
  partnerId String?
  partner   Partner? @relation(fields: [partnerId], references: [id])
  
  // Rule name
  name        String
  description String?
  
  // Scope
  planId      String?  // Specific plan
  moduleId    String?  // Specific module
  
  // Commission type
  commissionType CommissionType @default(PERCENTAGE)
  value          Decimal @db.Decimal(12, 2)  // Percentage or fixed amount
  
  // Recurring settings
  isRecurring    Boolean @default(true)
  maxRecurrences Int?     // null = unlimited
  
  // Validity
  validFrom   DateTime?
  validTo     DateTime?
  
  // Priority (higher = evaluated first)
  priority    Int @default(0)
  
  // Status
  isActive    Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([partnerId])
  @@index([planId])
  @@index([isActive])
  @@map("partner_commission_rules")
}

enum CommissionType {
  PERCENTAGE      // Percentage of subscription
  FIXED           // Fixed amount per event
  TIERED          // Based on performance tiers
}

// ============================================================================
// PARTNER COMMISSION RECORD
// Immutable commission records
// ============================================================================
model PartnerCommissionRecord {
  id       String @id @default(uuid())
  
  // Partner reference
  partnerId String
  partner   Partner @relation(fields: [partnerId], references: [id])
  
  // Attribution reference
  attributionId String
  attribution   PartnerAttribution @relation(fields: [attributionId], references: [id])
  
  // Event details
  eventType     CommissionEventType
  eventId       String?   // subscriptionId, paymentId, etc.
  eventDate     DateTime
  
  // Amounts
  grossAmount      Decimal @db.Decimal(12, 2) // Original transaction amount
  commissionRate   Decimal @db.Decimal(5, 2)  // Rate applied
  commissionAmount Decimal @db.Decimal(12, 2) // Calculated commission
  
  // Currency
  currency      String @default("NGN")
  
  // Status
  status        CommissionStatus @default(PENDING)
  
  // Payout reference (read-only from Payments module)
  payoutId      String?
  paidAt        DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([partnerId])
  @@index([attributionId])
  @@index([status])
  @@index([eventDate])
  @@map("partner_commission_records")
}

enum CommissionEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_UPGRADED
  ONE_TIME_PURCHASE
}

enum CommissionStatus {
  PENDING         // Commission calculated, awaiting confirmation
  EARNED          // Confirmed, awaiting payout
  READY_FOR_PAYOUT // Ready to be paid
  PAID            // Paid out
  CANCELLED       // Cancelled (e.g., refund)
}

// ============================================================================
// PARTNER EVENT LOG
// Audit trail for partner actions
// ============================================================================
model PartnerEventLog {
  id       String @id @default(uuid())

  // Event
  eventType  String
  eventData  Json

  // References
  partnerId      String?
  attributionId  String?
  commissionId   String?

  // Actor
  actorId   String?
  actorType String?

  // Timestamp
  occurredAt DateTime @default(now())

  @@index([partnerId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("partner_event_logs")
}

// ============================================================================
// MODULE 12: SUBSCRIPTION & BILLING EXTENSIONS
// Flexible pricing, bundles, and real-world billing logic
// Extends (not replaces) SaaS Core subscription engine
// ============================================================================

// ============================================================================
// BILLING CONFIGURATION
// Tenant-level billing extension settings
// ============================================================================
model BillingConfiguration {
  id       String @id @default(uuid())
  tenantId String @unique

  // Feature flags
  bundlesEnabled         Boolean @default(false)
  addOnsEnabled          Boolean @default(false)
  usageBillingEnabled    Boolean @default(false)
  gracePeriodsEnabled    Boolean @default(true)
  
  // Grace settings
  defaultGraceDays       Int     @default(7)
  graceSuspendFeatures   Boolean @default(true)
  
  // Usage settings
  usageAlertThreshold    Int     @default(80) // Percentage
  
  // Nigeria-first
  manualRenewalsAllowed  Boolean @default(true)
  informalUpgradesAllowed Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("billing_configurations")
}

// ============================================================================
// SUBSCRIPTION BUNDLE
// Bundled module offerings
// ============================================================================
model BillingBundle {
  id       String @id @default(uuid())
  tenantId String?  // null = global bundle
  
  // Bundle info
  name        String
  slug        String
  description String?
  
  // Pricing
  price           Decimal @db.Decimal(12, 2)
  currency        String  @default("NGN")
  billingInterval String  @default("MONTHLY") // MONTHLY, YEARLY
  
  // Discounts
  savingsPercent  Decimal? @db.Decimal(5, 2)  // vs buying separately
  
  // Status
  isActive      Boolean @default(true)
  isPromoted    Boolean @default(false)
  
  // Display
  displayOrder  Int @default(0)
  badgeText     String?  // "Best Value", "Popular", etc.
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items BillingBundleItem[]

  @@unique([tenantId, slug])
  @@index([isActive])
  @@map("billing_bundles")
}

// ============================================================================
// BUNDLE ITEM
// Modules included in a bundle
// ============================================================================
model BillingBundleItem {
  id       String @id @default(uuid())
  
  // Bundle reference
  bundleId String
  bundle   BillingBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  // Module reference (capability key)
  moduleKey     String
  moduleName    String?
  
  // Feature limits (if any)
  featureLimits Json?
  
  // Display
  displayOrder  Int @default(0)
  isHighlighted Boolean @default(false)
  
  createdAt DateTime @default(now())

  @@unique([bundleId, moduleKey])
  @@map("billing_bundle_items")
}

// ============================================================================
// ADD-ON
// Individual feature add-ons
// ============================================================================
model BillingAddOn {
  id       String @id @default(uuid())
  tenantId String?  // null = global add-on
  
  // Add-on info
  name        String
  slug        String
  description String?
  
  // Type
  addOnType   AddOnType @default(FEATURE)
  
  // Pricing
  price           Decimal @db.Decimal(12, 2)
  currency        String  @default("NGN")
  billingInterval String  @default("MONTHLY")
  
  // Quantity settings
  isQuantityBased Boolean @default(false)
  unitName        String? // "user", "store", etc.
  minQuantity     Int     @default(1)
  maxQuantity     Int?
  
  // Feature/capability
  moduleKey       String?
  featureKey      String?
  featureValue    Json?
  
  // Status
  isActive      Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions BillingAddOnSubscription[]

  @@unique([tenantId, slug])
  @@index([isActive])
  @@map("billing_addons")
}

enum AddOnType {
  FEATURE     // Specific feature unlock
  CAPACITY    // Quantity-based (users, stores, etc.)
  MODULE      // Full module access
  TIME_BOUND  // Temporary feature
}

// ============================================================================
// ADD-ON SUBSCRIPTION
// Active add-ons per subscription
// ============================================================================
model BillingAddOnSubscription {
  id       String @id @default(uuid())
  tenantId String
  
  // Subscription reference (Core)
  subscriptionId String
  
  // Add-on reference
  addOnId String
  addOn   BillingAddOn @relation(fields: [addOnId], references: [id])
  
  // Quantity
  quantity  Int @default(1)
  
  // Pricing snapshot
  priceAtPurchase  Decimal @db.Decimal(12, 2)
  currency         String  @default("NGN")
  
  // Status
  status    AddOnStatus @default(ACTIVE)
  
  // Dates
  startDate  DateTime @default(now())
  endDate    DateTime?
  cancelledAt DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([status])
  @@map("billing_addon_subscriptions")
}

enum AddOnStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

// ============================================================================
// USAGE METRIC
// Tracked usage metrics definition
// ============================================================================
model BillingUsageMetric {
  id       String @id @default(uuid())
  tenantId String?  // null = global metric
  
  // Metric info
  key         String
  name        String
  description String?
  
  // Unit
  unit        String  // "calls", "orders", "users", etc.
  
  // Aggregation
  aggregationType UsageAggregationType @default(SUM)
  
  // Limits
  includedUnits   Int?     // Free units per period
  overageRate     Decimal? @db.Decimal(12, 4) // Price per unit over
  
  // Billing
  billingPeriod   String @default("MONTHLY")
  
  // Status
  isActive      Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  records BillingUsageRecord[]

  @@unique([tenantId, key])
  @@map("billing_usage_metrics")
}

enum UsageAggregationType {
  SUM
  MAX
  AVG
  COUNT
}

// ============================================================================
// USAGE RECORD
// Immutable usage tracking
// ============================================================================
model BillingUsageRecord {
  id       String @id @default(uuid())
  tenantId String
  
  // Metric reference
  metricId String
  metric   BillingUsageMetric @relation(fields: [metricId], references: [id])
  
  // Period
  periodStart DateTime
  periodEnd   DateTime
  
  // Usage
  quantity    Decimal @db.Decimal(16, 4)
  
  // Source
  sourceType  String?  // "api", "order", "user", etc.
  sourceId    String?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([metricId])
  @@index([periodStart, periodEnd])
  @@map("billing_usage_records")
}

// ============================================================================
// BILLING ADJUSTMENT
// Append-only adjustments to billing
// ============================================================================
model BillingAdjustment {
  id       String @id @default(uuid())
  tenantId String
  
  // Subscription reference
  subscriptionId String?
  
  // Adjustment info
  type        AdjustmentType
  reason      String
  description String?
  
  // Amount
  amount      Decimal @db.Decimal(12, 2)
  currency    String  @default("NGN")
  
  // Application
  appliedAt   DateTime?
  expiresAt   DateTime?
  
  // Status
  status      AdjustmentStatus @default(PENDING)
  
  // Audit
  createdBy   String?
  approvedBy  String?
  approvedAt  DateTime?
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([status])
  @@map("billing_adjustments")
}

enum AdjustmentType {
  CREDIT      // Add credit
  DISCOUNT    // Apply discount
  REFUND      // Partial refund
  PROMO       // Promotional credit
  WAIVER      // Fee waiver
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  APPLIED
  EXPIRED
  CANCELLED
}

// ============================================================================
// DISCOUNT RULE
// Billing-side discount definitions
// ============================================================================
model BillingDiscountRule {
  id       String @id @default(uuid())
  tenantId String?  // null = global rule
  
  // Rule info
  name        String
  code        String?  // Promo code
  description String?
  
  // Type
  discountType DiscountType @default(PERCENTAGE)
  value        Decimal @db.Decimal(12, 2)
  
  // Scope
  planIds     String[] @default([])  // Empty = all plans
  moduleIds   String[] @default([])  // Empty = all modules
  
  // Partner link
  partnerId   String?
  
  // Limits
  maxUses       Int?
  maxUsesPerTenant Int?
  currentUses   Int @default(0)
  
  // Validity
  validFrom   DateTime?
  validTo     DateTime?
  
  // Conditions
  minOrderValue Decimal? @db.Decimal(12, 2)
  firstTimeOnly Boolean @default(false)
  
  // Status
  isActive    Boolean @default(true)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code])
  @@index([isActive])
  @@index([partnerId])
  @@map("billing_discount_rules")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_MONTHS
}

// ============================================================================
// GRACE POLICY
// Grace period and suspension policies
// ============================================================================
model BillingGracePolicy {
  id       String @id @default(uuid())
  tenantId String?  // null = global policy
  
  // Policy info
  name        String
  description String?
  
  // Grace period
  graceDays     Int @default(7)
  
  // Actions during grace
  limitFeatures       Boolean @default(true)
  sendReminders       Boolean @default(true)
  reminderDays        Int[]   @default([1, 3, 7])
  
  // Post-grace
  suspendAfterGrace   Boolean @default(true)
  dataRetentionDays   Int     @default(90)
  
  // Nigeria-first
  manualOverrideAllowed Boolean @default(true)
  
  // Status
  isActive    Boolean @default(true)
  isDefault   Boolean @default(false)
  
  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("billing_grace_policies")
}

// ============================================================================
// BILLING EVENT LOG
// Audit trail for billing actions
// ============================================================================
model BillingEventLog {
  id       String @id @default(uuid())
  tenantId String?

  // Event
  eventType  String
  eventData  Json

  // References
  subscriptionId String?
  bundleId       String?
  addOnId        String?
  adjustmentId   String?

  // Actor
  actorId   String?
  actorType String?

  // Timestamp
  occurredAt DateTime @default(now())

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("billing_event_logs")
}
