generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

// Global role - only SUPER_ADMIN has meaning here
// Regular users get their roles via TenantMembership
enum GlobalRole {
  SUPER_ADMIN  // Can access all tenants, manage platform
  USER         // Regular user, gets access via TenantMembership
}

// Tenant-specific role - assigned via TenantMembership
enum TenantRole {
  TENANT_ADMIN  // Full control of tenant (users, settings, billing)
  TENANT_USER   // Regular member with limited permissions
}

// Tenant lifecycle status
enum TenantStatus {
  PENDING_ACTIVATION  // Created by partner, awaiting tenant signup/payment
  ACTIVE              // Normal operation
  SUSPENDED           // Temporarily disabled (e.g., payment issue)
  DEACTIVATED         // Soft-deleted, data retained
}

// Attribution method - how the tenant was linked to a partner
enum AttributionMethod {
  PARTNER_CREATED     // Partner created the tenant directly
  REFERRAL_LINK       // Tenant signed up via referral link/code
  MANUAL_ASSIGNMENT   // Super Admin manually assigned (rare, audit logged)
}

// Domain verification status
enum DomainStatus {
  PENDING      // Awaiting DNS verification
  VERIFIED     // DNS verified, domain active
  FAILED       // Verification failed
}

// Domain type for clarity
enum DomainType {
  SUBDOMAIN    // e.g., acme.saascore.com (platform-provided)
  CUSTOM       // e.g., app.acme.com (customer-owned)
}

// ============================================================================
// USER
// Global identity - authentication happens here
// ============================================================================
model User {
  id          String     @id @default(uuid())
  email       String     @unique
  name        String?
  avatarUrl   String?
  globalRole  GlobalRole @default(USER)
  isActive    Boolean    @default(true)
  
  // Audit fields
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  lastLoginAt DateTime?

  // Relations
  memberships TenantMembership[]
  magicLinks  MagicLink[]
  sessions    Session[]
  
  // Partner relation (a user can belong to ONE partner organization)
  partnerMembership PartnerUser?

  @@index([email])
  @@index([globalRole])
}

// ============================================================================
// TENANT
// Organization/workspace - the isolation boundary
// ============================================================================
model Tenant {
  id          String       @id @default(uuid())
  name        String       // Display name: "Acme Corporation"
  slug        String       @unique // URL-safe identifier: "acme"
  status      TenantStatus @default(ACTIVE)
  
  // Branding (embedded for simplicity, could be separate model)
  appName        String   @default("SaaS App")
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String   @default("#6366f1")
  secondaryColor String   @default("#8b5cf6")

  // Audit fields
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  domains     TenantDomain[]
  memberships TenantMembership[]
  magicLinks  MagicLink[]
  
  // Partner referral (immutable - who referred this tenant)
  partnerReferral PartnerReferral?

  @@index([slug])
  @@index([status])
}

// ============================================================================
// TENANT MEMBERSHIP
// Join table: User <-> Tenant with role
// This is where tenant-specific permissions live
// ============================================================================
model TenantMembership {
  id        String     @id @default(uuid())
  userId    String
  tenantId  String
  role      TenantRole @default(TENANT_USER)
  isActive  Boolean    @default(true)
  
  // Audit fields
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  joinedAt  DateTime   @default(now())

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // A user can only have one membership per tenant
  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([role])
}

// ============================================================================
// TENANT DOMAIN
// Manages both subdomains and custom domains for tenant resolution
// ============================================================================
model TenantDomain {
  id         String       @id @default(uuid())
  tenantId   String
  domain     String       @unique // e.g., "acme" (subdomain) or "app.acme.com" (custom)
  type       DomainType
  status     DomainStatus @default(PENDING)
  isPrimary  Boolean      @default(false) // Primary domain shown in UI
  
  // For custom domain verification
  verificationToken String?
  verifiedAt        DateTime?

  // Audit fields
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Relations
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([tenantId])
  @@index([type, status])
}

// ============================================================================
// MAGIC LINK
// Passwordless authentication tokens
// ============================================================================
model MagicLink {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  tenantId  String?   // Optional: login directly to a specific tenant
  expiresAt DateTime
  usedAt    DateTime?
  
  // Audit fields
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// SESSION
// Active user sessions for authentication
// ============================================================================
model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  activeTenant String?  // Currently selected tenant (for multi-tenant users)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  
  // Audit fields
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// PARTNER DOMAIN - Platform-level reseller/affiliate system
// Partners are INDEPENDENT of Tenants - they exist at platform level
// ============================================================================

// Partner lifecycle status
enum PartnerStatus {
  PENDING      // Application submitted, awaiting approval
  ACTIVE       // Approved and operational
  SUSPENDED    // Temporarily disabled
  TERMINATED   // Permanently ended
}

// Partner tier for commission structures
enum PartnerTier {
  BRONZE       // Entry level
  SILVER       // Mid tier
  GOLD         // High performer
  PLATINUM     // Top tier / enterprise
}

// Partner user roles within a partner organization
enum PartnerRole {
  PARTNER_OWNER    // Full control: manage agreement, users, view all data
  PARTNER_STAFF    // Limited: view referrals/earnings, create referral codes
}

// Agreement status
enum AgreementStatus {
  DRAFT        // Being prepared
  ACTIVE       // Currently in effect
  SUPERSEDED   // Replaced by newer version
  TERMINATED   // Ended
}

// Commission calculation type
enum CommissionType {
  PERCENTAGE   // % of transaction
  FIXED        // Fixed amount per transaction
  TIERED       // Based on volume tiers
}

// Earning status
enum EarningStatus {
  PENDING      // Calculated, awaiting approval
  APPROVED     // Approved for payment
  PAID         // Payment processed
  DISPUTED     // Under review
  CANCELLED    // Cancelled/reversed
}

// ============================================================================
// PARTNER
// Independent platform actor - NOT a tenant, NOT a vendor
// Represents a reseller/affiliate organization
// ============================================================================
model Partner {
  id          String        @id @default(uuid())
  name        String        // Company name: "Digital Solutions Inc"
  slug        String        @unique // URL-safe identifier: "digital-solutions"
  email       String        // Primary contact email
  phone       String?       // Contact phone
  website     String?       // Partner's website
  
  status      PartnerStatus @default(PENDING)
  tier        PartnerTier   @default(BRONZE)
  
  // Business details
  companyNumber  String?    // Business registration number
  taxId          String?    // Tax identification
  address        Json?      // Structured address
  
  // Metadata for flexibility
  metadata    Json?
  
  // Audit fields
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  approvedAt  DateTime?     // When partner was approved
  
  // Relations
  users       PartnerUser[]
  agreements  PartnerAgreement[]
  referralCodes PartnerReferralCode[]
  referrals   PartnerReferral[]
  earnings    PartnerEarning[]

  @@index([slug])
  @@index([email])
  @@index([status])
  @@index([tier])
}

// ============================================================================
// PARTNER USER
// Users belonging to a Partner organization
// Links existing User model to Partner with role
// ============================================================================
model PartnerUser {
  id        String      @id @default(uuid())
  partnerId String
  userId    String
  role      PartnerRole @default(PARTNER_MEMBER)
  isActive  Boolean     @default(true)
  
  // Audit fields
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  joinedAt  DateTime    @default(now())

  // Relations
  partner   Partner     @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // A user can only belong to one partner (prevents conflicts)
  @@unique([userId])
  // Index for partner lookups
  @@unique([partnerId, userId])
  @@index([partnerId])
  @@index([role])
}

// ============================================================================
// PARTNER AGREEMENT
// Versioned agreement terms between platform and partner
// Supports multiple versions over time - only one ACTIVE at a time
// ============================================================================
model PartnerAgreement {
  id              String          @id @default(uuid())
  partnerId       String
  
  // Versioning
  version         Int             // Auto-increment per partner: 1, 2, 3...
  
  // Effective period
  effectiveFrom   DateTime        // When this agreement takes effect
  effectiveTo     DateTime?       // Null = current/indefinite
  
  // Commission terms
  commissionType  CommissionType  @default(PERCENTAGE)
  commissionRate  Decimal         @db.Decimal(5, 4) // e.g., 0.1500 = 15%
  
  // Tiered commission structure (if commissionType = TIERED)
  // Format: [{ "minVolume": 0, "maxVolume": 1000, "rate": 0.10 }, ...]
  commissionTiers Json?
  
  // Full agreement terms (flexible structure)
  terms           Json?           // Payment terms, conditions, etc.
  
  // Signature tracking
  status          AgreementStatus @default(DRAFT)
  signedAt        DateTime?
  signedByUserId  String?         // PartnerUser who signed
  
  // Platform approval
  approvedAt      DateTime?
  approvedByUserId String?        // Super Admin who approved
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  partner         Partner         @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  earnings        PartnerEarning[]

  // Only one agreement version number per partner
  @@unique([partnerId, version])
  @@index([partnerId])
  @@index([status])
  @@index([effectiveFrom, effectiveTo])
}

// ============================================================================
// PARTNER REFERRAL CODE
// Trackable codes for attribution
// Partners can have multiple codes for different campaigns
// ============================================================================
model PartnerReferralCode {
  id          String    @id @default(uuid())
  partnerId   String
  code        String    @unique // e.g., "PARTNER2024", "SUMMER-SALE"
  
  // Usage controls
  isActive    Boolean   @default(true)
  usageLimit  Int?      // Null = unlimited
  usageCount  Int       @default(0)
  expiresAt   DateTime? // Null = never expires
  
  // Campaign tracking
  campaignName String?  // e.g., "Q4 2024 Promotion"
  metadata    Json?     // Additional tracking data
  
  // Audit fields
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  partner     Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  referrals   PartnerReferral[]

  @@index([code])
  @@index([partnerId])
  @@index([isActive])
}

// ============================================================================
// PARTNER REFERRAL
// IMMUTABLE attribution link between Partner and Tenant
// Once created, the partner-tenant relationship cannot be changed
// This is the source of truth for "who referred this tenant"
// ============================================================================
model PartnerReferral {
  id              String    @id @default(uuid())
  partnerId       String
  tenantId        String    @unique // Each tenant can only have ONE referral (immutable)
  referralCodeId  String?   // The code used (if any)
  
  // Attribution timestamp - IMMUTABLE
  referredAt      DateTime  @default(now())
  
  // Lock flag - set to true after first successful billing
  // Once locked, this record can NEVER be modified or deleted
  attributionLocked Boolean @default(false)
  lockedAt        DateTime?
  
  // Context at time of referral
  referralSource  String?   // e.g., "website", "email", "direct"
  landingPage     String?   // URL where signup occurred
  metadata        Json?     // Additional attribution data
  
  // Audit fields
  createdAt       DateTime  @default(now())
  // NO updatedAt - this is intentionally immutable

  // Relations
  partner         Partner   @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  referralCode    PartnerReferralCode? @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  earnings        PartnerEarning[]

  @@index([partnerId])
  @@index([tenantId])
  @@index([referredAt])
  @@index([attributionLocked])
}

// ============================================================================
// PARTNER EARNING
// Tracks commission earned by partner for each billing period
// Linked to specific agreement version that was active at time of earning
// ============================================================================
model PartnerEarning {
  id              String        @id @default(uuid())
  partnerId       String
  referralId      String        // Which tenant referral generated this
  agreementId     String        // Which agreement terms applied
  
  // Billing period
  periodStart     DateTime      // Start of billing period
  periodEnd       DateTime      // End of billing period
  
  // Financial details
  grossAmount     Decimal       @db.Decimal(12, 2) // Total billed to tenant
  commissionRate  Decimal       @db.Decimal(5, 4)  // Rate at time of earning
  commissionAmount Decimal      @db.Decimal(12, 2) // Calculated earning
  currency        String        @default("USD")
  
  // Status tracking
  status          EarningStatus @default(PENDING)
  
  // Payment tracking
  paidAt          DateTime?
  paymentReference String?      // External payment ID
  paymentMethod   String?       // e.g., "bank_transfer", "paypal"
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  approvedAt      DateTime?
  approvedByUserId String?      // Super Admin who approved

  // Relations
  partner         Partner       @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  referral        PartnerReferral @relation(fields: [referralId], references: [id], onDelete: Restrict)
  agreement       PartnerAgreement @relation(fields: [agreementId], references: [id], onDelete: Restrict)

  @@index([partnerId])
  @@index([referralId])
  @@index([agreementId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
}

// ============================================================================
// AUDIT LOG
// Track all significant actions for compliance and debugging
// ============================================================================
enum AuditAction {
  // Tenant actions
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  TENANT_DEACTIVATED
  
  // Domain actions
  DOMAIN_ADDED
  DOMAIN_REMOVED
  DOMAIN_VERIFIED
  
  // User actions
  USER_INVITED
  USER_REMOVED
  USER_ROLE_CHANGED
  
  // Auth actions
  USER_LOGIN
  USER_LOGOUT
  
  // Super Admin actions
  SUPER_ADMIN_IMPERSONATION_START
  SUPER_ADMIN_IMPERSONATION_END
  
  // Partner actions
  PARTNER_CREATED
  PARTNER_UPDATED
  PARTNER_APPROVED
  PARTNER_SUSPENDED
  PARTNER_TERMINATED
  PARTNER_USER_ADDED
  PARTNER_USER_REMOVED
  PARTNER_AGREEMENT_CREATED
  PARTNER_AGREEMENT_SIGNED
  PARTNER_AGREEMENT_APPROVED
  PARTNER_REFERRAL_CREATED
  PARTNER_REFERRAL_LOCKED
  PARTNER_EARNING_CREATED
  PARTNER_EARNING_APPROVED
  PARTNER_EARNING_PAID
}

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  actorId     String      // User who performed the action
  actorEmail  String      // Denormalized for easy querying
  tenantId    String?     // Null for super admin global actions
  targetType  String?     // e.g., "User", "Tenant", "TenantDomain"
  targetId    String?     // ID of the affected entity
  metadata    Json?       // Additional context
  ipAddress   String?
  userAgent   String?
  
  // Audit fields
  createdAt   DateTime    @default(now())

  @@index([actorId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@index([targetType, targetId])
}
