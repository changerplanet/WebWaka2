generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

// Global role - only SUPER_ADMIN has meaning here
// Regular users get their roles via TenantMembership
enum GlobalRole {
  SUPER_ADMIN  // Can access all tenants, manage platform
  USER         // Regular user, gets access via TenantMembership
}

// Tenant-specific role - assigned via TenantMembership
enum TenantRole {
  TENANT_ADMIN  // Full control of tenant (users, settings, billing)
  TENANT_USER   // Regular member with limited permissions
}

// Tenant lifecycle status
enum TenantStatus {
  PENDING_ACTIVATION  // Created by partner, awaiting tenant signup/payment
  ACTIVE              // Normal operation
  SUSPENDED           // Temporarily disabled (e.g., payment issue)
  DEACTIVATED         // Soft-deleted, data retained
}

// Attribution method - how the tenant was linked to a partner
enum AttributionMethod {
  PARTNER_CREATED     // Partner created the tenant directly
  REFERRAL_LINK       // Tenant signed up via referral link/code
  MANUAL_ASSIGNMENT   // Super Admin manually assigned (rare, audit logged)
}

// Domain verification status
enum DomainStatus {
  PENDING      // Awaiting DNS verification
  VERIFIED     // DNS verified, domain active
  FAILED       // Verification failed
}

// Domain type for clarity
enum DomainType {
  SUBDOMAIN    // e.g., acme.saascore.com (platform-provided)
  CUSTOM       // e.g., app.acme.com (customer-owned)
}

// ============================================================================
// USER
// Global identity - authentication happens here
// ============================================================================
model User {
  id          String     @id @default(uuid())
  email       String     @unique
  name        String?
  avatarUrl   String?
  globalRole  GlobalRole @default(USER)
  isActive    Boolean    @default(true)
  
  // Audit fields
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  lastLoginAt DateTime?

  // Relations
  memberships TenantMembership[]
  magicLinks  MagicLink[]
  sessions    Session[]
  
  // Partner relation (a user can belong to ONE partner organization)
  partnerMembership PartnerUser?

  @@index([email])
  @@index([globalRole])
}

// ============================================================================
// TENANT
// Organization/workspace - the isolation boundary
// ============================================================================
model Tenant {
  id          String       @id @default(uuid())
  name        String       // Display name: "Acme Corporation"
  slug        String       @unique // URL-safe identifier: "acme"
  status      TenantStatus @default(ACTIVE)
  
  // Branding (embedded for simplicity, could be separate model)
  appName        String   @default("SaaS App")
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String   @default("#6366f1")
  secondaryColor String   @default("#8b5cf6")
  
  // Partner-assisted creation fields
  requestedModules   String[]  @default([]) // ["POS", "SVM", "MVM"] - requested at creation
  activatedModules   String[]  @default([]) // Actually provisioned after payment
  activatedAt        DateTime? // When tenant completed signup and payment
  
  // Audit fields
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  domains     TenantDomain[]
  memberships TenantMembership[]
  magicLinks  MagicLink[]
  
  // Partner referral (immutable - who referred this tenant)
  partnerReferral PartnerReferral?
  
  // Subscription & Entitlements
  subscription  Subscription?
  entitlements  Entitlement[]
  invoices      Invoice[]

  @@index([slug])
  @@index([status])
}

// ============================================================================
// TENANT MEMBERSHIP
// Join table: User <-> Tenant with role
// This is where tenant-specific permissions live
// ============================================================================
model TenantMembership {
  id        String     @id @default(uuid())
  userId    String
  tenantId  String
  role      TenantRole @default(TENANT_USER)
  isActive  Boolean    @default(true)
  
  // Audit fields
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  joinedAt  DateTime   @default(now())

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // A user can only have one membership per tenant
  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([role])
}

// ============================================================================
// TENANT DOMAIN
// Manages both subdomains and custom domains for tenant resolution
// ============================================================================
model TenantDomain {
  id         String       @id @default(uuid())
  tenantId   String
  domain     String       @unique // e.g., "acme" (subdomain) or "app.acme.com" (custom)
  type       DomainType
  status     DomainStatus @default(PENDING)
  isPrimary  Boolean      @default(false) // Primary domain shown in UI
  
  // For custom domain verification
  verificationToken String?
  verifiedAt        DateTime?

  // Audit fields
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Relations
  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([tenantId])
  @@index([type, status])
}

// ============================================================================
// MAGIC LINK
// Passwordless authentication tokens
// ============================================================================
model MagicLink {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  tenantId  String?   // Optional: login directly to a specific tenant
  expiresAt DateTime
  usedAt    DateTime?
  
  // Audit fields
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// SESSION
// Active user sessions for authentication
// ============================================================================
model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  activeTenant String?  // Currently selected tenant (for multi-tenant users)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  
  // Audit fields
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// SUBSCRIPTION & ENTITLEMENT DOMAIN
// Manages tenant subscriptions and module access
// Partner logic is ISOLATED - modules only check entitlements
// ============================================================================

// Subscription status
enum SubscriptionStatus {
  PENDING        // Created but not yet active
  TRIALING       // In trial period
  ACTIVE         // Paid and active
  PAST_DUE       // Payment failed, grace period
  CANCELLED      // Cancelled, access until period end
  EXPIRED        // Period ended, no access
  PAUSED         // Temporarily paused
}

// Billing interval
enum BillingInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

// Entitlement status
enum EntitlementStatus {
  ACTIVE         // Module is accessible
  SUSPENDED      // Temporarily suspended
  EXPIRED        // No longer valid
}

// Subscription event types
enum SubscriptionEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_PAUSED
  SUBSCRIPTION_RESUMED
  SUBSCRIPTION_UPGRADED
  SUBSCRIPTION_DOWNGRADED
  SUBSCRIPTION_EXPIRED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TRIAL_STARTED
  TRIAL_ENDED
}

// ============================================================================
// SUBSCRIPTION PLAN
// Defines available plans and their module bundles
// ============================================================================
model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String   // "Starter", "Professional", "Enterprise"
  slug          String   @unique
  description   String?
  
  // Pricing
  priceMonthly  Decimal  @db.Decimal(12, 2)
  priceYearly   Decimal  @db.Decimal(12, 2)
  currency      String   @default("USD")
  
  // Module entitlements included in this plan
  includedModules String[]  // ["POS", "SVM", "MVM"]
  
  // Limits and quotas
  maxUsers      Int?     // null = unlimited
  maxStorage    Int?     // GB, null = unlimited
  features      Json?    // Additional feature flags
  
  // Plan metadata
  isActive      Boolean  @default(true)
  isPublic      Boolean  @default(true)  // Visible in pricing page
  sortOrder     Int      @default(0)
  
  // Trial configuration
  trialDays     Int      @default(14)
  
  // Audit fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([slug])
  @@index([isActive, isPublic])
}

// ============================================================================
// SUBSCRIPTION
// Tenant's active subscription with optional Partner attribution
// Partner ID is OPTIONAL - not all subscriptions have partner attribution
// ============================================================================
model Subscription {
  id              String             @id @default(uuid())
  tenantId        String             @unique  // One subscription per tenant
  planId          String
  
  // Status
  status          SubscriptionStatus @default(PENDING)
  
  // Billing
  billingInterval BillingInterval    @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  
  // Pricing at time of subscription (may differ from plan if discounted)
  amount          Decimal            @db.Decimal(12, 2)
  currency        String             @default("USD")
  
  // Trial
  trialStart      DateTime?
  trialEnd        DateTime?
  
  // Cancellation
  cancelledAt     DateTime?
  cancelReason    String?
  cancelAtPeriodEnd Boolean          @default(false)
  
  // External payment provider reference
  externalId      String?            // Stripe subscription ID, etc.
  paymentProvider String?            // "stripe", "paypal", etc.
  
  // Partner attribution (OPTIONAL - may be null)
  // This links to the PartnerReferral, NOT directly to Partner
  // Ensures commission logic stays with attribution
  partnerReferralId String?
  
  // Metadata
  metadata        Json?
  
  // Audit fields
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan            SubscriptionPlan   @relation(fields: [planId], references: [id])
  partnerReferral PartnerReferral?   @relation(fields: [partnerReferralId], references: [id], onDelete: SetNull)
  entitlements    Entitlement[]
  events          SubscriptionEvent[]
  invoices        Invoice[]

  @@index([tenantId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([partnerReferralId])
}

// ============================================================================
// ENTITLEMENT
// Module access grants for a tenant
// MODULES ONLY CHECK THIS - no subscription/partner logic in modules
// ============================================================================
model Entitlement {
  id              String            @id @default(uuid())
  tenantId        String
  subscriptionId  String?           // null = manually granted
  
  // Module this entitlement grants access to
  module          String            // "POS", "SVM", "MVM"
  
  // Status
  status          EntitlementStatus @default(ACTIVE)
  
  // Validity period
  validFrom       DateTime          @default(now())
  validUntil      DateTime?         // null = until subscription ends
  
  // Limits specific to this entitlement
  limits          Json?             // { "maxTransactions": 1000 }
  
  // Source of entitlement (for auditing)
  source          String            @default("subscription") // "subscription", "addon", "promo", "manual"
  
  // Audit fields
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription    Subscription?     @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  // Tenant can have multiple entitlements for different modules
  @@unique([tenantId, module])
  @@index([tenantId])
  @@index([module])
  @@index([status])
}

// ============================================================================
// SUBSCRIPTION EVENT
// Immutable log of subscription lifecycle events
// Used for commission calculation and auditing
// ============================================================================
model SubscriptionEvent {
  id              String                @id @default(uuid())
  subscriptionId  String
  
  // Event type
  eventType       SubscriptionEventType
  
  // Snapshot at time of event (immutable)
  tenantId        String
  partnerId       String?               // From attribution, NULL if no partner
  
  // Module and billing info at time of event
  modules         String[]              // Modules at time of event
  billingAmount   Decimal?              @db.Decimal(12, 2)
  billingCurrency String?
  billingInterval BillingInterval?
  
  // Period info
  periodStart     DateTime?
  periodEnd       DateTime?
  
  // Additional context
  metadata        Json?                 // Event-specific data
  
  // External reference
  externalEventId String?               // Payment provider event ID
  
  // Timestamp - immutable
  occurredAt      DateTime              @default(now())
  
  // NO updatedAt - events are immutable

  // Relations
  subscription    Subscription          @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([tenantId])
  @@index([partnerId])
  @@index([eventType])
  @@index([occurredAt])
}

// ============================================================================
// INVOICE
// Billing records for subscriptions
// ============================================================================
model Invoice {
  id              String   @id @default(uuid())
  subscriptionId  String
  tenantId        String
  
  // Invoice details
  invoiceNumber   String   @unique
  status          String   // "draft", "open", "paid", "void", "uncollectible"
  
  // Amounts
  subtotal        Decimal  @db.Decimal(12, 2)
  tax             Decimal  @db.Decimal(12, 2) @default(0)
  total           Decimal  @db.Decimal(12, 2)
  amountPaid      Decimal  @db.Decimal(12, 2) @default(0)
  amountDue       Decimal  @db.Decimal(12, 2)
  currency        String   @default("USD")
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Dates
  issuedAt        DateTime @default(now())
  dueAt           DateTime
  paidAt          DateTime?
  
  // External reference
  externalId      String?  // Stripe invoice ID
  hostedUrl       String?  // URL to hosted invoice
  pdfUrl          String?  // URL to PDF
  
  // Partner attribution snapshot (for commission calculation)
  partnerId       String?
  
  // Audit fields
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([tenantId])
  @@index([status])
  @@index([partnerId])
}

// ============================================================================
// PARTNER DOMAIN - Platform-level reseller/affiliate system
// Partners are INDEPENDENT of Tenants - they exist at platform level
// ============================================================================

// Partner lifecycle status
enum PartnerStatus {
  PENDING      // Application submitted, awaiting approval
  ACTIVE       // Approved and operational
  SUSPENDED    // Temporarily disabled
  TERMINATED   // Permanently ended
}

// Partner tier for commission structures
enum PartnerTier {
  BRONZE       // Entry level
  SILVER       // Mid tier
  GOLD         // High performer
  PLATINUM     // Top tier / enterprise
}

// Partner user roles within a partner organization
enum PartnerRole {
  PARTNER_OWNER    // Full control: manage agreement, users, view all data
  PARTNER_STAFF    // Limited: view referrals/earnings, create referral codes
}

// Agreement status
enum AgreementStatus {
  DRAFT        // Being prepared
  ACTIVE       // Currently in effect
  SUPERSEDED   // Replaced by newer version
  TERMINATED   // Ended
}

// Commission calculation type
enum CommissionType {
  PERCENTAGE   // % of transaction amount
  FIXED        // Fixed amount per transaction/period
  TIERED       // Volume-based tiers
  HYBRID       // Combination of multiple models
}

// Commission trigger - when commission is earned
enum CommissionTrigger {
  ON_PAYMENT       // When payment is received
  ON_ACTIVATION    // When subscription activates (first payment)
  ON_RENEWAL       // On each renewal
  ON_SIGNUP        // One-time on signup
}

// Earning status - ledger state machine
enum EarningStatus {
  PENDING      // Calculated, awaiting clearance period
  CLEARED      // Clearance period passed, ready for payout
  APPROVED     // Approved for payment batch
  PAID         // Payment processed
  DISPUTED     // Under review/dispute
  REVERSED     // Reversed (chargeback, refund)
  VOIDED       // Voided before clearance
}

// Earning entry type - for ledger
enum EarningEntryType {
  CREDIT       // Positive earning (commission)
  DEBIT        // Negative (reversal, adjustment)
  ADJUSTMENT   // Manual adjustment
}

// ============================================================================
// PARTNER
// Independent platform actor - NOT a tenant, NOT a vendor
// Represents a reseller/affiliate organization
// ============================================================================
model Partner {
  id          String        @id @default(uuid())
  name        String        // Company name: "Digital Solutions Inc"
  slug        String        @unique // URL-safe identifier: "digital-solutions"
  email       String        // Primary contact email
  phone       String?       // Contact phone
  website     String?       // Partner's website
  
  status      PartnerStatus @default(PENDING)
  tier        PartnerTier   @default(BRONZE)
  
  // Business details
  companyNumber  String?    // Business registration number
  taxId          String?    // Tax identification
  address        Json?      // Structured address
  
  // Metadata for flexibility
  metadata    Json?
  
  // Audit fields
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  approvedAt  DateTime?     // When partner was approved
  
  // Relations
  users       PartnerUser[]
  agreements  PartnerAgreement[]
  referralCodes PartnerReferralCode[]
  referrals   PartnerReferral[]
  earnings    PartnerEarning[]

  @@index([slug])
  @@index([email])
  @@index([status])
  @@index([tier])
}

// ============================================================================
// PARTNER USER
// Users belonging to a Partner organization
// Links existing User model to Partner with role
// ============================================================================
model PartnerUser {
  id        String      @id @default(uuid())
  partnerId String
  userId    String
  role      PartnerRole @default(PARTNER_STAFF)
  isActive  Boolean     @default(true)
  
  // Audit fields
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  joinedAt  DateTime    @default(now())

  // Relations
  partner   Partner     @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // A user can only belong to one partner (prevents conflicts)
  @@unique([userId])
  // Index for partner lookups
  @@unique([partnerId, userId])
  @@index([partnerId])
  @@index([role])
}

// ============================================================================
// PARTNER AGREEMENT
// Versioned agreement terms between platform and partner
// Supports multiple versions over time - only one ACTIVE at a time
// ============================================================================
model PartnerAgreement {
  id              String          @id @default(uuid())
  partnerId       String
  
  // Versioning
  version         Int             // Auto-increment per partner: 1, 2, 3...
  
  // Effective period
  effectiveFrom   DateTime        // When this agreement takes effect
  effectiveTo     DateTime?       // Null = current/indefinite
  
  // Commission terms
  commissionType  CommissionType  @default(PERCENTAGE)
  commissionRate  Decimal         @db.Decimal(5, 4) // e.g., 0.1500 = 15%
  
  // Tiered commission structure (if commissionType = TIERED)
  // Format: [{ "minVolume": 0, "maxVolume": 1000, "rate": 0.10 }, ...]
  commissionTiers Json?
  
  // Full agreement terms (flexible structure)
  terms           Json?           // Payment terms, conditions, etc.
  
  // Signature tracking
  status          AgreementStatus @default(DRAFT)
  signedAt        DateTime?
  signedByUserId  String?         // PartnerUser who signed
  
  // Platform approval
  approvedAt      DateTime?
  approvedByUserId String?        // Super Admin who approved
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  partner         Partner         @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  earnings        PartnerEarning[]

  // Only one agreement version number per partner
  @@unique([partnerId, version])
  @@index([partnerId])
  @@index([status])
  @@index([effectiveFrom, effectiveTo])
}

// ============================================================================
// PARTNER REFERRAL CODE
// Trackable codes for attribution
// Partners can have multiple codes for different campaigns
// ============================================================================
model PartnerReferralCode {
  id          String    @id @default(uuid())
  partnerId   String
  code        String    @unique // e.g., "PARTNER2024", "SUMMER-SALE"
  
  // Usage controls
  isActive    Boolean   @default(true)
  usageLimit  Int?      // Null = unlimited
  usageCount  Int       @default(0)
  expiresAt   DateTime? // Null = never expires
  
  // Campaign tracking
  campaignName String?  // e.g., "Q4 2024 Promotion"
  metadata    Json?     // Additional tracking data
  
  // Audit fields
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  partner     Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  referrals   PartnerReferral[]

  @@index([code])
  @@index([partnerId])
  @@index([isActive])
}

// ============================================================================
// PARTNER REFERRAL
// IMMUTABLE attribution link between Partner and Tenant
// Once created, the partner-tenant relationship cannot be changed
// This is the source of truth for "who referred this tenant"
// ============================================================================
model PartnerReferral {
  id              String    @id @default(uuid())
  partnerId       String
  tenantId        String    @unique // Each tenant can only have ONE referral (immutable)
  referralCodeId  String?   // The code used (if any)
  
  // Attribution method - HOW the tenant was linked
  attributionMethod AttributionMethod @default(REFERRAL_LINK)
  
  // Attribution timestamp - IMMUTABLE
  referredAt      DateTime  @default(now())
  
  // Attribution window configuration
  // If set, attribution is only valid for commissions within this period
  attributionWindowDays Int?     // null = lifetime attribution
  attributionExpiresAt  DateTime? // Calculated: referredAt + windowDays
  
  // Lock flag - set to true after first successful billing
  // Once locked, this record can NEVER be modified or deleted
  attributionLocked Boolean @default(false)
  lockedAt        DateTime?
  
  // Context at time of referral
  referralSource  String?   // e.g., "website", "email", "direct"
  landingPage     String?   // URL where signup occurred
  metadata        Json?     // Additional attribution data
  
  // Who created this attribution
  createdByUserId String?   // Partner user or Super Admin who created
  
  // Audit fields
  createdAt       DateTime  @default(now())
  // NO updatedAt - this is intentionally immutable

  // Relations
  partner         Partner   @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  referralCode    PartnerReferralCode? @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  earnings        PartnerEarning[]
  subscriptions   Subscription[]  // Subscriptions attributed to this referral

  @@index([partnerId])
  @@index([tenantId])
  @@index([referredAt])
  @@index([attributionLocked])
  @@index([attributionMethod])
}

// ============================================================================
// PARTNER EARNING
// Tracks commission earned by partner for each billing period
// Linked to specific agreement version that was active at time of earning
// ============================================================================
model PartnerEarning {
  id              String        @id @default(uuid())
  partnerId       String
  referralId      String        // Which tenant referral generated this
  agreementId     String        // Which agreement terms applied
  
  // Billing period
  periodStart     DateTime      // Start of billing period
  periodEnd       DateTime      // End of billing period
  
  // Financial details
  grossAmount     Decimal       @db.Decimal(12, 2) // Total billed to tenant
  commissionRate  Decimal       @db.Decimal(5, 4)  // Rate at time of earning
  commissionAmount Decimal      @db.Decimal(12, 2) // Calculated earning
  currency        String        @default("USD")
  
  // Status tracking
  status          EarningStatus @default(PENDING)
  
  // Payment tracking
  paidAt          DateTime?
  paymentReference String?      // External payment ID
  paymentMethod   String?       // e.g., "bank_transfer", "paypal"
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  approvedAt      DateTime?
  approvedByUserId String?      // Super Admin who approved

  // Relations
  partner         Partner       @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  referral        PartnerReferral @relation(fields: [referralId], references: [id], onDelete: Restrict)
  agreement       PartnerAgreement @relation(fields: [agreementId], references: [id], onDelete: Restrict)

  @@index([partnerId])
  @@index([referralId])
  @@index([agreementId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
}

// ============================================================================
// AUDIT LOG
// Track all significant actions for compliance and debugging
// ============================================================================
enum AuditAction {
  // Tenant actions
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  TENANT_DEACTIVATED
  
  // Domain actions
  DOMAIN_ADDED
  DOMAIN_REMOVED
  DOMAIN_VERIFIED
  
  // User actions
  USER_INVITED
  USER_REMOVED
  USER_ROLE_CHANGED
  
  // Auth actions
  USER_LOGIN
  USER_LOGOUT
  
  // Super Admin actions
  SUPER_ADMIN_IMPERSONATION_START
  SUPER_ADMIN_IMPERSONATION_END
  
  // Partner actions
  PARTNER_CREATED
  PARTNER_UPDATED
  PARTNER_APPROVED
  PARTNER_SUSPENDED
  PARTNER_TERMINATED
  PARTNER_USER_ADDED
  PARTNER_USER_REMOVED
  PARTNER_AGREEMENT_CREATED
  PARTNER_AGREEMENT_SIGNED
  PARTNER_AGREEMENT_APPROVED
  PARTNER_REFERRAL_CREATED
  PARTNER_REFERRAL_LOCKED
  PARTNER_EARNING_CREATED
  PARTNER_EARNING_APPROVED
  PARTNER_EARNING_PAID
  
  // Attribution actions
  ATTRIBUTION_CREATED           // New attribution link created
  ATTRIBUTION_LOCKED            // Attribution locked after first billing
  ATTRIBUTION_LOCK_ATTEMPTED    // Failed attempt to modify locked attribution
  ATTRIBUTION_REASSIGN_BLOCKED  // Attempted reassignment blocked
  
  // Partner-assisted tenant creation
  PARTNER_TENANT_CREATED        // Partner created tenant in PENDING state
  PARTNER_TENANT_ACTIVATED      // Tenant completed signup and activated
  
  // Subscription actions (module-agnostic)
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_PAUSED
  SUBSCRIPTION_RESUMED
  SUBSCRIPTION_UPGRADED
  SUBSCRIPTION_DOWNGRADED
  SUBSCRIPTION_EXPIRED
  
  // Entitlement actions
  ENTITLEMENT_GRANTED
  ENTITLEMENT_REVOKED
  ENTITLEMENT_EXPIRED
  
  // Invoice actions
  INVOICE_CREATED
  INVOICE_PAID
  INVOICE_VOIDED
}

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  actorId     String      // User who performed the action
  actorEmail  String      // Denormalized for easy querying
  tenantId    String?     // Null for super admin global actions
  targetType  String?     // e.g., "User", "Tenant", "TenantDomain"
  targetId    String?     // ID of the affected entity
  metadata    Json?       // Additional context
  ipAddress   String?
  userAgent   String?
  
  // Audit fields
  createdAt   DateTime    @default(now())

  @@index([actorId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@index([targetType, targetId])
}
