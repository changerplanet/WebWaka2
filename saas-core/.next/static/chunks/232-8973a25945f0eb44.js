"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[232],{9232:function(e,t,n){n.d(t,{fh:function(){return g},kr:function(){return w},j3:function(){return S}});var a=n(2265);let r=["USER_DELETE","USER_INVITE","PERMISSION_CHANGE","PAYMENT_PROCESS","TENANT_DELETE","ADMIN_ACTION"],i={ACTIONS:"offlineActions",CACHE:"cachedData",META:"syncMeta"},s=null;function o(){return s||(s=new Promise((e,t)=>{if("undefined"==typeof indexedDB){t(Error("IndexedDB not available"));return}let n=indexedDB.open("saas-core-offline",1);n.onerror=()=>{console.error("Failed to open IndexedDB:",n.error),t(n.error)},n.onsuccess=()=>{e(n.result)},n.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains(i.ACTIONS)){let e=t.createObjectStore(i.ACTIONS,{keyPath:"id"});e.createIndex("byTenant","tenantId",{unique:!1}),e.createIndex("byStatus","syncStatus",{unique:!1}),e.createIndex("byTenantStatus",["tenantId","syncStatus"],{unique:!1}),e.createIndex("byTimestamp","clientTimestamp",{unique:!1})}if(!t.objectStoreNames.contains(i.CACHE)){let e=t.createObjectStore(i.CACHE,{keyPath:["tenantId","key"]});e.createIndex("byTenant","tenantId",{unique:!1}),e.createIndex("byExpiry","expiresAt",{unique:!1})}t.objectStoreNames.contains(i.META)||t.createObjectStore(i.META,{keyPath:"key"})}}))}async function l(){return o()}async function c(e){let t=await l(),n={...e,id:crypto.randomUUID(),clientTimestamp:Date.now(),syncStatus:"pending",retryCount:0};return new Promise((e,a)=>{let r=t.transaction(i.ACTIONS,"readwrite").objectStore(i.ACTIONS).add(n);r.onsuccess=()=>e(n),r.onerror=()=>a(r.error)})}async function u(e){let t=await l();return new Promise((n,a)=>{let r=t.transaction(i.ACTIONS,"readonly").objectStore(i.ACTIONS).index("byTenant").getAll(IDBKeyRange.only(e));r.onsuccess=()=>{let e=r.result;e.sort((e,t)=>e.clientTimestamp-t.clientTimestamp),n(e)},r.onerror=()=>a(r.error)})}async function d(e,t){let n=await l();return new Promise((a,r)=>{let s=n.transaction(i.ACTIONS,"readwrite").objectStore(i.ACTIONS).index("byTenant").openCursor(IDBKeyRange.only(e)),o=0;s.onsuccess=()=>{let e=s.result;if(e){let n=e.value;(!t||n.syncStatus===t)&&(e.delete(),o++),e.continue()}else a(o)},s.onerror=()=>r(s.error)})}async function f(e){let t=await l();return new Promise((n,a)=>{let r=t.transaction(i.ACTIONS,"readwrite").objectStore(i.ACTIONS).index("byTenantStatus").openCursor(IDBKeyRange.only([e,"failed"])),s=0;r.onsuccess=()=>{let e=r.result;if(e){let t=e.value;t.syncStatus="pending",t.retryCount=0,t.errorMessage=void 0,e.update(t),s++,e.continue()}else n(s)},r.onerror=()=>a(r.error)})}async function y(e){let t=await u(e);return{pending:t.filter(e=>"pending"===e.syncStatus).length,syncing:t.filter(e=>"syncing"===e.syncStatus).length,synced:t.filter(e=>"synced"===e.syncStatus).length,failed:t.filter(e=>"failed"===e.syncStatus).length,conflict:t.filter(e=>"conflict"===e.syncStatus).length,total:t.length}}function w(){let[e,t]=(0,a.useState)("undefined"==typeof navigator||navigator.onLine);return(0,a.useEffect)(()=>{let e=()=>t(!0),n=()=>t(!1);return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}},[]),e}function S(){let[e,t]=(0,a.useState)(null),[n,r]=(0,a.useState)(!1);(0,a.useEffect)(()=>{"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered"),t(e),e.addEventListener("updatefound",()=>{let t=e.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&r(!0)})})}).catch(e=>console.error("SW registration failed:",e)),navigator.serviceWorker.addEventListener("message",e=>{let{type:t,actionId:n,tenantId:a,error:r,conflictData:i}=e.data||{};window.dispatchEvent(new CustomEvent("sw-message",{detail:{type:t,actionId:n,tenantId:a,error:r,conflictData:i}}))}))},[]);let i=(0,a.useCallback)(()=>{(null==e?void 0:e.waiting)&&(e.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload())},[e]),s=(0,a.useCallback)(()=>{if(e){var t;let n=new MessageChannel;null===(t=e.active)||void 0===t||t.postMessage({type:"TRIGGER_SYNC"},[n.port2])}},[e]),o=(0,a.useCallback)(t=>{if(e){var n;let a=new MessageChannel;null===(n=e.active)||void 0===n||n.postMessage({type:"CLEAR_TENANT_CACHE",data:{tenantSlug:t}},[a.port2])}},[e]);return{registration:e,updateAvailable:n,update:i,triggerSync:s,clearTenantCache:o}}function g(e){let[t,n]=(0,a.useState)([]),[i,s]=(0,a.useState)({pending:0,syncing:0,synced:0,failed:0,conflict:0,total:0}),[l,S]=(0,a.useState)(!0),g=w(),E=(0,a.useCallback)(async()=>{try{await o();let[t,a]=await Promise.all([u(e),y(e)]);n(t),s(a)}catch(e){console.error("Failed to load offline actions:",e)}finally{S(!1)}},[e]);return(0,a.useEffect)(()=>{E()},[E,g]),(0,a.useEffect)(()=>{let t=t=>{let{type:n,tenantId:a}=t.detail;a!==e&&a||E()};return window.addEventListener("sw-message",t),()=>window.removeEventListener("sw-message",t)},[e,E]),{actions:t,stats:i,loading:l,isOnline:g,queue:(0,a.useCallback)(async(t,n,a,i,s,l,u)=>{if(r.includes(t))throw Error("Action type ".concat(t," is not allowed offline"));await o();let d=await c({tenantId:e,userId:s,type:t,endpoint:n,method:a,payload:i,resourceId:l,resourceVersion:u});return await E(),d},[e,E]),retryFailed:(0,a.useCallback)(async()=>{await o();let t=await f(e);return await E(),t},[e,E]),clear:(0,a.useCallback)(async t=>{await o();let n=await d(e,t);return await E(),n},[e,E]),refresh:E}}}}]);