"use strict";(()=>{var e={};e.id=7590,e.ids=[7590],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},88087:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>p,POST:()=>l});var s=r(49303),a=r(88716),o=r(60670),i=r(87070),c=r(56238);function u(e){return e?Number(e):0}function d(e,t=!0){return{id:e.id,tenantId:e.tenantId,name:e.name,slug:e.slug,description:e.description,shortDescription:e.shortDescription,categoryId:e.categoryId,categoryName:e.category?.name,tags:e.tags||[],basePrice:u(e.price),compareAtPrice:e.compareAtPrice?u(e.compareAtPrice):null,currency:"USD",taxable:e.taxable??!0,taxCategoryId:e.taxCategoryId,images:e.images?.map(e=>({id:e.id,url:e.url,altText:e.altText,position:e.position,isDefault:e.isDefault}))||[],status:e.status,publishedAt:e.publishedAt?.toISOString(),hasVariants:e.variants?.length>1,variants:t?e.variants?.map(t=>({id:t.id,productId:t.productId,name:t.name,sku:t.sku,barcode:t.barcode,price:u(t.price||e.price),compareAtPrice:t.compareAtPrice?u(t.compareAtPrice):null,options:t.optionValues||{},imageUrl:t.imageUrl,weight:t.weight?u(t.weight):null,isActive:t.isActive??!0,inventoryQuantity:0,inventoryPolicy:e.allowBackorder?"CONTINUE":"DENY",createdAt:t.createdAt?.toISOString(),updatedAt:t.updatedAt?.toISOString()})):[],options:e.options||[],metaTitle:e.metaTitle,metaDescription:e.metaDescription,weight:e.weight?u(e.weight):null,weightUnit:e.weightUnit||"lb",createdAt:e.createdAt?.toISOString(),updatedAt:e.updatedAt?.toISOString()}}async function p(e){try{let{searchParams:t}=new URL(e.url),r=t.get("tenantId"),n=t.get("productId"),s=t.get("slug"),a=t.get("categoryId"),o=t.get("query");t.get("inStockOnly");let u=t.get("status")||"ACTIVE",p=t.get("sortBy")||"name",l=t.get("sortOrder")||"asc",g=parseInt(t.get("limit")||"24",10),m=parseInt(t.get("offset")||"0",10);if(!r)return i.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});if(n){let e=await c._B.product.findFirst({where:{id:n,tenantId:r},include:{category:!0,variants:!0}});if(!e)return i.NextResponse.json({success:!1,error:"Product not found"},{status:404});return i.NextResponse.json({success:!0,product:d(e),source:"CORE"})}if(s){let e=await c._B.product.findFirst({where:{slug:s,tenantId:r},include:{category:!0,variants:!0}});if(!e)return i.NextResponse.json({success:!1,error:"Product not found"},{status:404});return i.NextResponse.json({success:!0,product:d(e),source:"CORE"})}let h={tenantId:r,status:u};a&&(h.categoryId=a),o&&(h.OR=[{name:{contains:o,mode:"insensitive"}},{description:{contains:o,mode:"insensitive"}},{sku:{contains:o,mode:"insensitive"}},{tags:{has:o}}]);let f=await c._B.product.count({where:h}),y={};"price"===p?y.price=l:"createdAt"===p?y.createdAt=l:y.name=l;let I=await c._B.product.findMany({where:h,include:{category:!0,variants:!0},orderBy:y,take:g,skip:m});return i.NextResponse.json({success:!0,products:I.map(e=>d(e)),total:f,hasMore:m+I.length<f,source:"CORE"})}catch(e){return console.error("[SVM] Error fetching catalog:",e),i.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function l(e){try{let{tenantId:t,productIds:r}=await e.json();if(!t)return i.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});if(!r||!Array.isArray(r))return i.NextResponse.json({success:!1,error:"productIds array is required"},{status:400});let n=await c._B.product.findMany({where:{id:{in:r},tenantId:t},include:{category:!0,variants:!0}});return i.NextResponse.json({success:!0,products:n.map(e=>d(e)),count:n.length,source:"CORE"})}catch(e){return console.error("[SVM] Error batch fetching products:",e),i.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/svm/catalog/route",pathname:"/api/svm/catalog",filename:"route",bundlePath:"app/api/svm/catalog/route"},resolvedPagePath:"/app/saas-core/src/app/api/svm/catalog/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:f}=g,y="/api/svm/catalog/route";function I(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},56238:(e,t,r)=>{r.d(t,{xW:()=>u,eE:()=>c,KS:()=>p,qk:()=>i,_B:()=>g,G0:()=>d,ah:()=>l});var n=r(53524);let s=["TenantMembership","TenantDomain","AuditLog"],a=[];function o(e){let t={...e,timestamp:new Date};a.push(t),a.length>1e3&&a.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function i(){return[...a]}function c(){a.length=0}class u extends Error{constructor(e,t,r,n){super(e),this.model=t,this.action=r,this.context=n,this.name="TenantIsolationError"}}function d(e,t,r,n){if(s.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let s="Bypass isolation attempted without SUPER_ADMIN role";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let s="No tenant context provided for tenant-scoped query";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}if(!r.tenantId){let s="No tenantId in context for tenant-scoped query";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}if(n&&n!==r.tenantId){let s=`Cross-tenant access attempt: query tenantId (${n}) != context tenantId (${r.tenantId})`;throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}}}}function p(e,t,r,n=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:n}}function l(e,t){return{...e,tenantId:t}}let g=globalThis.prisma??new n.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9380,5972],()=>r(88087));module.exports=n})();