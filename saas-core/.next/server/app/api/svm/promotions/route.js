"use strict";(()=>{var e={};e.id=3426,e.ids=[3426],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47898:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>d,POST:()=>p});var o=r(49303),i=r(88716),n=r(60670),a=r(87070),u=r(87151),c=r(32199);async function p(e){try{let t=await e.json(),{tenantId:r,action:s}=t;if(!r)return a.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});switch(s){case"VALIDATE":{let{code:e,subtotal:s,items:o,customerId:i,isFirstOrder:n}=t;if(!e)return a.NextResponse.json({success:!1,error:"Coupon code is required"},{status:400});let c=await (0,u.jC)(r,e);if(!c)return a.NextResponse.json({success:!1,valid:!1,error:"Invalid coupon code",errorCode:"NOT_FOUND"});let p=(o||[]).reduce((e,t)=>e+t.quantity,0),d=await (0,u.QF)(c,s||0,p,i,n,[]);if(!d.valid)return a.NextResponse.json({success:!0,valid:!1,error:d.error,errorCode:d.errorCode});let l=(0,u.Et)(c,o||[],s||0,t.shippingTotal);return a.NextResponse.json({success:!0,valid:!0,promotion:{id:c.id,name:c.name,description:c.description,code:c.code,discountType:c.discountType,discountValue:c.discountValue},potentialDiscount:l})}case"CALCULATE":{let{items:e,subtotal:s,shippingTotal:o,couponCodes:i,customerId:n,isFirstOrder:p}=t;if(void 0===s)return a.NextResponse.json({success:!1,error:"subtotal is required"},{status:400});let d=e||[],l=d.reduce((e,t)=>e+t.quantity,0),m=await (0,u.V$)(r),y=(i||[]).map(e=>(0,u.jC)(r,e)),g=(await Promise.all(y)).filter(e=>null!==e),f=[...m,...g].sort((e,t)=>t.priority!==e.priority?t.priority-e.priority:t.discountValue-e.discountValue),x=[],v=[],h=new c.Z(0),N=new c.Z(0);for(let e of f){let t=await (0,u.QF)(e,s,l,n,p,x);if(!t.valid){"COUPON"===e.type&&v.push(`${e.code}: ${t.error}`);continue}let r=(0,u.iP)(e,d);if(0===r.length&&"FREE_SHIPPING"!==e.discountType){"COUPON"===e.type&&v.push(`${e.code}: No eligible items in your cart`);continue}let i=(0,u.Et)(e,d,s,o);if(i&&(x.push(i),i.freeShipping&&o?N=new c.Z(o):h=h.plus(i.discountAmount),!e.stackable))break}h.greaterThan(s)&&(h=new c.Z(s));let w=new c.Z(s).minus(h).toDecimalPlaces(2).toNumber();return a.NextResponse.json({success:!0,appliedPromotions:x,subtotal:s,discountTotal:h.toDecimalPlaces(2).toNumber(),shippingDiscount:N.toDecimalPlaces(2).toNumber(),finalSubtotal:w,shippingTotal:o?new c.Z(o).minus(N).toNumber():void 0,errors:v.length>0?v:void 0})}default:{let{name:e,description:s,code:o,type:i,discountType:n,discountValue:c,maxDiscount:p,minOrderTotal:d,minQuantity:l,productIds:m,categoryIds:y,excludeProductIds:g,customerIds:f,firstOrderOnly:x,usageLimit:v,perCustomerLimit:h,startsAt:N,endsAt:w,stackable:P,priority:A,buyQuantity:O,getQuantity:T,getDiscountPercent:C}=t;if(!e||!n)return a.NextResponse.json({success:!1,error:"name and discountType are required"},{status:400});if(o&&await (0,u.jC)(r,o))return a.NextResponse.json({success:!1,error:"A promotion with this code already exists"},{status:400});let D={id:(0,u.Ox)("promo"),tenantId:r,name:e,description:s,code:o?.toUpperCase(),type:i||(o?"COUPON":"AUTOMATIC"),discountType:n,discountValue:c||0,maxDiscount:p,minOrderTotal:d,minQuantity:l,productIds:m||[],categoryIds:y||[],excludeProductIds:g||[],customerIds:f||[],firstOrderOnly:x||!1,usageLimit:v,usageCount:0,perCustomerLimit:h,startsAt:N?new Date(N):new Date,endsAt:w?new Date(w):void 0,isActive:!0,stackable:P||!1,priority:A||0,buyQuantity:O,getQuantity:T,getDiscountPercent:C,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await (0,u.Bc)(D),a.NextResponse.json({success:!0,promotion:D},{status:201})}}}catch(e){return console.error("[SVM] Error processing promotions request:",e),a.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Internal server error"},{status:500})}}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("tenantId"),s="true"===t.get("activeOnly"),o=t.get("type");if(!r)return a.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});let i=s?await (0,u.PL)(r):await (0,u.Fh)(r);return o&&(i=i.filter(e=>e.type===o)),a.NextResponse.json({success:!0,promotions:i.map(e=>({id:e.id,name:e.name,description:e.description,code:e.code,type:e.type,discountType:e.discountType,discountValue:e.discountValue,maxDiscount:e.maxDiscount,minOrderTotal:e.minOrderTotal,minQuantity:e.minQuantity,firstOrderOnly:e.firstOrderOnly,usageLimit:e.usageLimit,usageCount:e.usageCount,perCustomerLimit:e.perCustomerLimit,startsAt:e.startsAt,endsAt:e.endsAt,isActive:e.isActive,stackable:e.stackable,priority:e.priority,buyQuantity:e.buyQuantity,getQuantity:e.getQuantity,getDiscountPercent:e.getDiscountPercent,displayValue:function(e){switch(e.discountType){case"PERCENTAGE":return`${e.discountValue}% off${e.maxDiscount?` (max $${e.maxDiscount})`:""}`;case"FIXED_AMOUNT":return`$${e.discountValue.toFixed(2)} off`;case"FIXED_PER_ITEM":return`$${e.discountValue.toFixed(2)} off per item`;case"FREE_SHIPPING":return"Free shipping";case"BUY_X_GET_Y":let t=100===e.getDiscountPercent?"free":`${e.getDiscountPercent}% off`;return`Buy ${e.buyQuantity} get ${e.getQuantity} ${t}`;default:return""}}(e)})),total:i.length,activeCount:i.filter(e=>e.isActive).length})}catch(e){return console.error("[SVM] Error listing promotions:",e),a.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/svm/promotions/route",pathname:"/api/svm/promotions",filename:"route",bundlePath:"app/api/svm/promotions/route"},resolvedPagePath:"/app/saas-core/src/app/api/svm/promotions/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:g}=l,f="/api/svm/promotions/route";function x(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:y})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9380,5972,2199,7151],()=>r(47898));module.exports=s})();