"use strict";(()=>{var e={};e.id=7687,e.ids=[7687],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},42015:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>u});var i=r(49303),n=r(88716),a=r(60670),o=r(87070),l=r(32199),p=r(84588);async function u(e){try{let{tenantId:t,destination:r,items:s,subtotal:i,currency:n="USD"}=await e.json();if(!t)return o.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});if(!r||!r.country)return o.NextResponse.json({success:!1,error:"destination with country is required"},{status:400});if(!s||!Array.isArray(s)||0===s.length)return o.NextResponse.json({success:!1,error:"items array is required"},{status:400});if(void 0===i)return o.NextResponse.json({success:!1,error:"subtotal is required"},{status:400});let a=await (0,p.rt)(t),u=s.reduce((e,t)=>e+t.quantity,0),c=s.reduce((e,t)=>e+(t.weight||0)*t.quantity,0),d=function(e,t){let r=e.filter(e=>e.isActive).sort((e,t)=>t.priority-e.priority);for(let e of r)if(function(e,t){let{country:r,state:s,city:i,postalCode:n}=t;if(e.countries.length>0){if(!e.countries.some(e=>e.toUpperCase()===r.toUpperCase()))return!1}else if(!e.isDefault)return!1;return(!(e.states.length>0)||!s||!!e.states.some(e=>e.toUpperCase()===s.toUpperCase()))&&(!(e.cities.length>0)||!i||!!e.cities.some(e=>e.toLowerCase()===i.toLowerCase()))&&(!(e.postalCodes.length>0)||!n||!!e.postalCodes.some(e=>e.endsWith("*")?n.startsWith(e.slice(0,-1)):e===n))}(e,t))return e;return r.find(e=>e.isDefault)||null}(a,r);if(!d)return o.NextResponse.json({success:!0,destination:r,matchedZone:null,options:[],itemCount:u,totalWeight:c,subtotal:i,noShippingReason:"No shipping available to this destination"});let m=d.rates.filter(e=>e.isActive).filter(e=>!(void 0!==e.minOrderTotal&&null!==e.minOrderTotal&&i<e.minOrderTotal||void 0!==e.maxOrderTotal&&null!==e.maxOrderTotal&&i>e.maxOrderTotal||void 0!==e.minWeight&&null!==e.minWeight&&c<e.minWeight||void 0!==e.maxWeight&&null!==e.maxWeight&&c>e.maxWeight||e.allowedProductIds?.length&&!s.some(t=>e.allowedProductIds.includes(t.productId))||e.excludedProductIds?.length&&s.some(t=>e.excludedProductIds.includes(t.productId))||e.allowedCategoryIds?.length&&!s.some(t=>t.categoryId&&e.allowedCategoryIds.includes(t.categoryId))||e.excludedCategoryIds?.length&&s.some(t=>t.categoryId&&e.excludedCategoryIds.includes(t.categoryId)))).sort((e,t)=>e.priority-t.priority);if(0===m.length)return o.NextResponse.json({success:!0,destination:r,matchedZone:{id:d.id,name:d.name},options:[],itemCount:u,totalWeight:c,subtotal:i,noShippingReason:"No shipping rates available for this order"});let g=m.map(e=>{let t=function(e,t,r,s){let i=new l.Z(0);switch(e.rateType){case"FLAT":i=new l.Z(e.flatRate||0);break;case"WEIGHT_BASED":i=new l.Z(e.baseWeightFee||0).plus(new l.Z(e.weightRate||0).times(r));break;case"PRICE_BASED":i=new l.Z(t).times(e.percentageRate||0);break;case"ITEM_BASED":i=new l.Z(e.perItemRate||0).times(s)}let n=i.toDecimalPlaces(2).toNumber();return void 0!==e.freeAbove&&null!==e.freeAbove&&t>=e.freeAbove?{fee:0,originalFee:n,isFree:!0,freeShippingApplied:!0}:{fee:n,isFree:0===n,freeShippingApplied:!1,amountToFreeShipping:e.freeAbove?new l.Z(e.freeAbove).minus(t).toDecimalPlaces(2).toNumber():void 0}}(e,i,c,u);return{rateId:e.id,zoneName:d.name,rateName:e.name,carrier:e.carrier,description:e.description,fee:t.fee,originalFee:t.originalFee,isFree:t.isFree,freeShippingApplied:t.freeShippingApplied,freeShippingThreshold:e.freeAbove,amountToFreeShipping:t.amountToFreeShipping,estimatedDays:e.minDays||e.maxDays?{min:e.minDays,max:e.maxDays}:null,currency:n}}),h=g.reduce((e,t)=>t.fee<e.fee?t:e,g[0]),f=g.filter(e=>e.estimatedDays?.max),y=f.length>0?f.reduce((e,t)=>(t.estimatedDays?.max||1/0)<(e.estimatedDays?.max||1/0)?t:e,f[0]):null;return o.NextResponse.json({success:!0,destination:r,matchedZone:{id:d.id,name:d.name},options:g,cheapestOption:h,fastestOption:y!==h?y:null,itemCount:u,totalWeight:c,subtotal:i})}catch(e){return console.error("[SVM] Error calculating shipping:",e),o.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Internal server error"},{status:500})}}async function c(e){try{let{searchParams:t}=new URL(e.url),r=t.get("tenantId");if(!r)return o.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});let s=await (0,p.rt)(r);return o.NextResponse.json({success:!0,zones:s.map(e=>({id:e.id,name:e.name,description:e.description,countries:e.countries,states:e.states,postalCodes:e.postalCodes,cities:e.cities,isDefault:e.isDefault,isActive:e.isActive,priority:e.priority,rateCount:e.rates.filter(e=>e.isActive).length,rates:e.rates.map(e=>({id:e.id,name:e.name,description:e.description,carrier:e.carrier,rateType:e.rateType,flatRate:e.flatRate,freeAbove:e.freeAbove,estimatedDays:e.minDays||e.maxDays?{min:e.minDays,max:e.maxDays}:null,isActive:e.isActive}))})),totalZones:s.length,activeZones:s.filter(e=>e.isActive).length})}catch(e){return console.error("[SVM] Error listing shipping zones:",e),o.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/svm/shipping/route",pathname:"/api/svm/shipping",filename:"route",bundlePath:"app/api/svm/shipping/route"},resolvedPagePath:"/app/saas-core/src/app/api/svm/shipping/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h}=d,f="/api/svm/shipping/route";function y(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9380,5972,2199,4588],()=>r(42015));module.exports=s})();