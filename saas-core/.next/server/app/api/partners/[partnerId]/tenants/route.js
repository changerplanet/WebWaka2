"use strict";(()=>{var e={};e.id=8036,e.ids=[8036],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},83122:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>I,serverHooks:()=>N,staticGenerationAsyncStorage:()=>A});var a={};r.r(a),r.d(a,{GET:()=>g,POST:()=>m});var n=r(49303),s=r(88716),o=r(60670),i=r(87070),u=r(56238),d=r(93270);let c=["POS","SVM","MVM"];async function l(e,t){let r=await (0,d.uZ)();if(!r.authorized)return{success:!1,error:r.error,code:"UNAUTHORIZED"};if(r.partner.id!==e)return{success:!1,error:"Cannot create tenant for a different partner",code:"UNAUTHORIZED"};if("ACTIVE"!==r.partner.status)return{success:!1,error:"Partner must be active to create tenants",code:"PARTNER_INACTIVE"};if(!t.name||!t.slug||!t.contactEmail)return{success:!1,error:"Name, slug, and contact email are required",code:"INVALID_INPUT"};if(!/^[a-z0-9-]+$/.test(t.slug))return{success:!1,error:"Slug must contain only lowercase letters, numbers, and hyphens",code:"INVALID_INPUT"};if(0===t.requestedModules.length)return{success:!1,error:"At least one module must be selected",code:"INVALID_INPUT"};if(!t.requestedModules.every(e=>c.includes(e)))return{success:!1,error:`Invalid modules. Available: ${c.join(", ")}`,code:"MODULE_INVALID"};if(await u._B.tenant.findUnique({where:{slug:t.slug}}))return{success:!1,error:"A tenant with this slug already exists",code:"SLUG_EXISTS"};let a=await u._B.$transaction(async a=>{let n=await a.tenant.create({data:{name:t.name,slug:t.slug,status:"PENDING_ACTIVATION",requestedModules:t.requestedModules,activatedModules:[],appName:t.branding?.appName||t.name,primaryColor:t.branding?.primaryColor||"#6366f1",secondaryColor:t.branding?.secondaryColor||"#8b5cf6"}});await a.tenantDomain.create({data:{tenantId:n.id,domain:t.slug,type:"SUBDOMAIN",status:"VERIFIED",isPrimary:!0}});let s=await a.partnerReferral.create({data:{partnerId:e,tenantId:n.id,attributionMethod:"PARTNER_CREATED",attributionWindowDays:t.attributionWindowDays,attributionExpiresAt:t.attributionWindowDays?new Date(Date.now()+864e5*t.attributionWindowDays):null,referralSource:"partner-portal",createdByUserId:r.user.id,metadata:{contactEmail:t.contactEmail,contactName:t.contactName,requestedModules:t.requestedModules,partnerMetadata:t.metadata}}});return await a.auditLog.create({data:{action:"PARTNER_TENANT_CREATED",actorId:r.user.id,actorEmail:r.user.email,tenantId:n.id,targetType:"Tenant",targetId:n.id,metadata:{partnerId:e,partnerName:r.partner.name,tenantSlug:n.slug,requestedModules:t.requestedModules,contactEmail:t.contactEmail,attributionWindowDays:t.attributionWindowDays}}}),{tenant:n,referral:s}}),n=function(e,t){let r=encodeURIComponent(t);return`https://nextjs-commerce.preview.emergentagent.com/signup/complete?tenant=${e}&email=${r}`}(a.tenant.slug,t.contactEmail);return{success:!0,tenant:a.tenant,referral:a.referral,invitationUrl:n}}async function p(e,t){if(!(await (0,d.MQ)(e)).authorized)return{tenants:[],total:0};let r={partnerId:e,attributionMethod:"PARTNER_CREATED"};t?.status&&(r.tenant={status:{in:t.status}});let[a,n]=await Promise.all([u._B.partnerReferral.findMany({where:r,include:{tenant:!0},take:t?.limit||50,skip:t?.offset||0,orderBy:{createdAt:"desc"}}),u._B.partnerReferral.count({where:r})]);return{tenants:a.map(e=>e.tenant),total:n}}async function m(e,{params:t}){try{let{partnerId:r}=await t,a=await e.json();if(!a.name||!a.slug||!a.contactEmail)return i.NextResponse.json({error:"name, slug, and contactEmail are required"},{status:400});if(!a.requestedModules||!Array.isArray(a.requestedModules)||0===a.requestedModules.length)return i.NextResponse.json({error:`requestedModules is required. Available: ${c.join(", ")}`},{status:400});let n=await l(r,{name:a.name,slug:a.slug,contactEmail:a.contactEmail,contactName:a.contactName,requestedModules:a.requestedModules,branding:a.branding,attributionWindowDays:a.attributionWindowDays,metadata:a.metadata});if(!n.success)return i.NextResponse.json({error:n.error,code:n.code},{status:{UNAUTHORIZED:403,INVALID_INPUT:400,SLUG_EXISTS:409,PARTNER_INACTIVE:403,MODULE_INVALID:400}[n.code||""]||500});return i.NextResponse.json({tenant:{id:n.tenant.id,name:n.tenant.name,slug:n.tenant.slug,status:n.tenant.status,requestedModules:n.tenant.requestedModules,createdAt:n.tenant.createdAt},attribution:{id:n.referral.id,method:n.referral.attributionMethod,attributionWindowDays:n.referral.attributionWindowDays,isLifetime:!n.referral.attributionWindowDays},invitationUrl:n.invitationUrl},{status:201})}catch(e){return console.error("Error creating tenant:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function g(e,{params:t}){try{let{partnerId:r}=await t,a=await (0,d.MQ)(r);if(!a.authorized)return i.NextResponse.json({error:a.error},{status:a.status});let{searchParams:n}=new URL(e.url),s=n.get("status")?.split(",").filter(Boolean),o=parseInt(n.get("limit")||"50"),u=parseInt(n.get("offset")||"0"),c=await p(r,{status:s,limit:o,offset:u});return i.NextResponse.json({tenants:c.tenants.map(e=>({id:e.id,name:e.name,slug:e.slug,status:e.status,requestedModules:e.requestedModules,activatedModules:e.activatedModules,activatedAt:e.activatedAt,createdAt:e.createdAt})),total:c.total,limit:o,offset:u})}catch(e){return console.error("Error listing tenants:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/partners/[partnerId]/tenants/route",pathname:"/api/partners/[partnerId]/tenants",filename:"route",bundlePath:"app/api/partners/[partnerId]/tenants/route"},resolvedPagePath:"/app/saas-core/src/app/api/partners/[partnerId]/tenants/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:A,serverHooks:N}=I,E="/api/partners/[partnerId]/tenants/route";function y(){return(0,o.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:A})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9380,5972,6970,3270],()=>r(83122));module.exports=a})();