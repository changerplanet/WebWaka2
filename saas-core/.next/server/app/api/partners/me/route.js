"use strict";(()=>{var e={};e.id=6572,e.ids=[6572],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},50189:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>w});var r={};n.r(r),n.d(r,{GET:()=>c});var s=n(49303),i=n(88716),a=n(60670),o=n(87070),u=n(95456),d=n(56238);async function c(){try{let e=await (0,u.y_)();if(!e)return o.NextResponse.json({success:!1,error:"Authentication required"},{status:401});let t=await d._B.partnerUser.findUnique({where:{userId:e.user.id},include:{partner:{select:{id:!0,name:!0,slug:!0,status:!0,tier:!0}}}});if(!t)return o.NextResponse.json({success:!1,error:"Not a partner user"},{status:403});if(!t.isActive)return o.NextResponse.json({success:!1,error:"Partner membership is disabled"},{status:403});if("ACTIVE"!==t.partner.status)return o.NextResponse.json({success:!1,error:"Partner organization is not active"},{status:403});return o.NextResponse.json({success:!0,partnerId:t.partnerId,partner:t.partner,role:t.role})}catch(e){return console.error("Error fetching partner info:",e),o.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/partners/me/route",pathname:"/api/partners/me",filename:"route",bundlePath:"app/api/partners/me/route"},resolvedPagePath:"/app/saas-core/src/app/api/partners/me/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:w,serverHooks:m}=l,h="/api/partners/me/route";function f(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:w})}},95456:(e,t,n)=>{n.d(t,{CK:()=>u,bA:()=>o,j5:()=>w,kS:()=>l,q4:()=>p,y_:()=>c});var r=n(56238),s=n(38547),i=n(71615);function a(){return(0,s.Z)()+"-"+(0,s.Z)()}async function o(e,t){let n=e.toLowerCase().trim(),i=await r._B.user.findUnique({where:{email:n}});i||(i=await r._B.user.create({data:{id:(0,s.Z)(),email:n,globalRole:"USER"}}));let o=a(),u=new Date;return u.setMinutes(u.getMinutes()+15),await r._B.magicLink.create({data:{id:(0,s.Z)(),token:o,userId:i.id,tenantId:t||null,expiresAt:u}}),{token:o,user:i}}async function u(e){let t=await r._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await r._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await r._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await r._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let n=a(),i=new Date;i.setDate(i.getDate()+7);let o=await r._B.session.create({data:{id:(0,s.Z)(),userId:t.userId,token:n,activeTenant:t.tenantId,expiresAt:i}});return{user:await r._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:o.id,token:n},tenantId:t.tenantId}}async function d(e){let t=await r._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await r._B.session.delete({where:{id:t.id}}),null):(await r._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function c(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function l(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;t&&await r._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function p(e,t){let n=await r._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!n)return!1;let s=n.user.memberships.some(e=>e.tenantId===t&&e.isActive),i="SUPER_ADMIN"===n.user.globalRole;return(!!s||!!i)&&(await r._B.session.update({where:{id:n.id},data:{activeTenant:t}}),!0)}function w(e){return"SUPER_ADMIN"===e.globalRole}},56238:(e,t,n)=>{n.d(t,{xW:()=>d,eE:()=>u,KS:()=>l,qk:()=>o,_B:()=>w,G0:()=>c,ah:()=>p});var r=n(53524);let s=["TenantMembership","TenantDomain","AuditLog"],i=[];function a(e){let t={...e,timestamp:new Date};i.push(t),i.length>1e3&&i.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function o(){return[...i]}function u(){i.length=0}class d extends Error{constructor(e,t,n,r){super(e),this.model=t,this.action=n,this.context=r,this.name="TenantIsolationError"}}function c(e,t,n,r){if(s.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let s="Bypass isolation attempted without SUPER_ADMIN role";throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new d(s,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let s="No tenant context provided for tenant-scoped query";throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new d(s,e,t,n)}if(!n.tenantId){let s="No tenantId in context for tenant-scoped query";throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new d(s,e,t,n)}if(r&&r!==n.tenantId){let s=`Cross-tenant access attempt: query tenantId (${r}) != context tenantId (${n.tenantId})`;throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new d(s,e,t,n)}}}}function l(e,t,n,r=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:r}}function p(e,t){return{...e,tenantId:t}}let w=globalThis.prisma??new r.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9380,5972,6970],()=>n(50189));module.exports=r})();