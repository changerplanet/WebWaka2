"use strict";(()=>{var e={};e.id=167,e.ids=[167],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},40850:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{PATCH:()=>p,POST:()=>l});var n=r(49303),o=r(88716),s=r(60670),i=r(87070),d=r(56238),u=r(70340),c=r(57662),m=r(90324);async function l(e,{params:t}){try{let{slug:e,domainId:r}=await t,a=await (0,u.nc)(e);if(!a.authorized)return i.NextResponse.json({success:!1,error:a.error},{status:a.status});let n=await d._B.tenantDomain.findFirst({where:{id:r,tenantId:a.tenantId}});if(!n)return i.NextResponse.json({success:!1,error:"Domain not found"},{status:404});let o=await (0,m.F2)(r);if(o.success)return await (0,c.U)({action:"DOMAIN_VERIFIED",actorId:a.user.id,actorEmail:a.user.email,tenantId:a.tenantId,targetType:"TenantDomain",targetId:r,metadata:{domain:n.domain}}),i.NextResponse.json({success:!0,domain:o.domain,message:"Domain verified successfully!"});return i.NextResponse.json({success:!1,error:o.error},{status:400})}catch(e){return console.error("Failed to verify domain:",e),i.NextResponse.json({success:!1,error:"Failed to verify domain"},{status:500})}}async function p(e,{params:t}){try{let{slug:r,domainId:a}=await t,n=await (0,u.nc)(r);if(!n.authorized)return i.NextResponse.json({success:!1,error:n.error},{status:n.status});let{isPrimary:o}=await e.json(),s=await d._B.tenantDomain.findFirst({where:{id:a,tenantId:n.tenantId}});if(!s)return i.NextResponse.json({success:!1,error:"Domain not found"},{status:404});if(o&&"VERIFIED"!==s.status)return i.NextResponse.json({success:!1,error:"Only verified domains can be set as primary"},{status:400});o&&await d._B.tenantDomain.updateMany({where:{tenantId:n.tenantId,isPrimary:!0},data:{isPrimary:!1}});let c=await d._B.tenantDomain.update({where:{id:a},data:{isPrimary:o}});return i.NextResponse.json({success:!0,domain:c})}catch(e){return console.error("Failed to update domain:",e),i.NextResponse.json({success:!1,error:"Failed to update domain"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tenants/[slug]/domains/[domainId]/route",pathname:"/api/tenants/[slug]/domains/[domainId]",filename:"route",bundlePath:"app/api/tenants/[slug]/domains/[domainId]/route"},resolvedPagePath:"/app/saas-core/src/app/api/tenants/[slug]/domains/[domainId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:w}=f,I="/api/tenants/[slug]/domains/[domainId]/route";function v(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},57662:(e,t,r)=>{r.d(t,{F:()=>i,U:()=>s});var a=r(56238),n=r(38547),o=r(71615);async function s(e){try{let t=await (0,o.headers)(),r=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",s=t.get("user-agent")||"unknown";await a._B.auditLog.create({data:{id:(0,n.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:r,userAgent:s}})}catch(e){console.error("Failed to create audit log:",e)}}async function i(e){let{tenantId:t,actorId:r,action:n,targetType:o,limit:s=50,offset:i=0}=e,d={};t&&(d.tenantId=t),r&&(d.actorId=r),n&&(d.action=n),o&&(d.targetType=o);let[u,c]=await Promise.all([a._B.auditLog.findMany({where:d,orderBy:{createdAt:"desc"},take:s,skip:i}),a._B.auditLog.count({where:d})]);return{logs:u,total:c}}},90324:(e,t,r)=>{r.d(t,{qq:()=>s,bz:()=>u,F2:()=>d});var a=r(56238);let n=require("dns/promises");var o=r.n(n);function s(e,t){return{domain:e,method:"TXT",recordName:`_saascore-verify.${e}`,recordValue:t,status:"PENDING",instructions:`Add a TXT record to your DNS with:

Name: _saascore-verify
Value: ${t}

Note: DNS changes may take up to 48 hours to propagate.`}}async function i(e,t){try{let r=`_saascore-verify.${e}`,a=(await o().resolveTxt(r).catch(()=>[])).map(e=>e.join(""));if(console.log(`[Domain Verification] Checking ${r}:`,a),a.some(e=>e===t))return{verified:!0,records:a};return{verified:!1,error:a.length>0?"TXT record found but value does not match":"No TXT record found",records:a}}catch(t){if(console.error(`[Domain Verification] Error for ${e}:`,t.message),"ENOTFOUND"===t.code||"ENODATA"===t.code)return{verified:!1,error:"DNS record not found. Please ensure you have added the TXT record and wait for DNS propagation."};return{verified:!1,error:`DNS lookup failed: ${t.message}`}}}async function d(e){let t=await a._B.tenantDomain.findUnique({where:{id:e}});if(!t)return{success:!1,error:"Domain not found"};if("SUBDOMAIN"===t.type)return{success:!1,error:"Subdomains do not require verification"};if("VERIFIED"===t.status)return{success:!0,domain:t};if(!t.verificationToken)return{success:!1,error:"No verification token found"};let r=await i(t.domain,t.verificationToken);return r.verified?{success:!0,domain:await a._B.tenantDomain.update({where:{id:e},data:{status:"VERIFIED",verifiedAt:new Date}})}:{success:!1,error:r.error}}async function u(e){return!await a._B.tenantDomain.findUnique({where:{domain:e.toLowerCase()}})}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9380,5972,6970,340],()=>r(40850));module.exports=a})();