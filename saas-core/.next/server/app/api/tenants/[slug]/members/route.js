"use strict";(()=>{var e={};e.id=657,e.ids=[657],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},26159:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>A,patchFetch:()=>_,requestAsyncStorage:()=>w,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var s={};n.r(s),n.d(s,{GET:()=>c,POST:()=>p});var r=n(49303),i=n(88716),a=n(60670),o=n(87070),u=n(56238),d=n(95456),l=n(38547);async function c(e,{params:t}){try{let{slug:e}=await t,n=await (0,d.y_)(),s=await u._B.tenant.findUnique({where:{slug:e}});if(!s)return o.NextResponse.json({success:!1,error:"Tenant not found"},{status:404});if(n){let e=n.user.memberships.some(e=>e.tenantId===s.id&&"TENANT_ADMIN"===e.role);if(!(0,d.j5)(n.user)&&!e)return o.NextResponse.json({success:!1,error:"Not authorized"},{status:403})}let r=await u._B.tenantMembership.findMany({where:{tenantId:s.id},include:{user:{select:{id:!0,email:!0,name:!0,avatarUrl:!0,globalRole:!0,lastLoginAt:!0}}},orderBy:{createdAt:"desc"}});return o.NextResponse.json({success:!0,members:r.map(e=>({id:e.id,role:e.role,isActive:e.isActive,joinedAt:e.joinedAt,user:e.user}))})}catch(e){return console.error("Failed to fetch members:",e),o.NextResponse.json({success:!1,error:"Failed to fetch members"},{status:500})}}async function p(e,{params:t}){try{let{slug:n}=await t;await (0,d.y_)();let{email:s,role:r="TENANT_USER"}=await e.json();if(!s)return o.NextResponse.json({success:!1,error:"Email is required"},{status:400});let i=await u._B.tenant.findUnique({where:{slug:n}});if(!i)return o.NextResponse.json({success:!1,error:"Tenant not found"},{status:404});let a=await u._B.user.findUnique({where:{email:s.toLowerCase()}});if(a||(a=await u._B.user.create({data:{id:(0,l.Z)(),email:s.toLowerCase(),globalRole:"USER"}})),await u._B.tenantMembership.findUnique({where:{userId_tenantId:{userId:a.id,tenantId:i.id}}}))return o.NextResponse.json({success:!1,error:"User is already a member of this tenant"},{status:409});let c=await u._B.tenantMembership.create({data:{id:(0,l.Z)(),userId:a.id,tenantId:i.id,role:"TENANT_ADMIN"===r?"TENANT_ADMIN":"TENANT_USER"},include:{user:{select:{id:!0,email:!0,name:!0,avatarUrl:!0}}}});return o.NextResponse.json({success:!0,membership:{id:c.id,role:c.role,isActive:c.isActive,joinedAt:c.joinedAt,user:c.user}},{status:201})}catch(e){return console.error("Failed to add member:",e),o.NextResponse.json({success:!1,error:"Failed to add member"},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/tenants/[slug]/members/route",pathname:"/api/tenants/[slug]/members",filename:"route",bundlePath:"app/api/tenants/[slug]/members/route"},resolvedPagePath:"/app/saas-core/src/app/api/tenants/[slug]/members/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:f}=m,A="/api/tenants/[slug]/members/route";function _(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},95456:(e,t,n)=>{n.d(t,{CK:()=>u,bA:()=>o,j5:()=>m,kS:()=>c,q4:()=>p,y_:()=>l});var s=n(56238),r=n(38547),i=n(71615);function a(){return(0,r.Z)()+"-"+(0,r.Z)()}async function o(e,t){let n=e.toLowerCase().trim(),i=await s._B.user.findUnique({where:{email:n}});i||(i=await s._B.user.create({data:{id:(0,r.Z)(),email:n,globalRole:"USER"}}));let o=a(),u=new Date;return u.setMinutes(u.getMinutes()+15),await s._B.magicLink.create({data:{id:(0,r.Z)(),token:o,userId:i.id,tenantId:t||null,expiresAt:u}}),{token:o,user:i}}async function u(e){let t=await s._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await s._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await s._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await s._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let n=a(),i=new Date;i.setDate(i.getDate()+7);let o=await s._B.session.create({data:{id:(0,r.Z)(),userId:t.userId,token:n,activeTenant:t.tenantId,expiresAt:i}});return{user:await s._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:o.id,token:n},tenantId:t.tenantId}}async function d(e){let t=await s._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await s._B.session.delete({where:{id:t.id}}),null):(await s._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function l(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function c(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;t&&await s._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function p(e,t){let n=await s._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!n)return!1;let r=n.user.memberships.some(e=>e.tenantId===t&&e.isActive),i="SUPER_ADMIN"===n.user.globalRole;return(!!r||!!i)&&(await s._B.session.update({where:{id:n.id},data:{activeTenant:t}}),!0)}function m(e){return"SUPER_ADMIN"===e.globalRole}},56238:(e,t,n)=>{n.d(t,{xW:()=>d,eE:()=>u,KS:()=>c,qk:()=>o,_B:()=>m,G0:()=>l,ah:()=>p});var s=n(53524);let r=["TenantMembership","TenantDomain","AuditLog"],i=[];function a(e){let t={...e,timestamp:new Date};i.push(t),i.length>1e3&&i.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function o(){return[...i]}function u(){i.length=0}class d extends Error{constructor(e,t,n,s){super(e),this.model=t,this.action=n,this.context=s,this.name="TenantIsolationError"}}function l(e,t,n,s){if(r.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let r="Bypass isolation attempted without SUPER_ADMIN role";throw a({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let r="No tenant context provided for tenant-scoped query";throw a({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}if(!n.tenantId){let r="No tenantId in context for tenant-scoped query";throw a({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}if(s&&s!==n.tenantId){let r=`Cross-tenant access attempt: query tenantId (${s}) != context tenantId (${n.tenantId})`;throw a({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}}}}function c(e,t,n,s=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:s}}function p(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new s.PrismaClient({log:["error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),s=t.X(0,[9380,5972,6970],()=>n(26159));module.exports=s})();