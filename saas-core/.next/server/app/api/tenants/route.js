"use strict";(()=>{var e={};e.id=4835,e.ids=[4835],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},57993:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var r={};n.r(r),n.d(r,{GET:()=>l,POST:()=>d});var s=n(49303),o=n(88716),a=n(60670),i=n(87070),u=n(56238),c=n(38547);async function l(e){try{let e=await u._B.tenant.findMany({include:{domains:!0,_count:{select:{memberships:!0}}},orderBy:{createdAt:"desc"}});return i.NextResponse.json({success:!0,tenants:e.map(e=>({...e,_count:{users:e._count.memberships}}))})}catch(e){return console.error("Failed to fetch tenants:",e),i.NextResponse.json({success:!1,error:"Failed to fetch tenants"},{status:500})}}async function d(e){try{let{name:t,slug:n,customDomain:r,appName:s,logoUrl:o,faviconUrl:a,primaryColor:l,secondaryColor:d}=await e.json();if(!t||!n)return i.NextResponse.json({success:!1,error:"Name and slug are required"},{status:400});let p=n.toLowerCase();if(!/^[a-z0-9-]+$/.test(p))return i.NextResponse.json({success:!1,error:"Slug must contain only lowercase letters, numbers, and hyphens"},{status:400});if(await u._B.tenant.findUnique({where:{slug:p}}))return i.NextResponse.json({success:!1,error:"This subdomain is already taken"},{status:409});if(await u._B.tenantDomain.findUnique({where:{domain:p}}))return i.NextResponse.json({success:!1,error:"This subdomain is already in use"},{status:409});if(r&&await u._B.tenantDomain.findUnique({where:{domain:r.toLowerCase()}}))return i.NextResponse.json({success:!1,error:"This custom domain is already in use"},{status:409});let m=await u._B.tenant.create({data:{id:(0,c.Z)(),name:t,slug:p,appName:s||t,logoUrl:o||null,faviconUrl:a||null,primaryColor:l||"#6366f1",secondaryColor:d||"#8b5cf6",domains:{create:[{id:(0,c.Z)(),domain:p,type:"SUBDOMAIN",status:"VERIFIED",isPrimary:!r,verifiedAt:new Date},...r?[{id:(0,c.Z)(),domain:r.toLowerCase(),type:"CUSTOM",status:"PENDING",isPrimary:!0,verificationToken:(0,c.Z)()}]:[]]}},include:{domains:!0}}),f={...m,branding:{id:m.id,tenantId:m.id,appName:m.appName,logoUrl:m.logoUrl,faviconUrl:m.faviconUrl,primaryColor:m.primaryColor,secondaryColor:m.secondaryColor}};return i.NextResponse.json({success:!0,tenant:f},{status:201})}catch(e){if(console.error("Failed to create tenant:",e),"P2002"===e.code)return i.NextResponse.json({success:!1,error:"A tenant with this slug or domain already exists"},{status:409});return i.NextResponse.json({success:!1,error:"Failed to create tenant"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tenants/route",pathname:"/api/tenants",filename:"route",bundlePath:"app/api/tenants/route"},resolvedPagePath:"/app/saas-core/src/app/api/tenants/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h}=p,y="/api/tenants/route";function w(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},56238:(e,t,n)=>{n.d(t,{xW:()=>c,eE:()=>u,KS:()=>d,qk:()=>i,_B:()=>m,G0:()=>l,ah:()=>p});var r=n(53524);let s=["TenantMembership","TenantDomain","AuditLog"],o=[];function a(e){let t={...e,timestamp:new Date};o.push(t),o.length>1e3&&o.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function i(){return[...o]}function u(){o.length=0}class c extends Error{constructor(e,t,n,r){super(e),this.model=t,this.action=n,this.context=r,this.name="TenantIsolationError"}}function l(e,t,n,r){if(s.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let s="Bypass isolation attempted without SUPER_ADMIN role";throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new c(s,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let s="No tenant context provided for tenant-scoped query";throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new c(s,e,t,n)}if(!n.tenantId){let s="No tenantId in context for tenant-scoped query";throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new c(s,e,t,n)}if(r&&r!==n.tenantId){let s=`Cross-tenant access attempt: query tenantId (${r}) != context tenantId (${n.tenantId})`;throw a({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new c(s,e,t,n)}}}}function d(e,t,n,r=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:r}}function p(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new r.PrismaClient({log:["error"]})},38547:(e,t,n)=>{n.d(t,{Z:()=>u});var r=n(6005);let s={randomUUID:r.randomUUID},o=new Uint8Array(256),a=o.length,i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));let u=function(e,t,n){return!s.randomUUID||t||e?function(e,t,n){let s=(e=e||{}).random??e.rng?.()??(a>o.length-16&&((0,r.randomFillSync)(o),a=0),o.slice(a,a+=16));if(s.length<16)throw Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){if((n=n||0)<0||n+16>t.length)throw RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[n+e]=s[e];return t}return function(e,t=0){return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}(s)}(e,t,n):s.randomUUID()}}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9380,5972],()=>n(57993));module.exports=r})();