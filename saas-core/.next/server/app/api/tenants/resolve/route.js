"use strict";(()=>{var e={};e.id=327,e.ids=[327],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6316:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>c});var a={};n.r(a),n.d(a,{GET:()=>l});var r=n(9303),o=n(8716),s=n(670),i=n(7070),u=n(2315);async function l(e){try{let{searchParams:t}=new URL(e.url),n=t.get("slug"),a=t.get("host")||e.headers.get("host"),r=null;if(n?r=await (0,u.G_)(n):a&&(r=await (0,u.FZ)(a)),!r)return i.NextResponse.json({success:!0,tenant:null,message:"No tenant resolved - showing default/super admin view"});let o=r.tenant;return i.NextResponse.json({success:!0,tenant:{id:o.id,name:o.name,slug:o.slug,status:o.status,domains:o.domains,resolvedVia:r.resolvedVia,branding:{id:o.id,tenantId:o.id,appName:o.appName,logoUrl:o.logoUrl,faviconUrl:o.faviconUrl,primaryColor:o.primaryColor,secondaryColor:o.secondaryColor},appName:o.appName,primaryColor:o.primaryColor,secondaryColor:o.secondaryColor}})}catch(e){return console.error("Failed to resolve tenant:",e),i.NextResponse.json({success:!1,error:"Failed to resolve tenant"},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/tenants/resolve/route",pathname:"/api/tenants/resolve",filename:"route",bundlePath:"app/api/tenants/resolve/route"},resolvedPagePath:"/app/saas-core/src/app/api/tenants/resolve/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:c,serverHooks:m}=d,f="/api/tenants/resolve/route";function h(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:c})}},6238:(e,t,n)=>{n.d(t,{xW:()=>l,eE:()=>u,KS:()=>p,qk:()=>i,_B:()=>m,G0:()=>d,ah:()=>c});var a=n(3524);let r=["TenantMembership","TenantDomain","AuditLog"],o=[];function s(e){let t={...e,timestamp:new Date};o.push(t),o.length>1e3&&o.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function i(){return[...o]}function u(){o.length=0}class l extends Error{constructor(e,t,n,a){super(e),this.model=t,this.action=n,this.context=a,this.name="TenantIsolationError"}}function d(e,t,n,a){if(r.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let r="Bypass isolation attempted without SUPER_ADMIN role";throw s({model:e,action:t,context:n,query:{queryTenantId:a},reason:r}),new l(r,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let r="No tenant context provided for tenant-scoped query";throw s({model:e,action:t,context:n,query:{queryTenantId:a},reason:r}),new l(r,e,t,n)}if(!n.tenantId){let r="No tenantId in context for tenant-scoped query";throw s({model:e,action:t,context:n,query:{queryTenantId:a},reason:r}),new l(r,e,t,n)}if(a&&a!==n.tenantId){let r=`Cross-tenant access attempt: query tenantId (${a}) != context tenantId (${n.tenantId})`;throw s({model:e,action:t,context:n,query:{queryTenantId:a},reason:r}),new l(r,e,t,n)}}}}function p(e,t,n,a=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:a}}function c(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new a.PrismaClient({log:["error"]})},2315:(e,t,n)=>{n.d(t,{FZ:()=>r,G_:()=>o,sP:()=>s});var a=n(6238);async function r(e){let t=e.split(":")[0].toLowerCase(),n=await a._B.tenantDomain.findFirst({where:{domain:t,type:"CUSTOM",status:"VERIFIED"},include:{tenant:{include:{domains:!0}}}});if(n&&"ACTIVE"===n.tenant.status)return{tenant:n.tenant,resolvedVia:"custom_domain",domain:t};let r=t.split(".");if(r.length>=3){let e=r[0];if(!["www","api","app","admin","preview","localhost"].includes(e)){let t=await a._B.tenantDomain.findFirst({where:{domain:e,type:"SUBDOMAIN",status:"VERIFIED"},include:{tenant:{include:{domains:!0}}}});if(t&&"ACTIVE"===t.tenant.status)return{tenant:t.tenant,resolvedVia:"subdomain",domain:e};let n=await a._B.tenant.findFirst({where:{slug:e,status:"ACTIVE"},include:{domains:!0}});if(n)return{tenant:n,resolvedVia:"subdomain",domain:e}}}return null}async function o(e){let t=await a._B.tenantDomain.findFirst({where:{domain:e.toLowerCase(),type:"SUBDOMAIN"},include:{tenant:{include:{domains:!0}}}});if(t&&"ACTIVE"===t.tenant.status)return{tenant:t.tenant,resolvedVia:"query",domain:e};let n=await a._B.tenant.findFirst({where:{slug:e.toLowerCase(),status:"ACTIVE"},include:{domains:!0}});return n?{tenant:n,resolvedVia:"query",domain:e}:null}let s=async function(e){return a._B.tenant.findUnique({where:{slug:e},include:{domains:!0}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[380,972],()=>n(6316));module.exports=a})();