"use strict";(()=>{var e={};e.id=395,e.ids=[395],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},5784:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>y,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>w});var s={};n.r(s),n.d(s,{DELETE:()=>p,GET:()=>l,POST:()=>c});var r=n(9303),a=n(8716),i=n(670),o=n(7070),u=n(6238),d=n(340);async function l(e){try{let e=await (0,d.s3)();if(!e.authorized)return o.NextResponse.json({success:!1,error:e.error},{status:e.status});let t=(0,u.qk)();return o.NextResponse.json({success:!0,violationCount:t.length,violations:t.slice(-50)})}catch(e){return console.error("Failed to get violation logs:",e),o.NextResponse.json({success:!1,error:"Failed to get violation logs"},{status:500})}}async function c(e){try{let e=await (0,d.s3)();if(!e.authorized)return o.NextResponse.json({success:!1,error:e.error},{status:e.status});let t=[];(0,u.eE)();let n=await u._B.tenant.findMany({take:2});if(n.length<2)return o.NextResponse.json({success:!1,error:"Need at least 2 tenants for isolation testing"},{status:400});let s=n[0],r=n[1];try{(0,u.G0)("TenantMembership","findMany",null),await u._B.tenantMembership.findMany(),t.push({test:"Query without tenant context",passed:!1,error:"Should have thrown"})}catch(e){e instanceof u.xW?t.push({test:"Query without tenant context",passed:!0}):t.push({test:"Query without tenant context",passed:!1,error:String(e)})}try{let e=(0,u.KS)(s.id,"test-user",!1);(0,u.G0)("TenantMembership","findMany",e,r.id),t.push({test:"Cross-tenant query attempt",passed:!1,error:"Should have thrown"})}catch(e){e instanceof u.xW?t.push({test:"Cross-tenant query attempt",passed:!0}):t.push({test:"Cross-tenant query attempt",passed:!1,error:String(e)})}try{let e=(0,u.KS)(s.id,"test-user",!1);(0,u.G0)("TenantMembership","findMany",e,s.id),await u._B.tenantMembership.findMany({where:(0,u.ah)({},s.id)}),t.push({test:"Valid tenant-scoped query",passed:!0})}catch(e){t.push({test:"Valid tenant-scoped query",passed:!1,error:String(e)})}try{let n=(0,u.KS)(null,e.user.id,!0);(0,u.G0)("TenantMembership","findMany",n),await u._B.tenantMembership.findMany(),t.push({test:"Super admin cross-tenant query",passed:!0})}catch(e){t.push({test:"Super admin cross-tenant query",passed:!1,error:String(e)})}try{let e=(0,u.KS)(s.id,"test-user",!1,!0);(0,u.G0)("TenantMembership","findMany",e),t.push({test:"Non-admin bypass attempt",passed:!1,error:"Should have thrown"})}catch(e){e instanceof u.xW?t.push({test:"Non-admin bypass attempt",passed:!0}):t.push({test:"Non-admin bypass attempt",passed:!1,error:String(e)})}try{let n=(0,u.KS)(null,e.user.id,!0,!0);(0,u.G0)("TenantMembership","findMany",n),await u._B.tenantMembership.findMany(),t.push({test:"Super admin explicit bypass",passed:!0})}catch(e){t.push({test:"Super admin explicit bypass",passed:!1,error:String(e)})}try{(0,u.G0)("User","findMany",null),await u._B.user.findMany({take:1}),t.push({test:"Global model query without context",passed:!0})}catch(e){t.push({test:"Global model query without context",passed:!1,error:String(e)})}try{let e=(0,u.KS)(null,"test-user",!1);(0,u.G0)("TenantMembership","findMany",e),t.push({test:"Regular user without tenantId",passed:!1,error:"Should have thrown"})}catch(e){e instanceof u.xW?t.push({test:"Regular user without tenantId",passed:!0}):t.push({test:"Regular user without tenantId",passed:!1,error:String(e)})}let a=(0,u.qk)(),i=t.every(e=>e.passed);return o.NextResponse.json({success:!0,allPassed:i,results:t,violationsLogged:a.length,violations:a.slice(-10)})}catch(e){return console.error("Failed to run isolation tests:",e),o.NextResponse.json({success:!1,error:"Failed to run isolation tests: "+String(e)},{status:500})}}async function p(e){try{let e=await (0,d.s3)();if(!e.authorized)return o.NextResponse.json({success:!1,error:e.error},{status:e.status});return(0,u.eE)(),o.NextResponse.json({success:!0,message:"Violation logs cleared"})}catch(e){return console.error("Failed to clear violation logs:",e),o.NextResponse.json({success:!1,error:"Failed to clear violation logs"},{status:500})}}let h=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/test-isolation/route",pathname:"/api/admin/test-isolation",filename:"route",bundlePath:"app/api/admin/test-isolation/route"},resolvedPagePath:"/app/saas-core/src/app/api/admin/test-isolation/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:f}=h,y="/api/admin/test-isolation/route";function g(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:w})}},5456:(e,t,n)=>{n.d(t,{CK:()=>u,bA:()=>o,j5:()=>h,kS:()=>c,q4:()=>p,y_:()=>l});var s=n(6238),r=n(8547),a=n(1615);function i(){return(0,r.Z)()+"-"+(0,r.Z)()}async function o(e,t){let n=e.toLowerCase().trim(),a=await s._B.user.findUnique({where:{email:n}});a||(a=await s._B.user.create({data:{id:(0,r.Z)(),email:n,globalRole:"USER"}}));let o=i(),u=new Date;return u.setMinutes(u.getMinutes()+15),await s._B.magicLink.create({data:{id:(0,r.Z)(),token:o,userId:a.id,tenantId:t||null,expiresAt:u}}),{token:o,user:a}}async function u(e){let t=await s._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await s._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await s._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await s._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let n=i(),a=new Date;a.setDate(a.getDate()+7);let o=await s._B.session.create({data:{id:(0,r.Z)(),userId:t.userId,token:n,activeTenant:t.tenantId,expiresAt:a}});return{user:await s._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:o.id,token:n},tenantId:t.tenantId}}async function d(e){let t=await s._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await s._B.session.delete({where:{id:t.id}}),null):(await s._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function l(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function c(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;t&&await s._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function p(e,t){let n=await s._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!n)return!1;let r=n.user.memberships.some(e=>e.tenantId===t&&e.isActive),a="SUPER_ADMIN"===n.user.globalRole;return(!!r||!!a)&&(await s._B.session.update({where:{id:n.id},data:{activeTenant:t}}),!0)}function h(e){return"SUPER_ADMIN"===e.globalRole}},340:(e,t,n)=>{n.d(t,{nc:()=>u,s3:()=>i});var s=n(5456),r=n(6238);async function a(){let e=await (0,s.y_)();return e?e.user.isActive?{authorized:!0,user:e.user,session:e}:{authorized:!1,error:"Account is disabled",status:403}:{authorized:!1,error:"Authentication required",status:401}}async function i(){let e=await a();return e.authorized&&"SUPER_ADMIN"!==e.user.globalRole?{authorized:!1,error:"Super Admin access required",status:403}:e}async function o(e){let t=await a();if(!t.authorized)return t;if("SUPER_ADMIN"===t.user.globalRole)return{...t,role:"TENANT_ADMIN",tenantId:e};let n=t.session.user.memberships.find(t=>t.tenantId===e&&t.isActive);return n?"TENANT_ADMIN"!==n.role?{authorized:!1,error:"Tenant Admin access required",status:403}:{...t,role:n.role,tenantId:e}:{authorized:!1,error:"Not a member of this tenant",status:403}}async function u(e){let t=await r._B.tenant.findUnique({where:{slug:e},include:{domains:!0}});if(!t)return{authorized:!1,error:"Tenant not found",status:404};let n=await o(t.id);return n.authorized?{...n,tenant:t}:n}},6238:(e,t,n)=>{n.d(t,{xW:()=>d,eE:()=>u,KS:()=>c,qk:()=>o,_B:()=>h,G0:()=>l,ah:()=>p});var s=n(3524);let r=["TenantMembership","TenantDomain","AuditLog"],a=[];function i(e){let t={...e,timestamp:new Date};a.push(t),a.length>1e3&&a.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function o(){return[...a]}function u(){a.length=0}class d extends Error{constructor(e,t,n,s){super(e),this.model=t,this.action=n,this.context=s,this.name="TenantIsolationError"}}function l(e,t,n,s){if(r.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let r="Bypass isolation attempted without SUPER_ADMIN role";throw i({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let r="No tenant context provided for tenant-scoped query";throw i({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}if(!n.tenantId){let r="No tenantId in context for tenant-scoped query";throw i({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}if(s&&s!==n.tenantId){let r=`Cross-tenant access attempt: query tenantId (${s}) != context tenantId (${n.tenantId})`;throw i({model:e,action:t,context:n,query:{queryTenantId:s},reason:r}),new d(r,e,t,n)}}}}function c(e,t,n,s=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:s}}function p(e,t){return{...e,tenantId:t}}let h=globalThis.prisma??new s.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),s=t.X(0,[380,972,970],()=>n(5784));module.exports=s})();