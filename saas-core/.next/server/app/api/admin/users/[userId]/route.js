"use strict";(()=>{var e={};e.id=9992,e.ids=[9992],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},80813:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>l,PATCH:()=>c});var n=r(49303),a=r(88716),i=r(60670),o=r(87070),u=r(95456),d=r(56238);async function l(e,{params:t}){try{let{userId:e}=await t,r=await (0,u.y_)();if(!r)return o.NextResponse.json({success:!1,error:"Authentication required"},{status:401});if("SUPER_ADMIN"!==r.user.globalRole)return o.NextResponse.json({success:!1,error:"Super Admin access required"},{status:403});let s=await d._B.user.findUnique({where:{id:e},include:{memberships:{include:{tenant:{select:{id:!0,name:!0,slug:!0,status:!0}}}},partnerMembership:{include:{partner:{select:{id:!0,name:!0,slug:!0,status:!0,tier:!0}}}},sessions:{select:{id:!0,createdAt:!0,expiresAt:!0,ipAddress:!0,userAgent:!0},orderBy:{createdAt:"desc"},take:10},_count:{select:{sessions:!0}}}});if(!s)return o.NextResponse.json({success:!1,error:"User not found"},{status:404});return o.NextResponse.json({success:!0,user:{id:s.id,email:s.email,name:s.name,avatarUrl:s.avatarUrl,globalRole:s.globalRole,createdAt:s.createdAt.toISOString(),updatedAt:s.updatedAt.toISOString(),lastLoginAt:s.lastLoginAt?.toISOString()||null,totalSessions:s._count.sessions,recentSessions:s.sessions.map(e=>({id:e.id,createdAt:e.createdAt.toISOString(),expiresAt:e.expiresAt.toISOString(),ipAddress:e.ipAddress,userAgent:e.userAgent})),memberships:s.memberships.map(e=>({id:e.id,tenantId:e.tenantId,tenantName:e.tenant.name,tenantSlug:e.tenant.slug,tenantStatus:e.tenant.status,role:e.role,createdAt:e.createdAt.toISOString()})),partnerMembership:s.partnerMembership?{partnerId:s.partnerMembership.partnerId,partnerName:s.partnerMembership.partner.name,partnerSlug:s.partnerMembership.partner.slug,partnerTier:s.partnerMembership.partner.tier,role:s.partnerMembership.role,isActive:s.partnerMembership.isActive}:null}})}catch(e){return console.error("Error fetching user:",e),o.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function c(e,{params:t}){try{let{userId:r}=await t,s=await (0,u.y_)();if(!s)return o.NextResponse.json({success:!1,error:"Authentication required"},{status:401});if("SUPER_ADMIN"!==s.user.globalRole)return o.NextResponse.json({success:!1,error:"Super Admin access required"},{status:403});let{globalRole:n,name:a}=await e.json();if(n&&!["USER","SUPER_ADMIN"].includes(n))return o.NextResponse.json({success:!1,error:"Invalid role. Must be USER or SUPER_ADMIN"},{status:400});if(r===s.user.id&&"USER"===n)return o.NextResponse.json({success:!1,error:"Cannot demote yourself"},{status:400});let i=await d._B.user.findUnique({where:{id:r}});if(!i)return o.NextResponse.json({success:!1,error:"User not found"},{status:404});let l={};void 0!==n&&(l.globalRole=n),void 0!==a&&(l.name=a);let c=await d._B.user.update({where:{id:r},data:l,select:{id:!0,email:!0,name:!0,globalRole:!0}});return await d._B.auditLog.create({data:{action:"USER_ROLE_CHANGED",actorId:s.user.id,actorEmail:s.user.email,targetType:"User",targetId:r,metadata:{previousRole:i.globalRole,newRole:n||i.globalRole,changes:l}}}),o.NextResponse.json({success:!0,user:c,message:n?`User role changed to ${n}`:"User updated successfully"})}catch(e){return console.error("Error updating user:",e),o.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/users/[userId]/route",pathname:"/api/admin/users/[userId]",filename:"route",bundlePath:"app/api/admin/users/[userId]/route"},resolvedPagePath:"/app/saas-core/src/app/api/admin/users/[userId]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:h}=p,g="/api/admin/users/[userId]/route";function A(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},95456:(e,t,r)=>{r.d(t,{CK:()=>u,bA:()=>o,j5:()=>m,kS:()=>c,q4:()=>p,y_:()=>l});var s=r(56238),n=r(38547),a=r(71615);function i(){return(0,n.Z)()+"-"+(0,n.Z)()}async function o(e,t){let r=e.toLowerCase().trim(),a=await s._B.user.findUnique({where:{email:r}});a||(a=await s._B.user.create({data:{id:(0,n.Z)(),email:r,globalRole:"USER"}}));let o=i(),u=new Date;return u.setMinutes(u.getMinutes()+15),await s._B.magicLink.create({data:{id:(0,n.Z)(),token:o,userId:a.id,tenantId:t||null,expiresAt:u}}),{token:o,user:a}}async function u(e){let t=await s._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await s._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await s._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await s._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let r=i(),a=new Date;a.setDate(a.getDate()+7);let o=await s._B.session.create({data:{id:(0,n.Z)(),userId:t.userId,token:r,activeTenant:t.tenantId,expiresAt:a}});return{user:await s._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:o.id,token:r},tenantId:t.tenantId}}async function d(e){let t=await s._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await s._B.session.delete({where:{id:t.id}}),null):(await s._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function l(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function c(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;t&&await s._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function p(e,t){let r=await s._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!r)return!1;let n=r.user.memberships.some(e=>e.tenantId===t&&e.isActive),a="SUPER_ADMIN"===r.user.globalRole;return(!!n||!!a)&&(await s._B.session.update({where:{id:r.id},data:{activeTenant:t}}),!0)}function m(e){return"SUPER_ADMIN"===e.globalRole}},56238:(e,t,r)=>{r.d(t,{xW:()=>d,eE:()=>u,KS:()=>c,qk:()=>o,_B:()=>m,G0:()=>l,ah:()=>p});var s=r(53524);let n=["TenantMembership","TenantDomain","AuditLog"],a=[];function i(e){let t={...e,timestamp:new Date};a.push(t),a.length>1e3&&a.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function o(){return[...a]}function u(){a.length=0}class d extends Error{constructor(e,t,r,s){super(e),this.model=t,this.action=r,this.context=s,this.name="TenantIsolationError"}}function l(e,t,r,s){if(n.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let n="Bypass isolation attempted without SUPER_ADMIN role";throw i({model:e,action:t,context:r,query:{queryTenantId:s},reason:n}),new d(n,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let n="No tenant context provided for tenant-scoped query";throw i({model:e,action:t,context:r,query:{queryTenantId:s},reason:n}),new d(n,e,t,r)}if(!r.tenantId){let n="No tenantId in context for tenant-scoped query";throw i({model:e,action:t,context:r,query:{queryTenantId:s},reason:n}),new d(n,e,t,r)}if(s&&s!==r.tenantId){let n=`Cross-tenant access attempt: query tenantId (${s}) != context tenantId (${r.tenantId})`;throw i({model:e,action:t,context:r,query:{queryTenantId:s},reason:n}),new d(n,e,t,r)}}}}function c(e,t,r,s=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:s}}function p(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new s.PrismaClient({log:["error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9380,5972,6970],()=>r(80813));module.exports=s})();