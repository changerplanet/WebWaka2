"use strict";(()=>{var e={};e.id=2628,e.ids=[2628],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},73568:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>w,patchFetch:()=>g,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var r={};n.r(r),n.d(r,{GET:()=>d});var s=n(49303),a=n(88716),i=n(60670),o=n(87070),u=n(95456),l=n(56238);async function d(e){try{let t=await (0,u.y_)();if(!t)return o.NextResponse.json({success:!1,error:"Authentication required"},{status:401});if("SUPER_ADMIN"!==t.user.globalRole)return o.NextResponse.json({success:!1,error:"Super Admin access required"},{status:403});let{searchParams:n}=new URL(e.url),r=n.get("search")||"",s=n.get("role")||"",a=n.get("tenantId")||"",i=parseInt(n.get("limit")||"50"),d=parseInt(n.get("offset")||"0"),c={};r&&(c.OR=[{email:{contains:r,mode:"insensitive"}},{name:{contains:r,mode:"insensitive"}}]),s&&(c.globalRole=s),a&&(c.memberships={some:{tenantId:a}});let[p,m]=await Promise.all([l._B.user.findMany({where:c,include:{memberships:{include:{tenant:{select:{id:!0,name:!0,slug:!0,status:!0}}}},partnerMembership:{include:{partner:{select:{id:!0,name:!0,slug:!0,status:!0}}}},_count:{select:{sessions:!0}}},orderBy:{createdAt:"desc"},take:i,skip:d}),l._B.user.count({where:c})]),h=p.map(e=>({id:e.id,email:e.email,name:e.name,avatarUrl:e.avatarUrl,globalRole:e.globalRole,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString(),lastLoginAt:e.lastLoginAt?.toISOString()||null,activeSessions:e._count.sessions,memberships:e.memberships.map(e=>({id:e.id,tenantId:e.tenantId,tenantName:e.tenant.name,tenantSlug:e.tenant.slug,tenantStatus:e.tenant.status,role:e.role,createdAt:e.createdAt.toISOString()})),partnerMembership:e.partnerMembership?{partnerId:e.partnerMembership.partnerId,partnerName:e.partnerMembership.partner.name,partnerSlug:e.partnerMembership.partner.slug,role:e.partnerMembership.role,isActive:e.partnerMembership.isActive}:null})),[w,g,f,I]=await Promise.all([l._B.user.count(),l._B.user.count({where:{globalRole:"SUPER_ADMIN"}}),l._B.user.count({where:{memberships:{some:{}}}}),l._B.user.count({where:{partnerMembership:{isNot:null}}})]);return o.NextResponse.json({success:!0,users:h,total:m,limit:i,offset:d,stats:{totalUsers:w,superAdmins:g,usersWithTenants:f,usersWithPartners:I}})}catch(e){return console.error("Error fetching users:",e),o.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let c=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"/app/saas-core/src/app/api/admin/users/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h}=c,w="/api/admin/users/route";function g(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},95456:(e,t,n)=>{n.d(t,{CK:()=>u,bA:()=>o,j5:()=>m,kS:()=>c,q4:()=>p,y_:()=>d});var r=n(56238),s=n(38547),a=n(71615);function i(){return(0,s.Z)()+"-"+(0,s.Z)()}async function o(e,t){let n=e.toLowerCase().trim(),a=await r._B.user.findUnique({where:{email:n}});a||(a=await r._B.user.create({data:{id:(0,s.Z)(),email:n,globalRole:"USER"}}));let o=i(),u=new Date;return u.setMinutes(u.getMinutes()+15),await r._B.magicLink.create({data:{id:(0,s.Z)(),token:o,userId:a.id,tenantId:t||null,expiresAt:u}}),{token:o,user:a}}async function u(e){let t=await r._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await r._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await r._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await r._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let n=i(),a=new Date;a.setDate(a.getDate()+7);let o=await r._B.session.create({data:{id:(0,s.Z)(),userId:t.userId,token:n,activeTenant:t.tenantId,expiresAt:a}});return{user:await r._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:o.id,token:n},tenantId:t.tenantId}}async function l(e){let t=await r._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await r._B.session.delete({where:{id:t.id}}),null):(await r._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function d(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;return t?l(t):null}async function c(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;t&&await r._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function p(e,t){let n=await r._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!n)return!1;let s=n.user.memberships.some(e=>e.tenantId===t&&e.isActive),a="SUPER_ADMIN"===n.user.globalRole;return(!!s||!!a)&&(await r._B.session.update({where:{id:n.id},data:{activeTenant:t}}),!0)}function m(e){return"SUPER_ADMIN"===e.globalRole}},56238:(e,t,n)=>{n.d(t,{xW:()=>l,eE:()=>u,KS:()=>c,qk:()=>o,_B:()=>m,G0:()=>d,ah:()=>p});var r=n(53524);let s=["TenantMembership","TenantDomain","AuditLog"],a=[];function i(e){let t={...e,timestamp:new Date};a.push(t),a.length>1e3&&a.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function o(){return[...a]}function u(){a.length=0}class l extends Error{constructor(e,t,n,r){super(e),this.model=t,this.action=n,this.context=r,this.name="TenantIsolationError"}}function d(e,t,n,r){if(s.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let s="Bypass isolation attempted without SUPER_ADMIN role";throw i({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new l(s,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let s="No tenant context provided for tenant-scoped query";throw i({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new l(s,e,t,n)}if(!n.tenantId){let s="No tenantId in context for tenant-scoped query";throw i({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new l(s,e,t,n)}if(r&&r!==n.tenantId){let s=`Cross-tenant access attempt: query tenantId (${r}) != context tenantId (${n.tenantId})`;throw i({model:e,action:t,context:n,query:{queryTenantId:r},reason:s}),new l(s,e,t,n)}}}}function c(e,t,n,r=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:r}}function p(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new r.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9380,5972,6970],()=>n(73568));module.exports=r})();