"use strict";(()=>{var e={};e.id=2408,e.ids=[2408],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},43965:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>I,patchFetch:()=>h,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var n={};a.r(n),a.d(n,{DELETE:()=>x,GET:()=>l,POST:()=>p});var r=a(49303),s=a(88716),o=a(60670),i=a(87070),d=a(56238),u=a(70340),c=a(57662),m=a(38547);async function l(e,{params:t}){let a=await (0,u.s3)();if(!a.authorized)return i.NextResponse.json({success:!1,error:a.error},{status:a.status});try{let{id:e}=await t,a=await d._B.tenantDomain.findMany({where:{tenantId:e},orderBy:{createdAt:"desc"}});return i.NextResponse.json({success:!0,domains:a})}catch(e){return console.error("Failed to fetch domains:",e),i.NextResponse.json({success:!1,error:"Failed to fetch domains"},{status:500})}}async function p(e,{params:t}){let a=await (0,u.s3)();if(!a.authorized)return i.NextResponse.json({success:!1,error:a.error},{status:a.status});try{let{id:n}=await t,{domain:r,type:s,isPrimary:o}=await e.json();if(!r||!s)return i.NextResponse.json({success:!1,error:"Domain and type are required"},{status:400});let u=r.toLowerCase().trim();if("SUBDOMAIN"===s&&!/^[a-z0-9-]+$/.test(u))return i.NextResponse.json({success:!1,error:"Subdomain must contain only lowercase letters, numbers, and hyphens"},{status:400});if(await d._B.tenantDomain.findUnique({where:{domain:u}}))return i.NextResponse.json({success:!1,error:"Domain is already in use"},{status:409});o&&await d._B.tenantDomain.updateMany({where:{tenantId:n,isPrimary:!0},data:{isPrimary:!1}});let l=await d._B.tenantDomain.create({data:{id:(0,m.Z)(),tenantId:n,domain:u,type:s,status:"SUBDOMAIN"===s?"VERIFIED":"PENDING",isPrimary:o||!1,verificationToken:"CUSTOM"===s?(0,m.Z)():null,verifiedAt:"SUBDOMAIN"===s?new Date:null}});return await (0,c.U)({action:"DOMAIN_ADDED",actorId:a.user.id,actorEmail:a.user.email,tenantId:n,targetType:"TenantDomain",targetId:l.id,metadata:{domain:u,type:s}}),i.NextResponse.json({success:!0,domain:l},{status:201})}catch(e){return console.error("Failed to add domain:",e),i.NextResponse.json({success:!1,error:"Failed to add domain"},{status:500})}}async function x(e,{params:t}){let a=await (0,u.s3)();if(!a.authorized)return i.NextResponse.json({success:!1,error:a.error},{status:a.status});try{let{id:n}=await t,{searchParams:r}=new URL(e.url),s=r.get("domainId");if(!s)return i.NextResponse.json({success:!1,error:"domainId is required"},{status:400});let o=await d._B.tenantDomain.findFirst({where:{id:s,tenantId:n}});if(!o)return i.NextResponse.json({success:!1,error:"Domain not found"},{status:404});if(await d._B.tenantDomain.count({where:{tenantId:n}})<=1)return i.NextResponse.json({success:!1,error:"Cannot delete the last domain"},{status:400});return await d._B.tenantDomain.delete({where:{id:s}}),await (0,c.U)({action:"DOMAIN_REMOVED",actorId:a.user.id,actorEmail:a.user.email,tenantId:n,targetType:"TenantDomain",targetId:s,metadata:{domain:o.domain,type:o.type}}),i.NextResponse.json({success:!0,message:"Domain removed successfully"})}catch(e){return console.error("Failed to remove domain:",e),i.NextResponse.json({success:!1,error:"Failed to remove domain"},{status:500})}}let y=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/tenants/[id]/domains/route",pathname:"/api/admin/tenants/[id]/domains",filename:"route",bundlePath:"app/api/admin/tenants/[id]/domains/route"},resolvedPagePath:"/app/saas-core/src/app/api/admin/tenants/[id]/domains/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:g}=y,I="/api/admin/tenants/[id]/domains/route";function h(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},57662:(e,t,a)=>{a.d(t,{F:()=>i,U:()=>o});var n=a(56238),r=a(38547),s=a(71615);async function o(e){try{let t=await (0,s.headers)(),a=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",o=t.get("user-agent")||"unknown";await n._B.auditLog.create({data:{id:(0,r.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:a,userAgent:o}})}catch(e){console.error("Failed to create audit log:",e)}}async function i(e){let{tenantId:t,actorId:a,action:r,targetType:s,limit:o=50,offset:i=0}=e,d={};t&&(d.tenantId=t),a&&(d.actorId=a),r&&(d.action=r),s&&(d.targetType=s);let[u,c]=await Promise.all([n._B.auditLog.findMany({where:d,orderBy:{createdAt:"desc"},take:o,skip:i}),n._B.auditLog.count({where:d})]);return{logs:u,total:c}}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[9380,5972,6970,340],()=>a(43965));module.exports=n})();