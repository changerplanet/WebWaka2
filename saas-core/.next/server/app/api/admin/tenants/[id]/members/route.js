"use strict";(()=>{var e={};e.id=263,e.ids=[263],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},5745:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>_,requestAsyncStorage:()=>I,routeModule:()=>f,serverHooks:()=>A,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{DELETE:()=>h,GET:()=>m,PATCH:()=>w,POST:()=>p});var n=r(9303),s=r(8716),i=r(670),o=r(7070),u=r(6238),d=r(340),c=r(7662),l=r(8547);async function m(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:e}=await t,r=await u._B.tenantMembership.findMany({where:{tenantId:e},include:{user:{select:{id:!0,email:!0,name:!0,avatarUrl:!0,globalRole:!0,isActive:!0,lastLoginAt:!0}}},orderBy:{createdAt:"desc"}});return o.NextResponse.json({success:!0,members:r})}catch(e){return console.error("Failed to fetch members:",e),o.NextResponse.json({success:!1,error:"Failed to fetch members"},{status:500})}}async function p(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:a}=await t,{email:n,role:s="TENANT_USER"}=await e.json();if(!n)return o.NextResponse.json({success:!1,error:"Email is required"},{status:400});if(!await u._B.tenant.findUnique({where:{id:a}}))return o.NextResponse.json({success:!1,error:"Tenant not found"},{status:404});let i=await u._B.user.findUnique({where:{email:n.toLowerCase()}});if(i||(i=await u._B.user.create({data:{id:(0,l.Z)(),email:n.toLowerCase(),globalRole:"USER"}})),await u._B.tenantMembership.findUnique({where:{userId_tenantId:{userId:i.id,tenantId:a}}}))return o.NextResponse.json({success:!1,error:"User is already a member of this tenant"},{status:409});let d=await u._B.tenantMembership.create({data:{id:(0,l.Z)(),userId:i.id,tenantId:a,role:"TENANT_ADMIN"===s?"TENANT_ADMIN":"TENANT_USER"},include:{user:{select:{id:!0,email:!0,name:!0,avatarUrl:!0}}}});return await (0,c.U)({action:"USER_INVITED",actorId:r.user.id,actorEmail:r.user.email,tenantId:a,targetType:"User",targetId:i.id,metadata:{email:n.toLowerCase(),role:s}}),o.NextResponse.json({success:!0,membership:d},{status:201})}catch(e){return console.error("Failed to add member:",e),o.NextResponse.json({success:!1,error:"Failed to add member"},{status:500})}}async function w(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:a}=await t,{membershipId:n,role:s,isActive:i}=await e.json();if(!n)return o.NextResponse.json({success:!1,error:"membershipId is required"},{status:400});let d=await u._B.tenantMembership.findFirst({where:{id:n,tenantId:a},include:{user:!0}});if(!d)return o.NextResponse.json({success:!1,error:"Membership not found"},{status:404});let l={};void 0!==s&&(l.role=s),void 0!==i&&(l.isActive=i);let m=await u._B.tenantMembership.update({where:{id:n},data:l,include:{user:{select:{id:!0,email:!0,name:!0}}}});return await (0,c.U)({action:"USER_ROLE_CHANGED",actorId:r.user.id,actorEmail:r.user.email,tenantId:a,targetType:"User",targetId:d.userId,metadata:{email:d.user.email,oldRole:d.role,newRole:s,oldActive:d.isActive,newActive:i}}),o.NextResponse.json({success:!0,membership:m})}catch(e){return console.error("Failed to update member:",e),o.NextResponse.json({success:!1,error:"Failed to update member"},{status:500})}}async function h(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:a}=await t,{searchParams:n}=new URL(e.url),s=n.get("membershipId");if(!s)return o.NextResponse.json({success:!1,error:"membershipId is required"},{status:400});let i=await u._B.tenantMembership.findFirst({where:{id:s,tenantId:a},include:{user:!0}});if(!i)return o.NextResponse.json({success:!1,error:"Membership not found"},{status:404});return await u._B.tenantMembership.delete({where:{id:s}}),await (0,c.U)({action:"USER_REMOVED",actorId:r.user.id,actorEmail:r.user.email,tenantId:a,targetType:"User",targetId:i.userId,metadata:{email:i.user.email,role:i.role}}),o.NextResponse.json({success:!0,message:"Member removed successfully"})}catch(e){return console.error("Failed to remove member:",e),o.NextResponse.json({success:!1,error:"Failed to remove member"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/tenants/[id]/members/route",pathname:"/api/admin/tenants/[id]/members",filename:"route",bundlePath:"app/api/admin/tenants/[id]/members/route"},resolvedPagePath:"/app/saas-core/src/app/api/admin/tenants/[id]/members/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:I,staticGenerationAsyncStorage:g,serverHooks:A}=f,y="/api/admin/tenants/[id]/members/route";function _(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:g})}},7662:(e,t,r)=>{r.d(t,{F:()=>o,U:()=>i});var a=r(6238),n=r(8547),s=r(1615);async function i(e){try{let t=await (0,s.headers)(),r=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",i=t.get("user-agent")||"unknown";await a._B.auditLog.create({data:{id:(0,n.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||null,ipAddress:r,userAgent:i}})}catch(e){console.error("Failed to create audit log:",e)}}async function o(e){let{tenantId:t,actorId:r,action:n,targetType:s,limit:i=50,offset:o=0}=e,u={};t&&(u.tenantId=t),r&&(u.actorId=r),n&&(u.action=n),s&&(u.targetType=s);let[d,c]=await Promise.all([a._B.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:i,skip:o}),a._B.auditLog.count({where:u})]);return{logs:d,total:c}}},5456:(e,t,r)=>{r.d(t,{CK:()=>u,bA:()=>o,j5:()=>p,kS:()=>l,q4:()=>m,y_:()=>c});var a=r(6238),n=r(8547),s=r(1615);function i(){return(0,n.Z)()+"-"+(0,n.Z)()}async function o(e,t){let r=e.toLowerCase().trim(),s=await a._B.user.findUnique({where:{email:r}});s||(s=await a._B.user.create({data:{id:(0,n.Z)(),email:r,globalRole:"USER"}}));let o=i(),u=new Date;return u.setMinutes(u.getMinutes()+15),await a._B.magicLink.create({data:{id:(0,n.Z)(),token:o,userId:s.id,tenantId:t||null,expiresAt:u}}),{token:o,user:s}}async function u(e){let t=await a._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await a._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await a._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await a._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let r=i(),s=new Date;s.setDate(s.getDate()+7);let o=await a._B.session.create({data:{id:(0,n.Z)(),userId:t.userId,token:r,activeTenant:t.tenantId,expiresAt:s}});return{user:await a._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:o.id,token:r},tenantId:t.tenantId}}async function d(e){let t=await a._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await a._B.session.delete({where:{id:t.id}}),null):(await a._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function c(){let e=await (0,s.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function l(){let e=await (0,s.cookies)(),t=e.get("session_token")?.value;t&&await a._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function m(e,t){let r=await a._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!r)return!1;let n=r.user.memberships.some(e=>e.tenantId===t&&e.isActive),s="SUPER_ADMIN"===r.user.globalRole;return(!!n||!!s)&&(await a._B.session.update({where:{id:r.id},data:{activeTenant:t}}),!0)}function p(e){return"SUPER_ADMIN"===e.globalRole}},340:(e,t,r)=>{r.d(t,{nc:()=>u,s3:()=>i});var a=r(5456),n=r(6238);async function s(){let e=await (0,a.y_)();return e?e.user.isActive?{authorized:!0,user:e.user,session:e}:{authorized:!1,error:"Account is disabled",status:403}:{authorized:!1,error:"Authentication required",status:401}}async function i(){let e=await s();return e.authorized&&"SUPER_ADMIN"!==e.user.globalRole?{authorized:!1,error:"Super Admin access required",status:403}:e}async function o(e){let t=await s();if(!t.authorized)return t;if("SUPER_ADMIN"===t.user.globalRole)return{...t,role:"TENANT_ADMIN",tenantId:e};let r=t.session.user.memberships.find(t=>t.tenantId===e&&t.isActive);return r?"TENANT_ADMIN"!==r.role?{authorized:!1,error:"Tenant Admin access required",status:403}:{...t,role:r.role,tenantId:e}:{authorized:!1,error:"Not a member of this tenant",status:403}}async function u(e){let t=await n._B.tenant.findUnique({where:{slug:e},include:{domains:!0}});if(!t)return{authorized:!1,error:"Tenant not found",status:404};let r=await o(t.id);return r.authorized?{...r,tenant:t}:r}},6238:(e,t,r)=>{r.d(t,{xW:()=>d,eE:()=>u,KS:()=>l,qk:()=>o,_B:()=>p,G0:()=>c,ah:()=>m});var a=r(3524);let n=["TenantMembership","TenantDomain","AuditLog"],s=[];function i(e){let t={...e,timestamp:new Date};s.push(t),s.length>1e3&&s.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function o(){return[...s]}function u(){s.length=0}class d extends Error{constructor(e,t,r,a){super(e),this.model=t,this.action=r,this.context=a,this.name="TenantIsolationError"}}function c(e,t,r,a){if(n.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let n="Bypass isolation attempted without SUPER_ADMIN role";throw i({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new d(n,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let n="No tenant context provided for tenant-scoped query";throw i({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new d(n,e,t,r)}if(!r.tenantId){let n="No tenantId in context for tenant-scoped query";throw i({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new d(n,e,t,r)}if(a&&a!==r.tenantId){let n=`Cross-tenant access attempt: query tenantId (${a}) != context tenantId (${r.tenantId})`;throw i({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new d(n,e,t,r)}}}}function l(e,t,r,a=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:a}}function m(e,t){return{...e,tenantId:t}}let p=globalThis.prisma??new a.PrismaClient({log:["error"]})}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[380,972,970],()=>r(5745));module.exports=a})();