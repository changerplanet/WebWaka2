"use strict";(()=>{var e={};e.id=9263,e.ids=[9263],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},45745:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>x,serverHooks:()=>I,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{DELETE:()=>h,GET:()=>m,PATCH:()=>w,POST:()=>p});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),u=r(56238),d=r(70340),c=r(57662),l=r(38547);async function m(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:e}=await t,r=await u._B.tenantMembership.findMany({where:{tenantId:e},include:{user:{select:{id:!0,email:!0,name:!0,avatarUrl:!0,globalRole:!0,isActive:!0,lastLoginAt:!0}}},orderBy:{createdAt:"desc"}});return o.NextResponse.json({success:!0,members:r})}catch(e){return console.error("Failed to fetch members:",e),o.NextResponse.json({success:!1,error:"Failed to fetch members"},{status:500})}}async function p(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:s}=await t,{email:a,role:n="TENANT_USER"}=await e.json();if(!a)return o.NextResponse.json({success:!1,error:"Email is required"},{status:400});if(!await u._B.tenant.findUnique({where:{id:s}}))return o.NextResponse.json({success:!1,error:"Tenant not found"},{status:404});let i=await u._B.user.findUnique({where:{email:a.toLowerCase()}});if(i||(i=await u._B.user.create({data:{id:(0,l.Z)(),email:a.toLowerCase(),globalRole:"USER"}})),await u._B.tenantMembership.findUnique({where:{userId_tenantId:{userId:i.id,tenantId:s}}}))return o.NextResponse.json({success:!1,error:"User is already a member of this tenant"},{status:409});let d=await u._B.tenantMembership.create({data:{id:(0,l.Z)(),userId:i.id,tenantId:s,role:"TENANT_ADMIN"===n?"TENANT_ADMIN":"TENANT_USER"},include:{user:{select:{id:!0,email:!0,name:!0,avatarUrl:!0}}}});return await (0,c.U)({action:"USER_INVITED",actorId:r.user.id,actorEmail:r.user.email,tenantId:s,targetType:"User",targetId:i.id,metadata:{email:a.toLowerCase(),role:n}}),o.NextResponse.json({success:!0,membership:d},{status:201})}catch(e){return console.error("Failed to add member:",e),o.NextResponse.json({success:!1,error:"Failed to add member"},{status:500})}}async function w(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:s}=await t,{membershipId:a,role:n,isActive:i}=await e.json();if(!a)return o.NextResponse.json({success:!1,error:"membershipId is required"},{status:400});let d=await u._B.tenantMembership.findFirst({where:{id:a,tenantId:s},include:{user:!0}});if(!d)return o.NextResponse.json({success:!1,error:"Membership not found"},{status:404});let l={};void 0!==n&&(l.role=n),void 0!==i&&(l.isActive=i);let m=await u._B.tenantMembership.update({where:{id:a},data:l,include:{user:{select:{id:!0,email:!0,name:!0}}}});return await (0,c.U)({action:"USER_ROLE_CHANGED",actorId:r.user.id,actorEmail:r.user.email,tenantId:s,targetType:"User",targetId:d.userId,metadata:{email:d.user.email,oldRole:d.role,newRole:n,oldActive:d.isActive,newActive:i}}),o.NextResponse.json({success:!0,membership:m})}catch(e){return console.error("Failed to update member:",e),o.NextResponse.json({success:!1,error:"Failed to update member"},{status:500})}}async function h(e,{params:t}){let r=await (0,d.s3)();if(!r.authorized)return o.NextResponse.json({success:!1,error:r.error},{status:r.status});try{let{id:s}=await t,{searchParams:a}=new URL(e.url),n=a.get("membershipId");if(!n)return o.NextResponse.json({success:!1,error:"membershipId is required"},{status:400});let i=await u._B.tenantMembership.findFirst({where:{id:n,tenantId:s},include:{user:!0}});if(!i)return o.NextResponse.json({success:!1,error:"Membership not found"},{status:404});return await u._B.tenantMembership.delete({where:{id:n}}),await (0,c.U)({action:"USER_REMOVED",actorId:r.user.id,actorEmail:r.user.email,tenantId:s,targetType:"User",targetId:i.userId,metadata:{email:i.user.email,role:i.role}}),o.NextResponse.json({success:!0,message:"Member removed successfully"})}catch(e){return console.error("Failed to remove member:",e),o.NextResponse.json({success:!1,error:"Failed to remove member"},{status:500})}}let x=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/tenants/[id]/members/route",pathname:"/api/admin/tenants/[id]/members",filename:"route",bundlePath:"app/api/admin/tenants/[id]/members/route"},resolvedPagePath:"/app/saas-core/src/app/api/admin/tenants/[id]/members/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:I}=x,R="/api/admin/tenants/[id]/members/route";function b(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:g})}},57662:(e,t,r)=>{r.d(t,{F:()=>o,U:()=>i});var s=r(56238),a=r(38547),n=r(71615);async function i(e){try{let t=await (0,n.headers)(),r=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",i=t.get("user-agent")||"unknown";await s._B.auditLog.create({data:{id:(0,a.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:r,userAgent:i}})}catch(e){console.error("Failed to create audit log:",e)}}async function o(e){let{tenantId:t,actorId:r,action:a,targetType:n,limit:i=50,offset:o=0}=e,u={};t&&(u.tenantId=t),r&&(u.actorId=r),a&&(u.action=a),n&&(u.targetType=n);let[d,c]=await Promise.all([s._B.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:i,skip:o}),s._B.auditLog.count({where:u})]);return{logs:d,total:c}}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9380,5972,6970,340],()=>r(45745));module.exports=s})();