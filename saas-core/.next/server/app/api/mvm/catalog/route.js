"use strict";(()=>{var e={};e.id=7402,e.ids=[7402],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},22721:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>p,POST:()=>l});var s=r(49303),a=r(88716),o=r(60670),i=r(87070),c=r(56238);function u(e){return e?Number(e):0}function d(e){return{id:e.id,tenantId:e.tenantId,name:e.name,slug:e.slug,description:e.description,shortDescription:e.shortDescription,categoryId:e.categoryId,categoryName:e.category?.name,tags:e.tags||[],basePrice:u(e.price),compareAtPrice:e.compareAtPrice?u(e.compareAtPrice):null,currency:"USD",images:e.images?.map(e=>({id:e.id,url:e.url,altText:e.altText,position:e.position,isDefault:e.isDefault}))||[],status:e.status,hasVariants:e.variants?.length>1,variants:e.variants?.map(t=>({id:t.id,productId:t.productId,name:t.name,sku:t.sku,barcode:t.barcode,price:u(t.price||e.price),options:t.optionValues||{},isActive:t.isActive??!0}))||[],weight:e.weight?u(e.weight):null,weightUnit:e.weightUnit||"lb",createdAt:e.createdAt?.toISOString(),updatedAt:e.updatedAt?.toISOString()}}async function p(e){try{let{searchParams:t}=new URL(e.url),r=t.get("tenantId"),n=t.get("productId"),s=t.get("categoryId"),a=t.get("query");t.get("vendorId"),t.get("unmappedOnly");let o=parseInt(t.get("limit")||"24",10),u=parseInt(t.get("offset")||"0",10);if(!r)return i.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});if(n){let e=await c._B.product.findFirst({where:{id:n,tenantId:r},include:{category:!0,variants:!0}});if(!e)return i.NextResponse.json({success:!1,error:"Product not found"},{status:404});return i.NextResponse.json({success:!0,product:d(e),source:"CORE"})}let p={tenantId:r,status:"ACTIVE"};s&&(p.categoryId=s),a&&(p.OR=[{name:{contains:a,mode:"insensitive"}},{description:{contains:a,mode:"insensitive"}},{sku:{contains:a,mode:"insensitive"}}]);let l=await c._B.product.count({where:p}),m=await c._B.product.findMany({where:p,include:{category:!0,variants:!0},orderBy:{name:"asc"},take:o,skip:u});return i.NextResponse.json({success:!0,products:m.map(e=>d(e)),total:l,hasMore:u+m.length<l,source:"CORE"})}catch(e){return console.error("[MVM] Error fetching catalog:",e),i.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function l(e){try{let{tenantId:t,productIds:r}=await e.json();if(!t)return i.NextResponse.json({success:!1,error:"tenantId is required"},{status:400});if(!r||!Array.isArray(r))return i.NextResponse.json({success:!1,error:"productIds array is required"},{status:400});let n=await c._B.product.findMany({where:{id:{in:r},tenantId:t},include:{category:!0,variants:!0}});return i.NextResponse.json({success:!0,products:n.map(e=>d(e)),count:n.length,source:"CORE"})}catch(e){return console.error("[MVM] Error batch fetching products:",e),i.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/mvm/catalog/route",pathname:"/api/mvm/catalog",filename:"route",bundlePath:"app/api/mvm/catalog/route"},resolvedPagePath:"/app/saas-core/src/app/api/mvm/catalog/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:f}=m,y="/api/mvm/catalog/route";function I(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},56238:(e,t,r)=>{r.d(t,{xW:()=>u,eE:()=>c,KS:()=>p,qk:()=>i,_B:()=>m,G0:()=>d,ah:()=>l});var n=r(53524);let s=["TenantMembership","TenantDomain","AuditLog"],a=[];function o(e){let t={...e,timestamp:new Date};a.push(t),a.length>1e3&&a.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function i(){return[...a]}function c(){a.length=0}class u extends Error{constructor(e,t,r,n){super(e),this.model=t,this.action=r,this.context=n,this.name="TenantIsolationError"}}function d(e,t,r,n){if(s.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let s="Bypass isolation attempted without SUPER_ADMIN role";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let s="No tenant context provided for tenant-scoped query";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}if(!r.tenantId){let s="No tenantId in context for tenant-scoped query";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}if(n&&n!==r.tenantId){let s=`Cross-tenant access attempt: query tenantId (${n}) != context tenantId (${r.tenantId})`;throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:s}),new u(s,e,t,r)}}}}function p(e,t,r,n=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:n}}function l(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new n.PrismaClient({log:["error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9380,5972],()=>r(22721));module.exports=n})();