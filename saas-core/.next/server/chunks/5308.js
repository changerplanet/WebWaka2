"use strict";exports.id=5308,exports.ids=[5308],exports.modules={57662:(e,t,a)=>{a.d(t,{F:()=>c,U:()=>s});var n=a(56238),r=a(38547),o=a(71615);async function s(e){try{let t=await (0,o.headers)(),a=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",s=t.get("user-agent")||"unknown";await n._B.auditLog.create({data:{id:(0,r.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:a,userAgent:s}})}catch(e){console.error("Failed to create audit log:",e)}}async function c(e){let{tenantId:t,actorId:a,action:r,targetType:o,limit:s=50,offset:c=0}=e,i={};t&&(i.tenantId=t),a&&(i.actorId=a),r&&(i.action=r),o&&(i.targetType=o);let[l,u]=await Promise.all([n._B.auditLog.findMany({where:i,orderBy:{createdAt:"desc"},take:s,skip:c}),n._B.auditLog.count({where:i})]);return{logs:l,total:u}}},35308:(e,t,a)=>{a.d(t,{We:()=>d,ZV:()=>p});var n=a(56238),r=a(57662);async function o(e){return!!await n._B.auditLog.findFirst({where:{targetId:e,action:"TENANT_UPDATED"}})}async function s(e,t,a,n){await (0,r.U)({action:"TENANT_UPDATED",actorId:n||"system",actorEmail:"pos-system@internal",tenantId:a,targetType:"POS_EVENT",targetId:e,metadata:{eventType:t,processedAt:new Date().toISOString()}})}async function c(e){let{idempotencyKey:t,payload:a}=e;if(await o(t))return console.log("[POS] Event already processed:",t),{success:!0};try{let{tenantId:e,saleId:n,saleNumber:o,staffId:c,lineItems:i,grandTotal:l,payments:u}=a;return console.log("[POS] Sale completed:",o,"for tenant",e),console.log("[POS] Total: $"+l+", Items:",i.length),await (0,r.U)({action:"TENANT_CREATED",actorId:c,actorEmail:"pos@internal",tenantId:e,targetType:"SALE",targetId:n,metadata:{eventType:"POS_SALE_COMPLETED",saleNumber:o,grandTotal:l,itemCount:i.length,paymentMethods:u.map(e=>e.method)}}),await s(t,"pos.sale.completed",e,c),{success:!0}}catch(e){return console.error("[POS] Error handling sale completed:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e){let{idempotencyKey:t,payload:a}=e;if(await o(t))return{success:!0};try{let{tenantId:e,saleId:n,saleNumber:o,staffId:c,voidedByStaffId:i,reason:l,lineItems:u}=a;return console.log("[POS] Sale cancelled:",o,"by",i),await (0,r.U)({action:"TENANT_SUSPENDED",actorId:i,actorEmail:"pos@internal",tenantId:e,targetType:"SALE",targetId:n,metadata:{eventType:"POS_SALE_VOIDED",saleNumber:o,reason:l,originalStaffId:c,itemCount:u.length}}),await s(t,"pos.sale.cancelled",e,i),{success:!0}}catch(e){return console.error("[POS] Error handling sale cancelled:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e){let{idempotencyKey:t,payload:a}=e;if(await o(t))return{success:!0};try{let{tenantId:e,paymentId:n,saleId:o,staffId:c,method:i,amount:l,tipAmount:u}=a;return console.log("[POS] Payment captured:",i,"$"+l,"for sale",o),await (0,r.U)({action:"TENANT_UPDATED",actorId:c,actorEmail:"pos@internal",tenantId:e,targetType:"PAYMENT",targetId:n,metadata:{eventType:"POS_PAYMENT_RECORDED",saleId:o,method:i,amount:l,tipAmount:u||0}}),await s(t,"pos.payment.captured",e,c),{success:!0}}catch(e){return console.error("[POS] Error handling payment captured:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function u(e){let{idempotencyKey:t,payload:a}=e;if(await o(t))return{success:!0};try{let{tenantId:e,refundId:n,refundNumber:o,staffId:c,totalRefunded:i,reason:l,items:u}=a;return console.log("[POS] Refund created:",o,"for $"+i),await (0,r.U)({action:"TENANT_ACTIVATED",actorId:c,actorEmail:"pos@internal",tenantId:e,targetType:"REFUND",targetId:n,metadata:{eventType:"POS_REFUND_CREATED",refundNumber:o,totalRefunded:i,reason:l,itemCount:u.length}}),await s(t,"pos.refund.created",e,c),{success:!0}}catch(e){return console.error("[POS] Error handling refund created:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(e){switch(console.log("[POS] Received event:",e.eventType),e.eventType){case"pos.sale.completed":return c(e);case"pos.sale.cancelled":case"pos.sale.voided":return i(e);case"pos.payment.captured":return l(e);case"pos.refund.created":return u(e);default:return console.log("[POS] Unhandled event type:",e.eventType),{success:!0}}}async function p(e){try{let t=await n._B.entitlement.findUnique({where:{tenantId_module:{tenantId:e,module:"POS"}}});if(!t||"ACTIVE"!==t.status)return null;let a=t.limits||{},r=["offline"],o="number"==typeof a.max_registers?a.max_registers:1;return o>1&&r.push("multi_register"),!0===a.layaway_enabled&&r.push("layaway"),!0===a.advanced_discounts&&r.push("advanced_discounts"),!0===a.custom_receipts&&r.push("custom_receipts"),!1!==a.reports_enabled&&r.push("reports"),!0===a.api_enabled&&r.push("api"),{module:"POS",features:r,limits:{max_locations:"number"==typeof a.max_locations?a.max_locations:1,max_registers:o,max_staff:"number"==typeof a.max_staff?a.max_staff:5,max_offline_transactions:"number"==typeof a.max_offline_transactions?a.max_offline_transactions:50,max_products_cache:"number"==typeof a.max_products_cache?a.max_products_cache:500},expiresAt:t.validUntil?.toISOString()||null}}catch(e){return console.error("[POS] Error fetching entitlements:",e),null}}},56238:(e,t,a)=>{a.d(t,{xW:()=>l,eE:()=>i,KS:()=>d,qk:()=>c,_B:()=>m,G0:()=>u,ah:()=>p});var n=a(53524);let r=["TenantMembership","TenantDomain","AuditLog"],o=[];function s(e){let t={...e,timestamp:new Date};o.push(t),o.length>1e3&&o.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function c(){return[...o]}function i(){o.length=0}class l extends Error{constructor(e,t,a,n){super(e),this.model=t,this.action=a,this.context=n,this.name="TenantIsolationError"}}function u(e,t,a,n){if(r.includes(e)){if(a?.bypassIsolation===!0){if(!a.isSuperAdmin){let r="Bypass isolation attempted without SUPER_ADMIN role";throw s({model:e,action:t,context:a,query:{queryTenantId:n},reason:r}),new l(r,e,t,a)}return}if(!a?.isSuperAdmin){if(!a){let r="No tenant context provided for tenant-scoped query";throw s({model:e,action:t,context:a,query:{queryTenantId:n},reason:r}),new l(r,e,t,a)}if(!a.tenantId){let r="No tenantId in context for tenant-scoped query";throw s({model:e,action:t,context:a,query:{queryTenantId:n},reason:r}),new l(r,e,t,a)}if(n&&n!==a.tenantId){let r=`Cross-tenant access attempt: query tenantId (${n}) != context tenantId (${a.tenantId})`;throw s({model:e,action:t,context:a,query:{queryTenantId:n},reason:r}),new l(r,e,t,a)}}}}function d(e,t,a,n=!1){return{tenantId:e,userId:t,isSuperAdmin:a,bypassIsolation:n}}function p(e,t){return{...e,tenantId:t}}let m=globalThis.prisma??new n.PrismaClient({log:["error"]})}};