"use strict";exports.id=662,exports.ids=[662],exports.modules={90662:(t,e,a)=>{a.d(e,{KB:()=>u,mR:()=>c,rf:()=>v});var i=a(56238);function n(t){return t?Number(t):0}function o(t,e,a){let i=e?.quantityOnHand??0,o=e?.quantityReserved??0,r=e?.quantityAvailable??i-o,d=e?.reorderPoint??10;return{productId:t.id,variantId:void 0,sku:t.sku||"",name:t.name,barcode:t.barcode||void 0,price:n(t.price),costPrice:t.costPrice?n(t.costPrice):void 0,compareAtPrice:t.compareAtPrice?n(t.compareAtPrice):void 0,quantityOnHand:i,quantityReserved:o,quantityAvailable:r,lowStockThreshold:d,outOfStockThreshold:0,isInStock:r>0,isLowStock:r>0&&r<=d,allowNegative:t.allowBackorder||!1,trackInventory:t.trackInventory??!0,locationId:a?.id,locationName:a?.name,categoryId:t.categoryId||void 0,categoryName:t.category?.name||void 0,lastUpdated:e?.updatedAt||t.updatedAt,lastSoldAt:void 0}}function r(t,e,a,i){let o=a?.quantityOnHand??0,r=a?.quantityReserved??0,d=a?.quantityAvailable??o-r,l=a?.reorderPoint??10;return{productId:e.id,variantId:t.id,sku:t.sku||e.sku||"",name:`${e.name} - ${t.name}`,barcode:t.barcode||e.barcode||void 0,price:t.price?n(t.price):n(e.price),costPrice:t.costPrice?n(t.costPrice):e.costPrice?n(e.costPrice):void 0,compareAtPrice:t.compareAtPrice?n(t.compareAtPrice):e.compareAtPrice?n(e.compareAtPrice):void 0,quantityOnHand:o,quantityReserved:r,quantityAvailable:d,lowStockThreshold:l,outOfStockThreshold:0,isInStock:d>0,isLowStock:d>0&&d<=l,allowNegative:e.allowBackorder||!1,trackInventory:e.trackInventory??!0,locationId:i?.id,locationName:i?.name,categoryId:e.categoryId||void 0,categoryName:e.category?.name||void 0,lastUpdated:a?.updatedAt||t.updatedAt,lastSoldAt:void 0}}class d{async getProductInventory(t,e,a,n){if(a){let t=await i._B.productVariant.findFirst({where:{id:a,productId:e},include:{product:{include:{category:!0}},inventoryLevels:!n||{where:{locationId:n}}}});if(!t)return null;let o=t.inventoryLevels[0],d=o?await i._B.location.findUnique({where:{id:o.locationId}}):null;return r(t,t.product,o,d)}let d=await i._B.product.findFirst({where:{id:e,tenantId:t},include:{category:!0,inventoryLevels:n?{where:{locationId:n,variantId:null}}:{where:{variantId:null}}}});if(!d)return null;let l=d.inventoryLevels[0],s=l?await i._B.location.findUnique({where:{id:l.locationId}}):null;return o(d,l,s)}async getMultipleProductInventory(t,e,a){let n=new Map,d=[...new Set(e.map(t=>t.productId))],l=await i._B.product.findMany({where:{id:{in:d},tenantId:t},include:{category:!0,variants:{include:{inventoryLevels:!a||{where:{locationId:a}}}},inventoryLevels:!a||{where:{locationId:a}}}}),s=a?await i._B.location.findUnique({where:{id:a}}):null;for(let t of e){let e=l.find(e=>e.id===t.productId);if(!e)continue;let a=t.variantId?`${t.productId}:${t.variantId}`:t.productId;if(t.variantId){let i=e.variants.find(e=>e.id===t.variantId);if(i){let t=i.inventoryLevels[0];n.set(a,r(i,e,t,s))}}else{let t=e.inventoryLevels.find(t=>!t.variantId);n.set(a,o(e,t,s))}}return n}async checkAvailability(t,e,a,i,n){let o=await this.getProductInventory(t,e,i,n);if(!o)return{productId:e,variantId:i,requestedQuantity:a,availableQuantity:0,canFulfill:!1,shortfall:a,status:"OUT_OF_STOCK",message:"Product not found"};if(!o.trackInventory)return{productId:e,variantId:i,requestedQuantity:a,availableQuantity:1/0,canFulfill:!0,shortfall:0,status:"NOT_TRACKED",message:"Inventory not tracked for this product"};let r=o.quantityAvailable,d=r>=a||o.allowNegative,l="IN_STOCK";return r<=0?l="OUT_OF_STOCK":r<a?l="LOW_STOCK":o.isLowStock&&(l="LOW_STOCK"),{productId:e,variantId:i,requestedQuantity:a,availableQuantity:r,canFulfill:d,shortfall:d?0:a-r,status:l,message:d?`${r} units available`:`Only ${r} units available, need ${a}`}}async checkBatchAvailability(t,e,a){let i=await Promise.all(e.items.map(e=>this.checkAvailability(t,e.productId,e.quantity,e.variantId,a))),n=i.filter(t=>!t.canFulfill);return{allAvailable:0===n.length,results:i,unavailableItems:n}}async searchProducts(t,e,a){let n={tenantId:t,status:"ACTIVE",OR:[{name:{contains:e,mode:"insensitive"}},{sku:{contains:e,mode:"insensitive"}},{barcode:{contains:e,mode:"insensitive"}}]};a?.categoryId&&(n.categoryId=a.categoryId);let r=await i._B.product.findMany({where:n,include:{category:!0,inventoryLevels:a?.locationId?{where:{locationId:a.locationId,variantId:null}}:{where:{variantId:null}}},take:a?.limit||50}),d=a?.locationId?await i._B.location.findUnique({where:{id:a.locationId}}):null,l=r.map(t=>{let e=t.inventoryLevels[0];return o(t,e,d)});return a?.inStockOnly&&(l=l.filter(t=>t.isInStock||!t.trackInventory)),l}async getLowStockProducts(t,e){return(await i._B.inventoryLevel.findMany({where:{tenantId:t,...e&&{locationId:e},quantityAvailable:{lte:i._B.inventoryLevel.fields.reorderPoint}},include:{product:{include:{category:!0}},variant:!0,location:!0}})).map(t=>t.variant?r(t.variant,t.product,t,t.location):o(t.product,t,t.location))}async getInventorySnapshot(t,e){let a={tenantId:t,status:"ACTIVE",...e?.productIds&&{id:{in:e.productIds}}},n=await i._B.product.findMany({where:a,include:{category:!0,variants:{include:{inventoryLevels:!e?.locationId||{where:{locationId:e.locationId}}}},inventoryLevels:!e?.locationId||{where:{locationId:e.locationId}}}}),d=e?.locationId?await i._B.location.findUnique({where:{id:e.locationId}}):null,l=[];for(let t of n){let a=t.inventoryLevels.find(t=>!t.variantId),i=o(t,a,d);for(let a of((e?.includeZeroStock||i.quantityAvailable>0||!i.trackInventory)&&l.push(i),t.variants)){let i=a.inventoryLevels[0],n=r(a,t,i,d);(e?.includeZeroStock||n.quantityAvailable>0||!n.trackInventory)&&l.push(n)}}return l}}class l{async getCustomer(t,e){let a=await i._B.customer.findFirst({where:{id:e,tenantId:t}});return a?{id:a.id,tenantId:a.tenantId,email:a.email||void 0,phone:a.phone||void 0,firstName:a.firstName||void 0,lastName:a.lastName||void 0,fullName:a.fullName||void 0,company:a.company||void 0,taxId:a.taxId||void 0,status:a.status,defaultAddressId:a.defaultAddressId||void 0,tags:a.tags||[],notes:a.notes||void 0,totalOrders:a.totalOrders,totalSpent:n(a.totalSpent),createdAt:a.createdAt,updatedAt:a.updatedAt}:null}async searchCustomers(t,e,a){return(await i._B.customer.findMany({where:{tenantId:t,status:"ACTIVE",OR:[{email:{contains:e,mode:"insensitive"}},{phone:{contains:e}},{fullName:{contains:e,mode:"insensitive"}},{firstName:{contains:e,mode:"insensitive"}},{lastName:{contains:e,mode:"insensitive"}}]},take:a||20})).map(t=>({id:t.id,tenantId:t.tenantId,email:t.email||void 0,phone:t.phone||void 0,firstName:t.firstName||void 0,lastName:t.lastName||void 0,fullName:t.fullName||void 0,company:t.company||void 0,taxId:t.taxId||void 0,status:t.status,defaultAddressId:t.defaultAddressId||void 0,tags:t.tags||[],notes:t.notes||void 0,totalOrders:t.totalOrders,totalSpent:n(t.totalSpent),createdAt:t.createdAt,updatedAt:t.updatedAt}))}}class s{async getLocation(t,e){let a=await i._B.location.findFirst({where:{id:e,tenantId:t}});return a?{id:a.id,tenantId:a.tenantId,name:a.name,code:a.code||void 0,type:a.type,status:a.status,address:{street1:a.addressLine1||void 0,street2:a.addressLine2||void 0,city:a.city||void 0,state:a.state||void 0,postalCode:a.postalCode||void 0,country:a.country||void 0},phone:a.phone||void 0,email:a.email||void 0,isDefault:a.isDefaultLocation,allowsPickup:a.allowsPickup,allowsShipping:a.allowsShipping,operatingHours:a.operatingHours||void 0}:null}async getLocations(t,e){return(await i._B.location.findMany({where:{tenantId:t,...e&&{status:"ACTIVE"}},orderBy:[{isDefaultLocation:"desc"},{name:"asc"}]})).map(t=>({id:t.id,tenantId:t.tenantId,name:t.name,code:t.code||void 0,type:t.type,status:t.status,address:{street1:t.addressLine1||void 0,street2:t.addressLine2||void 0,city:t.city||void 0,state:t.state||void 0,postalCode:t.postalCode||void 0,country:t.country||void 0},phone:t.phone||void 0,email:t.email||void 0,isDefault:t.isDefaultLocation,allowsPickup:t.allowsPickup,allowsShipping:t.allowsShipping,operatingHours:t.operatingHours||void 0}))}async getDefaultLocation(t){let e=await i._B.location.findFirst({where:{tenantId:t,isDefaultLocation:!0,status:"ACTIVE"}});return e?{id:e.id,tenantId:e.tenantId,name:e.name,code:e.code||void 0,type:e.type,status:e.status,address:{street1:e.addressLine1||void 0,street2:e.addressLine2||void 0,city:e.city||void 0,state:e.state||void 0,postalCode:e.postalCode||void 0,country:e.country||void 0},phone:e.phone||void 0,email:e.email||void 0,isDefault:e.isDefaultLocation,allowsPickup:e.allowsPickup,allowsShipping:e.allowsShipping,operatingHours:e.operatingHours||void 0}:null}}let c=new d,u=new l,v=new s},56238:(t,e,a)=>{a.d(e,{xW:()=>s,eE:()=>l,KS:()=>u,qk:()=>d,_B:()=>p,G0:()=>c,ah:()=>v});var i=a(53524);let n=["TenantMembership","TenantDomain","AuditLog"],o=[];function r(t){let e={...t,timestamp:new Date};o.push(e),o.length>1e3&&o.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(e,null,2))}function d(){return[...o]}function l(){o.length=0}class s extends Error{constructor(t,e,a,i){super(t),this.model=e,this.action=a,this.context=i,this.name="TenantIsolationError"}}function c(t,e,a,i){if(n.includes(t)){if(a?.bypassIsolation===!0){if(!a.isSuperAdmin){let n="Bypass isolation attempted without SUPER_ADMIN role";throw r({model:t,action:e,context:a,query:{queryTenantId:i},reason:n}),new s(n,t,e,a)}return}if(!a?.isSuperAdmin){if(!a){let n="No tenant context provided for tenant-scoped query";throw r({model:t,action:e,context:a,query:{queryTenantId:i},reason:n}),new s(n,t,e,a)}if(!a.tenantId){let n="No tenantId in context for tenant-scoped query";throw r({model:t,action:e,context:a,query:{queryTenantId:i},reason:n}),new s(n,t,e,a)}if(i&&i!==a.tenantId){let n=`Cross-tenant access attempt: query tenantId (${i}) != context tenantId (${a.tenantId})`;throw r({model:t,action:e,context:a,query:{queryTenantId:i},reason:n}),new s(n,t,e,a)}}}}function u(t,e,a,i=!1){return{tenantId:t,userId:e,isSuperAdmin:a,bypassIsolation:i}}function v(t,e){return{...t,tenantId:e}}let p=globalThis.prisma??new i.PrismaClient({log:["error"]})}};