"use strict";exports.id=3270,exports.ids=[3270],exports.modules={95456:(e,t,r)=>{r.d(t,{CK:()=>o,bA:()=>u,j5:()=>h,kS:()=>c,q4:()=>w,y_:()=>l});var n=r(56238),i=r(38547),a=r(71615);function s(){return(0,i.Z)()+"-"+(0,i.Z)()}async function u(e,t){let r=e.toLowerCase().trim(),a=await n._B.user.findUnique({where:{email:r}});a||(a=await n._B.user.create({data:{id:(0,i.Z)(),email:r,globalRole:"USER"}}));let u=s(),o=new Date;return o.setMinutes(o.getMinutes()+15),await n._B.magicLink.create({data:{id:(0,i.Z)(),token:u,userId:a.id,tenantId:t||null,expiresAt:o}}),{token:u,user:a}}async function o(e){let t=await n._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await n._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await n._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await n._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let r=s(),a=new Date;a.setDate(a.getDate()+7);let u=await n._B.session.create({data:{id:(0,i.Z)(),userId:t.userId,token:r,activeTenant:t.tenantId,expiresAt:a}});return{user:await n._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:u.id,token:r},tenantId:t.tenantId}}async function d(e){let t=await n._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await n._B.session.delete({where:{id:t.id}}),null):(await n._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function l(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function c(){let e=await (0,a.cookies)(),t=e.get("session_token")?.value;t&&await n._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function w(e,t){let r=await n._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!r)return!1;let i=r.user.memberships.some(e=>e.tenantId===t&&e.isActive),a="SUPER_ADMIN"===r.user.globalRole;return(!!i||!!a)&&(await n._B.session.update({where:{id:r.id},data:{activeTenant:t}}),!0)}function h(e){return"SUPER_ADMIN"===e.globalRole}},93270:(e,t,r)=>{r.d(t,{MQ:()=>u,rO:()=>o,uZ:()=>s});var n=r(56238),i=r(95456);async function a(){let e=await (0,i.y_)();if(!e)return{authorized:!1,error:"Authentication required",status:401};if(!e.user.isActive)return{authorized:!1,error:"Account is disabled",status:403};let t=await n._B.partnerUser.findUnique({where:{userId:e.user.id},include:{partner:!0}});return t?t.isActive?"ACTIVE"!==t.partner.status?{authorized:!1,error:"Partner organization is not active",status:403}:{authorized:!0,user:e.user,session:e,partner:t.partner,partnerUser:t,role:t.role}:{authorized:!1,error:"Partner membership is disabled",status:403}:{authorized:!1,error:"Not a partner user",status:403}}async function s(){let e=await a();return e.authorized&&"PARTNER_OWNER"!==e.role?{authorized:!1,error:"Partner Owner access required",status:403}:e}async function u(e){let t=await (0,i.y_)();if(!t)return{authorized:!1,error:"Authentication required",status:401};if(!t.user.isActive)return{authorized:!1,error:"Account is disabled",status:403};if("SUPER_ADMIN"===t.user.globalRole){let r=await n._B.partner.findUnique({where:{id:e}});return r?{authorized:!0,user:t.user,session:t,partner:r,partnerUser:null,role:"PARTNER_OWNER"}:{authorized:!1,error:"Partner not found",status:404}}let r=await n._B.partnerUser.findUnique({where:{userId:t.user.id},include:{partner:!0}});return r?r.partnerId!==e?{authorized:!1,error:"Access denied to this partner",status:403}:r.isActive?"ACTIVE"!==r.partner.status?{authorized:!1,error:"Partner organization is not active",status:403}:{authorized:!0,user:t.user,session:t,partner:r.partner,partnerUser:r,role:r.role}:{authorized:!1,error:"Partner membership is disabled",status:403}:{authorized:!1,error:"Not a partner user",status:403}}async function o(e){let t=await u(e);return t.authorized&&"SUPER_ADMIN"!==t.session.user.globalRole&&"PARTNER_OWNER"!==t.role?{authorized:!1,error:"Partner Owner access required",status:403}:t}},56238:(e,t,r)=>{r.d(t,{xW:()=>d,eE:()=>o,KS:()=>c,qk:()=>u,_B:()=>h,G0:()=>l,ah:()=>w});var n=r(53524);let i=["TenantMembership","TenantDomain","AuditLog"],a=[];function s(e){let t={...e,timestamp:new Date};a.push(t),a.length>1e3&&a.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function u(){return[...a]}function o(){a.length=0}class d extends Error{constructor(e,t,r,n){super(e),this.model=t,this.action=r,this.context=n,this.name="TenantIsolationError"}}function l(e,t,r,n){if(i.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let i="Bypass isolation attempted without SUPER_ADMIN role";throw s({model:e,action:t,context:r,query:{queryTenantId:n},reason:i}),new d(i,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let i="No tenant context provided for tenant-scoped query";throw s({model:e,action:t,context:r,query:{queryTenantId:n},reason:i}),new d(i,e,t,r)}if(!r.tenantId){let i="No tenantId in context for tenant-scoped query";throw s({model:e,action:t,context:r,query:{queryTenantId:n},reason:i}),new d(i,e,t,r)}if(n&&n!==r.tenantId){let i=`Cross-tenant access attempt: query tenantId (${n}) != context tenantId (${r.tenantId})`;throw s({model:e,action:t,context:r,query:{queryTenantId:n},reason:i}),new d(i,e,t,r)}}}}function c(e,t,r,n=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:n}}function w(e,t){return{...e,tenantId:t}}let h=globalThis.prisma??new n.PrismaClient({log:["error"]})}};