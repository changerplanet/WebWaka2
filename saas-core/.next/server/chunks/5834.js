"use strict";exports.id=5834,exports.ids=[5834],exports.modules={57662:(e,r,t)=>{t.d(r,{F:()=>c,U:()=>s});var n=t(56238),a=t(38547),o=t(71615);async function s(e){try{let r=await (0,o.headers)(),t=r.get("x-forwarded-for")||r.get("x-real-ip")||"unknown",s=r.get("user-agent")||"unknown";await n._B.auditLog.create({data:{id:(0,a.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:t,userAgent:s}})}catch(e){console.error("Failed to create audit log:",e)}}async function c(e){let{tenantId:r,actorId:t,action:a,targetType:o,limit:s=50,offset:c=0}=e,i={};r&&(i.tenantId=r),t&&(i.actorId=t),a&&(i.action=a),o&&(i.targetType=o);let[d,u]=await Promise.all([n._B.auditLog.findMany({where:i,orderBy:{createdAt:"desc"},take:s,skip:c}),n._B.auditLog.count({where:i})]);return{logs:d,total:u}}},45834:(e,r,t)=>{t.d(r,{cP:()=>p,cr:()=>M});var n=t(56238),a=t(57662);async function o(e){return!!await n._B.auditLog.findFirst({where:{targetId:e,targetType:"MVM_EVENT"}})}async function s(e,r,t,n){await (0,a.U)({action:"TENANT_UPDATED",actorId:n||"mvm-system",actorEmail:"mvm-system@internal",tenantId:t,targetType:"MVM_EVENT",targetId:e,metadata:{eventType:r,processedAt:new Date().toISOString()}})}async function c(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return console.log("[MVM] Event already processed:",r),{success:!0};try{let{tenantId:e,vendorId:n,vendorName:o,email:c,commissionRate:i}=t;return console.log("[MVM] Vendor onboarded:",o,"for tenant",e),await (0,a.U)({action:"TENANT_CREATED",actorId:n,actorEmail:c,tenantId:e,targetType:"VENDOR",targetId:n,metadata:{eventType:"MVM_VENDOR_ONBOARDED",vendorName:o,commissionRate:i,tierId:t.tierId,tierName:t.tierName,onboardedAt:t.onboardedAt}}),await s(r,"mvm.vendor.onboarding_completed",e,n),{success:!0}}catch(e){return console.error("[MVM] Error handling vendor onboarded:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,vendorName:o,changedBy:c}=t;return console.log("[MVM] Vendor approved:",o),await (0,a.U)({action:"TENANT_UPDATED",actorId:c||"system",actorEmail:"admin@tenant",tenantId:e,targetType:"VENDOR",targetId:n,metadata:{eventType:"MVM_VENDOR_APPROVED",vendorName:o,previousStatus:t.previousStatus,newStatus:t.newStatus,changedAt:t.changedAt}}),await s(r,"mvm.vendor.approved",e,c||"system"),{success:!0}}catch(e){return console.error("[MVM] Error handling vendor approved:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,vendorName:o,reason:c,changedBy:i}=t;return console.log("[MVM] Vendor suspended:",o,"Reason:",c),await (0,a.U)({action:"TENANT_SUSPENDED",actorId:i||"system",actorEmail:"admin@tenant",tenantId:e,targetType:"VENDOR",targetId:n,metadata:{eventType:"MVM_VENDOR_SUSPENDED",vendorName:o,reason:c,previousStatus:t.previousStatus,changedAt:t.changedAt}}),await s(r,"mvm.vendor.suspended",e,i||"system"),{success:!0}}catch(e){return console.error("[MVM] Error handling vendor suspended:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function u(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,parentOrderId:n,parentOrderNumber:o,vendorCount:c,totalAmount:i,totalCommission:d}=t;return console.log("[MVM] Order split:",o,"into",c,"sub-orders"),await (0,a.U)({action:"TENANT_UPDATED",actorId:"system",actorEmail:"mvm-system@internal",tenantId:e,targetType:"ORDER_SPLIT",targetId:n,metadata:{eventType:"MVM_ORDER_SPLIT",parentOrderNumber:o,vendorCount:c,subOrderIds:t.subOrderIds,subOrderNumbers:t.subOrderNumbers,totalAmount:i,totalCommission:d,splitAt:t.splitAt}}),await s(r,"mvm.order.split",e,"system"),{success:!0}}catch(e){return console.error("[MVM] Error handling order split:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,subOrderId:o,subOrderNumber:c,items:i,grandTotal:d,commissionAmount:u}=t;return console.log("[MVM] Sub-order created:",c,"for vendor",n),console.log("[MVM] Items:",i.length,"Total: $"+d,"Commission: $"+u),await (0,a.U)({action:"TENANT_CREATED",actorId:n,actorEmail:"vendor@mvm",tenantId:e,targetType:"VENDOR_SUB_ORDER",targetId:o,metadata:{eventType:"MVM_SUBORDER_CREATED",subOrderNumber:c,parentOrderId:t.parentOrderId,parentOrderNumber:t.parentOrderNumber,itemCount:i.length,grandTotal:d,commissionAmount:u,vendorEarnings:t.vendorEarnings}}),await s(r,"mvm.suborder.created",e,n),{success:!0,reservationId:`mvm_res_${Date.now()}`}}catch(e){return console.error("[MVM] Error handling sub-order created:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,subOrderId:o,subOrderNumber:c,grandTotal:i,commissionAmount:d,customerId:u}=t;return console.log("[MVM] Sub-order delivered:",c),await (0,a.U)({action:"TENANT_UPDATED",actorId:n,actorEmail:"vendor@mvm",tenantId:e,targetType:"VENDOR_SUB_ORDER",targetId:o,metadata:{eventType:"MVM_SUBORDER_DELIVERED",subOrderNumber:c,grandTotal:i,commissionAmount:d,vendorEarnings:t.vendorEarnings,customerId:u,deliveredAt:t.deliveredAt}}),await s(r,"mvm.suborder.delivered",e,n),{success:!0}}catch(e){return console.error("[MVM] Error handling sub-order delivered:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function g(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,subOrderId:o,subOrderNumber:c,items:i,reason:d}=t;return console.log("[MVM] Sub-order cancelled:",c,"Reason:",d),await (0,a.U)({action:"TENANT_UPDATED",actorId:n,actorEmail:"vendor@mvm",tenantId:e,targetType:"VENDOR_SUB_ORDER",targetId:o,metadata:{eventType:"MVM_SUBORDER_CANCELLED",subOrderNumber:c,parentOrderId:t.parentOrderId,reason:d,itemCount:i.length,cancelledAt:t.cancelledAt}}),await s(r,"mvm.suborder.cancelled",e,n),{success:!0}}catch(e){return console.error("[MVM] Error handling sub-order cancelled:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function E(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,subOrderId:o,subOrderNumber:c,commissionRate:i,commissionAmount:d,orderTotal:u}=t;return console.log("[MVM] Commission earned: $"+d,"on order",c),console.log("[MVM] Rate:",i+"%","Order total: $"+u),await (0,a.U)({action:"TENANT_UPDATED",actorId:n,actorEmail:"vendor@mvm",tenantId:e,targetType:"COMMISSION",targetId:o,metadata:{eventType:"MVM_COMMISSION_EARNED",subOrderNumber:c,orderTotal:u,commissionRate:i,commissionAmount:d,vendorEarnings:t.vendorEarnings,earnedAt:t.earnedAt}}),await s(r,"mvm.commission.earned",e,n),{success:!0}}catch(e){return console.error("[MVM] Error handling commission earned:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function v(e){let{idempotencyKey:r,payload:t}=e;if(await o(r))return{success:!0};try{let{tenantId:e,vendorId:n,payoutRecordId:o,netAmount:c,currency:i,subOrderIds:d}=t;return console.log("[MVM] Payout ready: $"+c,i,"for vendor",n),console.log("[MVM] Includes",d.length,"sub-orders"),await (0,a.U)({action:"TENANT_UPDATED",actorId:n,actorEmail:"vendor@mvm",tenantId:e,targetType:"PAYOUT",targetId:o,metadata:{eventType:"MVM_PAYOUT_READY",grossAmount:t.grossAmount,commissionAmount:t.commissionAmount,netAmount:c,currency:i,subOrderCount:d.length,scheduledAt:t.scheduledAt}}),await s(r,"mvm.payout.ready",e,n),{success:!0}}catch(e){return console.error("[MVM] Error handling payout ready:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function p(e){let{eventType:r}=e;switch(console.log("[MVM] Processing event:",r),r){case"mvm.vendor.onboarding_completed":return c(e);case"mvm.vendor.approved":return i(e);case"mvm.vendor.suspended":return d(e);case"mvm.order.split":return u(e);case"mvm.suborder.created":return l(e);case"mvm.suborder.delivered":return m(e);case"mvm.suborder.cancelled":return g(e);case"mvm.commission.earned":return E(e);case"mvm.payout.ready":return v(e);default:return console.log("[MVM] Unknown event type:",r),{success:!0}}}async function M(e){try{let r=await n._B.entitlement.findUnique({where:{tenantId_module:{tenantId:e,module:"MVM"}},include:{subscription:!0}});if(!r||"ACTIVE"!==r.status)return{success:!1,module:"MVM",features:[],limits:{},expiresAt:null};let t=r.limits||{};return{success:!0,module:"MVM",features:["vendors","vendor_onboarding","vendor_dashboard","order_splitting","commission_management","payout_tracking"],limits:{max_vendors:t.max_vendors??10,max_vendor_staff_per_vendor:t.max_vendor_staff_per_vendor??3,max_products_per_vendor:t.max_products_per_vendor??50,max_commission_rules:t.max_commission_rules??5,max_vendor_tiers:t.max_vendor_tiers??3,commission_rate_min:t.commission_rate_min??5,commission_rate_max:t.commission_rate_max??30},expiresAt:r.validUntil?.toISOString()??null}}catch(e){return console.error("[MVM] Error fetching entitlements:",e),{success:!1,module:"MVM",features:[],limits:{},expiresAt:null}}}},56238:(e,r,t)=>{t.d(r,{xW:()=>d,eE:()=>i,KS:()=>l,qk:()=>c,_B:()=>g,G0:()=>u,ah:()=>m});var n=t(53524);let a=["TenantMembership","TenantDomain","AuditLog"],o=[];function s(e){let r={...e,timestamp:new Date};o.push(r),o.length>1e3&&o.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(r,null,2))}function c(){return[...o]}function i(){o.length=0}class d extends Error{constructor(e,r,t,n){super(e),this.model=r,this.action=t,this.context=n,this.name="TenantIsolationError"}}function u(e,r,t,n){if(a.includes(e)){if(t?.bypassIsolation===!0){if(!t.isSuperAdmin){let a="Bypass isolation attempted without SUPER_ADMIN role";throw s({model:e,action:r,context:t,query:{queryTenantId:n},reason:a}),new d(a,e,r,t)}return}if(!t?.isSuperAdmin){if(!t){let a="No tenant context provided for tenant-scoped query";throw s({model:e,action:r,context:t,query:{queryTenantId:n},reason:a}),new d(a,e,r,t)}if(!t.tenantId){let a="No tenantId in context for tenant-scoped query";throw s({model:e,action:r,context:t,query:{queryTenantId:n},reason:a}),new d(a,e,r,t)}if(n&&n!==t.tenantId){let a=`Cross-tenant access attempt: query tenantId (${n}) != context tenantId (${t.tenantId})`;throw s({model:e,action:r,context:t,query:{queryTenantId:n},reason:a}),new d(a,e,r,t)}}}}function l(e,r,t,n=!1){return{tenantId:e,userId:r,isSuperAdmin:t,bypassIsolation:n}}function m(e,r){return{...e,tenantId:r}}let g=globalThis.prisma??new n.PrismaClient({log:["error"]})}};