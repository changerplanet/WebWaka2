"use strict";exports.id=9550,exports.ids=[9550],exports.modules={59550:(e,t,a)=>{a.d(t,{Tq:()=>o,uL:()=>p,gu:()=>g});var r=a(56238),n=a(93270);async function i(e){let t=await r._B.partnerPayoutSettings.findUnique({where:{partnerId:e}});return t||(t=await r._B.partnerPayoutSettings.create({data:{partnerId:e,minimumPayout:100,currency:"USD",payoutFrequency:"MONTHLY",taxWithholdingEnabled:!1,taxDocumentStatus:"NOT_SUBMITTED",paymentMethodVerified:!1,payoutHold:!1}})),t}async function s(e){let t=await r._B.partner.findUnique({where:{id:e},select:{name:!0}}),a=await i(e),n=await r._B.partnerEarning.groupBy({by:["status"],where:{partnerId:e,entryType:"CREDIT"},_sum:{commissionAmount:!0},_count:!0}),s=await r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",payoutBatchId:{not:null},status:{in:["APPROVED","CLEARED"]}},_sum:{commissionAmount:!0}}),o={partnerId:e,partnerName:t?.name||"Unknown",pending:0,cleared:0,approved:0,inBatch:Number(s._sum.commissionAmount||0),totalPayable:0,totalPaid:0,totalReversed:0,currency:a.currency,minimumPayout:Number(a.minimumPayout),meetsMinimum:!1};for(let e of n){let t=Number(e._sum.commissionAmount||0);switch(e.status){case"PENDING":o.pending=t;break;case"CLEARED":o.cleared=t;break;case"APPROVED":o.approved=t;break;case"PAID":o.totalPaid=t;break;case"REVERSED":o.totalReversed=t}}return o.totalPayable=o.cleared+o.approved-o.inBatch,o.meetsMinimum=o.totalPayable>=o.minimumPayout,o}async function o(e){if(!(await (0,n.MQ)(e)).authorized)return null;let[t,a,r,i,s]=await Promise.all([u(e),m(e),l(e),c(e),d(e)]);return t?{partner:t,summary:a,earnings:r,referrals:i,recentActivity:s}:null}async function u(e){let t=await r._B.partner.findUnique({where:{id:e},include:{agreements:{where:{status:"ACTIVE",effectiveFrom:{lte:new Date},OR:[{effectiveTo:null},{effectiveTo:{gte:new Date}}]},orderBy:{version:"desc"},take:1}}});if(!t)return null;let a=t.agreements[0];return{id:t.id,name:t.name,slug:t.slug,status:t.status,tier:t.tier,joinedAt:t.createdAt,currentAgreement:a?{version:a.version,commissionRate:Number(a.commissionRate),commissionType:a.commissionType,effectiveFrom:a.effectiveFrom}:null}}async function m(e){let t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),n=new Date(t.getFullYear(),t.getMonth()-1,1),i=new Date(t.getFullYear(),t.getMonth(),0),o=await r._B.partnerReferral.groupBy({by:["partnerId"],where:{partnerId:e},_count:!0}),u=await r._B.partnerReferral.count({where:{partnerId:e,tenant:{status:"ACTIVE"}}}),m=await r._B.partnerReferral.count({where:{partnerId:e,tenant:{status:"PENDING_ACTIVATION"}}}),l=await r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",status:{in:["CLEARED","APPROVED","PAID"]}},_sum:{commissionAmount:!0}}),c=await r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",createdAt:{gte:a}},_sum:{commissionAmount:!0}}),d=await r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",createdAt:{gte:n,lte:i}},_sum:{commissionAmount:!0}}),p=await s(e);return{totalReferrals:o[0]?._count||0,activeReferrals:u,pendingReferrals:m,totalEarnings:Number(l._sum.commissionAmount||0),thisMonthEarnings:Number(c._sum.commissionAmount||0),lastMonthEarnings:Number(d._sum.commissionAmount||0),currentBalance:p.totalPayable,pendingClearance:p.pending,currency:p.currency}}async function l(e){let t=await s(e),a=[],n=new Date;for(let t=5;t>=0;t--){let i=new Date(n.getFullYear(),n.getMonth()-t,1),s=new Date(n.getFullYear(),n.getMonth()-t+1,0),o=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`,[u,m]=await Promise.all([r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",createdAt:{gte:i,lte:s}},_sum:{commissionAmount:!0}}),r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",status:"PAID",paidAt:{gte:i,lte:s}},_sum:{commissionAmount:!0}})]);a.push({month:o,earned:Number(u._sum.commissionAmount||0),paid:Number(m._sum.commissionAmount||0)})}return{balance:t,monthlyTrend:a,byStatus:{pending:t.pending,cleared:t.cleared,approved:t.approved,paid:t.totalPaid},currency:t.currency}}async function c(e){let t=await r._B.partnerReferral.groupBy({by:["partnerId"],where:{partnerId:e},_count:!0}),a=await r._B.partnerReferral.count({where:{partnerId:e,tenant:{status:"ACTIVE"}}}),n=await r._B.partnerReferral.count({where:{partnerId:e,tenant:{status:"PENDING_ACTIVATION"}}}),i=await r._B.partnerReferral.count({where:{partnerId:e,tenant:{status:"SUSPENDED"}}}),s=await r._B.partnerReferral.count({where:{partnerId:e,tenant:{status:"DEACTIVATED"}}}),o=await r._B.partnerReferral.findMany({where:{partnerId:e},include:{tenant:{select:{id:!0,name:!0,slug:!0,status:!0}}},orderBy:{referredAt:"desc"},take:10}),u=(await r._B.partnerReferral.findMany({where:{partnerId:e},include:{tenant:{select:{id:!0,name:!0,slug:!0,status:!0}},earnings:{where:{entryType:"CREDIT"},select:{commissionAmount:!0,paidAt:!0}}}})).map(e=>({referral:e,totalRevenue:e.earnings.reduce((e,t)=>e+Number(t.commissionAmount),0),lastPayment:e.earnings.filter(e=>e.paidAt).sort((e,t)=>(t.paidAt?.getTime()||0)-(e.paidAt?.getTime()||0))[0]?.paidAt})).sort((e,t)=>t.totalRevenue-e.totalRevenue).slice(0,5),m=(e,t=0,a=null)=>({referralId:e.id,tenantId:e.tenant.id,tenantName:e.tenant.name,tenantSlug:e.tenant.slug,tenantStatus:e.tenant.status,referredAt:e.referredAt,attributionMethod:e.attributionMethod,isLifetime:!e.attributionWindowDays,attributionExpiresAt:e.attributionExpiresAt,totalRevenue:t,lastPaymentDate:a});return{total:t[0]?._count||0,byStatus:{active:a,pending:n,suspended:i,churned:s},recent:o.map(e=>m(e)),topPerformers:u.map(e=>m(e.referral,e.totalRevenue,e.lastPayment||null))}}async function d(e){let t=[];for(let a of(await r._B.partnerEarning.findMany({where:{partnerId:e,entryType:"CREDIT"},orderBy:{createdAt:"desc"},take:5,include:{referral:{include:{tenant:{select:{name:!0}}}}}})))t.push({id:a.id,type:"EARNING",title:"Commission Earned",description:`Commission from ${a.referral.tenant.name}`,amount:Number(a.commissionAmount),currency:a.currency,timestamp:a.createdAt});for(let a of(await r._B.partnerReferral.findMany({where:{partnerId:e},orderBy:{referredAt:"desc"},take:5,include:{tenant:{select:{name:!0}}}})))t.push({id:a.id,type:"REFERRAL",title:"New Referral",description:`${a.tenant.name} was referred`,timestamp:a.referredAt});for(let a of(await r._B.payoutBatch.findMany({where:{partnerId:e},orderBy:{createdAt:"desc"},take:5})))t.push({id:a.id,type:"PAYOUT",title:`Payout ${a.status}`,description:`Batch ${a.batchNumber}`,amount:Number(a.netAmount),currency:a.currency,timestamp:a.createdAt});return t.sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime()).slice(0,10)}async function p(e,t,a){if(!(await (0,n.MQ)(e)).authorized)throw Error("Unauthorized");let i=await r._B.partnerReferral.findMany({where:{partnerId:e,referredAt:{gte:t,lte:a}},include:{tenant:{select:{status:!0}}}}),s=i.length,o=i.filter(e=>"ACTIVE"===e.tenant.status).length,u=Number((await r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",createdAt:{gte:t,lte:a}},_sum:{commissionAmount:!0}}))._sum.commissionAmount||0),m=await r._B.partnerReferral.count({where:{partnerId:e}}),l=new Date;l.setMonth(l.getMonth()-3);let c=await r._B.partnerReferral.count({where:{partnerId:e,referredAt:{lte:l}}}),d=await r._B.partnerReferral.count({where:{partnerId:e,referredAt:{lte:l},tenant:{status:"ACTIVE"}}}),p=c>0?d/c*100:100,g=a.getTime()-t.getTime(),f=new Date(t.getTime()-g),w=new Date(t.getTime()-1),y=await r._B.partnerReferral.count({where:{partnerId:e,referredAt:{gte:f,lte:w}}}),A=[],h=[],R=new Date(t);for(;R<=a;){let t=new Date(R.getFullYear(),R.getMonth(),1),a=new Date(R.getFullYear(),R.getMonth()+1,0),n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`,[i,s]=await Promise.all([r._B.partnerEarning.aggregate({where:{partnerId:e,entryType:"CREDIT",createdAt:{gte:t,lte:a}},_sum:{commissionAmount:!0}}),r._B.partnerReferral.count({where:{partnerId:e,referredAt:{gte:t,lte:a}}})]);A.push({month:n,amount:Number(i._sum.commissionAmount||0)}),h.push({month:n,count:s}),R.setMonth(R.getMonth()+1)}return{partnerId:e,period:{start:t,end:a},conversionRate:s>0?o/s*100:0,totalRevenue:u,averageRevenuePerReferral:m>0?u/m:0,retentionRate:p,churnRate:100-p,newReferralsThisPeriod:s,growthRate:y>0?(s-y)/y*100:s>0?100:0,monthlyRevenue:A,monthlyReferrals:h}}async function g(e,t){if(!(await (0,n.MQ)(e)).authorized)return{tenants:[],total:0};let a={partnerId:e};t?.status&&(a.tenant={status:{in:t.status}});let[i,s]=await Promise.all([r._B.partnerReferral.findMany({where:a,include:{tenant:{select:{id:!0,name:!0,slug:!0,status:!0}},earnings:{where:{entryType:"CREDIT"},select:{commissionAmount:!0,paidAt:!0}}},orderBy:{referredAt:t?.sortOrder||"desc"},take:t?.limit||20,skip:t?.offset||0}),r._B.partnerReferral.count({where:a})]),o=i.map(e=>{let t=e.earnings.reduce((e,t)=>e+Number(t.commissionAmount),0),a=e.earnings.filter(e=>e.paidAt).sort((e,t)=>(t.paidAt?.getTime()||0)-(e.paidAt?.getTime()||0))[0]?.paidAt;return{referralId:e.id,tenantId:e.tenant.id,tenantName:e.tenant.name,tenantSlug:e.tenant.slug,tenantStatus:e.tenant.status,referredAt:e.referredAt,attributionMethod:e.attributionMethod,isLifetime:!e.attributionWindowDays,attributionExpiresAt:e.attributionExpiresAt,totalRevenue:t,lastPaymentDate:a||null}});return t?.sortBy==="revenue"&&o.sort((e,a)=>"asc"===t.sortOrder?e.totalRevenue-a.totalRevenue:a.totalRevenue-e.totalRevenue),{tenants:o,total:s}}}};