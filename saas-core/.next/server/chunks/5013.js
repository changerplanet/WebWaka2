"use strict";exports.id=5013,exports.ids=[5013],exports.modules={57662:(e,t,r)=>{r.d(t,{F:()=>c,U:()=>o});var n=r(56238),a=r(38547),s=r(71615);async function o(e){try{let t=await (0,s.headers)(),r=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",o=t.get("user-agent")||"unknown";await n._B.auditLog.create({data:{id:(0,a.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:r,userAgent:o}})}catch(e){console.error("Failed to create audit log:",e)}}async function c(e){let{tenantId:t,actorId:r,action:a,targetType:s,limit:o=50,offset:c=0}=e,i={};t&&(i.tenantId=t),r&&(i.actorId=r),a&&(i.action=a),s&&(i.targetType=s);let[d,u]=await Promise.all([n._B.auditLog.findMany({where:i,orderBy:{createdAt:"desc"},take:o,skip:c}),n._B.auditLog.count({where:i})]);return{logs:d,total:u}}},56238:(e,t,r)=>{r.d(t,{xW:()=>d,eE:()=>i,KS:()=>l,qk:()=>c,_B:()=>p,G0:()=>u,ah:()=>m});var n=r(53524);let a=["TenantMembership","TenantDomain","AuditLog"],s=[];function o(e){let t={...e,timestamp:new Date};s.push(t),s.length>1e3&&s.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function c(){return[...s]}function i(){s.length=0}class d extends Error{constructor(e,t,r,n){super(e),this.model=t,this.action=r,this.context=n,this.name="TenantIsolationError"}}function u(e,t,r,n){if(a.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let a="Bypass isolation attempted without SUPER_ADMIN role";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:a}),new d(a,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let a="No tenant context provided for tenant-scoped query";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:a}),new d(a,e,t,r)}if(!r.tenantId){let a="No tenantId in context for tenant-scoped query";throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:a}),new d(a,e,t,r)}if(n&&n!==r.tenantId){let a=`Cross-tenant access attempt: query tenantId (${n}) != context tenantId (${r.tenantId})`;throw o({model:e,action:t,context:r,query:{queryTenantId:n},reason:a}),new d(a,e,t,r)}}}}function l(e,t,r,n=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:n}}function m(e,t){return{...e,tenantId:t}}let p=globalThis.prisma??new n.PrismaClient({log:["error"]})},95013:(e,t,r)=>{r.d(t,{NR:()=>p,Yd:()=>m});var n=r(56238),a=r(57662);async function s(e){return!!await n._B.auditLog.findFirst({where:{targetId:e,action:"TENANT_UPDATED"}})}async function o(e,t,r,n){await (0,a.U)({action:"TENANT_UPDATED",actorId:n||"system",actorEmail:"svm-system@internal",tenantId:r,targetType:"SVM_EVENT",targetId:e,metadata:{eventType:t,processedAt:new Date().toISOString()}})}async function c(e){let{idempotencyKey:t,payload:r}=e;if(await s(t))return console.log("[SVM] Event already processed:",t),{success:!0};try{let{tenantId:e,orderId:n,orderNumber:s,items:c,grandTotal:i,customerId:d}=r;return console.log("[SVM] Order placed:",s,"for tenant",e),console.log("[SVM] Total: $"+i+", Items:",c.length),await (0,a.U)({action:"TENANT_CREATED",actorId:d||"guest",actorEmail:r.guestEmail||"guest@checkout",tenantId:e,targetType:"ORDER",targetId:n,metadata:{eventType:"SVM_ORDER_PLACED",orderNumber:s,grandTotal:i,itemCount:c.length,currency:r.currency}}),await o(t,"svm.order.placed",e,d||"guest"),{success:!0,reservationId:`res_${Date.now()}`}}catch(e){return console.error("[SVM] Error handling order placed:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e){let{idempotencyKey:t,payload:r}=e;if(await s(t))return{success:!0};try{let{tenantId:e,orderId:n,orderNumber:s,amount:c,currency:i,customerId:d}=r;return console.log("[SVM] Payment requested:",s,"for $"+c),await (0,a.U)({action:"TENANT_UPDATED",actorId:d||"guest",actorEmail:r.guestEmail||"guest@checkout",tenantId:e,targetType:"PAYMENT_REQUEST",targetId:n,metadata:{eventType:"SVM_PAYMENT_REQUESTED",orderNumber:s,amount:c,currency:i}}),await o(t,"svm.order.payment_requested",e,d||"guest"),{success:!0,paymentIntentId:`pi_${Date.now()}`}}catch(e){return console.error("[SVM] Error handling payment requested:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(e){let{idempotencyKey:t,payload:r}=e;if(await s(t))return{success:!0};try{let{tenantId:e,orderId:n,orderNumber:s,cancelledBy:c,cancelledByUserId:i,reason:d,items:u,wasPaymentCaptured:l,refundAmount:m}=r;return console.log("[SVM] Order cancelled:",s,"by",c),await (0,a.U)({action:"TENANT_SUSPENDED",actorId:i||c.toLowerCase(),actorEmail:"svm@internal",tenantId:e,targetType:"ORDER",targetId:n,metadata:{eventType:"SVM_ORDER_CANCELLED",orderNumber:s,reason:d,cancelledBy:c,wasPaymentCaptured:l,refundAmount:m||0,itemCount:u.length}}),await o(t,"svm.order.cancelled",e,i||"system"),{success:!0}}catch(e){return console.error("[SVM] Error handling order cancelled:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function u(e){let{idempotencyKey:t,payload:r}=e;if(await s(t))return{success:!0};try{let{tenantId:e,orderId:n,orderNumber:s,corePaymentId:c,refundType:i,refundAmount:d,reason:u,items:l,requestedBy:m}=r;return console.log("[SVM] Refund requested:",s,i,"$"+d),await (0,a.U)({action:"TENANT_ACTIVATED",actorId:m,actorEmail:"svm@internal",tenantId:e,targetType:"REFUND",targetId:n,metadata:{eventType:"SVM_REFUND_REQUESTED",orderNumber:s,refundType:i,refundAmount:d,reason:u,corePaymentId:c,itemCount:l?.length||0}}),await o(t,"svm.order.refund_requested",e,m),{success:!0,refundId:`ref_${Date.now()}`}}catch(e){return console.error("[SVM] Error handling refund requested:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e){let{idempotencyKey:t,payload:r}=e;if(await s(t))return{success:!0};try{let{tenantId:e,orderId:n,orderNumber:s,carrier:c,trackingNumber:i,trackingUrl:d,notifyCustomer:u,customerEmail:l}=r;return console.log("[SVM] Order shipped:",s,"via",c,i),await (0,a.U)({action:"TENANT_UPDATED",actorId:"system",actorEmail:"svm@internal",tenantId:e,targetType:"ORDER",targetId:n,metadata:{eventType:"SVM_ORDER_SHIPPED",orderNumber:s,carrier:c,trackingNumber:i,trackingUrl:d,notifyCustomer:u}}),await o(t,"svm.order.shipped",e,"system"),{success:!0}}catch(e){return console.error("[SVM] Error handling order shipped:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e){switch(console.log("[SVM] Received event:",e.eventType),e.eventType){case"svm.order.placed":return c(e);case"svm.order.payment_requested":return i(e);case"svm.order.cancelled":return d(e);case"svm.order.refund_requested":return u(e);case"svm.order.shipped":return l(e);case"svm.order.created":case"svm.order.paid":case"svm.order.processing":case"svm.order.delivered":case"svm.order.fulfilled":case"svm.order.refunded":case"svm.order.status_changed":return console.log("[SVM] Event logged:",e.eventType,e.payload),{success:!0};default:return console.log("[SVM] Unhandled event type:",e.eventType),{success:!0}}}async function p(e){try{let t=await n._B.entitlement.findUnique({where:{tenantId_module:{tenantId:e,module:"SVM"}}});if(!t||"ACTIVE"!==t.status)return{module:"SVM",features:["storefront","cart","checkout","orders"],limits:{max_products:100,max_orders_per_month:500,max_storage_mb:1024},expiresAt:null};let r=t.limits||{},a=["storefront","cart","checkout","orders"];return!1!==r.promotions_enabled&&a.push("promotions"),!1!==r.reviews_enabled&&a.push("reviews"),!1!==r.wishlist_enabled&&a.push("wishlist"),!1!==r.cms_enabled&&a.push("cms"),!1!==r.seo_enabled&&a.push("seo"),!1!==r.analytics_enabled&&a.push("analytics"),!0===r.api_enabled&&a.push("api"),{module:"SVM",features:a,limits:{max_products:"number"==typeof r.max_products?r.max_products:100,max_orders_per_month:"number"==typeof r.max_orders_per_month?r.max_orders_per_month:500,max_storage_mb:"number"==typeof r.max_storage_mb?r.max_storage_mb:1024,max_banners:"number"==typeof r.max_banners?r.max_banners:10,max_pages:"number"==typeof r.max_pages?r.max_pages:20},expiresAt:t.validUntil?.toISOString()||null}}catch(e){return console.error("[SVM] Error fetching entitlements:",e),null}}}};