"use strict";exports.id=7151,exports.ids=[7151],exports.modules={56238:(t,e,r)=>{r.d(e,{xW:()=>d,eE:()=>u,KS:()=>l,qk:()=>a,_B:()=>y,G0:()=>c,ah:()=>m});var i=r(53524);let n=["TenantMembership","TenantDomain","AuditLog"],o=[];function s(t){let e={...t,timestamp:new Date};o.push(e),o.length>1e3&&o.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(e,null,2))}function a(){return[...o]}function u(){o.length=0}class d extends Error{constructor(t,e,r,i){super(t),this.model=e,this.action=r,this.context=i,this.name="TenantIsolationError"}}function c(t,e,r,i){if(n.includes(t)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let n="Bypass isolation attempted without SUPER_ADMIN role";throw s({model:t,action:e,context:r,query:{queryTenantId:i},reason:n}),new d(n,t,e,r)}return}if(!r?.isSuperAdmin){if(!r){let n="No tenant context provided for tenant-scoped query";throw s({model:t,action:e,context:r,query:{queryTenantId:i},reason:n}),new d(n,t,e,r)}if(!r.tenantId){let n="No tenantId in context for tenant-scoped query";throw s({model:t,action:e,context:r,query:{queryTenantId:i},reason:n}),new d(n,t,e,r)}if(i&&i!==r.tenantId){let n=`Cross-tenant access attempt: query tenantId (${i}) != context tenantId (${r.tenantId})`;throw s({model:t,action:e,context:r,query:{queryTenantId:i},reason:n}),new d(n,t,e,r)}}}}function l(t,e,r,i=!1){return{tenantId:t,userId:e,isSuperAdmin:r,bypassIsolation:i}}function m(t,e){return{...t,tenantId:e}}let y=globalThis.prisma??new i.PrismaClient({log:["error"]})},87151:(t,e,r)=>{r.d(e,{Bc:()=>I,Et:()=>h,Fh:()=>c,Ox:()=>o,PL:()=>l,QF:()=>T,S4:()=>f,V$:()=>m,iP:()=>O,jC:()=>y,nb:()=>g,zX:()=>p});var i=r(56238),n=r(32199);function o(t="promo"){return`${t}_${Date.now().toString(36)}${Math.random().toString(36).substring(2,9)}`}function s(t){return null==t?null:Number(t)}function a(t){return{id:t.id,tenantId:t.tenantId,name:t.name,description:t.description,code:t.code,type:t.type,discountType:t.discountType,discountValue:Number(t.discountValue),maxDiscount:s(t.maxDiscount),minOrderTotal:s(t.minOrderTotal),minQuantity:t.minQuantity,productIds:t.productIds||[],categoryIds:t.categoryIds||[],excludeProductIds:t.excludeProductIds||[],customerIds:t.customerIds||[],firstOrderOnly:t.firstOrderOnly,usageLimit:t.usageLimit,usageCount:t.usageCount,perCustomerLimit:t.perCustomerLimit,startsAt:t.startsAt,endsAt:t.endsAt,isActive:t.isActive,stackable:t.stackable,priority:t.priority,buyQuantity:t.buyQuantity,getQuantity:t.getQuantity,getDiscountPercent:t.getDiscountPercent,createdAt:t.createdAt?.toISOString(),updatedAt:t.updatedAt?.toISOString()}}async function u(t){let e=new Date;return(await i._B.$transaction([i._B.svmPromotion.create({data:{tenantId:t,name:"Welcome Discount",description:"10% off your first order",code:"WELCOME10",type:"COUPON",discountType:"PERCENTAGE",discountValue:10,productIds:[],categoryIds:[],excludeProductIds:[],customerIds:[],firstOrderOnly:!0,usageCount:0,startsAt:e,isActive:!0,stackable:!1,priority:0}}),i._B.svmPromotion.create({data:{tenantId:t,name:"Summer Sale",description:"15% off orders over $100 (max $50 discount)",code:null,type:"AUTOMATIC",discountType:"PERCENTAGE",discountValue:15,maxDiscount:50,minOrderTotal:100,productIds:[],categoryIds:[],excludeProductIds:[],customerIds:[],firstOrderOnly:!1,usageCount:0,startsAt:e,isActive:!0,stackable:!0,priority:10}}),i._B.svmPromotion.create({data:{tenantId:t,name:"Free Shipping",description:"Free shipping on orders over $50",code:"FREESHIP",type:"COUPON",discountType:"FREE_SHIPPING",discountValue:0,minOrderTotal:50,productIds:[],categoryIds:[],excludeProductIds:[],customerIds:[],firstOrderOnly:!1,usageCount:0,startsAt:e,isActive:!0,stackable:!0,priority:5}}),i._B.svmPromotion.create({data:{tenantId:t,name:"Buy 2 Get 1 Free",description:"Buy any 2 items, get 1 free",code:"BOGO",type:"COUPON",discountType:"BUY_X_GET_Y",discountValue:100,buyQuantity:2,getQuantity:1,getDiscountPercent:100,productIds:[],categoryIds:[],excludeProductIds:[],customerIds:[],firstOrderOnly:!1,usageCount:0,startsAt:e,isActive:!0,stackable:!1,priority:0}}),i._B.svmPromotion.create({data:{tenantId:t,name:"$20 Off",description:"$20 off orders over $75 (limit 100 uses)",code:"SAVE20",type:"COUPON",discountType:"FIXED_AMOUNT",discountValue:20,minOrderTotal:75,usageLimit:100,perCustomerLimit:1,productIds:[],categoryIds:[],excludeProductIds:[],customerIds:[],firstOrderOnly:!1,usageCount:0,startsAt:e,isActive:!0,stackable:!1,priority:0}})])).map(a)}async function d(t){let e=await i._B.svmPromotion.findMany({where:{tenantId:t}});return e.length>0?e.map(a):u(t)}async function c(t){return d(t)}async function l(t){let e=new Date;return(await i._B.svmPromotion.findMany({where:{tenantId:t,isActive:!0,startsAt:{lte:e},OR:[{endsAt:null},{endsAt:{gt:e}}]}})).map(a).filter(t=>!t.usageLimit||t.usageCount<t.usageLimit)}async function m(t){return(await l(t)).filter(t=>"AUTOMATIC"===t.type||"FLASH_SALE"===t.type)}async function y(t,e){let r=await i._B.svmPromotion.findFirst({where:{tenantId:t,code:{equals:e,mode:"insensitive"},isActive:!0,startsAt:{lte:new Date},OR:[{endsAt:null},{endsAt:{gt:new Date}}]}});if(!r)return null;let n=a(r);return n.usageLimit&&n.usageCount>=n.usageLimit?null:n}async function p(t,e){let r=await i._B.svmPromotion.findFirst({where:{id:e,tenantId:t}});return r?a(r):null}async function I(t){await i._B.svmPromotion.create({data:{id:t.id,tenantId:t.tenantId,name:t.name,description:t.description,code:t.code,type:t.type,discountType:t.discountType,discountValue:t.discountValue,maxDiscount:t.maxDiscount,minOrderTotal:t.minOrderTotal,minQuantity:t.minQuantity,productIds:t.productIds,categoryIds:t.categoryIds,excludeProductIds:t.excludeProductIds,customerIds:t.customerIds,firstOrderOnly:t.firstOrderOnly,usageLimit:t.usageLimit,usageCount:t.usageCount,perCustomerLimit:t.perCustomerLimit,buyQuantity:t.buyQuantity,getQuantity:t.getQuantity,getDiscountPercent:t.getDiscountPercent,startsAt:t.startsAt,endsAt:t.endsAt,isActive:t.isActive,stackable:t.stackable,priority:t.priority}})}async function g(t,e,r){return await i._B.svmPromotion.findFirst({where:{id:e,tenantId:t}})?a(await i._B.svmPromotion.update({where:{id:e},data:{name:r.name,description:r.description,discountValue:r.discountValue,maxDiscount:r.maxDiscount,minOrderTotal:r.minOrderTotal,minQuantity:r.minQuantity,productIds:r.productIds,categoryIds:r.categoryIds,excludeProductIds:r.excludeProductIds,customerIds:r.customerIds,firstOrderOnly:r.firstOrderOnly,usageLimit:r.usageLimit,perCustomerLimit:r.perCustomerLimit,buyQuantity:r.buyQuantity,getQuantity:r.getQuantity,getDiscountPercent:r.getDiscountPercent,startsAt:r.startsAt,endsAt:r.endsAt,isActive:r.isActive,stackable:r.stackable,priority:r.priority}})):null}async function f(t,e){let r=await i._B.svmPromotion.findFirst({where:{id:e,tenantId:t}});return r?(await i._B.svmPromotion.delete({where:{id:e}}),a(r)):null}async function A(t,e){return e?await i._B.svmPromotionUsage.count({where:{promotionId:t,customerId:e}}):0}async function T(t,e,r,i,n,o=[]){let s=new Date;if(!t.isActive)return{valid:!1,error:"This promotion is no longer active",errorCode:"INACTIVE"};if(t.startsAt>s)return{valid:!1,error:"This promotion has not started yet",errorCode:"NOT_STARTED"};if(t.endsAt&&t.endsAt<s)return{valid:!1,error:"This promotion has expired",errorCode:"EXPIRED"};if(t.usageLimit&&t.usageCount>=t.usageLimit)return{valid:!1,error:"This promotion has reached its usage limit",errorCode:"USAGE_LIMIT_REACHED"};let a=await A(t.id,i);return t.perCustomerLimit&&a>=t.perCustomerLimit?{valid:!1,error:"You have already used this promotion the maximum number of times",errorCode:"CUSTOMER_LIMIT_REACHED"}:t.customerIds.length>0&&i&&!t.customerIds.includes(i)?{valid:!1,error:"This promotion is not available for your account",errorCode:"CUSTOMER_NOT_ELIGIBLE"}:t.firstOrderOnly&&!n?{valid:!1,error:"This promotion is only valid for first-time orders",errorCode:"FIRST_ORDER_ONLY"}:t.minOrderTotal&&e<t.minOrderTotal?{valid:!1,error:`Minimum order total of $${t.minOrderTotal.toFixed(2)} required`,errorCode:"MIN_ORDER_NOT_MET"}:t.minQuantity&&r<t.minQuantity?{valid:!1,error:`Minimum of ${t.minQuantity} items required`,errorCode:"MIN_QUANTITY_NOT_MET"}:!t.stackable&&o.length>0?{valid:!1,error:"This promotion cannot be combined with other discounts",errorCode:"NOT_STACKABLE"}:o.some(e=>e.promotionId===t.id)?{valid:!1,error:"This promotion is already applied",errorCode:"ALREADY_APPLIED"}:{valid:!0}}function O(t,e){return e.filter(e=>!t.excludeProductIds.includes(e.productId)&&!!(0===t.productIds.length&&0===t.categoryIds.length||t.productIds.length>0&&t.productIds.includes(e.productId)||t.categoryIds.length>0&&e.categoryId&&t.categoryIds.includes(e.categoryId)))}function h(t,e,r,i){let o;let s=O(t,e),a=new n.Z(0),u=!1,d=[],c="";switch(t.discountType){case"PERCENTAGE":{let r=s.reduce((t,e)=>t+e.unitPrice*e.quantity,0),i=new n.Z(r).times(t.discountValue).dividedBy(100);o=i.toDecimalPlaces(2).toNumber(),a=t.maxDiscount&&i.greaterThan(t.maxDiscount)?new n.Z(t.maxDiscount):i,d=s.map(t=>t.productId),c=`${t.discountValue}% off${d.length<e.length?" eligible items":""}`;break}case"FIXED_AMOUNT":(a=new n.Z(t.discountValue)).greaterThan(r)&&(a=new n.Z(r)),c=`$${t.discountValue.toFixed(2)} off your order`;break;case"FIXED_PER_ITEM":{let e=s.reduce((t,e)=>t+e.quantity,0);a=new n.Z(t.discountValue).times(e);let r=s.reduce((t,e)=>t+e.unitPrice*e.quantity,0);a.greaterThan(r)&&(a=new n.Z(r)),d=s.map(t=>t.productId),c=`$${t.discountValue.toFixed(2)} off each eligible item`;break}case"FREE_SHIPPING":u=!0,c="Free shipping";break;case"BUY_X_GET_Y":{if(!t.buyQuantity||!t.getQuantity)return null;let e=[...s].sort((t,e)=>e.unitPrice-t.unitPrice),r=Math.floor(e.reduce((t,e)=>t+e.quantity,0)/(t.buyQuantity+t.getQuantity));if(0===r)return null;let i=t.getDiscountPercent||100,o=0,u=new n.Z(0);for(let s of[...e].reverse()){let e=Math.min(s.quantity,r*t.getQuantity-o);if(e>0){let t=new n.Z(s.unitPrice).times(e).times(i).dividedBy(100);u=u.plus(t),o+=e}if(o>=r*t.getQuantity)break}a=u,d=s.map(t=>t.productId);let l=100===i?"free":`${i}% off`;c=`Buy ${t.buyQuantity} get ${t.getQuantity} ${l}`}}let l=a.toDecimalPlaces(2).toNumber();return 0!==l||u?{promotionId:t.id,promotionName:t.name,code:t.code,discountType:t.discountType,discountAmount:l,originalAmount:o,cappedAmount:o&&o>l?l:void 0,affectedItems:d.length>0?d:void 0,freeShipping:u,message:c}:null}}};