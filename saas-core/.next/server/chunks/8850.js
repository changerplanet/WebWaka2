"use strict";exports.id=8850,exports.ids=[8850],exports.modules={95456:(e,t,r)=>{r.d(t,{CK:()=>o,bA:()=>s,j5:()=>w,kS:()=>c,q4:()=>f,y_:()=>l});var a=r(56238),n=r(38547),i=r(71615);function d(){return(0,n.Z)()+"-"+(0,n.Z)()}async function s(e,t){let r=e.toLowerCase().trim(),i=await a._B.user.findUnique({where:{email:r}});i||(i=await a._B.user.create({data:{id:(0,n.Z)(),email:r,globalRole:"USER"}}));let s=d(),o=new Date;return o.setMinutes(o.getMinutes()+15),await a._B.magicLink.create({data:{id:(0,n.Z)(),token:s,userId:i.id,tenantId:t||null,expiresAt:o}}),{token:s,user:i}}async function o(e){let t=await a._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await a._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await a._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await a._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let r=d(),i=new Date;i.setDate(i.getDate()+7);let s=await a._B.session.create({data:{id:(0,n.Z)(),userId:t.userId,token:r,activeTenant:t.tenantId,expiresAt:i}});return{user:await a._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:s.id,token:r},tenantId:t.tenantId}}async function u(e){let t=await a._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await a._B.session.delete({where:{id:t.id}}),null):(await a._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function l(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;return t?u(t):null}async function c(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;t&&await a._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function f(e,t){let r=await a._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!r)return!1;let n=r.user.memberships.some(e=>e.tenantId===t&&e.isActive),i="SUPER_ADMIN"===r.user.globalRole;return(!!n||!!i)&&(await a._B.session.update({where:{id:r.id},data:{activeTenant:t}}),!0)}function w(e){return"SUPER_ADMIN"===e.globalRole}},58850:(e,t,r)=>{r.d(t,{Bd:()=>d,H4:()=>f,_w:()=>u,bl:()=>l,cS:()=>i,xQ:()=>c});var a=r(56238),n=r(95456);async function i(e){return!!await a._B.partnerReferral.findUnique({where:{tenantId:e}})}async function d(e){let t=await a._B.partnerReferral.findUnique({where:{tenantId:e},select:{attributionLocked:!0}});return t?.attributionLocked??!1}async function s(e){if(!await a._B.tenant.findUnique({where:{id:e.tenantId},select:{id:!0,status:!0}}))return{valid:!1,error:"Tenant not found",code:"NOT_FOUND"};if(await i(e.tenantId))return{valid:!1,error:"Tenant already has attribution. Attribution is immutable.",code:"ALREADY_ATTRIBUTED"};let t=await a._B.partner.findUnique({where:{id:e.partnerId},select:{id:!0,status:!0}});if(!t)return{valid:!1,error:"Partner not found",code:"NOT_FOUND"};if("ACTIVE"!==t.status)return{valid:!1,error:"Partner is not active. Only active partners can receive attribution.",code:"PARTNER_INACTIVE"};if(e.referralCodeId){let t=await a._B.partnerReferralCode.findUnique({where:{id:e.referralCodeId},select:{partnerId:!0,isActive:!0,usageLimit:!0,usageCount:!0,expiresAt:!0}});if(!t)return{valid:!1,error:"Referral code not found",code:"INVALID_CODE"};if(t.partnerId!==e.partnerId)return{valid:!1,error:"Referral code does not belong to this partner",code:"INVALID_CODE"};if(!t.isActive)return{valid:!1,error:"Referral code is inactive",code:"INVALID_CODE"};if(t.usageLimit&&t.usageCount>=t.usageLimit)return{valid:!1,error:"Referral code has reached usage limit",code:"INVALID_CODE"};if(t.expiresAt&&t.expiresAt<new Date)return{valid:!1,error:"Referral code has expired",code:"INVALID_CODE"}}return{valid:!0}}async function o(e){let t=await (0,n.y_)(),r=await s(e);if(!r.valid)return{success:!1,error:r.error,code:r.code};let i=null;return e.attributionWindowDays&&(i=new Date).setDate(i.getDate()+e.attributionWindowDays),{success:!0,referral:await a._B.$transaction(async r=>{let a=await r.partnerReferral.create({data:{partnerId:e.partnerId,tenantId:e.tenantId,referralCodeId:e.referralCodeId,attributionMethod:e.method,attributionWindowDays:e.attributionWindowDays,attributionExpiresAt:i,referralSource:e.referralSource,landingPage:e.landingPage,metadata:e.metadata??void 0,createdByUserId:t?.user?.id,attributionLocked:!1}});return e.referralCodeId&&await r.partnerReferralCode.update({where:{id:e.referralCodeId},data:{usageCount:{increment:1}}}),await r.auditLog.create({data:{action:"ATTRIBUTION_CREATED",actorId:t?.user?.id||"system",actorEmail:t?.user?.email||"system@saascore.internal",tenantId:e.tenantId,targetType:"PartnerReferral",targetId:a.id,metadata:{partnerId:e.partnerId,method:e.method,referralCodeId:e.referralCodeId,attributionWindowDays:e.attributionWindowDays,isLifetime:!e.attributionWindowDays}}}),a})}}async function u(e,t,r){let n=await a._B.partnerReferralCode.findUnique({where:{code:t},select:{id:!0,partnerId:!0,partner:{select:{agreements:{where:{status:"ACTIVE"},select:{commissionType:!0}}}}}});return n?o({tenantId:e,partnerId:n.partnerId,method:"REFERRAL_LINK",referralCodeId:n.id,referralSource:r?.referralSource,landingPage:r?.landingPage,metadata:r?.metadata}):{success:!1,error:"Invalid referral code",code:"INVALID_CODE"}}async function l(e){let t=await (0,n.y_)(),r=await a._B.partnerReferral.findUnique({where:{tenantId:e}});return r?r.attributionLocked?{success:!0,referral:r}:{success:!0,referral:await a._B.$transaction(async r=>{let a=await r.partnerReferral.update({where:{tenantId:e},data:{attributionLocked:!0,lockedAt:new Date}});return await r.auditLog.create({data:{action:"ATTRIBUTION_LOCKED",actorId:t?.user?.id||"billing-system",actorEmail:t?.user?.email||"billing@saascore.internal",tenantId:e,targetType:"PartnerReferral",targetId:a.id,metadata:{partnerId:a.partnerId,lockedAt:a.lockedAt}}}),a})}:{success:!1,error:"Attribution not found",code:"NOT_FOUND"}}async function c(e){return a._B.partnerReferral.findUnique({where:{tenantId:e},include:{partner:{select:{id:!0,name:!0,slug:!0,status:!0}},referralCode:{select:{id:!0,code:!0,campaignName:!0}}}})}let f={IMMUTABLE:!0,LOCKS_AFTER_BILLING:!0,NO_REASSIGNMENT:!0,DEFAULT_WINDOW_DAYS:null,METHODS:["PARTNER_CREATED","REFERRAL_LINK","MANUAL_ASSIGNMENT"]}},56238:(e,t,r)=>{r.d(t,{xW:()=>u,eE:()=>o,KS:()=>c,qk:()=>s,_B:()=>w,G0:()=>l,ah:()=>f});var a=r(53524);let n=["TenantMembership","TenantDomain","AuditLog"],i=[];function d(e){let t={...e,timestamp:new Date};i.push(t),i.length>1e3&&i.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function s(){return[...i]}function o(){i.length=0}class u extends Error{constructor(e,t,r,a){super(e),this.model=t,this.action=r,this.context=a,this.name="TenantIsolationError"}}function l(e,t,r,a){if(n.includes(e)){if(r?.bypassIsolation===!0){if(!r.isSuperAdmin){let n="Bypass isolation attempted without SUPER_ADMIN role";throw d({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new u(n,e,t,r)}return}if(!r?.isSuperAdmin){if(!r){let n="No tenant context provided for tenant-scoped query";throw d({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new u(n,e,t,r)}if(!r.tenantId){let n="No tenantId in context for tenant-scoped query";throw d({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new u(n,e,t,r)}if(a&&a!==r.tenantId){let n=`Cross-tenant access attempt: query tenantId (${a}) != context tenantId (${r.tenantId})`;throw d({model:e,action:t,context:r,query:{queryTenantId:a},reason:n}),new u(n,e,t,r)}}}}function c(e,t,r,a=!1){return{tenantId:e,userId:t,isSuperAdmin:r,bypassIsolation:a}}function f(e,t){return{...e,tenantId:t}}let w=globalThis.prisma??new a.PrismaClient({log:["error"]})}};