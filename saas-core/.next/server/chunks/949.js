"use strict";exports.id=949,exports.ids=[949],exports.modules={7662:(e,t,n)=>{n.d(t,{F:()=>s,U:()=>o});var r=n(6238),a=n(8547),i=n(1615);async function o(e){try{let t=await (0,i.headers)(),n=t.get("x-forwarded-for")||t.get("x-real-ip")||"unknown",o=t.get("user-agent")||"unknown";await r._B.auditLog.create({data:{id:(0,a.Z)(),action:e.action,actorId:e.actorId,actorEmail:e.actorEmail,tenantId:e.tenantId||null,targetType:e.targetType||null,targetId:e.targetId||null,metadata:e.metadata||void 0,ipAddress:n,userAgent:o}})}catch(e){console.error("Failed to create audit log:",e)}}async function s(e){let{tenantId:t,actorId:n,action:a,targetType:i,limit:o=50,offset:s=0}=e,u={};t&&(u.tenantId=t),n&&(u.actorId=n),a&&(u.action=a),i&&(u.targetType=i);let[d,c]=await Promise.all([r._B.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:o,skip:s}),r._B.auditLog.count({where:u})]);return{logs:d,total:c}}},5456:(e,t,n)=>{n.d(t,{CK:()=>u,bA:()=>s,j5:()=>w,kS:()=>l,q4:()=>f,y_:()=>c});var r=n(6238),a=n(8547),i=n(1615);function o(){return(0,a.Z)()+"-"+(0,a.Z)()}async function s(e,t){let n=e.toLowerCase().trim(),i=await r._B.user.findUnique({where:{email:n}});i||(i=await r._B.user.create({data:{id:(0,a.Z)(),email:n,globalRole:"USER"}}));let s=o(),u=new Date;return u.setMinutes(u.getMinutes()+15),await r._B.magicLink.create({data:{id:(0,a.Z)(),token:s,userId:i.id,tenantId:t||null,expiresAt:u}}),{token:s,user:i}}async function u(e){let t=await r._B.magicLink.findUnique({where:{token:e},include:{user:!0}});if(!t)return null;if(t.expiresAt<new Date)return await r._B.magicLink.delete({where:{id:t.id}}),null;if(t.usedAt)return null;await r._B.magicLink.update({where:{id:t.id},data:{usedAt:new Date}}),await r._B.user.update({where:{id:t.userId},data:{lastLoginAt:new Date}});let n=o(),i=new Date;i.setDate(i.getDate()+7);let s=await r._B.session.create({data:{id:(0,a.Z)(),userId:t.userId,token:n,activeTenant:t.tenantId,expiresAt:i}});return{user:await r._B.user.findUnique({where:{id:t.userId},include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}),session:{id:s.id,token:n},tenantId:t.tenantId}}async function d(e){let t=await r._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:{where:{isActive:!0},include:{tenant:!0}}}}}});return t?t.expiresAt<new Date?(await r._B.session.delete({where:{id:t.id}}),null):(await r._B.session.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{user:t.user,sessionId:t.id,activeTenantId:t.activeTenant}):null}async function c(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;return t?d(t):null}async function l(){let e=await (0,i.cookies)(),t=e.get("session_token")?.value;t&&await r._B.session.deleteMany({where:{token:t}}),e.delete("session_token")}async function f(e,t){let n=await r._B.session.findUnique({where:{token:e},include:{user:{include:{memberships:!0}}}});if(!n)return!1;let a=n.user.memberships.some(e=>e.tenantId===t&&e.isActive),i="SUPER_ADMIN"===n.user.globalRole;return(!!a||!!i)&&(await r._B.session.update({where:{id:n.id},data:{activeTenant:t}}),!0)}function w(e){return"SUPER_ADMIN"===e.globalRole}},340:(e,t,n)=>{n.d(t,{nc:()=>u,s3:()=>o});var r=n(5456),a=n(6238);async function i(){let e=await (0,r.y_)();return e?e.user.isActive?{authorized:!0,user:e.user,session:e}:{authorized:!1,error:"Account is disabled",status:403}:{authorized:!1,error:"Authentication required",status:401}}async function o(){let e=await i();return e.authorized&&"SUPER_ADMIN"!==e.user.globalRole?{authorized:!1,error:"Super Admin access required",status:403}:e}async function s(e){let t=await i();if(!t.authorized)return t;if("SUPER_ADMIN"===t.user.globalRole)return{...t,role:"TENANT_ADMIN",tenantId:e};let n=t.session.user.memberships.find(t=>t.tenantId===e&&t.isActive);return n?"TENANT_ADMIN"!==n.role?{authorized:!1,error:"Tenant Admin access required",status:403}:{...t,role:n.role,tenantId:e}:{authorized:!1,error:"Not a member of this tenant",status:403}}async function u(e){let t=await a._B.tenant.findUnique({where:{slug:e},include:{domains:!0}});if(!t)return{authorized:!1,error:"Tenant not found",status:404};let n=await s(t.id);return n.authorized?{...n,tenant:t}:n}},4245:(e,t,n)=>{n.d(t,{F2:()=>u,bz:()=>d,qq:()=>o});var r=n(6238),a=n(4932),i=n.n(a);function o(e,t){return{domain:e,method:"TXT",recordName:`_saascore-verify.${e}`,recordValue:t,status:"PENDING",instructions:`Add a TXT record to your DNS with:

Name: _saascore-verify
Value: ${t}

Note: DNS changes may take up to 48 hours to propagate.`}}async function s(e,t){try{let n=`_saascore-verify.${e}`,r=(await i().resolveTxt(n).catch(()=>[])).map(e=>e.join(""));if(console.log(`[Domain Verification] Checking ${n}:`,r),r.some(e=>e===t))return{verified:!0,records:r};return{verified:!1,error:r.length>0?"TXT record found but value does not match":"No TXT record found",records:r}}catch(t){if(console.error(`[Domain Verification] Error for ${e}:`,t.message),"ENOTFOUND"===t.code||"ENODATA"===t.code)return{verified:!1,error:"DNS record not found. Please ensure you have added the TXT record and wait for DNS propagation."};return{verified:!1,error:`DNS lookup failed: ${t.message}`}}}async function u(e){let t=await r._B.tenantDomain.findUnique({where:{id:e}});if(!t)return{success:!1,error:"Domain not found"};if("SUBDOMAIN"===t.type)return{success:!1,error:"Subdomains do not require verification"};if("VERIFIED"===t.status)return{success:!0,domain:t};if(!t.verificationToken)return{success:!1,error:"No verification token found"};let n=await s(t.domain,t.verificationToken);return n.verified?{success:!0,domain:await r._B.tenantDomain.update({where:{id:e},data:{status:"VERIFIED",verifiedAt:new Date}})}:{success:!1,error:n.error}}async function d(e){return!await r._B.tenantDomain.findUnique({where:{domain:e.toLowerCase()}})}},6238:(e,t,n)=>{n.d(t,{xW:()=>d,eE:()=>u,KS:()=>l,qk:()=>s,_B:()=>w,G0:()=>c,ah:()=>f});var r=n(3524);let a=["TenantMembership","TenantDomain","AuditLog"],i=[];function o(e){let t={...e,timestamp:new Date};i.push(t),i.length>1e3&&i.shift(),console.error("[TENANT ISOLATION VIOLATION]",JSON.stringify(t,null,2))}function s(){return[...i]}function u(){i.length=0}class d extends Error{constructor(e,t,n,r){super(e),this.model=t,this.action=n,this.context=r,this.name="TenantIsolationError"}}function c(e,t,n,r){if(a.includes(e)){if(n?.bypassIsolation===!0){if(!n.isSuperAdmin){let a="Bypass isolation attempted without SUPER_ADMIN role";throw o({model:e,action:t,context:n,query:{queryTenantId:r},reason:a}),new d(a,e,t,n)}return}if(!n?.isSuperAdmin){if(!n){let a="No tenant context provided for tenant-scoped query";throw o({model:e,action:t,context:n,query:{queryTenantId:r},reason:a}),new d(a,e,t,n)}if(!n.tenantId){let a="No tenantId in context for tenant-scoped query";throw o({model:e,action:t,context:n,query:{queryTenantId:r},reason:a}),new d(a,e,t,n)}if(r&&r!==n.tenantId){let a=`Cross-tenant access attempt: query tenantId (${r}) != context tenantId (${n.tenantId})`;throw o({model:e,action:t,context:n,query:{queryTenantId:r},reason:a}),new d(a,e,t,n)}}}}function l(e,t,n,r=!1){return{tenantId:e,userId:t,isSuperAdmin:n,bypassIsolation:r}}function f(e,t){return{...e,tenantId:t}}let w=globalThis.prisma??new r.PrismaClient({log:["error"]})}};