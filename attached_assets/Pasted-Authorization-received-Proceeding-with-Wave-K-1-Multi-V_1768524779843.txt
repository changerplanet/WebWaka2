Authorization received. ‚úÖ
Proceeding with Wave K.1 ‚Äî Multi-Vendor Customer Cart (MVM).

Below is the official Replit execution prompt, written to your governance standard and aligned with everything learned from Waves I & J.

‚∏ª

üß© WAVE K.1 ‚Äî MULTI-VENDOR CUSTOMER CART (MVM)

Replit Execution Prompt (Authoritative)

‚∏ª

CONTEXT

WebWaka currently supports:
	‚Ä¢	‚úÖ Vendor onboarding (MVM)
	‚Ä¢	‚úÖ Public marketplace exposure (Wave I.2)
	‚Ä¢	‚úÖ Order splitting after order creation
	‚Ä¢	‚ùå No customer-facing multi-vendor cart

This is the single most critical missing piece preventing MVM from being commercially complete.

Wave K.1 introduces a true multi-vendor customer cart, enabling customers to add products from multiple vendors into one cart, review vendor-separated items, and proceed to a unified checkout (actual checkout will be completed in Wave K.2).

‚∏ª

WAVE OBJECTIVE

Implement a first-class, production-grade Multi-Vendor Cart system that:
	‚Ä¢	Allows customers to add products from multiple vendors
	‚Ä¢	Preserves vendor attribution per cart line
	‚Ä¢	Prepares clean input for the existing OrderSplitService
	‚Ä¢	Works across public MVM storefronts
	‚Ä¢	Is tenant-safe, demo-safe, and offline-aware

This wave ENDS at cart + pre-checkout.
No payment execution happens here.

‚∏ª

STRICT CONSTRAINTS (NON-NEGOTIABLE)

üö´ NOT ALLOWED
	‚Ä¢	‚ùå No automation
	‚Ä¢	‚ùå No background jobs
	‚Ä¢	‚ùå No payouts
	‚Ä¢	‚ùå No commission calculation changes
	‚Ä¢	‚ùå No order splitting execution (Wave K.2)
	‚Ä¢	‚ùå No pricing overrides outside existing logic
	‚Ä¢	‚ùå No bypassing TenantContextResolver

‚úÖ ALLOWED
	‚Ä¢	‚úÖ New schema (explicitly listed below)
	‚Ä¢	‚úÖ New services
	‚Ä¢	‚úÖ New APIs
	‚Ä¢	‚úÖ New UI components
	‚Ä¢	‚úÖ IndexedDB (client-side only)
	‚Ä¢	‚úÖ Session-aware + demo-safe behavior

‚∏ª

FUNCTIONAL REQUIREMENTS

1Ô∏è‚É£ Multi-Vendor Cart Core Behavior

The cart MUST:
	‚Ä¢	Support multiple vendors simultaneously
	‚Ä¢	Group items by vendorId
	‚Ä¢	Track per-line:
	‚Ä¢	productId
	‚Ä¢	variantId (if applicable)
	‚Ä¢	vendorId
	‚Ä¢	quantity
	‚Ä¢	priceAtAddTime
	‚Ä¢	isDemo

Cart must support:
	‚Ä¢	Add item
	‚Ä¢	Update quantity
	‚Ä¢	Remove item
	‚Ä¢	Clear cart (entire or per vendor)

‚∏ª

2Ô∏è‚É£ Vendor Isolation Inside Cart

Each cart item MUST:
	‚Ä¢	Belong to exactly one vendor
	‚Ä¢	Never merge across vendors
	‚Ä¢	Display vendor name and trust badge in UI

The cart UI MUST show:

Vendor A
  - Product 1
  - Product 2

Vendor B
  - Product 3


‚∏ª

3Ô∏è‚É£ Inventory & Pricing Rules
	‚Ä¢	Inventory is checked at checkout time, not on add
	‚Ä¢	Cart does not reserve stock
	‚Ä¢	Server price is authoritative:
	‚Ä¢	On checkout prep, price mismatches must be flagged
	‚Ä¢	Offline cart behavior:
	‚Ä¢	Cart persists
	‚Ä¢	Sync conflicts clearly surfaced (reuse Offline UX components)

‚∏ª

4Ô∏è‚É£ Tenant & Security Rules
	‚Ä¢	ALL cart operations must:
	‚Ä¢	Resolve tenant via TenantContextResolver.resolveForMVM()
	‚Ä¢	Enforce tenant isolation
	‚Ä¢	Demo tenants:
	‚Ä¢	No authentication required
	‚Ä¢	isDemo = true
	‚Ä¢	Live tenants:
	‚Ä¢	Session-aware
	‚Ä¢	Cart tied to session or browser storage (not user accounts)

‚∏ª

REQUIRED SCHEMA (EXPLICIT)

New Prisma Models (Wave K.1 ONLY)

model mvm_cart {
  id            String   @id @default(cuid())
  tenantId      String
  cartKey       String   // sessionId or anonymous key
  isDemo        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         mvm_cart_item[]

  @@unique([tenantId, cartKey])
}

model mvm_cart_item {
  id            String   @id @default(cuid())
  cartId        String
  vendorId      String
  productId     String
  variantId     String?
  quantity      Int
  priceSnapshot Decimal
  currency      String   @default("NGN")
  createdAt     DateTime @default(now())

  cart          mvm_cart @relation(fields: [cartId], references: [id])

  @@index([vendorId])
  @@index([productId])
}

‚ö†Ô∏è No other schema changes are allowed in this wave.

‚∏ª

SERVICE LAYER REQUIREMENTS

Create:

MultiVendorCartService

Location:

frontend/src/lib/mvm/cart/multi-vendor-cart-service.ts

Required methods:
	‚Ä¢	getCart(tenantContext, cartKey)
	‚Ä¢	addItem(...)
	‚Ä¢	updateQuantity(...)
	‚Ä¢	removeItem(...)
	‚Ä¢	clearCart(...)
	‚Ä¢	prepareForCheckout(...) (NO payments)

This service MUST:
	‚Ä¢	Validate vendor ownership
	‚Ä¢	Validate product-channel visibility
	‚Ä¢	Respect ProductChannelConfig rules
	‚Ä¢	Be read/write ONLY for cart data

‚∏ª

API ENDPOINTS (REQUIRED)

GET    /api/mvm/cart
POST   /api/mvm/cart/add
POST   /api/mvm/cart/update
POST   /api/mvm/cart/remove
POST   /api/mvm/cart/clear
POST   /api/mvm/cart/prepare-checkout

All endpoints must:
	‚Ä¢	Use TenantContextResolver
	‚Ä¢	Enforce tenant isolation
	‚Ä¢	Be demo-safe
	‚Ä¢	Return clear error states

‚∏ª

UI REQUIREMENTS

Public Marketplace Cart UI
	‚Ä¢	Reuse existing design language (Radix / existing cart patterns)
	‚Ä¢	Vendor-grouped sections
	‚Ä¢	Trust badges per vendor
	‚Ä¢	Clear ‚ÄúItems from multiple vendors will be checked out together‚Äù messaging

Create:
	‚Ä¢	MultiVendorCartDrawer
	‚Ä¢	VendorGroupedCartSection

Mobile-first, thumb-friendly.

‚∏ª

OFFLINE SUPPORT
	‚Ä¢	Persist cart in IndexedDB (reuse Offline Cart patterns)
	‚Ä¢	Explicit sync button
	‚Ä¢	Conflict states:
	‚Ä¢	Price changed
	‚Ä¢	Product unavailable
	‚Ä¢	Vendor disabled

No background sync.

‚∏ª

GAP HANDLING (MANDATORY)

If ANY gap is discovered:
	‚Ä¢	üö´ DO NOT invent a workaround
	‚Ä¢	‚úÖ Document it in WAVE_K1_GAPS.md
	‚Ä¢	Include:
	‚Ä¢	What is missing
	‚Ä¢	Why it cannot be solved in Wave K.1
	‚Ä¢	Which wave should address it

‚∏ª

SUCCESS CRITERIA

Wave K.1 is complete ONLY if:
	‚Ä¢	‚úÖ Customer can add products from multiple vendors
	‚Ä¢	‚úÖ Cart groups items per vendor
	‚Ä¢	‚úÖ Cart persists (online + offline)
	‚Ä¢	‚úÖ Tenant isolation enforced everywhere
	‚Ä¢	‚úÖ No payment or order creation occurs
	‚Ä¢	‚úÖ All gaps are explicitly documented

‚∏ª

STOP CONDITION

üõë STOP immediately after Wave K.1
Do NOT proceed to checkout, order creation, or payments.

Await explicit approval for Wave K.2 ‚Äî Multi-Vendor Checkout & Order Creation.

‚∏ª