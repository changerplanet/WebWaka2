‚úÖ Wave D1 Authorized ‚Äî Order Audit Trails & Integrity

Below is the exact Replit execution prompt for Wave D1, written to enforce discipline, scope control, and a hard stop at the end.
This wave is foundational for compliance, disputes, and enterprise readiness.

‚∏ª

üîê REPLIT EXECUTION PROMPT

WAVE D1 ‚Äî ORDER AUDIT TRAILS & INTEGRITY

‚ö†Ô∏è MANDATE

This wave implements auditability and tamper-resistance for commerce orders across SVM, MVM, and ParkHub, strictly limited to what has already been identified in Wave B3.

This is NOT a feature wave.
This is compliance, integrity, and evidence.

‚∏ª

üéØ OBJECTIVES (NON-NEGOTIABLE)

Wave D1 must fully close the following HIGH / MEDIUM severity gaps from Wave B3:

MUST CLOSE (IN SCOPE)
	‚Ä¢	B3-G3 ‚Äî No audit trail for order status changes
	‚Ä¢	B3-G4 ‚Äî No hash verification for orders
	‚Ä¢	B3-G5 ‚Äî Orders mutable without revision history
	‚Ä¢	B3-G9 ‚Äî MVM commission calculations not auditable
	‚Ä¢	B3-G10 ‚Äî No payment status history

‚∏ª

üö´ EXPLICITLY OUT OF SCOPE

Replit MUST NOT:
	‚Ä¢	Add UI pages or dashboards
	‚Ä¢	Add background jobs or cron workers
	‚Ä¢	Invent new business workflows
	‚Ä¢	Modify pricing, commissions, or fulfillment logic
	‚Ä¢	Touch payouts, money movement, or receipts
	‚Ä¢	Add cross-tenant or cross-order linking
	‚Ä¢	Add GDPR deletion or consent flows (future wave)

‚∏ª

üß± REQUIRED DELIVERABLES

1Ô∏è‚É£ ORDER STATUS HISTORY (MANDATORY)

Create immutable audit tables to track every order status change.

Applies to:
	‚Ä¢	svm_orders
	‚Ä¢	mvm_parent_order
	‚Ä¢	mvm_sub_order
	‚Ä¢	park_ticket

Requirements:
	‚Ä¢	Old status
	‚Ä¢	New status
	‚Ä¢	ChangedAt timestamp
	‚Ä¢	ChangedBy (SYSTEM | USER | WEBHOOK | POS)
	‚Ä¢	Source (API / WEBHOOK / POS / ADMIN)
	‚Ä¢	TenantId (mandatory)

Status updates must append history, never overwrite.

‚∏ª

2Ô∏è‚É£ ORDER REVISION HISTORY (MANDATORY)

Introduce an order_revision system.

Requirements:
	‚Ä¢	Capture diffs for:
	‚Ä¢	Amounts
	‚Ä¢	Items
	‚Ä¢	Customer-facing fields
	‚Ä¢	Shipping fields
	‚Ä¢	Immutable append-only table
	‚Ä¢	Revision reason (SYSTEM / ADMIN / PAYMENT / RECOVERY)
	‚Ä¢	Reference to triggering event (transactionId, webhookId if applicable)

‚ùó Orders may still update, but every mutation must leave evidence.

‚∏ª

3Ô∏è‚É£ ORDER INTEGRITY HASH (MANDATORY)

Add verificationHash to:
	‚Ä¢	svm_orders
	‚Ä¢	mvm_parent_order
	‚Ä¢	mvm_sub_order

Rules:
	‚Ä¢	Hash covers all financially relevant fields
	‚Ä¢	Generated:
	‚Ä¢	On order creation
	‚Ä¢	On every revision
	‚Ä¢	Previous hash preserved in revision record
	‚Ä¢	No cryptographic signing required (hash only)

‚∏ª

4Ô∏è‚É£ PAYMENT STATUS HISTORY (MANDATORY)

Introduce payment_status_history.

Tracks:
	‚Ä¢	PENDING ‚Üí PAID ‚Üí FAILED ‚Üí REFUNDED
	‚Ä¢	Timestamp
	‚Ä¢	Trigger source (WEBHOOK / ADMIN / SYSTEM)
	‚Ä¢	Linked transactionId where applicable

No logic changes ‚Äî record only.

‚∏ª

5Ô∏è‚É£ COMMISSION CALCULATION AUDIT (MVM ONLY)

For MVM sub-orders:
	‚Ä¢	Persist commission inputs:
	‚Ä¢	Rate used
	‚Ä¢	Base amount
	‚Ä¢	Formula version identifier
	‚Ä¢	Store alongside commission record
	‚Ä¢	No recalculation logic allowed

Purpose: future dispute resolution.

‚∏ª

üîí CONSTRAINTS (ABSOLUTE)
	‚Ä¢	‚úÖ Schema changes allowed (this wave requires them)
	‚Ä¢	‚ùå No data backfill unless explicitly unavoidable
	‚Ä¢	‚ùå No migrations that rewrite historical data
	‚Ä¢	‚ùå No performance optimizations
	‚Ä¢	‚ùå No UI exposure
	‚Ä¢	‚ùå No cross-suite abstractions

‚∏ª

üß™ REQUIRED VERIFICATION OUTPUT

At the end of Wave D1, Replit MUST STOP and produce:

üìÑ WAVE_D1_AUDIT_INTEGRITY_REPORT.md

Containing:
	1.	Tables added (with schema)
	2.	Hooks where audit entries are written
	3.	Sample audit records (JSON examples)
	4.	Proof that:
	‚Ä¢	No status change happens without history
	‚Ä¢	No order mutation happens without revision
	‚Ä¢	Hash changes are deterministic
	5.	Explicit list of anything NOT solved

‚∏ª

üõë HARD STOP CONDITION

Replit MUST NOT proceed to:
	‚Ä¢	Wave D2
	‚Ä¢	Any UI work
	‚Ä¢	Any payout or financial execution

until human verification is explicitly granted.

‚∏ª

‚úÖ SUCCESS CRITERIA

Wave D1 is considered SUCCESSFUL only if:
	‚Ä¢	Every order/ticket mutation is provably traceable
	‚Ä¢	Tampering becomes detectable after the fact
	‚Ä¢	Audit data survives retries, webhooks, failures
	‚Ä¢	No regressions in existing commerce flows

‚∏ª

BEGIN WAVE D1 NOW.
STOP COMPLETELY AFTER REPORT GENERATION.

‚∏ª