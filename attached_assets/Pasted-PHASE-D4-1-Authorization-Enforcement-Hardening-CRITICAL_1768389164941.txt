PHASE D4.1

Authorization Enforcement Hardening (CRITICAL)

⸻

PHASE NAME

Phase D4.1 — Authorization Enforcement Hardening

⸻

OBJECTIVE

Implement strict, centralized role-based and tenant-based authorization enforcement across the WebWaka platform to eliminate:
	•	Page-level unauthorized access
	•	Cross-tenant data leakage
	•	Role equivalence bugs (Owner = Staff = Tenant User)

This phase converts conceptual authorization into enforced authorization.

⸻

SCOPE (STRICT — DO NOT EXCEED)

✅ ALLOWED
	•	Add or modify middleware
	•	Add or modify layout guards
	•	Add role/tenant checks to existing routes
	•	Fix API tenant scoping bugs
	•	Add 403 / redirect behavior
	•	Add inline documentation comments explaining intent

❌ NOT ALLOWED
	•	❌ No feature development
	•	❌ No UI redesign
	•	❌ No schema changes
	•	❌ No seed data changes
	•	❌ No auth mechanism changes (magic link stays)
	•	❌ No business logic refactors beyond access control
	•	❌ No demo assumptions

⸻

ROLE DEFINITIONS (SOURCE OF TRUTH)

Platform Roles
	•	SUPER_ADMIN
	•	PARTNER_OWNER
	•	PARTNER_ADMIN
	•	PARTNER_SALES
	•	PARTNER_SUPPORT
	•	PARTNER_STAFF

Tenant Roles
	•	TENANT_ADMIN
	•	TENANT_USER
	•	END_USER

⸻

MANDATORY AUTHORIZATION RULES

1. Admin Access
	•	/admin/**
	•	✅ SUPER_ADMIN ONLY
	•	❌ Everyone else → 403 or redirect

⸻

2. Partner Portal
	•	/partner-portal/**
	•	✅ All PARTNER_* roles
	•	❌ All TENANT_* and END_USER

⸻

3. Partner Dashboard
	•	/dashboard/partner/**
	•	PARTNER_OWNER, PARTNER_ADMIN → full access
	•	PARTNER_SALES, PARTNER_SUPPORT → limited (view-only, no settings)
	•	PARTNER_STAFF → assigned tenants only
	•	❌ Tenant users

⸻

4. Tenant Dashboards
	•	/health/**, /education/**, /commerce/**, etc.
	•	TENANT_ADMIN → full tenant access
	•	TENANT_USER → operational pages only
	•	END_USER → self-data only
	•	❌ Partner roles unless explicitly impersonating (do not implement impersonation now)

⸻

API-LEVEL ENFORCEMENT (CRITICAL)

Fix /api/tenants
	•	Partner users → return only assigned tenants
	•	Tenant users → return only their tenant
	•	Never return all tenants to any non-SUPER_ADMIN user

Audit and fix ALL list APIs to ensure:

where: {
  tenantId: session.tenantId
}

or equivalent partner scoping.

⸻

IMPLEMENTATION REQUIREMENTS

1. Central Middleware
	•	Use Next.js middleware for coarse route blocking
	•	Route patterns:
	•	/admin
	•	/partner-portal
	•	/dashboard/partner
	•	/health, /education, etc.

2. Layout Guards
	•	Add role checks in:
	•	app/(admin)/layout.tsx
	•	app/(partner)/layout.tsx
	•	app/(tenant)/layout.tsx
	•	Fail closed (deny by default)

3. Page-Level Safety
	•	Pages must not render sensitive content if unauthorized
	•	Redirect or render 403 component

⸻

VERIFICATION STEPS (MANDATORY)

After implementation, explicitly test:

Partner Roles
	•	demo.owner@webwaka.com
	•	demo.staff@webwaka.com

Tenant Roles
	•	Tenant Admin (clinic admin)
	•	Tenant User (doctor)
	•	End User (patient)

Confirm:
	•	❌ No access to /admin except SUPER_ADMIN
	•	❌ No cross-tenant data from APIs
	•	❌ Tenant users cannot access partner routes
	•	❌ Partner staff cannot access partner settings

⸻

DELIVERABLES
	1.	Authorization Matrix
	•	Route → Allowed Roles → Enforcement Location
	2.	Fix Summary
	•	Files changed
	•	Guards added
	3.	Re-run Phase D4 table
	•	Updated PASS/FAIL with evidence

⸻

STOP CONDITIONS
	•	❌ Do NOT proceed to Phase D5
	•	❌ Do NOT seed data
	•	❌ Do NOT modify schemas
	•	❌ Do NOT deploy

STOP immediately after report is produced.

⸻

SUCCESS CRITERIA
	•	Unauthorized users receive 403 or redirect
	•	No route returns 200 unless explicitly allowed
	•	/api/tenants leak is fully resolved
	•	Role differentiation is observable in UX

⸻

BEGIN PHASE D4.1 NOW.