Authorization received.
Below is the exact Replit execution prompt for Wave B1-Fix â€” Commerce Integrity Remediation, written to enforce surgical scope, zero drift, and hard stop conditions.

â¸»

ðŸ”§ REPLIT EXECUTION PROMPT

WAVE B1-FIX â€” COMMERCE INTEGRITY REMEDIATION (P0 ONLY)

âš ï¸ ABSOLUTE CONTEXT (READ CAREFULLY)

You are executing Wave B1-Fix, which exists only to remediate two P0-critical commerce integrity failures identified in the Wave B1 READ-ONLY Commerce Integrity Analysis.

This is NOT a feature wave.
This is NOT a refactor wave.
This is NOT a UX wave.
This is NOT a payout-enablement wave.

This wave exists solely to make the platform safe for future money movement.

Any deviation = FAILURE.

â¸»

ðŸŽ¯ OBJECTIVE (NON-NEGOTIABLE)

Close ONLY the following two P0 blockers:

P0-1: MVM Inventoryâ€“Payment Timing Gap

Inventory must never be permanently deducted before confirmed payment.

P0-2: ParkHub Seat Selection Race Condition

Seats must never be double-bookable under concurrency.

â¸»

ðŸ§± SCOPE BOUNDARIES (STRICT)

âœ… YOU MAY:
	â€¢	Modify existing commerce logic
	â€¢	Add minimal supporting logic ONLY where required to close the two gaps
	â€¢	Add database constraints or fields ONLY if strictly necessary for integrity
	â€¢	Add inventory restoration paths tied to existing lifecycle events
	â€¢	Add locking / uniqueness enforcement for seat selection

âŒ YOU MUST NOT:
	â€¢	Add new features
	â€¢	Add new user-facing UI
	â€¢	Change checkout UX
	â€¢	Enable payouts
	â€¢	Introduce background jobs
	â€¢	Add cron workers
	â€¢	Add new APIs unrelated to the fixes
	â€¢	Refactor unrelated code
	â€¢	Touch commissions, refunds, wallets, or ledgers beyond necessity
	â€¢	â€œImproveâ€ things not explicitly listed below

â¸»

ðŸ› ï¸ REQUIRED FIXES (STEP-BY-STEP)

ðŸ”´ FIX 1 â€” MVM INVENTORYâ€“PAYMENT TIMING

Current Broken Behavior
	â€¢	Inventory is deducted before payment confirmation
	â€¢	Failed / abandoned payments permanently reduce inventory

REQUIRED REMEDIATION
Implement ONE of the following safe patterns (choose the least invasive):

Preferred (A):
	â€¢	Move final inventory deduction to the payment success webhook
	â€¢	Until payment success:
	â€¢	Inventory is validated, not deducted
	â€¢	On webhook success:
	â€¢	Deduct inventory atomically
	â€¢	On webhook failure / timeout:
	â€¢	No inventory change required

Acceptable (B) if A is not feasible:
	â€¢	Introduce reserved inventory
	â€¢	Reservation expires or is released on:
	â€¢	Payment failure
	â€¢	Order expiration
	â€¢	Reservation must NOT affect available inventory counts permanently

ALSO REQUIRED
	â€¢	Restore inventory when:
	â€¢	Order expires (EXPIRED)
	â€¢	Payment fails after initiation
	â€¢	Ensure idempotency:
	â€¢	Replayed webhooks MUST NOT double-deduct inventory

ðŸ“Œ Verification required:
Demonstrate (via code comments or tests) that:
	â€¢	Payment success â†’ inventory deducted once
	â€¢	Payment failure â†’ inventory unchanged
	â€¢	Order expiration â†’ inventory restored

â¸»

ðŸ”´ FIX 2 â€” PARKHUB SEAT SELECTION RACE CONDITION

Current Broken Behavior
	â€¢	Seat availability is checked
	â€¢	Seat is queued later
	â€¢	No atomic guarantee
	â€¢	Concurrent agents can select same seat

REQUIRED REMEDIATION
Implement at least ONE hard integrity guarantee:

Preferred (A):
	â€¢	Add database-level unique constraint on:

(tripId, seatNumber)

in the queue or ticket table

Acceptable (B):
	â€¢	Optimistic locking with conflict detection
	â€¢	On conflict:
	â€¢	Reject second selection
	â€¢	Force seat re-selection

ALSO REQUIRED
	â€¢	Ensure offline-first flow still works
	â€¢	Ensure sync conflict resolution does NOT create duplicate tickets

ðŸ“Œ Verification required:
Demonstrate that:
	â€¢	Two concurrent attempts for same seat â†’ only one succeeds
	â€¢	Second attempt fails safely with a clear conflict path

â¸»

ðŸ§ª VERIFICATION REQUIREMENTS (MANDATORY)

At the end of implementation, produce a Wave B1-Fix Verification Report containing:
	1.	Inventory Flow Proof
	â€¢	Before payment
	â€¢	After payment success
	â€¢	After payment failure
	â€¢	After order expiration
	2.	Seat Lock Proof
	â€¢	Where atomicity is enforced
	â€¢	Why double booking is now impossible
	3.	Idempotency Confirmation
	â€¢	Why retries/webhooks cannot cause duplication

â¸»

ðŸ›‘ HARD STOP CONDITIONS

You MUST STOP immediately when:
	â€¢	Both P0 issues are fixed
	â€¢	Verification report is written
	â€¢	No other gaps are touched

DO NOT:
	â€¢	Proceed to payouts
	â€¢	Proceed to Wave C
	â€¢	Proceed to UX work
	â€¢	â€œClean upâ€ unrelated code

Return control with:

â€œWave B1-Fix complete. Ready for verification.â€

â¸»

âŒ FAILURE CONDITIONS (AUTOMATIC REJECTION)

This wave will be rejected if ANY of the following occur:
	â€¢	Inventory is still deducted before payment confirmation
	â€¢	Inventory is not restored on expiration/failure
	â€¢	Seat uniqueness is still enforced only in application logic
	â€¢	Any unrelated feature is added
	â€¢	Scope exceeds the two P0 issues
	â€¢	No clear verification evidence is provided

â¸»

ðŸ“Œ FINAL NOTE TO REPLIT

This wave determines whether real money can safely flow through WebWaka.

Precision > speed
Correctness > cleverness
Discipline > enthusiasm

Execute only what is required. Stop when done.

â¸»

When Replit completes this, we will verify line-by-line before authorizing the next wave.