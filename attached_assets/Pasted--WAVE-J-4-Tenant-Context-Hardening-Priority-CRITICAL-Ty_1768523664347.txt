üîê WAVE J.4 ‚Äî Tenant Context Hardening

Priority: CRITICAL
Type: Core Architecture
Mode: Read-heavy, controlled refactor
Status: AUTHORIZED

‚∏ª

üéØ OBJECTIVE

Harden WebWaka‚Äôs tenant context handling across all public and semi-public surfaces by reducing reliance on client-passed tenant identifiers and establishing a server-authoritative tenant resolution layer, without breaking existing functionality.

This wave is about security, correctness, and future-proofing, not feature expansion.

‚∏ª

üß† CONTEXT (DO NOT IGNORE)

WebWaka currently exposes tenantId / tenantSlug in multiple places, especially in:
	‚Ä¢	SVM public storefronts
	‚Ä¢	MVM public marketplace
	‚Ä¢	ParkHub public marketplace
	‚Ä¢	Sites & Funnels public rendering
	‚Ä¢	Canonical order, customer, and proof APIs

This is known architectural debt, already documented in Wave I and Wave J reports.

Wave J.4 exists to:
	‚Ä¢	Reduce exposure
	‚Ä¢	Normalize resolution
	‚Ä¢	Prepare for domains, white-label, and enterprise scale

‚∏ª

üß± SCOPE ‚Äî WHAT TO IMPLEMENT

1Ô∏è‚É£ Tenant Context Resolver Layer (NEW, INTERNAL)

Create a single authoritative resolver responsible for tenant context resolution.

Required capabilities:
	‚Ä¢	Resolve tenant from:
	‚Ä¢	tenantSlug (public routes)
	‚Ä¢	request host (future-ready, no domain logic yet)
	‚Ä¢	Validate:
	‚Ä¢	tenant exists
	‚Ä¢	tenant status is ACTIVE
	‚Ä¢	required capability/module is enabled
	‚Ä¢	Return a TenantContext object (opaque to clients)

üìå This resolver must be used by:
	‚Ä¢	SVM storefront routes
	‚Ä¢	MVM marketplace routes
	‚Ä¢	ParkHub marketplace routes
	‚Ä¢	Sites & Funnels public routes
	‚Ä¢	Canonical APIs (orders, customers, proofs)

‚∏ª

2Ô∏è‚É£ TenantContext Object (NEW CANONICAL TYPE)

Define a canonical, internal-only structure:

TenantContext {
  tenantId: string
  tenantSlug: string
  isDemo: boolean
  enabledModules: string[]
  source: "slug" | "host"
}

‚ö†Ô∏è This object:
	‚Ä¢	Must be resolved server-side only
	‚Ä¢	Must NOT be reconstructed client-side
	‚Ä¢	Must NOT be passed verbatim to client components unless unavoidable

‚∏ª

3Ô∏è‚É£ Public Route Refactors (STRICTLY LIMITED)

Refactor existing public routes to use the resolver:
	‚Ä¢	/[tenantSlug]/store
	‚Ä¢	/[tenantSlug]/marketplace/*
	‚Ä¢	/[tenantSlug]/parkhub/*
	‚Ä¢	/[tenantSlug]/* (Sites & Funnels public pages)
	‚Ä¢	/api/orders/canonical
	‚Ä¢	/api/customers/canonical
	‚Ä¢	/api/proofs/*

Rules:
	‚Ä¢	‚ùå NO new business logic
	‚Ä¢	‚ùå NO schema changes
	‚Ä¢	‚ùå NO auth system changes
	‚Ä¢	‚ùå NO feature additions
	‚Ä¢	‚úÖ Replace ad-hoc tenant resolution with the resolver

‚∏ª

4Ô∏è‚É£ Controlled Client Exposure (IMPORTANT)

Where tenant identifiers must reach the client (e.g. existing providers):
	‚Ä¢	Clearly mark as temporary architectural debt
	‚Ä¢	Centralize the exposure in ONE place
	‚Ä¢	Document why it cannot yet be removed

üìå Example:

SVMProvider still requires tenantId ‚Äî allowed, but documented.

‚∏ª

5Ô∏è‚É£ Demo vs Live Rules (MUST PRESERVE)
	‚Ä¢	Demo tenants:
	‚Ä¢	Resolver allows bypass
	‚Ä¢	Mark TenantContext.isDemo = true
	‚Ä¢	Live tenants:
	‚Ä¢	Strict validation
	‚Ä¢	404 on invalid / suspended tenants

‚∏ª

üßæ REQUIRED DOCUMENTATION (MANDATORY)

At completion, produce WAVE_J4_TENANT_CONTEXT_REPORT.md containing:

A. What Was Refactored
	‚Ä¢	List of routes updated
	‚Ä¢	Services now using TenantContextResolver

B. What Was NOT Changed
	‚Ä¢	Explicit confirmation of:
	‚Ä¢	‚ùå No schema changes
	‚Ä¢	‚ùå No new auth
	‚Ä¢	‚ùå No new business logic

C. Remaining Architectural Debt
	‚Ä¢	All places where tenantId is still exposed
	‚Ä¢	Why they remain
	‚Ä¢	Which future wave will address them

D. Security Improvements Achieved
	‚Ä¢	Before vs after comparison
	‚Ä¢	Risk reduction summary

‚∏ª

üö´ HARD CONSTRAINTS (NON-NEGOTIABLE)
	‚Ä¢	‚ùå Do NOT introduce a new API proxy layer
	‚Ä¢	‚ùå Do NOT invent opaque tokens yet
	‚Ä¢	‚ùå Do NOT change client contracts unnecessarily
	‚Ä¢	‚ùå Do NOT add background jobs
	‚Ä¢	‚ùå Do NOT add authentication

This wave is foundational, not transformative.

‚∏ª

üõë STOP CONDITION

When finished, you must:
	1.	Deliver WAVE_J4_TENANT_CONTEXT_REPORT.md
	2.	Explicitly list all remaining tenant exposure gaps
	3.	STOP and wait for approval before Wave K

‚∏ª

‚úÖ SUCCESS DEFINITION

Wave J.4 is successful if:
	‚Ä¢	All public surfaces resolve tenant context uniformly
	‚Ä¢	Tenant validation logic exists in one place
	‚Ä¢	Exposure is reduced, documented, and controlled
	‚Ä¢	Platform is ready for:
	‚Ä¢	White-label domains
	‚Ä¢	Partner branding
	‚Ä¢	External templates
	‚Ä¢	Enterprise onboarding

‚∏ª