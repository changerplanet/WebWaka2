Perfect. Below is the official, tightened Replit execution prompt for Wave K.3 â€” Close Remaining Commerce Gaps (Postâ€“MVM Checkout Hardening), written to reflect everything learned from Waves K.1 & K.2, and to strictly respect governance rules.

â¸»

ğŸ” WAVE K.3 â€” CLOSE REMAINING COMMERCE GAPS

Replit Execution Prompt (Authoritative)

Platform: WebWaka
Phase: Wave K.3 â€” Commerce Completion & Reliability
Status: âœ… AUTHORIZED TO START
Mode: READâ€“WRITE (Scoped)
Owner: Replit
Architectural Authority: WebWaka Core Rules Apply

â¸»

ğŸ¯ WAVE K.3 OBJECTIVE

Harden and complete the Multi-Vendor Commerce lifecycle by closing post-checkout operational gaps discovered in Wave K.2 â€” without breaking or re-architecting existing systems.

This wave is about correctness, safety, and production realism, not new features.

â¸»

ğŸ§­ SCOPE â€” WHAT MUST BE IMPLEMENTED

1ï¸âƒ£ Payment Webhooks & Order Finalization

Problem Identified:
Payments are initiated correctly, but:
	â€¢	Final confirmation is client-driven
	â€¢	No canonical server-side payment confirmation flow exists

Implement:
	â€¢	Webhook handlers for:
	â€¢	Paystack (primary)
	â€¢	Demo provider (internal simulation)
	â€¢	Idempotent webhook processing
	â€¢	Canonical flow:

PAYMENT_CONFIRMED â†’ ORDER_CONFIRMED â†’ INVENTORY_DEDUCTED


	â€¢	Ensure:
	â€¢	Duplicate webhook events are safely ignored
	â€¢	Orders are finalized ONLY after verified payment

ğŸ“Œ Constraints
	â€¢	âŒ No new payment providers
	â€¢	âŒ No payout execution
	â€¢	âœ… Use existing PaymentTransaction + Order models
	â€¢	âœ… Respect demo vs live behavior

â¸»

2ï¸âƒ£ Partial Vendor Fulfillment Handling (MVM)

Problem Identified:
	â€¢	Orders can split into multiple vendor sub-orders
	â€¢	One vendor may fail while others succeed

Implement:
	â€¢	Parent order status becomes PARTIALLY_FULFILLED when applicable
	â€¢	Sub-order-level fulfillment independence
	â€¢	Parent order aggregates child states correctly
	â€¢	Customer-facing order view reflects mixed fulfillment

ğŸ“Œ Constraints
	â€¢	âŒ No refunds yet
	â€¢	âŒ No re-routing logic
	â€¢	âœ… Read-only aggregation + state transitions only

â¸»

3ï¸âƒ£ Split Refund Readiness (NO MONEY MOVEMENT)

Problem Identified:
Refunds are not supported, but must be modeled correctly.

Implement (Model + Visibility only):
	â€¢	RefundIntent model (NO execution)
	â€¢	Support:
	â€¢	Full refund
	â€¢	Vendor-specific refund
	â€¢	Admin & Partner visibility
	â€¢	Customer visibility (read-only)

ğŸ“Œ Constraints
	â€¢	âŒ No payment reversal
	â€¢	âŒ No wallet crediting
	â€¢	âŒ No automation
	â€¢	âœ… Visibility + correctness only

â¸»

4ï¸âƒ£ Shipping Fee Allocation (Multi-Vendor)

Problem Identified:
Shipping is currently flat or implicit.

Implement:
	â€¢	Per-vendor shipping allocation
	â€¢	Parent order shows:
	â€¢	Total shipping
	â€¢	Sub-orders show:
	â€¢	Their share of shipping
	â€¢	Allocation rules:
	â€¢	Weight-based if available
	â€¢	Fallback: proportional by subtotal

ğŸ“Œ Constraints
	â€¢	âŒ No carrier integrations
	â€¢	âŒ No dynamic pricing engines
	â€¢	âœ… Deterministic allocation logic only

â¸»

5ï¸âƒ£ Order Recovery & Resilience

Problem Identified:
If payment fails mid-flow, recovery is unclear.

Implement:
	â€¢	Safe retry mechanisms:
	â€¢	Resume checkout from cart
	â€¢	Re-initiate payment without duplicating orders
	â€¢	Order expiration handling:
	â€¢	EXPIRED state if unpaid beyond threshold
	â€¢	Clear customer messaging

ğŸ“Œ Constraints
	â€¢	âŒ No cron jobs
	â€¢	âŒ No background workers
	â€¢	âœ… User-triggered recovery only

â¸»

ğŸ›‘ HARD CONSTRAINTS (NON-NEGOTIABLE)

Rule	Status
No new payment providers	âŒ
No payout execution	âŒ
No background jobs	âŒ
No automations	âŒ
No schema rewrites	âŒ
No breaking existing APIs	âŒ
Idempotency enforced	âœ…
Demo-safe behavior preserved	âœ…
Tenant isolation enforced	âœ…


â¸»

ğŸ“„ REQUIRED DELIVERABLES (MANDATORY)

At completion, Replit MUST provide:

1ï¸âƒ£ Wave K.3 Completion Report

Including:
	â€¢	APIs added or modified
	â€¢	Models added or extended
	â€¢	Payment lifecycle diagram
	â€¢	Order state transition matrix
	â€¢	Demo vs live behavior

2ï¸âƒ£ Explicit Gap Register
	â€¢	List all remaining commerce gaps
	â€¢	Clearly label:
	â€¢	Why they exist
	â€¢	Why they are NOT solved in Wave K.3
	â€¢	Which future wave they belong to

3ï¸âƒ£ Explicit Confirmations

Replit must explicitly confirm:
	â€¢	âŒ No money moved
	â€¢	âŒ No automation added
	â€¢	âŒ No background jobs
	â€¢	âŒ No partner/vendor payouts
	â€¢	âŒ No architectural shortcuts

â¸»

ğŸ›‘ REQUIRED STOP CONDITION

After delivering the Wave K.3 report:

STOP. DO NOT PROCEED.
Await explicit authorization before starting any further work.

â¸»

âœ… SUCCESS CRITERIA

Wave K.3 is considered successful when:
	â€¢	MVM orders are payment-correct, resilient, and recoverable
	â€¢	Partial fulfillment is modeled correctly
	â€¢	Refunds are visible but inert
	â€¢	Shipping fees are transparently allocated
	â€¢	No new architectural debt is introduced

â¸»

You are now cleared to proceed with Wave K.3.

When complete, paste the Wave K.3 Completion Report here for final review and approval.