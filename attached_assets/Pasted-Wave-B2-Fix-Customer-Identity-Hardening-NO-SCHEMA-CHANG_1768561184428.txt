Wave B2-Fix ‚Äî Customer & Identity Hardening (NO SCHEMA CHANGES)

‚ö†Ô∏è ABSOLUTE CONSTRAINTS (NON-NEGOTIABLE)

You are executing Wave B2-Fix.

This wave is HARDENING ONLY.

‚ùå DO NOT:
	‚Ä¢	Create or modify Prisma models
	‚Ä¢	Add new database tables
	‚Ä¢	Add migrations
	‚Ä¢	Introduce customer accounts
	‚Ä¢	Add consent storage
	‚Ä¢	Add anonymization or deletion logic
	‚Ä¢	Merge identities
	‚Ä¢	Change canonical ID generation rules
	‚Ä¢	Introduce authentication systems
	‚Ä¢	Touch payment, receipts, or proofs logic

‚úÖ YOU MAY:
	‚Ä¢	Tighten access control
	‚Ä¢	Add identity verification requirements
	‚Ä¢	Add runtime guards and warnings
	‚Ä¢	Add flags, metadata, and explicit disclosures
	‚Ä¢	Modify API behavior without changing schemas
	‚Ä¢	Improve failure modes and error responses
	‚Ä¢	Add comments and internal documentation

Any violation of these constraints = FAILURE.

‚∏ª

üéØ WAVE OBJECTIVE

Reduce identity misuse, access leakage, and false assumptions in customer/order access
WITHOUT introducing new data models or persistence.

‚∏ª

üß© EXECUTION TASKS (DO IN THIS EXACT ORDER)

‚∏ª

üîí TASK B2-F1 ‚Äî Order Access Hardening (CRITICAL)

Objective:
Ensure order references are NOT bearer tokens for live tenants.

Actions:
	1.	Update public order detail surfaces:
	‚Ä¢	/[tenantSlug]/orders/[orderRef]
	‚Ä¢	/api/orders/canonical/[reference]
	2.	Enforce:
	‚Ä¢	For LIVE tenants:
	‚Ä¢	Require email or phone verification
	‚Ä¢	Verification must match the order‚Äôs customer data
	‚Ä¢	For DEMO tenants:
	‚Ä¢	Preserve existing open access behavior
	3.	If verification fails:
	‚Ä¢	Return a generic response
	‚Ä¢	Do NOT reveal whether the order exists
	4.	Ensure:
	‚Ä¢	No order details are returned without verification (live tenants)
	‚Ä¢	Order reference alone is insufficient

Explicitly document this change in code comments.

‚úÖ Closes B2 GAP-5 (Order reference as bearer token)

‚∏ª

üß© TASK B2-F2 ‚Äî Identity Fragmentation Signaling

Objective:
Prevent silent cross-system identity confusion.

Actions:
	1.	Detect when:
	‚Ä¢	Email-based canonical identity ‚â† phone-based canonical identity
	‚Ä¢	Common scenario: SVM/MVM (email) vs ParkHub (phone-only)
	2.	In canonical customer responses:
	‚Ä¢	Add explicit metadata flag:

identityFragmented: true
fragmentationReason: 'EMAIL_PHONE_MISMATCH' | 'PHONE_ONLY_SOURCE'
affectedSystems: ['SVM', 'MVM', 'PARKHUB']


	3.	Behavior rules:
	‚Ä¢	Queries by email MUST NOT silently include ParkHub tickets
	‚Ä¢	Queries by phone MAY aggregate across systems
	‚Ä¢	Ambiguity must be surfaced, never hidden

‚ùå Do NOT merge identities
‚ùå Do NOT change canonical ID generation

‚∏ª

üõ°Ô∏è TASK B2-F3 ‚Äî Canonical Identity Guardrails

Objective:
Prevent future misuse of CanonicalCustomer as a persistent entity.

Actions:
	1.	Add explicit runtime assertions:
	‚Ä¢	CanonicalCustomer is read-only
	‚Ä¢	CanonicalCustomer MUST NOT be persisted
	‚Ä¢	CanonicalCustomer MUST NOT be used as foreign keys
	2.	Add developer warnings (runtime or logs) if:
	‚Ä¢	Any code attempts to store canonicalId
	‚Ä¢	Any code treats canonical identity as authoritative storage
	3.	Add top-level documentation comment in:
	‚Ä¢	canonical-customer-service.ts
	‚Ä¢	identity-resolution.ts

Example:

/**
 * IMPORTANT:
 * CanonicalCustomer is a READ-ONLY, DERIVED identity.
 * It MUST NOT be persisted or treated as a primary customer record.
 */


‚∏ª

üìú TASK B2-F4 ‚Äî Privacy & Compliance Disclosure (INTERNAL)

Objective:
Make privacy limitations explicit and auditable.

Actions:
	1.	Add a privacyLimitations block to canonical responses (internal APIs only):

privacyLimitations: {
  consentTracking: false,
  rightToErasure: false,
  retentionPolicyDefined: false,
  dataDerivedFromOrders: true
}


	2.	Ensure:
	‚Ä¢	This is informational only
	‚Ä¢	No behavior changes
	‚Ä¢	No data storage
	3.	Add inline documentation referencing:
	‚Ä¢	NDPR / GDPR gaps
	‚Ä¢	Why they are deferred
	‚Ä¢	Which future wave should handle them

‚∏ª

üõë MANDATORY STOP CONDITIONS (DO NOT PROCEED PAST THIS)

You MUST STOP when ALL of the following are true:
	‚Ä¢	‚úÖ Live tenant order pages require email/phone verification
	‚Ä¢	‚úÖ Order reference alone no longer grants access (live tenants)
	‚Ä¢	‚úÖ Identity fragmentation is explicitly surfaced in APIs
	‚Ä¢	‚úÖ No schema changes were made
	‚Ä¢	‚úÖ No migrations were created
	‚Ä¢	‚úÖ No customer table exists
	‚Ä¢	‚úÖ All original Wave B2 gaps remain documented
	‚Ä¢	‚úÖ No proof/receipt logic was modified

At this point:

üëâ STOP. DO NOT CONTINUE TO WAVE B3.
üëâ Prepare a Wave B2-Fix Completion Report summarizing:
	‚Ä¢	What was hardened
	‚Ä¢	What remains intentionally unfixed
	‚Ä¢	Confirmation of constraint compliance

‚∏ª

‚ùå FAILURE CONDITIONS

This wave FAILS if:
	‚Ä¢	Any database schema is touched
	‚Ä¢	Any customer persistence is introduced
	‚Ä¢	Any identity is merged
	‚Ä¢	Any B3-related logic is implemented
	‚Ä¢	Any access is loosened instead of tightened

‚∏ª

üìå FINAL REMINDER TO REPLIT

This is identity hardening, not identity completion.
Your job is to reduce risk and ambiguity, not to ‚Äúfinish‚Äù customer identity.

STOP EXACTLY AT THE END OF TASK B2-F4.